(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[74874],{122:e=>{"use strict";e.exports=function e(t,s){if(t===s)return!0;if(t&&s&&"object"==typeof t&&"object"==typeof s){if(t.constructor!==s.constructor)return!1;var o,n,i;if(Array.isArray(t)){if((o=t.length)!=s.length)return!1;for(n=o;0!==n--;)if(!e(t[n],s[n]))return!1;return!0}if(t.constructor===RegExp)return t.source===s.source&&t.flags===s.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===s.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===s.toString();if((o=(i=Object.keys(t)).length)!==Object.keys(s).length)return!1;for(n=o;0!==n--;)if(!Object.prototype.hasOwnProperty.call(s,i[n]))return!1;for(n=o;0!==n--;){var r=i[n];if(!e(t[r],s[r]))return!1}return!0}return t!==t&&s!==s}},16540:(e,t,s)=>{"use strict";s.r(t),s.d(t,{AugLoopApi:()=>ur});var o,n=s(27051),i=s(74844),r=s(38752);!function(e){e[e.error=0]="error",e[e.warn=1]="warn",e[e.info=3]="info",e[e.metric=4]="metric",e[e.verbose=5]="verbose",e[e.debug=6]="debug",e[e.disabled=7]="disabled"}(o||(o={}));var a={util:{},roots:{default:{}}},c=(a.util,a.roots.default||(a.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.count=0,e.prototype.cv="",e.prototype.serviceName="",e.prototype.sessionKey="",e.prototype.traceId="",e.prototype.durationMs=0,e.prototype.success=!1,e.prototype.resultDescription="",e.prototype.resultJSON="",e.prototype.resultSignature="",e.prototype.operationName="",e.prototype.resourceId="",e.prototype.dimension0="",e.prototype.dimension1="",e.prototype.dimension2="",e.prototype.dimension3="",e.prototype.clientAppName="",e.prototype.clientAppPlatform="",e.prototype.clientRuntimeVersion="",e.prototype.clientAppVersion="",e.prototype.clientReleaseAudienceGroup="",e.prototype.clientReleaseChannel="",e.prototype.clientReleaseFork="",e.prototype.clientSessionId="",e.prototype.clientFlights="",e.prototype.clientIPRange="",e.prototype.clientDocSessionId="",e.prototype.clientUserAgent="",e.prototype.userType="",e.prototype.userId="",e.prototype.userTenantId="",e.prototype.joinContextId="",e.prototype.ariaTenant="",e.prototype.ariaNamespace="",e.prototype.dataFields="",e.prototype.userDataBoundaryType="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/OperationEvent"},e}());const l="undefined"!=typeof process&&process.hrtime?()=>{const e=process.hrtime();return 1e3*e[0]+e[1]/1e6}:"undefined"!=typeof performance&&performance.now?()=>performance.now():()=>Date.now(),u="undefined"!=typeof process&&process.hrtime?()=>{const e=process.hrtime();return 1e6*e[0]+e[1]/1e3}:"undefined"!=typeof performance&&performance.now?()=>Math.round(1e3*performance.now()):()=>1e3*Date.now(),h=Symbol("dataFieldsObject"),p=Symbol("dataFieldsAreDirty"),d=Symbol("_dataFields");class g extends c{constructor(e,t){super(e),this.eventName="Operation",this.options=t,this.durationMs=null===e||void 0===e?void 0:e.durationMs,e&&void 0!=e.count||(this.count=1),(null===e||void 0===e?void 0:e.dataFields)&&(this.dataFields=e.dataFields)}setClientMetadata(e,t){return e&&(this.clientAppName=e.appName,this.clientAppPlatform=e.appPlatform,this.clientAppVersion=e.appVersion,void 0!=t&&t||(this.clientFlights=e.flights),this.clientReleaseAudienceGroup=e.releaseAudienceGroup,this.clientReleaseChannel=e.releaseChannel,this.clientReleaseFork=e.releaseFork,this.clientRuntimeVersion=e.runtimeVersion,this.clientSessionId=e.sessionId,this.clientDocSessionId=e.docSessionId,this.clientUserAgent=e.userAgent),this}setUserContext(e){return e&&(this.userId=e.puid||e.oid,this.userType=e.userType&&e.userType.toString(),this.userTenantId=e.tid),this}setMetricCustomDimensions(e,t){if(!this.options)throw new Error("Attempting to set custom dimensions ".concat(e," to operation ").concat(this.operationName," without activating MetricCount or MetricDuration"));this.options.metricCustomDimensions=this.options.metricCustomDimensions||{},this.options.metricCustomDimensions[e]=t}setDataField(e,t){this[h]||(this[h]={}),this[h][e]=t,this[p]=!0}setDataFields(e){this[h]||(this[h]={}),this[h]=Object.assign(Object.assign({},this[h]),e),this[p]=!0}start(){return this.startTime=l(),this}recordStep(e){return this.setDataField(e,Math.floor(l()-this.startTime)),this}stop(){const e=l();return this.durationMs=Math.round(e-this.startTime),this}addCustomMetric(e){void 0===this.customMetrics&&(this.customMetrics=[]),this.customMetrics.push(e)}getCustomMetrics(){const e=[];if(void 0!==this.customMetrics){const t=e=>[...this.getDimensionNames(),...e.extraDimensions.map(e=>e.name)];for(const s of this.customMetrics){const o={};o["".concat(this.operationName,".").concat(s.nameSuffix)]={dimensionNames:()=>t(s),dimensionValues:[...this.getDimensionValues(),...s.extraDimensions.map(e=>e.value)],value:s.value},e.push(o)}}return e}getMetrics(e){var t,s;const o={};if(this.operationName)switch(this.operationName){case"SessionHealthOrphanedEventsWithoutProperSessionKey":case"SessionHealthOrphanedSessions":case"WorkflowActivationState":o[this.operationName+".CountV2"]={dimensionNames:g.getOrphanedSessionHealthDimensionNames.bind(g),dimensionValues:this.getOrphanedSessionHealthDimensionValues(),value:this.count};break;case"MarkUnhealthySession":case"MarkHealthWarningSession":o[this.operationName+".Reason"]={dimensionNames:g.getSessionHealthDimensionNames.bind(g),dimensionValues:this.getSessionHealthDimensionValues(),value:1};break;default:if("matchmaker_timer"===this.operationName&&(o["Workflow.DurationMs"]={dimensionNames:g.getWorkflowDimensionNames.bind(g),dimensionValues:this.getWorkflowDimensionValues(),value:this.durationMs||0},o["Workflow.Count"]={dimensionNames:g.getWorkflowDimensionNames.bind(g),dimensionValues:this.getWorkflowDimensionValues(),value:1}),void 0!==this.durationMs){const s="".concat(this.operationName,".DurationMsV2");((null===(t=this.options)||void 0===t?void 0:t.metricDuration)||e.indexOf(s)>=0)&&(o[s]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.durationMs})}{const t="".concat(this.operationName,".CountV2");((null===(s=this.options)||void 0===s?void 0:s.metricCount)||e.indexOf(t)>=0)&&(o[t]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.count})}}return o}getDimensionNames(){var e,t;let s=g.dimensionNames;if(null===(e=this.options)||void 0===e?void 0:e.metricCustomDimensions){s=s.slice();for(const e in null===(t=this.options)||void 0===t?void 0:t.metricCustomDimensions)s.push(e)}return s}getDimensionValues(){var e,t;const s=[this.success,this.clientAppName,this.clientAppPlatform,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3];if(null===(e=this.options)||void 0===e?void 0:e.metricCustomDimensions)for(const o in null===(t=this.options)||void 0===t?void 0:t.metricCustomDimensions)s.push(this.options.metricCustomDimensions[o]);return s}static getOrphanedSessionHealthDimensionNames(){return this.orphanedSessionHealthDimensionNames}getOrphanedSessionHealthDimensionValues(){return[this.success,this.clientAppName,this.clientAppPlatform,this.clientReleaseAudienceGroup,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}static getSessionHealthDimensionNames(){return this.sessionHealthDimensionNames}getSessionHealthDimensionValues(){return[this.resultSignature,this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}static getWorkflowDimensionNames(){return this.workflowDimensionNames}getWorkflowDimensionValues(){return[this.resultSignature,this.resourceId,this.resourceId,this.success]}}var f,m,y,T,v,w;g.dimensionNames=["Success","ClientAppName","ClientAppPlatform","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"],g.orphanedSessionHealthDimensionNames=["Success","ClientAppName","ClientAppPlatform","ClientReleaseAudienceGroup","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"],g.sessionHealthDimensionNames=["Reason","ClientAppName","ClientAppPlatform","ClientAppVersion","Dimension0","Dimension1","Dimension2","Dimension3"],g.workflowDimensionNames=["ResultSignature","WorkflowId","ResourceId","Success"],Object.defineProperty(g.prototype,"dataFields",{get:function(){var e,t;return this[p]&&(this[d]=JSON.stringify(null!==(e=this[h])&&void 0!==e?e:{}),this[p]=!1),void 0!==this[p]?this[d]:null!==(t=this[d])&&void 0!==t?t:""},set:function(e){this[h]=e&&""!==e?JSON.parse(e):{},this[d]=e,this[p]=!1},enumerable:!0,configurable:!0}),function(e){e[e.EditorLowPrivilege=0]="EditorLowPrivilege",e[e.AugLoopLowPrivilege=1]="AugLoopLowPrivilege",e[e.Anonymous=2]="Anonymous",e[e.ClientAssertion=3]="ClientAssertion",e[e.ClientAssertionV2=4]="ClientAssertionV2",e[e.AutoClpLowPrivilege=5]="AutoClpLowPrivilege",e[e.AutoClpAppOnlyLowPrivilege=6]="AutoClpAppOnlyLowPrivilege",e[e.Substrate=7]="Substrate",e[e.WacUserInfo=8]="WacUserInfo",e[e.OwaExchange=9]="OwaExchange",e[e.SmartCompose=10]="SmartCompose",e[e.WritingAnalyticsLowPrivilege=11]="WritingAnalyticsLowPrivilege",e[e.DWEngineLowPrivilege=12]="DWEngineLowPrivilege",e[e.SubstrateApp=13]="SubstrateApp",e[e.CortanaAppPop=14]="CortanaAppPop",e[e.OfficeAppsAppOnly=15]="OfficeAppsAppOnly",e[e.PPTFrontdoorAppPop=16]="PPTFrontdoorAppPop",e[e.EditorAppOnlyLowPrivilege=17]="EditorAppOnlyLowPrivilege",e[e.AugLoopApp=18]="AugLoopApp",e[e.MeetingIntelligenceApp=19]="MeetingIntelligenceApp",e[e.GraphApp=20]="GraphApp",e[e.IceServicesApp=21]="IceServicesApp",e[e.AzureMapsApp=22]="AzureMapsApp",e[e.SpoApp=23]="SpoApp",e[e.OneDrive=24]="OneDrive",e[e.GoogleDrive=25]="GoogleDrive",e[e.GettyApp=26]="GettyApp",e[e.Dropbox=27]="Dropbox",e[e.GooglePhotos=28]="GooglePhotos",e[e.EditorApp=29]="EditorApp",e[e.AmazonKindle=30]="AmazonKindle",e[e.ShredderApp=31]="ShredderApp",e[e.FormsLowPrivilege=32]="FormsLowPrivilege",e[e.VivaSalesLowPrivilege=33]="VivaSalesLowPrivilege",e[e.IntentSvcApp=34]="IntentSvcApp",e[e.DcgLowPrivilege=35]="DcgLowPrivilege",e[e.CSALowPrivilege=36]="CSALowPrivilege",e[e.ConsumerSydneyLowPrivilege=37]="ConsumerSydneyLowPrivilege",e[e.CompliantSydneyApp=38]="CompliantSydneyApp",e[e.M365AdminApp=39]="M365AdminApp",e[e.MeetingArtifactsServiceLowPrivilege=40]="MeetingArtifactsServiceLowPrivilege",e[e.AlchemyApp=41]="AlchemyApp",e[e.M365Admin=42]="M365Admin",e[e.ConsumerShellApp=43]="ConsumerShellApp",e[e.PowerQueryLowPrivilege=44]="PowerQueryLowPrivilege",e[e.CIIApp=45]="CIIApp",e[e.ConsumerShell=46]="ConsumerShell",e[e.AssistCopilotLowPrivilege=47]="AssistCopilotLowPrivilege",e[e.Pva=48]="Pva",e[e.TeamsCopilotServiceLowPrivilege=49]="TeamsCopilotServiceLowPrivilege",e[e.CallAnalytics=50]="CallAnalytics",e[e.IncomingPFT=51]="IncomingPFT",e[e.GraphExchange=52]="GraphExchange",e[e.EXOAdmin=53]="EXOAdmin",e[e.InsightsServicesLowPrivilege=54]="InsightsServicesLowPrivilege",e[e.VivaServicesLowPrivilege=55]="VivaServicesLowPrivilege",e[e.EcsAppOnly=56]="EcsAppOnly",e[e.ShredderLowPrivilege=57]="ShredderLowPrivilege",e[e.SpoLowPrivilege=58]="SpoLowPrivilege",e[e.PromptValidationApp=59]="PromptValidationApp",e[e.CompliantSydneyLowPrivilege=60]="CompliantSydneyLowPrivilege",e[e.SubstrateTenantFeedbackApp=61]="SubstrateTenantFeedbackApp",e[e.MonitoringPlatform=62]="MonitoringPlatform",e[e.YammerLowPrivilege=63]="YammerLowPrivilege",e[e.VivaLearningLowPrivilege=64]="VivaLearningLowPrivilege",e[e.VivaInsightsLowPrivilege=65]="VivaInsightsLowPrivilege",e[e.ClientAugLoopApp=66]="ClientAugLoopApp",e[e.AssistAuthLowPrivilege=67]="AssistAuthLowPrivilege",e[e.VivaLearningSearchPreProdLowPrivilege=68]="VivaLearningSearchPreProdLowPrivilege",e[e.SubstrateSearchApp=69]="SubstrateSearchApp",e[e.SparkContentPlatformLowPrivilege=70]="SparkContentPlatformLowPrivilege",e[e.SparkContentPlatformPopApp=71]="SparkContentPlatformPopApp",e[e.ConsumerSydneyApp=72]="ConsumerSydneyApp",e[e.BusinessAssistAuthLowPrivilege=73]="BusinessAssistAuthLowPrivilege",e[e.AzureResourceManager=74]="AzureResourceManager",e[e.AlchemyPortal=75]="AlchemyPortal",e[e.VivaUserSkillsApp=76]="VivaUserSkillsApp",e[e.VivaEngageAppPop=77]="VivaEngageAppPop",e[e.SubstrateAppOnly=78]="SubstrateAppOnly",e[e.PowerAutomateFlowCreationLowPrivilege=79]="PowerAutomateFlowCreationLowPrivilege",e[e.PowerAutomateConnectionCreationLowPrivilege=80]="PowerAutomateConnectionCreationLowPrivilege",e[e.PowerAutomateAuthorizeConnectionLowPrivilege=81]="PowerAutomateAuthorizeConnectionLowPrivilege",e[e.TCAAppPop=82]="TCAAppPop",e[e.BusinessAssistAuthAppPop=83]="BusinessAssistAuthAppPop",e[e.HolmesApp=84]="HolmesApp",e[e.GraphAppOnly=85]="GraphAppOnly",e[e.SimsApp=86]="SimsApp",e[e.VivaOrgInsightsLowPrivilege=87]="VivaOrgInsightsLowPrivilege",e[e.VivaGoalsAppPop=88]="VivaGoalsAppPop",e[e.GCBotAppPop=89]="GCBotAppPop",e[e.ShredderV2App=90]="ShredderV2App",e[e.ShredderV2LowPrivilege=91]="ShredderV2LowPrivilege",e[e.AmplifyProfileService=92]="AmplifyProfileService",e[e.AzureDevopsLowPrivilege=93]="AzureDevopsLowPrivilege",e[e.CommuteServices=94]="CommuteServices",e[e.GCBotAppOnly=95]="GCBotAppOnly",e[e.TCAAppOnly=96]="TCAAppOnly",e[e.MavenAgentLowPrivilege=97]="MavenAgentLowPrivilege",e[e.VivaOrgInsightsAppPop=98]="VivaOrgInsightsAppPop",e[e.EduAssignmentsPftAtPop=99]="EduAssignmentsPftAtPop",e[e.AugloopAppPop=100]="AugloopAppPop",e[e.OneNoteLowPrivilege=101]="OneNoteLowPrivilege",e[e.TeamsAuthzSvcAppPop=102]="TeamsAuthzSvcAppPop",e[e.LoopAppPop=103]="LoopAppPop",e[e.LoopAppOnly=104]="LoopAppOnly",e[e.BapLowPrivilege=105]="BapLowPrivilege",e[e.IC3AppPop=106]="IC3AppPop",e[e.PowerPlatformApiGateway=107]="PowerPlatformApiGateway",e[e.OdspNotifyAppPop=108]="OdspNotifyAppPop",e[e.MIPSyncService=109]="MIPSyncService",e[e.RightsManagementServices=110]="RightsManagementServices",e[e.TCAV2AppPop=111]="TCAV2AppPop",e[e.SubstrateLLMLowPrivilege=112]="SubstrateLLMLowPrivilege",e[e.SubstrateSearchLowPrivilege=113]="SubstrateSearchLowPrivilege",e[e.CloudPolicyServiceAppPop=114]="CloudPolicyServiceAppPop",e[e.TCAV2LowPrivilege=115]="TCAV2LowPrivilege",e[e.AiHubServicesAppPop=116]="AiHubServicesAppPop",e[e.TMRAppOnly=117]="TMRAppOnly",e[e.PacmanAppPop=118]="PacmanAppPop",e[e.AugloopAlternativeIdentity=119]="AugloopAlternativeIdentity",e[e.SpoAppOnly=120]="SpoAppOnly",e[e.DataverseLowPrivilege=121]="DataverseLowPrivilege",e[e.SubstrateLLMApp=122]="SubstrateLLMApp",e[e.SimsAppOnly=123]="SimsAppOnly",e[e.PythonService=124]="PythonService",e[e.PythonServiceAppOnly=125]="PythonServiceAppOnly",e[e.DesignerAppServiceLowPrivilege=126]="DesignerAppServiceLowPrivilege",e[e.DesignerAppServiceAppPop=127]="DesignerAppServiceAppPop",e[e.AmplifyProfileServiceAppOnly=128]="AmplifyProfileServiceAppOnly",e[e.MARSAppPop=129]="MARSAppPop",e[e.PlannerAppPop=130]="PlannerAppPop",e[e.BingForBusinessLowPrivilege=131]="BingForBusinessLowPrivilege",e[e.OLS=132]="OLS",e[e.OLSAppPop=133]="OLSAppPop",e[e.GCS=134]="GCS",e[e.AugLoopConsumer=135]="AugLoopConsumer",e[e.ContentValidationServiceAppOnly=136]="ContentValidationServiceAppOnly",e[e.FabricLowPrivilege=137]="FabricLowPrivilege",e[e.FeatureAccessManagementAppPop=138]="FeatureAccessManagementAppPop",e[e.FireIntelligenceAppOnly=139]="FireIntelligenceAppOnly",e[e.MARSLowPrivilege=140]="MARSLowPrivilege",e[e.EXOAdminAppPop=141]="EXOAdminAppPop",e[e.IncomingAT=142]="IncomingAT",e[e.CopilotLabLowPrivilege=143]="CopilotLabLowPrivilege",e[e.VivaPulseLowPrivilege=144]="VivaPulseLowPrivilege",e[e.WacAppPop=145]="WacAppPop",e[e.PowerAppsAiBuilderLowPrivilege=146]="PowerAppsAiBuilderLowPrivilege",e[e.CognitiveApiAppOnly=147]="CognitiveApiAppOnly",e[e.CopilotMetricsAppOnly=148]="CopilotMetricsAppOnly",e[e.ShredderAppOnly=149]="ShredderAppOnly",e[e.TeamsAuthzSvcLowPrivilege=150]="TeamsAuthzSvcLowPrivilege",e[e.PlannerLowPrivilege=151]="PlannerLowPrivilege"}(f||(f={})),function(e){e[e.Unknown=0]="Unknown",e[e.Consumer=1]="Consumer",e[e.Enterprise=2]="Enterprise"}(m||(m={})),function(e){e[e.Default=0]="Default",e[e.EDPSCompliant=1]="EDPSCompliant"}(y||(y={})),function(e){e.AuthorizationCode="authorization_code",e.ClientCredentials="client_credentials",e.RefreshToken="refresh_token"}(T||(T={})),function(e){e[e.LoggedIn=0]="LoggedIn",e[e.LoggedOut=1]="LoggedOut"}(v||(v={})),function(e){e.Log="Log"}(w||(w={}));const C="undefined"!=typeof process?{NODE_ENV:"production",PUBLIC_URL:".",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.SERVICE_NAME:"client",S="abcdefghijklmnopqrstuvwxyz0123456789",k={97:0,98:1,99:2,100:3,101:4,102:5,103:6,104:7,105:8,106:9,107:10,108:11,109:12,110:13,111:14,112:15,113:16,114:17,115:18,116:19,117:20,118:21,119:22,120:23,121:24,122:25,48:26,49:27,50:28,51:29,52:30,53:31,54:32,55:33,56:34,57:35};let b,A=[],_=[],M=e=>null,I=e=>{};const N=new Map,P=new Map,E=new Map,x=new Map;var D,O;!function(e){e.Default="",e.EDPSCompliant="edps"}(D||(D={})),function(e){e.defineCoreLogCategory=e=>({root:"Core",name:e}),e.defineWorkflowLogCategory=e=>({root:"Workflow",name:e}),e.clearLoggers=()=>{A=[],_=[],P.clear(),E.clear()},e.clearAggregators=()=>{N.clear()},e.addLogger=e=>{-1===A.indexOf(e)&&(A.push(e),R(P,e))},e.addDecidingLogger=e=>{-1===_.indexOf(e)&&(_.push(e),R(E,e))},e.setCorrelationContextCallback=e=>{b=e},e.setStartPerformanceEventCallback=e=>{M=e},e.setStopPerformanceEventCallback=e=>{I=e},e.addAggregator=e=>{e.init((e,t)=>{V(e,t)}),N.has(e.eventName)?N.get(e.eventName).push(e):N.set(e.eventName,[e])},e.flushAggregators=e=>{N.forEach(t=>{t.forEach(t=>t.flush(e))})},e.setTagLevelOverride=(e,t)=>{const s=Q(e);x.set(s,t)},e.resetTagLevelOverrides=()=>{x.clear()},e.error=(e,t,s,n,i,r,a,c,l,u)=>{q(e,t,o.error,s,n,i,r,a,c,l,u)},e.warn=(e,t,s,n,i,r,a,c,l,u)=>{q(e,t,o.warn,s,n,i,r,a,c,l,u)},e.info=(e,t,s,n,i,r,a,c,l,u)=>{q(e,t,o.info,s,n,i,r,a,c,l,u)},e.verbose=(e,t,s,n,i,r,a,c,l,u)=>{q(e,t,o.verbose,s,n,i,r,a,c,l,u)},e.debug=(e,t,s,n,i,r,a,c,l,u)=>{q(e,t,o.debug,s,n,i,r,a,c,l,u)},e.metric=(e,t,s,n,i,r,a,c,l,u)=>{q(e,t,o.metric,s,n,i,r,a,c,l,u)},e.formatMetric=(e,t,s,o)=>{const n={};return n[e]={dimensionNames:s,dimensionValues:o,value:t},n},e.dynamic=e=>{V(e)}}(O||(O={}));const R=(e,t)=>{const s=t.level;Object.keys(o).map(e=>o[e]).filter(e=>"string"!==typeof e).filter(e=>e<=s).forEach(s=>{e.has(s)?e.get(s).push(t):e.set(s,[t])})},B=e=>{if("string"===typeof e)return e;let t="";for(let s=0;s<e.length;s++){s>0&&(t+=" ");const o=e[s];o instanceof Error?t+=JSON.stringify({message:o.message,name:o.name,stack:o.stack}):t+="object"===typeof o?JSON.stringify(o):o}return t},L=[],W=["Level","Tag"],F=["Level","Tag","Workflow"],G=e=>U(e).length,U=e=>void 0!==e?P.get(e)||L:A,H=(e,t)=>(void 0!==e?E.get(e)||[]:_).filter(e=>e.shouldLog(t)),q=(e,t,s,o,n,i,r,a,c,l,u)=>{s=x.get(e)||s;const h=U(s),p=H(s,o);if(0==h.length&&0==p.length)return;const d=M(w.Log),g=K(e),f=((e,t,s,o,n,i,r,a)=>{if(void 0===t&&("string"===typeof e||"object"===typeof e))return e;if(void 0===t&&"function"===typeof e)return e();const c=[];for(const l of[e,t,s,o,n,i,r,a])void 0!==l&&c.push("function"===typeof l?l():l);return c})(o,n,i,r,a,c,l,u);if(j(t))z(f)&&V({eventName:"Metrics",tagId:g,category:"".concat(t.root,".").concat(t.name),traceLevel:s,message:"",getMetrics:()=>f},!1,h,p);else if(z(f)){const e=f;e.tagId=g,e.category="".concat(t.root,".").concat(t.name),"Operation"===e.eventName&&"Workflow"===t.root&&(e.eventName="WorkflowOperation",b&&(e.joinContextId=b().joinContextId,e.workflow=b().workflow)),e.traceLevel=s;const o=N.get(e.eventName);if(o)for(let t=0;t<o.length;++t){const s=o[t];if(s&&s.add(e,t===o.length-1))break}else V(e,!1,h,p)}else{const e=()=>{var e;return"Core"===t.root?{TraceEventV2:{dimensionNames:()=>W,dimensionValues:[String(s),g],value:1}}:{WorkflowTraceEvent:{dimensionNames:()=>F,dimensionValues:[String(s),g,b?null===(e=b())||void 0===e?void 0:e.workflow:""],value:1}}};V({eventName:"Log",tagId:g,category:"".concat(t.root,".").concat(t.name),traceLevel:s,message:B(f),getMetrics:e},!1,h,p)}I(d)},V=function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0;var n,i,r,a,c,l,u,h,p,d,g,f,m,y;let T;if(null==s&&(s=U(e.traceLevel)),o=o||L,s.length>0||o.length>0){if(e.serviceName=C,!t&&b){const t=b();t&&(T={disableLogging:t.disableLogging,userDataBoundaryType:null===(i=null===(n=t.sessionDescriptor)||void 0===n?void 0:n.userContext)||void 0===i?void 0:i.userDataBoundaryType},e.cv=e.cv?e.cv:t.cv.toString(),e.sessionKey=e.sessionKey?e.sessionKey:t.sessionKey,e.userTenantId=e.userTenantId?e.userTenantId:t.userTenantId,e.workflow=e.workflow?e.workflow:t.workflow,e.clientAppName=e.clientAppName?e.clientAppName:null===(r=t.clientMetadata)||void 0===r?void 0:r.appName,e.clientAppPlatform=e.clientAppPlatform?e.clientAppPlatform:null===(a=t.clientMetadata)||void 0===a?void 0:a.appPlatform,e.clientAppVersion=e.clientAppVersion?e.clientAppVersion:null===(c=t.clientMetadata)||void 0===c?void 0:c.appVersion,e.clientDocSessionId=e.clientDocSessionId?e.clientDocSessionId:null===(l=t.clientMetadata)||void 0===l?void 0:l.docSessionId,e.clientReleaseAudienceGroup=e.clientReleaseAudienceGroup?e.clientReleaseAudienceGroup:null===(u=t.clientMetadata)||void 0===u?void 0:u.releaseAudienceGroup,e.clientReleaseChannel=e.clientReleaseChannel?e.clientReleaseChannel:null===(h=t.clientMetadata)||void 0===h?void 0:h.releaseChannel,e.clientReleaseFork=e.clientReleaseFork?e.clientReleaseFork:null===(p=t.clientMetadata)||void 0===p?void 0:p.releaseFork,e.clientRuntimeVersion=e.clientRuntimeVersion?e.clientRuntimeVersion:null===(d=t.clientMetadata)||void 0===d?void 0:d.runtimeVersion,e.clientSessionId=e.clientSessionId?e.clientSessionId:null===(g=t.clientMetadata)||void 0===g?void 0:g.sessionId,e.clientUserAgent=e.clientUserAgent?e.clientUserAgent:null===(f=t.clientMetadata)||void 0===f?void 0:f.userAgent,e.traceId=e.traceId||t.traceId,e.isClientTelemetrySampled=e.isClientTelemetrySampled?e.isClientTelemetrySampled:null===(m=t.clientMetadata)||void 0===m?void 0:m.isClientTelemetrySampled,e.userDataBoundaryType=J(T),e.ecsConfigIDs=null===(y=t.ecsConfigIDsManager)||void 0===y?void 0:y.getAllConfigIDsString())}for(const t of s)t.log(e,T);for(const t of o)t.log(e)}},j=e=>e.name===Y.WorkflowMetricsOnly.name&&e.root===Y.WorkflowMetricsOnly.root,z=e=>!Array.isArray(e)&&"object"===typeof e,J=e=>(null===e||void 0===e?void 0:e.userDataBoundaryType)===y.EDPSCompliant?D.EDPSCompliant:D.Default,K=e=>S[e>>24&63]+S[e>>18&63]+S[e>>12&63]+S[e>>6&63]+S[63&e],Q=e=>e&&5===e.length?k[e.charCodeAt(0)]<<24|k[e.charCodeAt(1)]<<18|k[e.charCodeAt(2)]<<12|k[e.charCodeAt(3)]<<6|k[e.charCodeAt(4)]:-1;class Y{}Y.CoreDefault=O.defineCoreLogCategory("Default"),Y.CoreSystem=O.defineCoreLogCategory("System"),Y.CoreUnsampled=O.defineCoreLogCategory("Unsampled"),Y.WorkflowDefault=O.defineWorkflowLogCategory("Default"),Y.WorkflowUnsampled=O.defineWorkflowLogCategory("Unsampled"),Y.WorkflowMetricsOnly=O.defineWorkflowLogCategory("MetricsOnly"),Y.PrivacyGuardEvent=O.defineCoreLogCategory("PrivacyGuardEvent");var X,Z;!function(e){e[e.ProductServiceUsage=2]="ProductServiceUsage",e[e.ProductServicePerformance=4]="ProductServicePerformance"}(X||(X={})),function(e){e[e.BasicEvent=10]="BasicEvent",e[e.FullEvent=100]="FullEvent",e[e.RequiredServiceDataEvent=110]="RequiredServiceDataEvent"}(Z||(Z={}));const $="n~",ee=/\|\~/g;class te{constructor(){this.count=0,this.measureSums=new Map}}class se{constructor(e,t,s,o,n){var i=this;this.buckets=new Map,this.init=e=>{this.log=e},this.add=function(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!i.condition||!i.condition(e))return!0===t&&i.log(e,!1),!1;const s=[];for(const r of i.dimensions)if(void 0===e[r]||null===e[r])s.push(null);else{let t="";"boolean"==typeof e[r]?t="b~":"number"==typeof e[r]&&(t=$),s.push("".concat(t).concat(e[r].toString().replace(ee,"_")))}const o=s.join("|");let n=i.buckets.get(o);if(!n){n=new te,n.traceLevel=e.traceLevel;for(const e of i.avgMeasures)n.measureSums.set(e,0);i.buckets.set(o,n)}n.count++;for(const r of i.avgMeasures)e[r]&&n.measureSums.set(r,n.measureSums.get(r)+e[r]);return!0},this.flush=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];i.buckets.forEach((e,t)=>{const s={traceLevel:e.traceLevel,eventName:i.eventName,count:e.count},o=t.split("|");for(let n=0;n<i.dimensions.length;n++){const e=i.dimensions[n],t=o[n];0===t.indexOf("b~")?s[e]="b~true"===t:0===t.indexOf($)?s[e]=parseInt(t.slice(2),10):s[e]=t}for(const n of i.avgMeasures)s[n]=Math.round(e.measureSums.get(n)/e.count);i.log(s,!0)}),i.buckets.clear(),e&&(i.condition=null,clearInterval(i.interval))},this.eventName=e,this.condition=t,this.dimensions=s,this.avgMeasures=o,n>0&&(this.interval=setInterval(this.flush,1e3*n))}}const oe=["cloud.dev.microsoft","officeppe.com","cloud.microsoft","office.com","office365.us","ic.gov","microsoft.scloud","microsoftonline.cn"],ne=(e,t,s,o)=>new se(e,e=>e.success&&s.indexOf(e[t])>=0,[t,"ariaNamespace","resourceId","success","resultSignature","clientDocSessionId","dimension0","dimension1","dimension2","dimension3"],["durationMs"],o),ie=e=>{if(!e)return e;for(const t of oe)if(e.indexOf(t)>=0)return e;return"**redacted**"};class re{constructor(e){this.level=o.info,this.hostCallbacks=e}log(e){if(null==this.hostCallbacks||null==this.hostCallbacks.sendTelemetryEvent)return;const t=(e,t,s,o,n)=>{let i=t.charAt(0).toUpperCase()+t.slice(1),r={DocSessionId:e.clientDocSessionId,ResourceId:e.resourceId,ResultDescription:e.resultDescription,ResultSignature:e.resultSignature,Dimension0:e.dimension0,Dimension1:e.dimension1,Dimension2:e.dimension2,Dimension3:e.dimension3,JoinContextId:e.joinContextId,ServerSessionKey:this.serverSessionKey};s&&(r=Object.assign(Object.assign({},r),JSON.parse(s)));const a=o||re.augLoopAriaTenantToken,c=n||a!=re.augLoopAriaTenantToken?n:re.augLoopAriaNamespace;i=i||re.operationNamePlaceholder;const l={CV:e.cv,Duration:1e3*(e.durationMs||0),Count:e.count,AggMode:2,Success:e.success};this.hostCallbacks.sendTelemetryEvent(a,c?"".concat(c,"_").concat(i):i,r,"Office.System.Activity",l,!1,X.ProductServiceUsage|X.ProductServicePerformance,Z.RequiredServiceDataEvent)},s=(e,t,s)=>{this.hostCallbacks.sendDiagnosticTrace&&this.hostCallbacks.sendDiagnosticTrace(e,t,s)};if("Workflow.MetricsOnly"==e.category);else if("Operation"===e.eventName){const s=e;t(s,s.operationName,s.dataFields,void 0,s.ariaNamespace)}else if("SessionHealth"===e.eventName){t(e,e.sessionHealthEventName)}else if("WorkflowOperation"===e.eventName){const s=e;t(s,s.operationName,s.dataFields,s.ariaTenant,s.ariaNamespace)}else"Log"===e.eventName&&s(e.tagId,e.traceLevel,e.message)}setServerSessionKey(e){this.serverSessionKey=e}}re.augLoopAriaTenantToken="3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770",re.augLoopAriaNamespace="Office_AugLoop_Client",re.operationNamePlaceholder="OperationNameNotProvided";var ae=null;"undefined"!==typeof WebSocket?ae=WebSocket:"undefined"!==typeof MozWebSocket?ae=MozWebSocket:"undefined"!==typeof s.g?ae=s.g.WebSocket||s.g.MozWebSocket:"undefined"!==typeof window?ae=window.WebSocket||window.MozWebSocket:"undefined"!==typeof self&&(ae=self.WebSocket||self.MozWebSocket);const ce=ae,le="object"===typeof process&&"object"===typeof process.versions&&"undefined"!==typeof process.versions.node,ue=1e5;class he{constructor(e,t){this.networkOverrideOptions=e,this.settings=t,this.hadEgressError=!1,this.isClosing=!1,this.pendingEgress=[]}get egressByteCountOp(){return this._egressByteCountOp||(this._egressByteCountOp=new g({operationName:"WSEgressByteOrderOfMagnitude",success:!0}),this._egressByteCountOp.setClientMetadata(this.clientMetadata,!0)),this._egressByteCountOp}init(e,t,s,o,n){var i,r;if(this.clientMetadata=n,le&&this.networkOverrideOptions){const t={servername:null===(i=this.networkOverrideOptions)||void 0===i?void 0:i.hostHeader,headers:(null===(r=this.networkOverrideOptions)||void 0===r?void 0:r.hostHeader)?{host:this.networkOverrideOptions.hostHeader}:void 0};this.ws=new ce(e,t)}else this.ws=new ce(e);this.logOp=new g({operationName:he.className,success:!0}).start(),this.logOp.setClientMetadata(n,!0),this.ingressByteCountOp=new g({operationName:"WSIngressByteOrderOfMagnitude",success:!0}),this.ingressByteCountOp.setClientMetadata(n,!0),this.ws.addEventListener("open",e=>{s(),this.logOp.resourceId="OnOpen",this.logOp.resultDescription="",this.logOp.success=!0,this.logOp.dimension0=this.pendingEgress.length.toString(),O.info(508843801,Y.CoreDefault,this.logOp.stop())}),this.ws.addEventListener("message",e=>{this.logIngressCount(e.data),t(e.data)}),this.ws.addEventListener("error",e=>{this.errorMessage=e.message,this.logOp.resourceId="OnError",this.logOp.resultDescription=this.errorMessage,this.logOp.success=!1,O.info(508843800,Y.CoreDefault,this.logOp.stop()),this.ws?this.ws.close():this.logWsUndefinedError("error event handler")}),this.ws.addEventListener("close",e=>{this.logOp.resourceId="OnClose",this.logOp.resultDescription=e?"code: ".concat(e.code,". reason: ").concat(e.reason):"",this.logOp.success=!0,O.info(508843799,Y.CoreDefault,this.logOp.stop()),o(this.errorMessage),this.isClosing=!1})}egress(e){var t;const s=e.obj;(null===(t=this.settings)||void 0===t?void 0:t.webSocketWorkerShouldLogEgressCount)&&this.logEgressCount(s),this.ws.send(s,e=>{e&&!this.hadEgressError&&(this.hadEgressError=!0,this.logOp.resourceId="OnEgressError",this.logOp.resultDescription=e.message,this.logOp.success=!1,O.info(508843797,Y.CoreDefault,this.logOp.stop()))})}close(){this.isClosing||(this.isClosing=!0,this.ws?this.ws.close():this.logWsUndefinedError("close"))}logIngressCount(e){const t=e.length;t>ue&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=t.toString().length.toString(),O.info(508843794,Y.CoreDefault,this.ingressByteCountOp.stop()))}logEgressCount(e){const t="string"===typeof e?e.length:e.byteLength;t>ue&&(this.egressByteCountOp.start(),this.egressByteCountOp.dimension2=t.toString().length.toString(),O.info(505710625,Y.CoreDefault,this.egressByteCountOp.stop()))}logWsUndefinedError(e){const t=new g({operationName:he.className,success:!1}).start();t.setClientMetadata(this.clientMetadata,!0),t.resourceId="webSocketUndefined",t.resultDescription=e+": this.ws null or undefined",O.info(506566722,Y.CoreDefault,t.stop())}}he.className="WebSocketWorker";class pe{constructor(e){this.childCount=0,this.id=e||function(){for(let e=0;e<ge;e++)fe[e]=de[Math.floor(Math.random()*de.length)];return fe.join("")}()}static fromString(e,t){if(!e)throw new Error("Received invalid correlation vector string");let s;return s=e.endsWith(".0")?new pe(e.substring(0,e.length-2)):new pe(e),t&&(s.childCount=t),s}newChild(){return++this.childCount,new pe(this.id+"."+this.childCount.toString())}toString(){return this.id.length>127?this.id.substring(0,127)+"!":this.id}}const de=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],ge=22,fe=new Array(ge);var me,ye,Te,ve={util:{},roots:{default:{}}},we=(ve.util,ve.roots.default||(ve.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.cv="",e.prototype.serviceName="",e.prototype.sessionKey="",e.prototype.traceId="",e.prototype.clientAppName="",e.prototype.clientAppPlatform="",e.prototype.clientRuntimeVersion="",e.prototype.clientAppVersion="",e.prototype.clientReleaseAudienceGroup="",e.prototype.clientReleaseChannel="",e.prototype.clientReleaseFork="",e.prototype.clientSessionId="",e.prototype.clientFlights="",e.prototype.clientIPRange="",e.prototype.clientDocSessionId="",e.prototype.clientUserAgent="",e.prototype.userType="",e.prototype.userId="",e.prototype.userTenantId="",e.prototype.sessionHealthEventName="",e.prototype.source="",e.prototype.reason="",e.prototype.reasonDependency="",e.prototype.subReason="",e.prototype.impact="",e.prototype.success=!1,e.prototype.durationMs=0,e.prototype.count=0,e.prototype.message="",e.prototype.affectedWorkflows="",e.prototype.resourceId="",e.prototype.dimension0="",e.prototype.dimension1="",e.prototype.dimension2="",e.prototype.dimension3="",e.prototype.resultDescription="",e.prototype.resultSignature="",e.prototype.joinContextId="",e.prototype.userDataBoundaryType="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/SessionHealthEvent"},e}());!function(e){e[e.Unknown=0]="Unknown",e[e.Core=1]="Core",e[e.Workflow=2]="Workflow",e[e.SessionExtension=3]="SessionExtension",e[e.Client=4]="Client",e[e.ClientRuntime=5]="ClientRuntime"}(me||(me={})),function(e){e[e.Unknown=0]="Unknown",e[e.Core=1]="Core",e[e.Workflow=2]="Workflow",e[e.SessionExtension=3]="SessionExtension",e[e.Client=4]="Client",e[e.Network=5]="Network",e[e.AugLoopDependency=6]="AugLoopDependency",e[e.WorkflowDependency=7]="WorkflowDependency",e[e.ClientRuntime=8]="ClientRuntime"}(ye||(ye={})),function(e){e[e.Unknown=0]="Unknown",e[e.None=1]="None",e[e.MissingInput=2]="MissingInput",e[e.MissingOutput=3]="MissingOutput"}(Te||(Te={}));class Ce extends we{constructor(e,t){var s,o;super({source:me[e.source],reason:ye[e.reason],reasonDependency:e.reasonDependency,subReason:e.subReason,sessionHealthEventName:e.sessionHealthEventName,impact:Te[e.impact],success:e.success,durationMs:null!==(s=e.durationMs)&&void 0!==s?s:0,count:"number"===typeof e.count?e.count:1,message:e.message,affectedWorkflows:(null!==(o=e.affectedWorkflows)&&void 0!==o?o:[]).join(","),resourceId:e.resourceId,dimension0:e.dimension0,dimension1:e.dimension1,dimension2:e.dimension2,dimension3:e.dimension3,cv:e.cv,resultSignature:e.resultSignature,resultDescription:e.resultDescription,joinContextId:e.joinContextId}),this.eventName="SessionHealth",this.aggregationEnabled=!1,t&&this.setClientMetadata(t),this.metricCount=e.metricCount,this.metricDuration=e.metricDuration}getMetrics(){const e={};return(void 0===this.metricCount||this.metricCount)&&(e["".concat(this.sessionHealthEventName,".CountV2")]={dimensionNames:()=>Ce.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.count}),(void 0===this.metricDuration||this.metricDuration)&&(e["".concat(this.sessionHealthEventName,".DurationMsV2")]={dimensionNames:()=>Ce.dimensionNames,dimensionValues:this.getDimensionValues(),value:this.durationMs}),e}setClientMetadata(e){return e&&(this.clientAppName=e.appName,this.clientAppPlatform=e.appPlatform,this.clientAppVersion=e.appVersion,this.clientFlights=e.flights,this.clientReleaseAudienceGroup=e.releaseAudienceGroup,this.clientReleaseChannel=e.releaseChannel,this.clientReleaseFork=e.releaseFork,this.clientRuntimeVersion=e.runtimeVersion,this.clientSessionId=e.sessionId,this.clientDocSessionId=e.docSessionId,this.clientUserAgent=e.userAgent),this}setUserContext(e){return e&&(this.userId=e.puid||e.oid,this.userType=e.userType&&e.userType.toString(),this.userTenantId=e.tid),this}setReason(e){return this.reason=ye[e],this}setSource(e){return this.source=me[e],this}setImpact(e){return this.impact=Te[e],this}setAffectedWorkflows(e){return this.affectedWorkflows=(null!==e&&void 0!==e?e:[]).join(","),this}getAffectedWorkflows(){return this.affectedWorkflows.split(",")}enableAggregation(){return this.aggregationEnabled=!0,this}shouldBeAggregated(){return this.aggregationEnabled}start(){return this.startTime=l(),this}stop(){const e=l();return this.durationMs=Math.round(e-this.startTime),this}getDimensionValues(){var e;return[this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.success?"1":"0","".concat(this.reason,"_").concat(this.reasonDependency),this.impact,null!==(e=this.getAffectedWorkflows()[0])&&void 0!==e?e:"",this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}}Ce.dimensionNames=["ClientAppName","ClientAppPlatform","ClientAppVersion","Success","Reason","Impact","FirstAffectedWorkflow","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];var Se,ke,be=s(122),Ae=s.n(be);class _e{constructor(){this.listeners=new Map,this.lastId=0}addListener(e){if(!e)throw new Error("No callback provided for data listener");return this.listeners.set(this.lastId,e),this.lastId++}removeListener(e){this.listeners.delete(e)}notifyListeners(e){this.listeners.forEach(t=>{t(e)})}}!function(e){e.Add="Add",e.Remove="Remove",e.Set="Set",e.Delete="Delete"}(ke||(ke={}));class Me{static applyECSPatchOperation(e,t){let s=!1;if("object"===typeof t||Array.isArray(t))switch(e.operation){case ke.Add:case ke.Remove:s=Me.applyAddOrRemoveOperation(e.path,t,e.value,e.operation);break;case ke.Set:s=Me.applySetOperation(e.path,t,e.value);break;case ke.Delete:s=Me.applyDeleteOperation(e.path,t,e.value)}return s?O.verbose(505956121,Y.CoreDefault,"PATCH operation succeeded for ".concat(e.operation," on ").concat(e.settingName," with path: ").concat(e.path,".")):O.error(505956122,Y.CoreDefault,"PATCH operation failed for ".concat(e.operation," on ").concat(e.settingName," with path: ").concat(e.path)),s}static applyAddOrRemoveOperation(e,t,s,o){let n=!1;try{let i=[];if("object"!==typeof t||Array.isArray(t)?Array.isArray(t)&&(i=t):i=e.reduce((e,t)=>e&&e[t],t),Array.isArray(i))if(o===ke.Add)i.push(s),n=!0;else if(o===ke.Remove){const e=i.indexOf(s);e>=0&&(i.splice(e,1),n=!0)}}catch(i){O.info(505968832,Y.CoreDefault,"Exception thrown while applying operation type: ".concat(o," for an array. Error: ").concat(i)),n=!1}return n}static applySetOperation(e,t,s){let o=!1;try{const n=e.slice(0,-1),i=e[e.length-1];let r={};"object"!==typeof t||Array.isArray(t)||(r=n.reduce((e,t)=>e&&e[t],t),"object"!==typeof r||Array.isArray(r)||(r[i]=s,o=!0))}catch(n){O.info(505968802,Y.CoreDefault,"Exception thrown while applying set operation. Error: ".concat(n)),o=!1}return o}static applyDeleteOperation(e,t,s){let o=!1;try{let n={};"object"!==typeof t||Array.isArray(t)||(n=e.reduce((e,t)=>e&&e[t],t),"object"!==typeof n||Array.isArray(n)||"string"!==typeof s||n.hasOwnProperty(s)&&(delete n[s],o=!0))}catch(n){O.info(505968801,Y.CoreDefault,"Exception thrown while applying delete operation. Error: ".concat(n)),o=!1}return o}}Se=Me,Me.parseECSOperation=(e,t)=>{if(!t.hasOwnProperty("operationType")||!t.hasOwnProperty("path")||!t.hasOwnProperty("value"))throw new Error("Invalid format for PATCH operation on setting: ".concat(e));const s=t.operationType.toLowerCase(),o=Se.convertToConfigPatchOperationType(s);return{settingName:e,path:t.path?t.path.split("."):[],operation:o,value:t.value}},Me.convertToConfigPatchOperationType=e=>{switch(e){case"add":return ke.Add;case"remove":return ke.Remove;case"set":return ke.Set;case"delete":return ke.Delete;default:throw new Error("Invalid operation type: ".concat(e))}};var Ie=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};class Ne extends _e{constructor(e){super(),this.name=e}static initEcsSettingsProvider(e){O.info(505999498,Y.CoreDefault,"Initializing ECS settings provider."),Ne.ecsSettingsProvider=e}static enableEcsPatchConfig(e){Ne.ecsPatchConfigEnabled=e}static getInstance(e){let t=this.allSettings.get(e);if(!t){t=new Ne(e);const s=Ne.tryGetConfigProperty(Ne.currentConfig,e);s.success&&t.updateValue(s.value),this.allSettings.set(e,t)}return t}static getPatternInstance(e){let t=this.allPatternSettings.get(e);if(!t){t={regex:new RegExp(e),setting:new Ne(e)};const s=Ne.tryGetConfigPropertyByPattern(Ne.currentConfig,t.regex);t.setting.updateValue(s),this.allPatternSettings.set(e,t)}return t.setting}static setNewConfig(e){Ne.currentConfig=e,O.info(572837966,Y.CoreDefault,"New config: ".concat(JSON.stringify(e))),Ne.allSettings.forEach((e,t)=>{const s=Ne.tryGetConfigProperty(Ne.currentConfig,t).value;e.updateValue(s)&&(O.info(572837967,Y.CoreDefault,"Setting new value for ".concat(t,": ").concat(s instanceof Object?JSON.stringify(s):s)),e.notifyListeners(s))}),Ne.allPatternSettings.forEach((t,s)=>{const o=Ne.tryGetConfigPropertyByPattern(e,t.regex);t.setting.updateValue(o)&&(O.info(508432774,Y.CoreDefault,"Setting new value for pattern ".concat(s,": ").concat(JSON.stringify(o))),t.setting.notifyListeners(o))})}static tryGetConfigProperty(e,t){return e&&e.hasOwnProperty(t)?{success:!0,value:Ne.selectApplicableValue(e[t])}:{success:!1,value:void 0}}static tryGetConfigPropertyByPattern(e,t){const s=[];if(e){const o=Object.getOwnPropertyNames(e).filter(e=>t.test(e));for(const t of o)s.push({name:t,value:Ne.selectApplicableValue(e[t])})}return s}static setGlobalFilter(e){Ne.globalFilter=e}static setLocalConfig(e){Ne.localConfig=e,O.info(506053841,Y.CoreDefault,"Setting localConfig field in Setting class: ".concat(JSON.stringify(Ne.localConfig)))}static clear(){Ne.currentConfig=void 0,Ne.localConfig=void 0,Ne.allSettings.clear(),Ne.allPatternSettings.clear(),Ne.ecsSettingsProvider=void 0}static selectApplicableValue(e){let t;if(e){const s=e.find(e=>!Ne.globalFilter||Ne.globalFilter(e));s&&(t=s.value)}return t}getName(){return this.name}getValue(){if(function(){var e;return"undefined"!==typeof globalThis.process&&"true"===(null===(e=globalThis.process.env)||void 0===e?void 0:e.VALIDATE_CORRECT_USAGE_OF_GET_VALUE)}()&&0===this.listeners.size){const e=new Error("SettingInstance or ChangeGate is being used incorrectly. Make sure .getValue() or ChangeGate is called during runtime or there is a listener set up on the setting. For more info visit: ".concat(Ne.troubleshootUrl));throw e.name="Incorrect usage of getValue()",e}return this.value}getValueAdvancedAsync(e){return Ie(this,void 0,void 0,function*(){const t=new g({operationName:"ECSGetValueAsync"},{metricDuration:!0}).start();let s;try{const o=yield Ne.ecsSettingsProvider.getSettingValue(this.name,e);t.dimension0=o.userAuthenticated?"Authenticated":"Anonymous",t.success=!0;let n=o.value,i=o.ecsSection;return n||(n=Ne.tryGetConfigProperty(Ne.localConfig,this.name).value,n&&o.patchValue&&(n=Ne.applyPatchOperationOnSetting(this.name,n,o.patchValue),i=o.ecsPatchSection)),s="Setting value for ".concat(this.name," is ").concat(JSON.stringify(n),".\n Config IDs: ").concat(JSON.stringify(i),"."),n}catch(o){O.error(505226379,Y.CoreDefault,"Exception thrown while getting setting value for ".concat(this.name,". Error: ").concat(o)),t.success=!1;const e=Ne.tryGetConfigProperty(Ne.localConfig,this.name).value;return s="Setting value for ".concat(this.name," is ").concat(JSON.stringify(e),"."),e}finally{O.info(506053839,Y.CoreDefault,t.stop()),O.info(505821320,Y.CoreDefault,s)}})}updateValue(e){return!Ae()(this.value,e)&&(O.info(572837968,Y.CoreDefault,"Received new property value for ".concat(this.getName(),":"),e),this.value=e,!0)}static applyPatchOperationsOnConfig(e){try{if(!Ne.ecsPatchConfigEnabled)return e;const s=this.tryGetConfigProperty(e,"patchOperations").value;if(!s||0===s.length)return e;const o=[];for(const[e,i]of Object.entries(s))try{o.push(Me.parseECSOperation(e,i))}catch(t){O.error(505734922,Y.CoreDefault,"Exception thrown while parsing ECS PATCH operation for setting: ".concat(e,". Error: ").concat(t));continue}const n=new Map;for(const t of o)if(null===e||void 0===e?void 0:e.hasOwnProperty(t.settingName)){const s=JSON.parse(JSON.stringify(e[t.settingName])),o=Ne.selectApplicableValue(s);Me.applyECSPatchOperation(t,o)&&(n.set(t.settingName,o),e[t.settingName]=s)}return n.size>0&&O.info(505788322,Y.CoreDefault,"Resulting settings after PATCHes were applied: ".concat(JSON.stringify(Object.fromEntries(n)))),e}catch(t){return O.error(505788321,Y.CoreDefault,"Exception thrown while applying ECS PATCH operations. Error: ".concat(t)),e}}static applyPatchOperationOnSetting(e,t,s){try{if(!Ne.ecsPatchConfigEnabled)return t;const o=JSON.parse(JSON.stringify(t)),n=s,i=Me.parseECSOperation(e,n);return Me.applyECSPatchOperation(i,o),o}catch(o){return O.error(505788323,Y.CoreDefault,"Exception thrown while applying ECS PATCH operation on setting. Error: ".concat(o)),t}}}Ne.allSettings=new Map,Ne.allPatternSettings=new Map,Ne.ecsPatchConfigEnabled=!1,Ne.troubleshootUrl="https://eng.ms/docs/experiences-devices/opg/office-ai/augloop-ai-platform/augmentation-loop/documentation/server-workflow-tutorials/settings/troubleshoot";class Pe extends _e{constructor(e,t){super(),this.listenerId=NaN,this.defaultValue=t,this.setting=Ne.getInstance(e)}getDefaultValue(){return this.defaultValue}addListener(e){return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(()=>{this.notifyListeners(this.getValue())})),super.addListener(e)}removeListener(e){super.removeListener(e),0!=this.listeners.size||Number.isNaN(this.listenerId)||(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}getValue(){const e=this.setting.getValue();return void 0===e?this.defaultValue:e}getValueAdvancedAsync(e){return Ie(this,void 0,void 0,function*(){const t=yield this.setting.getValueAdvancedAsync(e);return void 0===t?this.defaultValue:t})}}const Ee=new Pe("disabledChangeGates",[]),xe=function(e,t){const s=-1===Ee.getValue().indexOf(e);if(!t)return s;if(s){for(var o=arguments.length,n=new Array(o>2?o-2:0),i=2;i<o;i++)n[i-2]=arguments[i];return t(...n)}};var De=s(52071);var Oe,Re,Be,Le,We,Fe,Ge;!function(e){e[e.ServerError=0]="ServerError",e[e.WorkflowDisabled=100]="WorkflowDisabled",e[e.TokenNotReady=101]="TokenNotReady",e[e.FlightNotReady=102]="FlightNotReady",e[e.ContextNotReady=103]="ContextNotReady",e[e.WorkflowExcluded=104]="WorkflowExcluded",e[e.WorkflowExecutionTimeout=105]="WorkflowExecutionTimeout",e[e.LambdaExecutionError=106]="LambdaExecutionError",e[e.UnexpectedOutput=107]="UnexpectedOutput",e[e.FailedToFetchInputs=108]="FailedToFetchInputs",e[e.FailedToFetchRequestedContexts=109]="FailedToFetchRequestedContexts"}(Oe||(Oe={})),function(e){e[e.Unknown=0]="Unknown",e[e.InvalidRequest=1]="InvalidRequest",e[e.InvalidResponse=2]="InvalidResponse",e[e.RuntimeNotInitialized=3]="RuntimeNotInitialized",e[e.RequestCancelled=4]="RequestCancelled",e[e.ResponseReceivedAfterFinalResponse=5]="ResponseReceivedAfterFinalResponse"}(Re||(Re={})),function(e){e[e.Unknown=0]="Unknown",e[e.Found=302]="Found",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.RequestEntityTooLarge=413]="RequestEntityTooLarge",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.UnprocessableContent=422]="UnprocessableContent",e[e.TooManyRequests=429]="TooManyRequests",e[e.SocketDisconnect=499]="SocketDisconnect",e[e.InternalServerError=500]="InternalServerError",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.UnsupportedMessage=1e3]="UnsupportedMessage",e[e.Cancelled=1001]="Cancelled",e[e.EgressError=1002]="EgressError",e[e.SyncMessageException=2e3]="SyncMessageException",e[e.SyncMessageUnsupported=2001]="SyncMessageUnsupported",e[e.SyncMessageUnexpectedSeed=2002]="SyncMessageUnexpectedSeed",e[e.SyncMessageUnsupportedBatch=2003]="SyncMessageUnsupportedBatch",e[e.SyncMessageQueueFull=2004]="SyncMessageQueueFull",e[e.SyncMessageTooLateOrDuplicate=2005]="SyncMessageTooLateOrDuplicate",e[e.SyncMessageGroupIdMismatch=2006]="SyncMessageGroupIdMismatch",e[e.SyncMessageGroupStop=2007]="SyncMessageGroupStop",e[e.SyncMessageLost=2008]="SyncMessageLost",e[e.SyncMessageUnprocessedDuplicate=2009]="SyncMessageUnprocessedDuplicate",e[e.SyncMessageSessionClosed=2010]="SyncMessageSessionClosed",e[e.SyncMessageAbandoned=2011]="SyncMessageAbandoned",e[e.SyncMessageTooManyDeltaOperations=2012]="SyncMessageTooManyDeltaOperations",e[e.SyncMessageSessionSizeLimitExceeded=2013]="SyncMessageSessionSizeLimitExceeded",e[e.TokenValidationError=2100]="TokenValidationError",e[e.TokenDecryptError=2101]="TokenDecryptError",e[e.TokenTypeError=2102]="TokenTypeError",e[e.TokenUserBlocked=2103]="TokenUserBlocked",e[e.AnnotationActivationInvalidType=2200]="AnnotationActivationInvalidType",e[e.AnnotationReleaseTokenNotFound=2300]="AnnotationReleaseTokenNotFound"}(Be||(Be={})),function(e){e[e.UnKnown=0]="UnKnown",e[e.Start=1]="Start",e[e.Regular=2]="Regular",e[e.CheckConnection=3]="CheckConnection",e[e.PostEgress=4]="PostEgress",e[e.TimeoutResend=5]="TimeoutResend",e[e.FailResend=6]="FailResend"}(Le||(Le={})),function(e){e[e.IdentityChange=0]="IdentityChange"}(We||(We={})),function(e){e[e.Idle=0]="Idle",e[e.Pending=1]="Pending"}(Fe||(Fe={})),function(e){e[e.NotStarted=0]="NotStarted",e[e.Started=1]="Started",e[e.Incomplete=2]="Incomplete",e[e.Finished=3]="Finished"}(Ge||(Ge={}));class Ue{constructor(e){De.h.assign(Ue,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ue.getTypeName()])}}Ue.H_={T_:Ue.getTypeName(),B_:Ue.getBaseTypes()};class He{constructor(e){De.h.assign(He,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Response"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[He.getTypeName()])}}He.H_={T_:He.getTypeName(),B_:He.getBaseTypes()};class qe{constructor(e){De.h.assign(qe,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_StreamingResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[qe.getTypeName()])}}qe.H_={T_:qe.getTypeName(),B_:qe.getBaseTypes()};class Ve{constructor(e){De.h.assign(Ve,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_StreamingRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ve.getTypeName()])}}Ve.H_={T_:Ve.getTypeName(),B_:Ve.getBaseTypes()};class je{constructor(e){De.h.assign(je,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ExecutionError"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[je.getTypeName()])}}je.H_={T_:je.getTypeName(),B_:je.getBaseTypes()};class ze{constructor(e){De.h.assign(ze,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_GetAnnotationsClientError"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[ze.getTypeName()])}}ze.H_={T_:ze.getTypeName(),B_:ze.getBaseTypes()};class Je{constructor(e){De.h.assign(Je,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_GetAnnotationsErrorInfo"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[Je.getTypeName()])}}Je.H_={T_:Je.getTypeName(),B_:Je.getBaseTypes()};class Ke{constructor(e){De.h.assign(Ke,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ke.getTypeName()])}}Ke.H_={T_:Ke.getTypeName(),B_:Ke.getBaseTypes()};class Qe{constructor(e){De.h.assign(Qe,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TimeoutErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Qe.getTypeName()])}}Qe.H_={T_:Qe.getTypeName(),B_:Qe.getBaseTypes()};class Ye{constructor(e){De.h.assign(Ye,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_RateLimitErrorResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ye.getTypeName()])}}Ye.H_={T_:Ye.getTypeName(),B_:Ye.getBaseTypes()};class Xe{constructor(e){De.h.assign(Xe,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Xe.getTypeName()])}}Xe.H_={T_:Xe.getTypeName(),B_:Xe.getBaseTypes()};class Ze{constructor(e){De.h.assign(Ze,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionInitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ze.getTypeName()])}}Ze.H_={T_:Ze.getTypeName(),B_:Ze.getBaseTypes()};class $e{constructor(e){De.h.assign($e,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionLongPollMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[$e.getTypeName()])}}$e.H_={T_:$e.getTypeName(),B_:$e.getBaseTypes()};class et{constructor(e){De.h.assign(et,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionLongPollResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[et.getTypeName()])}}et.H_={T_:et.getTypeName(),B_:et.getBaseTypes()};class tt{constructor(e){De.h.assign(tt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseReason"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[tt.getTypeName()])}}tt.H_={T_:tt.getTypeName(),B_:tt.getBaseTypes()};class st{constructor(e){De.h.assign(st,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionSwapOnClose"}static getBaseTypes(){return["AugLoop_Session_Protocol_SessionCloseReason"]}static typeGuard(e){return De.h.matchesTypesFor(e,[st.getTypeName()])}}st.H_={T_:st.getTypeName(),B_:st.getBaseTypes()};class ot{constructor(e){De.h.assign(ot,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ot.getTypeName()])}}ot.H_={T_:ot.getTypeName(),B_:ot.getBaseTypes()};class nt{constructor(e){De.h.assign(nt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_CacheDumpRequestMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[nt.getTypeName()])}}nt.H_={T_:nt.getTypeName(),B_:nt.getBaseTypes()};class it{constructor(e){De.h.assign(it,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_CacheDumpRequestResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[it.getTypeName()])}}it.H_={T_:it.getTypeName(),B_:it.getBaseTypes()};class rt{constructor(e){De.h.assign(rt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationActivationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[rt.getTypeName()])}}rt.H_={T_:rt.getTypeName(),B_:rt.getBaseTypes()};class at{constructor(e){De.h.assign(at,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationActivationResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[at.getTypeName()])}}at.H_={T_:at.getTypeName(),B_:at.getBaseTypes()};class ct{constructor(e){De.h.assign(ct,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationResultStateMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ct.getTypeName()])}}ct.H_={T_:ct.getTypeName(),B_:ct.getBaseTypes()};class lt{constructor(e){De.h.assign(lt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationReleaseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[lt.getTypeName()])}}lt.H_={T_:lt.getTypeName(),B_:lt.getBaseTypes()};class ut{constructor(e){De.h.assign(ut,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationReleaseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ut.getTypeName()])}}ut.H_={T_:ut.getTypeName(),B_:ut.getBaseTypes()};class ht{constructor(e){De.h.assign(ht,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ht.getTypeName()])}}ht.H_={T_:ht.getTypeName(),B_:ht.getBaseTypes()};class pt{constructor(e){De.h.assign(pt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[pt.getTypeName()])}}pt.H_={T_:pt.getTypeName(),B_:pt.getBaseTypes()};class dt{constructor(e){De.h.assign(dt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_BatchedMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[dt.getTypeName()])}}dt.H_={T_:dt.getTypeName(),B_:dt.getBaseTypes()};class gt{constructor(e){De.h.assign(gt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[gt.getTypeName()])}}gt.H_={T_:gt.getTypeName(),B_:gt.getBaseTypes()};class ft{constructor(e){De.h.assign(ft,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ft.getTypeName()])}}ft.H_={T_:ft.getTypeName(),B_:ft.getBaseTypes()};class mt{constructor(e){De.h.assign(mt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SyncResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[mt.getTypeName()])}}mt.H_={T_:mt.getTypeName(),B_:mt.getBaseTypes()};class yt{constructor(e){De.h.assign(yt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionDeleteMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[yt.getTypeName()])}}yt.H_={T_:yt.getTypeName(),B_:yt.getBaseTypes()};class Tt{constructor(e){De.h.assign(Tt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_AnnotationResultsMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Tt.getTypeName()])}}Tt.H_={T_:Tt.getTypeName(),B_:Tt.getBaseTypes()};class vt{constructor(e){De.h.assign(vt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TokenProvisionMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[vt.getTypeName()])}}vt.H_={T_:vt.getTypeName(),B_:vt.getBaseTypes()};class wt{constructor(e){De.h.assign(wt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TokenFailureMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[wt.getTypeName()])}}wt.H_={T_:wt.getTypeName(),B_:wt.getBaseTypes()};class Ct{constructor(e){De.h.assign(Ct,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_TokenProvisionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ct.getTypeName()])}}Ct.H_={T_:Ct.getTypeName(),B_:Ct.getBaseTypes()};class St{constructor(e){De.h.assign(St,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_KeepAlive"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[St.getTypeName()])}}St.H_={T_:St.getTypeName(),B_:St.getBaseTypes()};class kt{constructor(e){De.h.assign(kt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowGraphInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[kt.getTypeName()])}}kt.H_={T_:kt.getTypeName(),B_:kt.getBaseTypes()};class bt{constructor(e){De.h.assign(bt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowGraphInitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[bt.getTypeName()])}}bt.H_={T_:bt.getTypeName(),B_:bt.getBaseTypes()};class At{constructor(e){De.h.assign(At,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionCompleteMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[At.getTypeName()])}}At.H_={T_:At.getTypeName(),B_:At.getBaseTypes()};class _t{constructor(e){De.h.assign(_t,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SeedingStatusChangeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[_t.getTypeName()])}}_t.H_={T_:_t.getTypeName(),B_:_t.getBaseTypes()};class Mt{constructor(e){De.h.assign(Mt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitV2Message"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Mt.getTypeName()])}}Mt.H_={T_:Mt.getTypeName(),B_:Mt.getBaseTypes()};class It{constructor(e){De.h.assign(It,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitV2Response"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[It.getTypeName()])}}It.H_={T_:It.getTypeName(),B_:It.getBaseTypes()};class Nt{constructor(e){De.h.assign(Nt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Nt.getTypeName()])}}Nt.H_={T_:Nt.getTypeName(),B_:Nt.getBaseTypes()};class Pt{constructor(e){De.h.assign(Pt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2InitResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Pt.getTypeName()])}}Pt.H_={T_:Pt.getTypeName(),B_:Pt.getBaseTypes()};class Et{constructor(e){De.h.assign(Et,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_OAuth2CallbackMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Et.getTypeName()])}}Et.H_={T_:Et.getTypeName(),B_:Et.getBaseTypes()};class xt{constructor(e){De.h.assign(xt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_BridgeMessage"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[xt.getTypeName()])}}xt.H_={T_:xt.getTypeName(),B_:xt.getBaseTypes()};class Dt{constructor(e){De.h.assign(Dt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionConnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Dt.getTypeName()])}}Dt.H_={T_:Dt.getTypeName(),B_:Dt.getBaseTypes()};class Ot{constructor(e){De.h.assign(Ot,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionDisconnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ot.getTypeName()])}}Ot.H_={T_:Ot.getTypeName(),B_:Ot.getBaseTypes()};class Rt{constructor(e){De.h.assign(Rt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SessionReconnectMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Rt.getTypeName()])}}Rt.H_={T_:Rt.getTypeName(),B_:Rt.getBaseTypes()};class Bt{constructor(e){De.h.assign(Bt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_SubmittedCustomMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Bt.getTypeName()])}}Bt.H_={T_:Bt.getTypeName(),B_:Bt.getBaseTypes()};class Lt{constructor(e){De.h.assign(Lt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ServerAuthenticationStateChangeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Lt.getTypeName()])}}Lt.H_={T_:Lt.getTypeName(),B_:Lt.getBaseTypes()};class Wt{constructor(e){De.h.assign(Wt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ClaimsChallengeMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Wt.getTypeName()])}}Wt.H_={T_:Wt.getTypeName(),B_:Wt.getBaseTypes()};class Ft{constructor(e){De.h.assign(Ft,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_BlobUploadResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ft.getTypeName()])}}Ft.H_={T_:Ft.getTypeName(),B_:Ft.getBaseTypes()};class Gt{constructor(e){De.h.assign(Gt,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_GetPluginsMetadataMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Gt.getTypeName()])}}Gt.H_={T_:Gt.getTypeName(),B_:Gt.getBaseTypes()};class Ut{constructor(e){De.h.assign(Ut,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_GetPluginsMetadataResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ut.getTypeName()])}}Ut.H_={T_:Ut.getTypeName(),B_:Ut.getBaseTypes()};class Ht{constructor(e){De.h.assign(Ht,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_ExecutionCorrelatedClientResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ht.getTypeName()])}}Ht.H_={T_:Ht.getTypeName(),B_:Ht.getBaseTypes()};class qt{constructor(e){if(this.cache=new Map,this.options=e||{sweepInterval:100},void 0!=this.options.idleDurationMs&&this.options.idleDurationMs<=0)throw new Error("Idle duration must be positive");if(this.interval=this.options.sweepInterval||100,this.interval<=0)throw new Error("Sweep interval must be a positive number")}static setLogIntervalError(e){qt.logIntervalError=e}put(e,t,s,o,n,i,r){if(void 0===s||null===s||s<=0)throw new Error("Cache timeout must be a positive number");(void 0===n||null===n||n<=0)&&(n=this.options.idleDurationMs);const a={value:t,lastUsed:n?Date.now():void 0,expire:s+Date.now(),idleDurationMs:n,expireCallback:o,expiringTriggerTime:i+Date.now(),expiringCallback:r};return this.cache.set(e,a),this.timeout||(this.timeout=setInterval(this.onInterval.bind(this),this.interval),this.timeout.unref&&this.timeout.unref()),t}del(e){if(this.options.delCallback){const t=this.cache.get(e);t&&this.options.delCallback(e,t.value)}const t=this.cache.delete(e);return 0===this.size()&&this.clear(),t}clear(){this.timeout&&(clearInterval(this.timeout),this.timeout=void 0),this.cache.clear()}get(e){let t=this.cache.get(e);if(t){if(this.options.idleDurationMs&&(t.lastUsed=Date.now()),t.expire<Date.now()&&(this.del(e),t.expireCallback&&t.expireCallback(e,t.value),t=this.cache.get(e),!t))return;return t.value}}keys(){return this.cache.keys()}forEach(e){this.cache.forEach((t,s)=>{e(t.value,s)})}size(){return this.cache.size}updateExpireTime(e,t){return!!(this.cache.has(e)&&t>=0)&&(this.cache.get(e).expire=t+Date.now(),!0)}onInterval(){const e=Date.now();this.cache.forEach((t,s)=>{try{if(t.idleDurationMs&&t.lastUsed<e-t.idleDurationMs)return this.del(s),void(this.options.idleCallback&&this.options.idleCallback(s,t.value));t.expire<e&&(this.del(s),t.expireCallback&&t.expireCallback(s,t.value)),t.expiringTriggerTime<e&&t.expiringCallback&&(t.expiringCallback(s,t.value),t.expiringCallback=void 0)}catch(o){qt.logIntervalError&&qt.logIntervalError(o)}})}}var Vt=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};const jt=new Pe("processMessageEndpointValidation",!1);var zt,Jt;function Kt(e){const t=["AugLoop_Excel_Session_Protocol_","AugLoop_Powerpoint_Session_Protocol_","AugLoop_Session_Protocol_"];let s;for(const i of t)if(0===e.indexOf(i)){s=i;break}if(!s)return"MalformedMessageName";const o="Message",n=e.indexOf(o,e.length-7)===e.length-7;return e.slice(s.length,n?-7:void 0)}!function(e){e.ClientDisconnected="Client disconnected.",e.ClientClosed="Client closed",e.UnsupportedSyncMessage="SyncMessages with seq = -1 are not supported anymore.",e.UnexpectedSeedMessage="Unexpected seed message",e.SyncMessageUnsupportedBatch="SyncMessage with unsupported batching.",e.AnnotationTokenNotFound="Token not found",e.TooManyDeltaOperations="SyncMessage with too many delta operations",e.UnsupportedSyncMessageSeq0NonSeeding="SyncMessages with seq 0 are not supported in non seeding sequencer (SenderId)."}(zt||(zt={})),function(e){e.ProvisionTokenValidationError="Token provision message didn't pass token validation.",e.ProvisionTokenDecryptAndTransformError="Token provision message didn't pass token decrypt and transform."}(Jt||(Jt={}));class Qt{constructor(e){this.config=e,this.nextMessageId=1,this.pendingResponseCallbacks=new qt({sweepInterval:5e3}),this.messageCallbacks=new Map,this.messageValidators=new Map,this.messageIdPrefix=e.messageIdPrefix,this.source="c"===e.messageIdPrefix?me.ClientRuntime:me.Core,this.stats={sendMessageCount:0,sendMessageClientDisconnectedErrors:0,sendMessageErrors:0,sendMessageDurationMsMax:0,processMessageCount:0,processMessageProvisionTokenErrors:0,processMessageErrors:0,processMessageDurationMsMax:0}}setClientMetadata(e){this.clientMetadata=e}setEgress(e){this.egress=e,this.config.resendPendingMessagesOnReconnect&&this.egress&&this.pendingResponseCallbacks.forEach((e,t)=>{e.logOp.dimension1=(e.sendCount++).toString(),this.egress(e.message,t=>this.onEgressError(t,e))})}ingress(e,t){He.typeGuard(e)?(this.processResponse(e),t()):this.processMessage(e,t),ot.typeGuard(e)&&!e.reconnectAllowed&&this.clearAllPendingResponses()}sendMessage(e,t,s){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;var n,i;const r=new Ce({sessionHealthEventName:"SendMessage",source:this.source,reason:ye.Client,impact:this.source===me.ClientRuntime?Te.MissingInput:Te.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv,resourceId:Kt(De.h.getTypeNameFor(e)),dimension0:o.toString()}).start().enableAggregation(),a=()=>{if(r.setClientMetadata(this.clientMetadata),r.success)O.info(572836e3,Y.CoreDefault,r.stop());else{const e="ErrorWithoutPendingResponse"===r.resultSignature||"ResponseCallbackException"===r.resultSignature||"We called into done callback"!==r.message;r.message=JSON.stringify({errorNotPropagatedToDoneCallback:e}),O.error(572836001,Y.CoreDefault,r.stop())}};xe("PersistMessageId")?e.messageId=null!==(n=e.messageId)&&void 0!==n?n:"".concat(this.messageIdPrefix).concat(this.nextMessageId++):e.messageId="".concat(this.messageIdPrefix).concat(this.nextMessageId++),dt.typeGuard(e)&&e.messages.forEach((t,s)=>t.messageId=e.messageId+"."+s);const c=De.h.getTypeNameFor(e)===ot.getTypeName(),l={message:e,logOp:r,logEvent:a,callback:void 0,sendCount:1};if(!s&&!c){l.callback=(s,o)=>{var n;if(s?xe("IgnoreUnsupportedMessageErrorForOldClientVersion")&&s.code===Be.UnsupportedMessage?(r.resultSignature="Success",r.resultDescription="Ignore error for ".concat(De.h.getTypeNameFor(e)," message ").concat(e.messageId).concat(gt.typeGuard(e)?", seq ".concat(e.seq):"",": ").concat(s.error)):(r.success=!1,r.resultSignature=s.error,r.resultDescription="Error for ".concat(De.h.getTypeNameFor(e)," message ").concat(e.messageId).concat(gt.typeGuard(e)?", seq ".concat(e.seq):"",": ").concat(s.error)):r.resultSignature="Success",t)try{r.message="We called into done callback",t(s,o)}catch(i){r.success=!1,r.resultSignature="ResponseCallbackException",r.resultDescription="Web"===(null===(n=this.clientMetadata)||void 0===n?void 0:n.appPlatform)?JSON.stringify({message:i.message,stack:i.stack}):JSON.stringify({message:i.message})}a(),this.updateSendMessageStats(r.success,r.durationMs,s?new Error(s.error):void 0)};const s=()=>{l.callback(new Qe({code:Be.RequestTimeout,error:"Timeout waiting for response"}),void 0)};let o=this.config.responseTimeoutMs;if($e.typeGuard(e)){const t=e;o=t.longPollTimeoutHint>=15e3&&t.longPollTimeoutHint<=3e5?t.longPollTimeoutHint+5e3:12e4}else Ve.typeGuard(e)&&(o=null!==(i=e.maxDelayMs)&&void 0!==i?i:12e4);this.pendingResponseCallbacks.put(e.messageId,l,o,s)}this.egress&&this.egress(e,e=>this.onEgressError(e,l),o)}onEgressError(e,t){var s,o;if(e){const n=t.message,i=this.pendingResponseCallbacks.get(t.message.messageId);i?(this.pendingResponseCallbacks.del(n.messageId),i.callback(new Ke({messageId:n.messageId,code:Be.EgressError,error:e.message}))):ot.typeGuard(n)?(t.logOp.success=null!==(o=null===(s=e.message)||void 0===s?void 0:s.endsWith("Client disconnected."))&&void 0!==o&&o,t.logOp.resultSignature="ErrorSendingSessionCloseMessage",t.logOp.resultDescription="Error for ".concat(De.h.getTypeNameFor(n)," message ").concat(n.messageId,": ").concat(e.message),t.logEvent()):(t.logOp.success=!1,t.logOp.resultSignature="ErrorWithoutPendingResponse",t.logOp.resultDescription="Error for ".concat(De.h.getTypeNameFor(n)," message ").concat(n.messageId,": ").concat(e.message),t.logEvent())}}queryEgressCacheSize(){return this.pendingResponseCallbacks.size()}onMessage(e,t,s){this.messageCallbacks.set(e,t),s&&this.messageValidators.set(e,s)}onMessageAsync(e,t,s){this.messageCallbacks.set(e,(e,s)=>Vt(this,void 0,void 0,function*(){try{const o=yield t(e);Ke.typeGuard(o)?s(o,void 0):s(void 0,o)}catch(o){s(o)}})),s&&this.messageValidators.set(e,s)}getStats(){return this.stats}hasMessageCallback(e){return this.messageCallbacks.has(e)}cancelPendingResponseCallbacks(e){this.pendingResponseCallbacks.forEach((t,s)=>{t&&(this.pendingResponseCallbacks.del(s),t.callback(new Ke({messageId:s,code:Be.Cancelled,error:"Cancelled. Reason: ".concat(e)})))})}clearAllPendingResponses(){if(0==this.pendingResponseCallbacks.size())return;const e=new g({operationName:"PurgePendingResponses",resultDescription:this.pendingResponseCallbacks.size().toString(),success:!0});O.info(572836002,Y.CoreDefault,e),this.pendingResponseCallbacks.clear()}processMessage(e,t){const s=new Ce({sessionHealthEventName:"ProcessMessage",source:this.source,reason:ye.Client,impact:this.source===me.ClientRuntime?Te.MissingOutput:Te.MissingInput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv}).start().enableAggregation(),o=()=>{if(s.setClientMetadata(this.clientMetadata),s.success)O.info(572836003,Y.CoreDefault,s.stop());else{const e="UnsupportedMessage"===s.resourceId||"Timeout"===s.resultSignature||"OnResponseInvokedMoreThanOnce"===s.resultSignature||"MessageCallbackException"===s.resultSignature||"We called into messageCallback"!==s.message;s.message=JSON.stringify({errorHappenedOutsideRegisteredMessageCallback:e}),O.error(572836032,Y.CoreDefault,s.stop())}};let n=this.messageCallbacks.get(De.h.getTypeNameFor(e));n?s.resourceId=Kt(De.h.getTypeNameFor(e)):n=(e,t)=>{s.resourceId=Kt(De.h.getTypeNameFor(e)),"MalformedMessageName"!==s.resourceId&&(s.resourceId="UnsupportedMessage"),t(new Ke({messageId:e.messageId,code:Be.UnsupportedMessage,error:"Message type ".concat(De.h.getTypeNameFor(e)," is not supported")}))};const i=(e,t,s)=>!0===jt.getValue()?JSON.stringify({message:e,validationSuccess:null===t||void 0===t?void 0:t.success,validationError:null===t||void 0===t?void 0:t.error,validationDurationMicroseconds:null===t||void 0===t?void 0:t.durationMicroseconds,stack:s}):void 0!==s?JSON.stringify({message:e,stack:s}):e;let r;const a=this.messageValidators.get(De.h.getTypeNameFor(e));if(a&&jt.getValue()){const t=u(),s=a.validate(e),o=u();r={success:s.success,error:s.error,durationMicroseconds:Math.round(o-t)}}let c=!1;const l=(n,a)=>{if(c){s.success=!1,s.resultSignature="OnResponseInvokedMoreThanOnce";const t="Invoked onResponse for ".concat(De.h.getTypeNameFor(e)," message ").concat(e.messageId," more than once");s.resultDescription=i(t,r)}else if(n){s.success=!1,s.resultSignature=n.error,void 0!==n.code&&(s.dimension0=Be[n.code]);const t="Error for ".concat(De.h.getTypeNameFor(e)," message ").concat(e.messageId,": ").concat(n.error);s.resultDescription=i(t,r)}else s.resultSignature="Success",s.resultDescription=i("",r);c=!0,o(),n&&!De.h.matchesTypesFor(n,[Ke.getTypeName()])&&(n=new Ke({error:"Internal Server Error"})),this.updateProcessMessageStats(s.success,s.durationMs,n?new Error(n.error):void 0),n?(n.messageId=e.messageId,t(n)):a?(a.messageId=e.messageId,t(void 0,a)):t()};try{s.message="We called into messageCallback",n(e,l)}catch(h){s.success=!1,s.resultSignature="MessageCallbackException",s.resultDescription=i(h.message,r,h.stack),o(),this.updateProcessMessageStats(!1,s.durationMs,h),t()}}processResponse(e){var t;const s=new g({operationName:"ProcessResponse"});if(s.success=!0,s.setClientMetadata(this.clientMetadata),s.start(),e.messageId){const t=this.pendingResponseCallbacks.get(e.messageId),o=null===t||void 0===t?void 0:t.callback;if(o){if(qe.typeGuard(e)&&!e.finalResponse){const s=t.message.maxDelayMs;this.pendingResponseCallbacks.updateExpireTime(e.messageId,s)}else this.pendingResponseCallbacks.del(e.messageId);De.h.matchesTypesFor(e,[Ke.getTypeName()])?o(e):o(void 0,e)}else s.resultSignature="NoPendingMessage",s.resultDescription="".concat(e.messageId),s.success=!1}else s.resultSignature="NoMessageIdSetInResponse",Ke.typeGuard(e)?s.resultDescription=e.error:s.resultDescription="MessageId is not available",s.success=!1;"Production"!==(null===(t=this.clientMetadata)||void 0===t?void 0:t.releaseAudienceGroup)&&(s.resourceId=Kt(De.h.getTypeNameFor(e)),O.info(572836034,Y.CoreDefault,s.stop()))}updateSendMessageStats(e,t,s){this.stats.sendMessageCount++,this.stats.sendMessageDurationMsMax=Math.max(t,this.stats.sendMessageDurationMsMax),e||s?e&&s&&O.warn(572836036,Y.CoreDefault,"Succeeded send message provided error object."):O.warn(572836035,Y.CoreDefault,"Failed send message did not provide error object."),e||(s&&s.message===zt.ClientDisconnected?this.stats.sendMessageClientDisconnectedErrors++:this.stats.sendMessageErrors++)}updateProcessMessageStats(e,t,s){this.stats.processMessageCount++,this.stats.processMessageDurationMsMax=Math.max(t,this.stats.processMessageDurationMsMax),e||s?e&&s&&O.warn(572836038,Y.CoreDefault,"Succeeded process message provided error object."):O.warn(572836037,Y.CoreDefault,"Failed process message did not provide error object."),e||(s&&s.message===Jt.ProvisionTokenValidationError?this.stats.processMessageProvisionTokenErrors++:this.stats.processMessageErrors++)}}var Yt,Xt=s(17283);!function(e){e[e.Undefined=0]="Undefined",e[e.Schema=1]="Schema",e[e.Boolean=2]="Boolean",e[e.Number=3]="Number",e[e.String=4]="String",e[e.Buffer=5]="Buffer",e[e.Function=6]="Function"}(Yt||(Yt={}));class Zt{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){De.h.assign(Zt,this,e)}static getTypeName(){return"AugLoop_Core_Annotation"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[Zt.getTypeName()])}}Zt.H_={T_:Zt.getTypeName(),B_:Zt.getBaseTypes()};class $t{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){De.h.assign($t,this,e)}static getTypeName(){return"AugLoop_Core_BinaryClassificationAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[$t.getTypeName()])}}$t.H_={T_:$t.getTypeName(),B_:$t.getBaseTypes()};class es{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){De.h.assign(es,this,e)}static getTypeName(){return"AugLoop_Core_StreamAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[es.getTypeName()])}}es.H_={T_:es.getTypeName(),B_:es.getBaseTypes()};class ts{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){De.h.assign(ts,this,e)}static getTypeName(){return"AugLoop_Core_ExecutionCorrelatedAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ts.getTypeName()])}}ts.H_={T_:ts.getTypeName(),B_:ts.getBaseTypes()};class ss{constructor(e){De.h.assign(ss,this,e)}static getTypeName(){return"AugLoop_Signals_Signal"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[ss.getTypeName()])}}ss.H_={T_:ss.getTypeName(),B_:ss.getBaseTypes()};class os{constructor(e){De.h.assign(os,this,e)}static getTypeName(){return"AugLoop_Core_DirtyAreaSignal"}static getBaseTypes(){return["AugLoop_Signals_Signal"]}static typeGuard(e){return De.h.matchesTypesFor(e,[os.getTypeName()])}}os.H_={T_:os.getTypeName(),B_:os.getBaseTypes()};class ns{constructor(e){De.h.assign(ns,this,e)}static getTypeName(){return"AugLoop_Core_DirtyDocumentSignal"}static getBaseTypes(){return["AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ns.getTypeName()])}}ns.H_={T_:ns.getTypeName(),B_:ns.getBaseTypes()};class is{constructor(e){De.h.assign(is,this,e)}static getTypeName(){return"AugLoop_Core_ItemDelta"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[is.getTypeName()])}}is.H_={T_:is.getTypeName(),B_:is.getBaseTypes()};class rs{constructor(e){De.h.assign(rs,this,e)}static getTypeName(){return"AugLoop_Core_ItemChangesDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(e){return De.h.matchesTypesFor(e,[rs.getTypeName()])}}rs.H_={T_:rs.getTypeName(),B_:rs.getBaseTypes()};class as{constructor(e){De.h.assign(as,this,e)}static getTypeName(){return"AugLoop_Core_Operation"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[as.getTypeName()])}}as.H_={T_:as.getTypeName(),B_:as.getBaseTypes()};class cs{constructor(e){De.h.assign(cs,this,e)}static getTypeName(){return"AugLoop_Core_OperationWithSiblingContext"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[cs.getTypeName()])}}cs.H_={T_:cs.getTypeName(),B_:cs.getBaseTypes()};class ls{constructor(e){De.h.assign(ls,this,e)}static getTypeName(){return"AugLoop_Core_AddOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ls.getTypeName()])}}ls.H_={T_:ls.getTypeName(),B_:ls.getBaseTypes()};class us{constructor(e){De.h.assign(us,this,e)}static getTypeName(){return"AugLoop_Core_MoveOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[us.getTypeName()])}}us.H_={T_:us.getTypeName(),B_:us.getBaseTypes()};class hs{constructor(e){De.h.assign(hs,this,e)}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[hs.getTypeName()])}}hs.H_={T_:hs.getTypeName(),B_:hs.getBaseTypes()};class ps{constructor(e){De.h.assign(ps,this,e)}static getTypeName(){return"AugLoop_Core_UpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ps.getTypeName()])}}ps.H_={T_:ps.getTypeName(),B_:ps.getBaseTypes()};class ds{constructor(e){De.h.assign(ds,this,e)}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ds.getTypeName()])}}ds.H_={T_:ds.getTypeName(),B_:ds.getBaseTypes()};class gs{constructor(e){De.h.assign(gs,this,e)}static getTypeName(){return"AugLoop_Core_PurgeOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[gs.getTypeName()])}}gs.H_={T_:gs.getTypeName(),B_:gs.getBaseTypes()};class fs{constructor(e){De.h.assign(fs,this,e)}static getTypeName(){return"AugLoop_Core_PurgeSubtreeExceptTypesOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[fs.getTypeName()])}}fs.H_={T_:fs.getTypeName(),B_:fs.getBaseTypes()};class ms{constructor(e){De.h.assign(ms,this,e)}static getTypeName(){return"AugLoop_Core_PurgeByTypesOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ms.getTypeName()])}}ms.H_={T_:ms.getTypeName(),B_:ms.getBaseTypes()};class ys{constructor(e){De.h.assign(ys,this,e)}static getTypeName(){return"AugLoop_Core_FocusOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ys.getTypeName()])}}ys.H_={T_:ys.getTypeName(),B_:ys.getBaseTypes()};class Ts{constructor(e){De.h.assign(Ts,this,e)}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ts.getTypeName()])}}Ts.H_={T_:Ts.getTypeName(),B_:Ts.getBaseTypes()};class vs{constructor(e){De.h.assign(vs,this,e)}static getTypeName(){return"AugLoop_Core_DeltaUpdateOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[vs.getTypeName()])}}vs.H_={T_:vs.getTypeName(),B_:vs.getBaseTypes()};class ws{constructor(e){De.h.assign(ws,this,e)}static getTypeName(){return"AugLoop_Core_MicroSyncOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ws.getTypeName()])}}ws.H_={T_:ws.getTypeName(),B_:ws.getBaseTypes()};class Cs{constructor(e){De.h.assign(Cs,this,e)}static getTypeName(){return"AugLoop_Signals_SignalOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Cs.getTypeName()])}}Cs.H_={T_:Cs.getTypeName(),B_:Cs.getBaseTypes()};class Ss{constructor(e){De.h.assign(Ss,this,e)}static getTypeName(){return"AugLoop_Core_CancelSignalTriggeredWorkflowExecutionOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ss.getTypeName()])}}Ss.H_={T_:Ss.getTypeName(),B_:Ss.getBaseTypes()};class ks{static createHealthCheckRequest(e){return{payload:{},payloadSchema:{category:Yt.Schema,schema:{name:"HealthCheckRequest"}},requestedSchema:{category:Yt.Schema,schema:{name:"HealthCheckResponse"}},clientMetadata:e}}static isFeatureEnabled(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"None";return e&&e.isFeatureEnabled?e.isFeatureEnabled("Microsoft.Office.AugLoop."+t,o).catch(()=>Promise.resolve(s)):Promise.resolve(s)}static isChangeGateEnabled(e,t){return e&&e.isChangeGateEnabled?e.isChangeGateEnabled(t):Promise.resolve(!1)}static convertWebSocketUrlToHttp(e){return this.convertUrl(e,!1)}static convertServiceUrlToWebSocket(e){return this.convertUrl(e,!0)}static convertUrl(e,t){if(!e)return e;const s=e.split(":");let o=s[0].toLowerCase();return 0==o.indexOf(t?"http":"ws")?(o=t?o.replace("http","ws"):o.replace("ws","http"),s[0]=o,s.join(":")):e}static deepEquals(e,t){return Ae()(e,t)}static collectTelemetry(e,t,s,o,n,i){var r,a,c,l;e.start(),e.resultSignature=null!==o&&void 0!==o?o:"",e.resultDescription=null!==n&&void 0!==n?n:"",e.success=s,i?(e.dimension0=null!==(r=i[0])&&void 0!==r?r:"",e.dimension1=null!==(a=i[1])&&void 0!==a?a:"",e.dimension2=null!==(c=i[2])&&void 0!==c?c:"",e.dimension3=null!==(l=i[3])&&void 0!==l?l:""):(e.dimension0="",e.dimension1="",e.dimension2="",e.dimension3=""),t.log(()=>O.info(508367457,Y.CoreDefault,e.stop()))}}ks.getCurrentTimeMs=()=>Date.now?Date.now():(new Date).getTime();class bs{constructor(e){this.maxNumberOfLogs=40,this.numberOfLogs=0,this.id=e}log(e){if(this.numberOfLogs<this.maxNumberOfLogs&&(this.numberOfLogs++,e(),this.numberOfLogs===this.maxNumberOfLogs)){const e=new g({operationName:"OnLastLog",success:!0,resourceId:this.id,resultDescription:"Limit for number of logs for id: ".concat(this.id," reached - all next logs will be dropped")});O.warn(572838107,Y.CoreDefault,e)}}}De.h.getTypeName(),Zt.getTypeName(),ss.getTypeName();const As=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Number.isFinite(e)?e:t};var _s,Ms=s(71724),Is=s.n(Ms);!function(e){e.ArrivedBeforeReseeding="Message is dropped from queue since it arrived before reseeding is started",e.DroppedAsOldestInQueue="Message is dropped as oldest in full queue",e.DroppedBecauseClientDisconnected="Message is dropped because client is disconnected from server"}(_s||(_s={}));class Ns{constructor(e){this.logOp=new g({operationName:"MessageQueue",success:!0}),this.queue=new(Is())(1e3),this.callbacks=e}clear(){this.queue.clear()}size(){return this.queue.length}push(e,t,s){this.logOp.start();const o=this.queue;if(1e3===o.length){this.logOp.resourceId="QueueFull",this.logOp.success=!1,O.warn(508843746,Y.CoreDefault,this.logOp.stop());const e=o.shift();e.onResponse&&e.onResponse(new Ke({error:_s.DroppedAsOldestInQueue}))}o.push({message:e,onResponse:t,timeQueued:ks.getCurrentTimeMs(),attemptNumber:s})}sendOnSessionInitialized(e){this.logOp.start();const t=this.queue.length;let s=0;if(t>0){const o=ks.getCurrentTimeMs()-this.queue.get(0).timeQueued;for(;this.queue.length>0&&this.callbacks.canSendMessage();){const t=this.queue.shift();e&&this.containSequencedSyncMessage(t)?(s++,t.onResponse&&t.onResponse(new Ke({error:_s.ArrivedBeforeReseeding}))):t.message instanceof Uint8Array?this.callbacks.sendBytes(t.message):this.callbacks.sendMessage(t.message,t.onResponse,t.attemptNumber)}this.logOp.resourceId="SendOnSessionInitialized",this.logOp.resultDescription="Queue size before: ".concat(t,", after: ").concat(this.queue.length,". droppedSyncMessages: ").concat(s),this.logOp.setDataField("OldestMessageInQueueTimeWaitingMs",o),this.logOp.success=!0,O.warn(508843745,Y.CoreDefault,this.logOp.stop())}}containSequencedSyncMessage(e){return e.message instanceof gt&&De.h.matchesTypesFor(e.message,[gt.getTypeName()])&&e.message.seq>=0||e.message instanceof dt&&De.h.matchesTypesFor(e.message,[dt.getTypeName()])}}var Ps;!function(e){e[e.Initing=0]="Initing",e[e.Running=1]="Running",e[e.Disconnected=2]="Disconnected",e[e.Closed=3]="Closed"}(Ps||(Ps={}));const Es=(e,t,s,o)=>{t&&(t.cv||(t.cv=e.cvParent.newChild().toString()),e.messageEndpoint.sendMessage(t,(t,o)=>{t||De.h.getTypeNameFor(o)!==mt.getTypeName()||(e.stats.lastSyncMessage=Date.now()),s&&s(t,o)},void 0,o))},xs=(e,t,s,o)=>{t&&(e.messageQueue.push(t,s,o),e.networkWorkerManager.init(void 0,e.customInitPromise).catch(e=>{const t=new g({operationName:"WorkerManagerInit",success:!1,resultDescription:"".concat(e)});O.error(508843789,Y.CoreDefault,t)}))},Ds=(e,t)=>{t&&(e.messageQueue.push(t),e.networkWorkerManager.init(void 0,e.customInitPromise).catch(e=>{O.error(508843788,Y.CoreDefault,"Init failed: ".concat(e))}))};class Os{constructor(e){this.context=e}onEnter(e){}sendMessage(e,t,s,o){}sendBytes(e){}canSendMessage(){return!1}onConnectionClose(){}}class Rs extends Os{constructor(){super(...arguments),this.stateName=Ps.Initing,this.possibleNextStates=[Ps.Running,Ps.Disconnected,Ps.Closed]}sendMessage(e,t,s){De.h.matchesTypesFor(e,[Xe.getTypeName()])?Es(this.context,e,t,s):xs(this.context,e,t)}sendBytes(e){Ds(this.context,e)}onConnectionClose(){this.context.setState(Ps.Disconnected)}}class Bs extends Os{constructor(){super(...arguments),this.stateName=Ps.Running,this.possibleNextStates=[Ps.Disconnected,Ps.Closed]}onEnter(e){e&&e.isSessionReseedingStarted&&this.context.resetNextSyncSequenceId(),this.context.messageQueue.sendOnSessionInitialized(e&&e.isSessionReseedingStarted)}sendMessage(e,t,s,o){Es(this.context,e,t,s)}sendBytes(e){e&&this.context.networkWorkerManager.egressBytes(e)}canSendMessage(){return!0}onConnectionClose(){this.context.setState(Ps.Disconnected)}}class Ls extends Os{constructor(){super(...arguments),this.stateName=Ps.Disconnected,this.possibleNextStates=[Ps.Initing,Ps.Closed]}onEnter(e){this.context.messageEndpoint.cancelPendingResponseCallbacks(zt.ClientDisconnected)}sendMessage(e,t,s,o){if(De.h.matchesTypesFor(e,[Xe.getTypeName()]))this.context.setState(Ps.Initing),Es(this.context,e,t,s);else if(De.h.matchesTypesFor(e,[ot.getTypeName()]))this.context.setState(Ps.Closed);else{if(!o)return void xs(this.context,e,t,s);t&&t(new Ke({messageId:e.messageId,error:_s.DroppedBecauseClientDisconnected}))}}sendBytes(e){Ds(this.context,e)}}class Ws extends Os{constructor(){super(...arguments),this.stateName=Ps.Closed,this.possibleNextStates=[]}onEnter(e){this.context.messageEndpoint.cancelPendingResponseCallbacks(zt.ClientClosed)}}const{AugLoopTextEncoder:Fs,AugLoopTextDecoder:Gs}=(()=>{if("undefined"===typeof TextEncoder||"undefined"===typeof TextDecoder){s(78299);const e={AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder};return TextEncoder=void 0,TextDecoder=void 0,e}return{AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder}})();var Us=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};class Hs{static extractFragments(e){if(e[0]!==Hs.IDENTIFIERBYTE)throw new Error("Invalid Binary: Incorrect Identifier");let t=1;const s=[],o=new DataView(e.buffer,e.byteOffset,e.byteLength);for(;t<e.byteLength;){if(t+4>e.byteLength)throw new Error("Invalid Binary: Error reading fragment length");const n=o.getUint32(t);if(t+n+4>e.byteLength)throw new Error("Invalid Binary: Fragment out of range");"undefined"!==typeof Buffer&&Buffer.from?s.push(Buffer.from(e.buffer,e.byteOffset+t+4,n)):s.push(new Uint8Array(e.buffer,e.byteOffset+t+4,n)),t+=4+n}if(s.length<1)throw new Error("Invalid Binary: No fragments found");return s}static deserialize(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>e;const s=Hs.extractFragments(e),o=Hs.textDecoder.decode(s[0]);return JSON.parse(o,(e,o)=>{if("string"===typeof o){if(o.substring(0,Hs.BINARYKEYWORD.length)===Hs.BINARYKEYWORD){const e=parseInt(o.substring(Hs.BINARYKEYWORD.length),10);if("number"!==typeof e||e>=s.length-1)throw new Error("Invalid Binary: Binary index out of range");return t(s[e+1])}if(o.substring(0,Hs.ESCAPEKEYWORD.length)===Hs.ESCAPEKEYWORD)return o.substring(Hs.ESCAPEKEYWORD.length)}return o})}static deserializeAsync(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>Us(this,void 0,void 0,function*(){return e});return Us(this,void 0,void 0,function*(){const s=Hs.extractFragments(e),o=Hs.textDecoder.decode(s[0]),n=[],i=Symbol("placeholder"),r=e=>{if(Array.isArray(e)){for(let t=0;t<e.length;t++)e[t]=r(e[t]);return e}if(null!==e&&"object"===typeof e){if(e[i])return e.value;for(const t of Object.keys(e))e[t]=r(e[t]);return e}return e};let a=JSON.parse(o,(e,o)=>{if("string"===typeof o){if(o.startsWith(Hs.BINARYKEYWORD)){const e=parseInt(o.substring(Hs.BINARYKEYWORD.length),10);if("number"!==typeof e||e>=s.length-1)throw new Error("Invalid Binary: Binary index out of range");const r=t(s[e+1]);return n.push(r),(e=>{const t={[i]:!0,value:void 0};return e.then(e=>{t.value=e}),t})(r)}if(o.startsWith(Hs.ESCAPEKEYWORD))return o.substring(Hs.ESCAPEKEYWORD.length)}return o});return yield Promise.all(n),a=yield r(a),a})}static serializeInternal(e){const t=[void 0],s=JSON.stringify(e,(e,s)=>ArrayBuffer.isView(s)?(t.push(s),"".concat(Hs.BINARYKEYWORD).concat(t.length-2)):s&&"Buffer"===s.type&&Array.isArray(s.data)?(t.push(new Uint8Array(s.data)),"".concat(Hs.BINARYKEYWORD).concat(t.length-2)):"string"===typeof s&&s.substring(0,Hs.ESCAPEKEYWORD.length)===Hs.ESCAPEKEYWORD?Hs.ESCAPEKEYWORD+s:s);t[0]=Hs.textEncoder.encode(s);const o=t.reduce((e,t)=>e+4+t.byteLength,0),n=new Uint8Array(o+1);n[0]=Hs.IDENTIFIERBYTE;let i=1;const r=new DataView(n.buffer,n.byteOffset,n.byteLength);for(const a of t)r.setUint32(i,a.byteLength),n.set(a,i+4),i+=4+a.byteLength;return n}static serialize(e){return Hs.serializeInternal(e)}static serializeAsync(e){return Us(this,void 0,void 0,function*(){return new Promise((t,s)=>{try{t(Hs.serializeInternal(e))}catch(o){s(o)}})})}}Hs.IDENTIFIERBYTE=3,Hs.BINARYKEYWORD=":b",Hs.ESCAPEKEYWORD=":",Hs.textDecoder=new Gs,Hs.textEncoder=new Fs;var qs=s(99038);const Vs="Request timed out";function js(e,t,s){const o=new qs.Request(e,t);return zs.add(o,s)}const zs=new class{constructor(e,t,s){if(this.requestInProgress=!1,this.queuedRequests=[],null==e)throw new Error("No request.");this.fetch=e,this.fetchTimeout=t,this.queueTimeout=s}tryProcessNextRequest(){if(this.requestInProgress=!1,this.queuedRequests.length>0){const[e,t,s]=this.queuedRequests.shift();clearTimeout(s),this.add(e,t)}}add(e,t){if(this.requestInProgress){const s=setTimeout(()=>{t(new Error("Timed out waiting in queue"),null),this.queuedRequests.shift()},this.queueTimeout);this.queuedRequests.push([e,t,s])}else{this.requestInProgress=!0;new Promise((t,s)=>{let o=!1;const n=setTimeout(()=>{o=!0,s(new Error("Fetch timed out"))},this.fetchTimeout);this.fetch(e).then(e=>{o||(clearTimeout(n),t(e))}).catch(e=>{o||(clearTimeout(n),s(e))})}).then(e=>{t(null,e),this.tryProcessNextRequest()}).catch(e=>{t(e,null),this.tryProcessNextRequest()})}}}(qs.fetch,2e4,12e4);class Js{constructor(e){De.h.assign(Js,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowRegistrationMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Js.getTypeName()])}}Js.H_={T_:Js.getTypeName(),B_:Js.getBaseTypes()};class Ks{constructor(e){De.h.assign(Ks,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ks.getTypeName()])}}Ks.H_={T_:Ks.getTypeName(),B_:Ks.getBaseTypes()};class Qs{constructor(e){De.h.assign(Qs,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowCancellationRequest"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Qs.getTypeName()])}}Qs.H_={T_:Qs.getTypeName(),B_:Qs.getBaseTypes()};class Ys{constructor(e){De.h.assign(Ys,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_WorkflowExecutionResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ys.getTypeName()])}}Ys.H_={T_:Ys.getTypeName(),B_:Ys.getBaseTypes()};class Xs{constructor(e){De.h.assign(Xs,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_RuntimeInitMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Xs.getTypeName()])}}Xs.H_={T_:Xs.getTypeName(),B_:Xs.getBaseTypes()};class Zs{constructor(e){De.h.assign(Zs,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_DiagnosticTraceMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Zs.getTypeName()])}}Zs.H_={T_:Zs.getTypeName(),B_:Zs.getBaseTypes()};class $s{constructor(e){De.h.assign($s,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[$s.getTypeName()])}}$s.H_={T_:$s.getTypeName(),B_:$s.getBaseTypes()};class eo{constructor(e){De.h.assign(eo,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_TelemetryFlushMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[eo.getTypeName()])}}eo.H_={T_:eo.getTypeName(),B_:eo.getBaseTypes()};class to{constructor(e){De.h.assign(to,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_SessionCloseResponse"}static getBaseTypes(){return["AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[to.getTypeName()])}}to.H_={T_:to.getTypeName(),B_:to.getBaseTypes()};class so{constructor(e){De.h.assign(so,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_WorkflowDefinitionOverrideMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[so.getTypeName()])}}so.H_={T_:so.getTypeName(),B_:so.getBaseTypes()};class oo{constructor(e){De.h.assign(oo,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsRequestMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_StreamingRequest","AugLoop_Session_Protocol_Message"]}static typeGuard(e){return De.h.matchesTypesFor(e,[oo.getTypeName()])}}oo.H_={T_:oo.getTypeName(),B_:oo.getBaseTypes()};class no{constructor(e){De.h.assign(no,this,e)}static getTypeName(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsResponseMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_StreamingResponse","AugLoop_Session_Protocol_Response"]}static typeGuard(e){return De.h.matchesTypesFor(e,[no.getTypeName()])}}no.H_={T_:no.getTypeName(),B_:no.getBaseTypes()};const io=3e4;class ro{constructor(e,t,s,o){this.lastPingTime=0,this.lastPongTime=0,this.lastEgressTime=0,this.remainingPingFailures=3,this.isPingPongSuccessful=!1,this.reducedPingPongRetryEnabled=o,this.pingPongLogOp=new g({operationName:"WebSocketReliabilityManager",success:!0,resourceId:this.reducedPingPongRetryEnabled?"reducedPingPongRetryEnabled":""}).start(),this.pingPongLogOp.setClientMetadata(s,!0),this.worker=e,this.rateControllerClose=t}start(){this.reducedPingPongRetryEnabled?(this.pingPongLogOp.start(),this.pingPongLogOp.resultSignature="initial ping"):this.logOperation(!0,"ping","initial ping"),this.ping(),this.isPingPongSuccessful=!0,this.startInterval()}onResponse(){this.lastPongTime=Date.now(),this.reducedPingPongRetryEnabled&&(this.pingPongLogOp.success=!0,O.info(506795283,Y.CoreDefault,this.pingPongLogOp.stop()))}isReliabilityResponse(e){return"string"===typeof e&&1===e.length&&e===ro.pingPongMessage}close(){this.reducedPingPongRetryEnabled?(this.pingPongLogOp.start(),this.pingPongLogOp.success=!0,this.pingPongLogOp.resultSignature="close",O.info(506795282,Y.CoreDefault,this.pingPongLogOp.stop())):this.logOperation(!0,"ping","close"),this.lastPingTime=0,this.lastPongTime=0,this.isPingPongSuccessful=!1,this.clearPingInterval(),this.worker=void 0}checkConnection(){return this.isPingPongSuccessful}postEgress(){this.lastEgressTime=Date.now()}needsParsedResponses(){return!1}ping(){this.reducedPingPongRetryEnabled?this.worker||(this.pingPongLogOp.success=!1,this.pingPongLogOp.resultDescription="websocket worker undefined",this.rateControllerClose(),O.info(506795281,Y.CoreDefault,this.pingPongLogOp.stop())):this.lastPingTime=Date.now(),this.worker&&(this.reducedPingPongRetryEnabled&&(this.lastPingTime=Date.now()),this.worker.egress({obj:ro.pingPongMessage}))}startInterval(){this.pingInterval=setInterval(()=>{if(this.reducedPingPongRetryEnabled){if(this.lastPongTime<this.lastPingTime&&Date.now()-this.lastPingTime<io)return;this.isPingPongSuccessful=this.lastPongTime>=this.lastPingTime,this.pingPongLogOp.start(),this.isPingPongSuccessful?(this.pingPongLogOp.resultSignature="ping",this.ping()):(this.pingPongLogOp.success=!1,this.pingPongLogOp.resultDescription="Pong not received",O.info(506795280,Y.CoreDefault,this.pingPongLogOp.stop()),this.worker?this.worker.close():this.rateControllerClose())}else{if(this.isPingPongSuccessful=this.lastPongTime>=this.lastPingTime&&this.lastPongTime-this.lastPingTime<=io,this.lastPongTime>this.lastEgressTime)return;const e=this.lastPongTime-this.lastPingTime;this.isPingPongSuccessful?(this.remainingPingFailures=3,this.ping()):this.remainingPingFailures>0?(--this.remainingPingFailures,this.ping()):(this.logOperation(!1,"ping","Pong still not received after all retry attempts",["".concat(e),"".concat(this.remainingPingFailures)]),this.worker?this.worker.close():this.rateControllerClose())}},io)}clearPingInterval(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0)}logOperation(e,t,s,o){var n,i,r,a;this.pingPongLogOp.start(),this.pingPongLogOp.success=e,this.pingPongLogOp.resultSignature=t,this.pingPongLogOp.resultDescription=s,o&&(this.pingPongLogOp.dimension0=null!==(n=o[0])&&void 0!==n?n:"",this.pingPongLogOp.dimension1=null!==(i=o[1])&&void 0!==i?i:"",this.pingPongLogOp.dimension2=null!==(r=o[2])&&void 0!==r?r:"",this.pingPongLogOp.dimension3=null!==(a=o[3])&&void 0!==a?a:""),O.info(507320073,Y.CoreDefault,this.pingPongLogOp.stop())}}ro.pingPongMessage="~";const ao="Request timed out";class co{constructor(e,t,s){this.remainingRetryAttempts=4,this.isAsleep=!1,this.isLongPollSuccessful=!1,this.isActiveLongPoll=!1,this.isResponseReceived=!1,this.lastEgressTime=0,this.longPollLogOp=new g({operationName:"OnLongPollMessage",success:!0}),this.clientMetadata=t,this.sessionCorrelationVector=s,this.longPollLogOp.setClientMetadata(this.clientMetadata,!0),this.worker=e}start(){const e=new g({operationName:"StartHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),O.info(508163399,Y.CoreDefault,e.stop()),this.trySendLongPoll(Le.Start,!0),this.isLongPollSuccessful=!0}onResponse(e){if(!e||this.isResponseReceived){const e=new g({operationName:"HttpReliabilityManagerFailure",success:!1}).start();return e.setClientMetadata(this.clientMetadata,!0),void O.info(508162497,Y.CoreDefault,e.stop())}this.isResponseReceived=!0,this.isActiveLongPoll=!1;const t=e;if(t.error)if(this.isLongPollSuccessful=!1,--this.remainingRetryAttempts,this.remainingRetryAttempts>0){this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription="Retry attempts left : ".concat(this.remainingRetryAttempts),this.longPollLogOp.resultSignature=t.error,O.info(508163398,Y.CoreDefault,this.longPollLogOp.stop());const e=t.error===ao?Le.TimeoutResend:Le.FailResend;t.error===ao||3===this.remainingRetryAttempts?this.trySendLongPoll(e,!0):this.enqueueSendLongPoll(e)}else this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription="Long poll still not received after all retry attempts",O.info(508163397,Y.CoreDefault,this.longPollLogOp.stop()),this.worker&&this.worker.close();else this.longPollLogOp.success=!0,this.longPollLogOp.resultDescription="Long poll received",O.info(508163401,Y.CoreDefault,this.longPollLogOp.stop()),this.remainingRetryAttempts=4,this.isLongPollSuccessful=!0,this.trySendLongPoll(Le.Regular)}close(){const e=new g({operationName:"CloseHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),O.info(508162467,Y.CoreDefault,e.stop()),this.sendLongPollTimer&&(clearTimeout(this.sendLongPollTimer),this.sendLongPollTimer=void 0),this.isActiveLongPoll=!1,this.isLongPollSuccessful=!1,this.worker=void 0}checkConnection(){if(this.isAsleep){this.isAsleep=!1;const e=new g({operationName:"AwakenHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),O.info(508162496,Y.CoreDefault,e.stop()),this.trySendLongPoll(Le.CheckConnection,!0)}return this.isLongPollSuccessful}isReliabilityResponse(e){return"string"!==typeof e&&et.typeGuard(e)}postEgress(){this.lastEgressTime=Date.now(),this.trySendLongPoll(Le.PostEgress)}needsParsedResponses(){return!0}enqueueSendLongPoll(e){this.sendLongPollTimer=setTimeout(()=>{this.trySendLongPoll(e,!0)},2e4)}trySendLongPoll(e,t){if(!this.worker){const e=new g({operationName:"LongPollNoOp",success:!0}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Worker is undefined",void O.info(507281438,Y.CoreDefault,e.stop())}if(!0===this.isActiveLongPoll){const e=new g({operationName:"LongPollNoOp",success:!0}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Already active long poll",void O.info(508163396,Y.CoreDefault,e.stop())}if(this.isActiveLongPoll=!0,Date.now()-this.lastEgressTime>6e4&&!t){this.isActiveLongPoll=!1,this.isAsleep=!0;const e=new g({operationName:"LongPollSleep",success:!0}).start();return e.setClientMetadata(this.clientMetadata),e.resultDescription="isAsleep: ".concat(this.isAsleep,", isActiveLongPoll: ").concat(this.isActiveLongPoll),void O.info(507278739,Y.CoreDefault,e.stop())}this.longPollLogOp.start(),this.isResponseReceived=!1,this.worker.egress({obj:this.getLongPollMessageString(e),isHttpSessionLongPollMessage:!0,isHttpSessionInitMessage:!1})}getLongPollMessageString(e){const t=new $e({longPollTimeoutHint:15e3,type:e});return this.sessionCorrelationVector&&(t.cv=this.sessionCorrelationVector().newChild().toString()),JSON.stringify(t)}}const lo=JSON.stringify(new et({error:Vs}));class uo{constructor(e){this.networkOverrideOptions=e,this.isClosed=!1,this.pendingEgress=[]}init(e,t,s,o){const n=new g({operationName:"HttpWorkerInit",success:!0}).start(),i=e.split("/?x-origin=");2===i.length?(this.url=ks.convertWebSocketUrlToHttp(i[0]),this.origin=i[1]):(this.url=ks.convertWebSocketUrlToHttp(e),this.origin=void 0),this.ingress=t,this.onOpen=s,this.onClose=o,O.info(507839180,Y.CoreDefault,n.stop())}egress(e){const t=new g({operationName:"HttpEgress",success:!0}).start();if(!this.isConnectedToSession()&&!e.isHttpSessionInitMessage)return this.pendingEgress.push(e),t.success=!1,t.resultDescription="NotConnected, pendingQueueSize:  "+this.pendingEgress.length.toString(),void O.info(508163394,Y.CoreDefault,t.stop());const s=this.getRequestInfo(e,t);if(!s.url)return t.success=!1,t.resultDescription="Could not generate HTTP request",void O.error(508163393,Y.CoreDefault,t.stop());e.isHttpSessionLongPollMessage?this.egressLongPoll(s,t):js(s.url,s.request,(e,s)=>{e?this.onEgressError(t,"OnEgressError:"+(null===e||void 0===e?void 0:e.message)):s&&s.ok?s.text().then(e=>{t.success=!0,O.info(508163362,Y.CoreDefault,t.stop()),this.ingressInternal(e)}).catch(e=>{this.onEgressError(t,"OnEgressParseError: "+(null===e||void 0===e?void 0:e.message))}):this.onEgressError(t,"OnEgressResponseError: "+(null===e||void 0===e?void 0:e.message)+", Status ".concat(null===s||void 0===s?void 0:s.status,": ").concat(null===s||void 0===s?void 0:s.statusText))})}close(){const e=new g({operationName:"HttpWorkerClose",success:!0}).start();if(this.isClosed)return e.resultDescription="AlreadyClosed",void O.info(508163360,Y.CoreDefault,e.stop());O.info(508163359,Y.CoreDefault,e.stop()),this.isClosed=!0,this.sessionSettings=void 0,this.onClose&&(this.onClose(void 0),this.onClose=void 0)}onEgressError(e,t){e.success=!1,e.resultDescription=t,O.error(508163358,Y.CoreDefault,e.stop()),this.isClosed||this.close()}ingressInternal(e,t){let s=e;t||(s=this.formatServerInput(e));const o=e=>{Ze.typeGuard(e)&&this.onSessionInitResponse(e)};s&&(this.logIngressCount(s),this.ingress(s,o))}onSessionInitResponse(e){const t=new g({operationName:"HttpWorkerOpen",success:!0}).start();if(!e.sessionKey||!e.origin||!e.anonymousToken||!e.sessionUrlBase)return t.success=!1,t.resultDescription="SessionInitResponse missing information",void O.error(507809949,Y.CoreDefault,t.stop());O.info(508163357,Y.CoreDefault,t.stop()),this.setSessionSettings(e.sessionKey,e.origin,e.anonymousToken,e.sessionUrlBase),this.onOpen(),this.pendingEgress.forEach(e=>{this.egress(e)}),this.pendingEgress=[]}egressLongPoll(e,t){var s,o,n;(s=e.url,o=2e4,n=e.request,new Promise((e,t)=>{const i=setTimeout(()=>{t(new Error(Vs))},o);(0,qs.fetch)(s,n||{}).then(t=>{clearTimeout(i),e(t)}).catch(e=>{clearTimeout(i),t(e)})})).then(e=>{e&&e.ok?e.text().then(e=>{t.success=!0,t.resourceId="LongPoll",O.info(508163355,Y.CoreDefault,t.stop()),this.ingressInternal(e)}).catch(e=>{this.onEgressError(t,"LongPollFetchParseError: "+(null===e||void 0===e?void 0:e.message))}):this.onEgressError(t,"LongPollFetchStatusFailure: "+(null===e||void 0===e?void 0:e.statusText))}).catch(e=>{e.message===Vs?(t.success=!1,t.resultDescription="LongPollFetchResponseTimeout:"+(null===e||void 0===e?void 0:e.message),O.error(508163353,Y.CoreDefault,t.stop()),this.ingressInternal(lo,!0)):this.onEgressError(t,"LongPollFetchResponseError: "+(null===e||void 0===e?void 0:e.message))})}getRequestInfo(e,t){const s=this.getUrl(null===e||void 0===e?void 0:e.isHttpSessionInitMessage),o=this.getHeader(e,t);return t.resultSignature=s,{url:s,request:{method:"POST",headers:o,body:e.obj}}}getUrl(e){const t=this.sessionSettings&&this.sessionSettings.sliceUrl?this.sessionSettings.sliceUrl:this.url;return e?t+"/sessioninit":this.isConnectedToSession()?t+"/session/"+this.sessionSettings.sessionKey:""}getHeader(e,t){var s;const o=new qs.Headers;return(null===e||void 0===e?void 0:e.isHttpSessionInitMessage)?(o.set("Content-Type","application/json"),this.origin&&o.set("x-origin",this.origin)):this.isConnectedToSession()&&(e.obj instanceof Uint8Array||e.obj instanceof ArrayBuffer?(o.set("Content-Type","application/jsond2"),t.dimension0=e.obj.byteLength.toString().length.toString()):o.set("Content-Type","application/json"),o.append("Authorization","Bearer ".concat(this.sessionSettings.anonymousToken)),o.set("x-origin",this.sessionSettings.origin)),(null===(s=this.networkOverrideOptions)||void 0===s?void 0:s.hostHeader)&&o.set("host",this.networkOverrideOptions.hostHeader),o}setSessionSettings(e,t,s,o){const n=o.replace("/session","");this.sessionSettings={sessionKey:e,origin:t,anonymousToken:s,sliceUrl:n}}isConnectedToSession(){return this.sessionSettings&&this.sessionSettings.sessionKey.length>0&&this.sessionSettings.anonymousToken.length>0&&this.sessionSettings.origin.length>0&&this.sessionSettings.sliceUrl.length>0&&!this.isClosed}formatServerInput(e){return e.length>1?e.substring(1,e.length-1):""}logIngressCount(e){const t=e.length;if(t>1e5){const e=new g({operationName:"HttpIngressByteOrderOfMagnitude",success:!0}).start();e.dimension2=t.toString().length.toString(),O.info(508409622,Y.CoreDefault,e.stop())}}}const ho=e=>{var t,s;if(Tt.typeGuard(e)){const s=e.ops.filter(e=>De.h.matchesTypesFor(e,["AugLoop_Core_AddOperation"]));for(const e of s)for(const s of e.items)if(s.body&&(null===(t=s.body)||void 0===t?void 0:t.isFirstUserPerceivedResponse))return!0}else if(no.typeGuard(e))return null===(s=e.content)||void 0===s?void 0:s.some(e=>{var t;return null===(t=e.body)||void 0===t?void 0:t.isFirstUserPerceivedResponse});return!1},po=(e,t,s,o,n)=>{const i=(e=>{const t=e.filter(e=>De.h.matchesTypesFor(e,["AugLoop_Signals_SignalOperation"]));for(const s of t)for(const e of s.items)if(e.body&&De.h.matchesTypesFor(e.body,["AugLoop_CopilotChatHistory_CopilotChatHistorySignal","AugLoop_Copilot_CopilotInputSignal"]))return e})(e);i&&(n.setDataField("CurrentTimestamp",s),n.cv=t||"",n.resultSignature=o,n.resourceId=De.h.getTypeNameFor(i.body),i.contextId&&n.setDataField("ContextId",i.contextId),i.sourceTimestamp&&n.setDataField("SourceTimestamp",i.sourceTimestamp),O.info(505983429,Y.CoreDefault,n.stop()))},go=(e,t,s,o,n)=>{o&&!ho(e)||(n.setDataField("CurrentTimestamp",t),n.cv=e.cv,n.resultSignature=s,n.resourceId=e.annotationType,n.dimension1="AreApologies: ".concat(e.areApologies),O.info(505983428,Y.CoreDefault,n.stop()))};var fo=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};const mo=1e5,yo=3e6,To=1e3;class vo{constructor(e){var t;this.emptyMessageId=0,this.egressMessageCount=0,this.egressByteCount=0,this.prevSeq=-1,this.rpsThreshold=150,this.bpsThreshold=5e8,this.isClosing=!1,this.messageQueue=void 0,this.egressRateLogOp=new g({operationName:"NetworkEgressRate",success:!0}),this.egressedCache=new Map,this.initPromise=new Promise(e=>{this.resolveInitPromise=e}),this.messageQueue=new(Is()),this.reducedPingPongRetryEnabled=null!==(t=null===e||void 0===e?void 0:e.reducedPingPongRetryEnabled)&&void 0!==t&&t}init(e,t,s,o,n){this.worker=e,this.ingress=t,this.clientMetadata=o,this.networkMode=s,this.reliabilityManager=((e,t,s,o,n)=>e instanceof uo?new co(e,s,o):new ro(e,t,s,n))(this.worker,this.close.bind(this),void 0,n,this.reducedPingPongRetryEnabled),this.egressRateLogOp.setClientMetadata(this.clientMetadata,!0),this.resetRateLimiter(),this.onCloseController=new Promise(e=>{this.resolveCloseControllerPromise=e}),this.queueProcessingCompletePromise=new Promise(e=>{this.resolveQueueProcessingCompletePromise=e}),this.resolveInitPromise()}open(){const e=new g({operationName:"NetworkRateControllerOpen",success:!0,dimension3:"networkMode: ".concat(this.networkMode)}).start();e.setClientMetadata(this.clientMetadata,!0),this.initPromise.then(()=>{if(!this.reliabilityManager)return e.success=!1,void(e.resultDescription="Reliability Manager is undefined");this.egressRateControlIntervalStart=Date.now(),this.reliabilityManager.start(),this.processQueue()}).catch(t=>{var s;e.success=!1,e.resultDescription="Catch: "+(null!==(s=null===t||void 0===t?void 0:t.message)&&void 0!==s?s:"")}).finally(()=>{O.info(507834384,Y.CoreDefault,e.stop())})}ingressFromWorker(e,t){this.reliabilityManager?this.reliabilityManager.needsParsedResponses()||!this.reliabilityManager.isReliabilityResponse(e)?this.ingress(e,e=>{null===t||void 0===t||t(e),this.reliabilityManager.needsParsedResponses()&&this.reliabilityManager.isReliabilityResponse(e)&&this.reliabilityManager.onResponse(e)}):this.reliabilityManager.onResponse():this.ingress(e,t)}onRateLimitErrorResponse(e){const t=new g({operationName:"NetworkRateControllerOnRateLimitResponse",success:!0}).start();t.setClientMetadata(this.clientMetadata,!0),t.resultSignature="rateLimitAlreadyStarted: ".concat(void 0!==this.rateLimitTimeout),t.setDataField("RetryAfterMs",e.retryAfterMs),t.setDataField("QueueSize",this.messageQueue.length),this.startRateLimiting(e.retryAfterMs),O.info(507388684,Y.CoreDefault,t.stop())}setRpsBps(e,t){const s=new g({operationName:"NetworkRateControllerRateLimitsSet",success:!0}).start();s.setClientMetadata(this.clientMetadata,!0),e&&(this.rpsThreshold=.8*e,s.resultDescription+="maxRPS: ".concat(e,", rpsThreshold: ").concat(this.rpsThreshold,"; ")),t&&(this.bpsThreshold=.8*t,s.resultDescription+="maxRPS: ".concat(t,", rpsThreshold: ").concat(this.bpsThreshold,"; ")),O.info(507388683,Y.CoreDefault,s.stop())}close(){var e,t;return fo(this,void 0,void 0,function*(){const s=new g({operationName:"NetworkRateControllerClose",success:!0,dimension3:"networkMode: ".concat(this.networkMode)}).start();s.setClientMetadata(this.clientMetadata,!0),this.isClosing=!0,null===(e=this.resolveCloseControllerPromise)||void 0===e||e.call(this);const o=null===(t=this.reliabilityManager)||void 0===t?void 0:t.checkConnection();s.setDataField("QueueSizeBeforeFlush",this.messageQueue.length),0!=this.messageQueue.length&&o&&(yield this.queueProcessingCompletePromise),s.setDataField("QueueSizeAfterFlush",this.messageQueue.length),s.setDataField("IsConnected",o),this.reliabilityManager?this.reliabilityManager.close():s.resultDescription="Reliability Manager is undefined",this.worker=void 0,this.prevSeq=-1,this.clearEgressControlTimeout(),this.reliabilityManager=void 0,O.info(507834381,Y.CoreDefault,s.stop())})}clearMessageQueues(){this.egressedCache.clear(),this.messageQueue=void 0}egress(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;var s,o;if(!this.reliabilityManager)return void this.logEgressActivity(!1,"Reliability Manager is undefined","");const n=this.getMessageSize(e);if(n>=yo)return void this.logEgressActivity(!1,"Message size exceeded ".concat(yo),"Message size: ".concat(n));if((e.obj instanceof ArrayBuffer||e.isHttpSessionInitMessage)&&this.worker)return this.logEgressActivity(!0,"isArrayBuffer: ".concat(e.obj instanceof ArrayBuffer,", isHttpSessionInitMessage: ").concat(e.isHttpSessionInitMessage),""),void this.worker.egress(e);this.validateSyncMessage(e.messageId,e.seqId);const i=null!==(s=e.messageId)&&void 0!==s?s:"id".concat(this.emptyMessageId++),r={obj:e.obj,seqId:null===e||void 0===e?void 0:e.seqId,messageId:i,isHttpSessionInitMessage:null===e||void 0===e?void 0:e.isHttpSessionInitMessage},a=t>0,c=new g({operationName:"NetworkRateControllerQueueItem",success:!0,dimension3:"isRetry: ".concat(a)}).start();c.setClientMetadata(this.clientMetadata,!0);const l={message:r,logOp:c};if(a?this.messageQueue.unshift(l):this.messageQueue.push(l),this.messageQueue.length>1e4){const e=this.messageQueue.shift(),t="NetworkRateControllerQueue max size reached. Dropping messageId: ".concat(e.message.messageId);throw e.logOp.resultDescription=t,e.logOp.success=!1,O.info(506001225,Y.CoreDefault,e.logOp.stop()),new Error(t)}null===(o=this.resolveQueueNotEmptyPromise)||void 0===o||o.call(this)}getMessageSize(e){return e.obj instanceof ArrayBuffer?e.obj.byteLength:e.obj.length}sendToNetworkWorker(e){var t;try{if(!this.worker)return void this.logEgressActivity(!1,"NetworkWorker is undefined","SendToNetworkWorkerFailure");if(!this.reliabilityManager)return void this.logEgressActivity(!1,"Reliability Manager is undefined","SendToNetworkWorkerFailure");this.worker.egress(e),this.onSendToNetworkWorker(e),null===(t=this.reliabilityManager)||void 0===t||t.postEgress();const s=this.getMessageSize(e);this.logEgressCount(s)}catch(s){this.logEgressActivity(!1,"SendToNetworkWorkerFailure",s?s.message:"")}}onSendToNetworkWorker(e){if("string"===typeof e.obj)try{const t=JSON.parse(e.obj);if(gt.typeGuard(t)){((e,t,s,o)=>{po(e.ops,e.cv,t,s,o)})(t,Date.now(),"SendToNetwork",new g({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start())}else if(oo.typeGuard(t)){((e,t,s)=>{var o,n,i,r;s.resultSignature=t,s.resourceId="".concat(null===(o=e.sourceInfo)||void 0===o?void 0:o.featureId,"-").concat(null===(n=e.sourceInfo)||void 0===n?void 0:n.entryPoint),s.cv=e.cv,s.setDataFields({AnnotationTypes:null===(i=e.annotationTypes)||void 0===i?void 0:i.toString(),MaxDelayMs:null===(r=e.maxDelayMs)||void 0===r?void 0:r.toString()}),O.info(505455200,Y.CoreDefault,s.stop())})(t,"GetAnnotationsSendToNetwork",new g({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start())}}catch(t){}}processQueue(){var e,t,s;return fo(this,void 0,void 0,function*(){if(!this.reliabilityManager){const e=new g({operationName:"NetworkRateControllerProcessQueueFailure",success:!1,dimension3:"networkMode: ".concat(this.networkMode)}).start();return e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Reliability Manager is undefined",void O.info(507573643,Y.CoreDefault,e.stop())}const o=new g({operationName:"NetworkRateControllerProcessQueue",success:!0}).start();for(;;){if(0===this.messageQueue.length){if(this.isClosing){o.setDataField("ExitReason","Stage#1 Closing");break}yield Promise.race([this.queueNotEmpty(),this.onCloseController])}if(this.rateLimitTimeout){const e=new g({operationName:"NetworkRateControllerRateLimitBackoff",dimension3:"networkMode: ".concat(this.networkMode)}).start();e.setClientMetadata(this.clientMetadata,!0),e.setDataField("QueueLengthBeforeBackoff",this.messageQueue.length),yield Promise.race([this.rateLimitTimeout,this.onCloseController]),e.setDataField("QueueLengthAfterBackoff",this.messageQueue.length),e.setDataField("IsClosing",this.isClosing),e.success=!0,this.rateLimitTimeout=void 0,this.resetRateLimiter(),O.info(507281410,Y.CoreDefault,e.stop())}if(!(null===(e=this.reliabilityManager)||void 0===e?void 0:e.checkConnection())){if(this.isClosing){o.setDataField("ExitReason","Stage#2 Closing");break}yield this.checkConnectionPromise(),this.connectionPromise=void 0}if(!this.reliabilityManager){o.setDataField("ExitReason","Stage#2 ReliabilityManager null");break}for(;this.messageQueue.length>0&&this.reliabilityManager.checkConnection();){if(Date.now()-this.egressRateControlIntervalStart>=To)this.resetRateLimiter();else if(this.egressMessageCount>=this.rpsThreshold||this.egressByteCount>=this.bpsThreshold){const e=1100;let t="";this.egressMessageCount>=this.rpsThreshold&&(t+="RPS exceeded."),this.egressByteCount>=this.bpsThreshold&&(t+="BPS exceeded.");const s="rateLimitHit",o=new g({operationName:"NetworkRateControllerEgress",dimension3:"networkMode: ".concat(this.networkMode)}).start();o.setClientMetadata(this.clientMetadata,!0),o.success=!0,o.resultDescription=s,o.resultSignature=t,o.dimension0=this.messageQueue.length.toString().length.toString(),o.dimension1="rateLimitHit",o.setDataField("QueueLength",this.messageQueue.length),o.setDataField("RateLimitDelayMs",e),O.info(507281409,Y.CoreDefault,o.stop()),this.startRateLimiting(e);break}const e=this.messageQueue.shift();this.sendToNetworkWorker(e.message),O.info(507388682,Y.CoreDefault,e.logOp.stop())}this.onQueueNotEmpty=void 0,this.resolveQueueNotEmptyPromise=void 0}null===(t=this.resolveQueueProcessingCompletePromise)||void 0===t||t.call(this),this.resolveQueueProcessingCompletePromise=void 0,o.setClientMetadata(this.clientMetadata,!0),o.setDataField("QueueSize",this.messageQueue.length),o.setDataField("IsConnected",null===(s=this.reliabilityManager)||void 0===s?void 0:s.checkConnection()),o.setDataField("IsClosing",this.isClosing),O.info(507368671,Y.CoreDefault,o.stop())})}queueNotEmpty(){return this.onQueueNotEmpty||(this.onQueueNotEmpty=new Promise(e=>{this.resolveQueueNotEmptyPromise=e})),this.onQueueNotEmpty}checkConnectionPromise(){return this.connectionPromise||(this.connectionPromise=new Promise(e=>{setTimeout(e,1e3)})),this.connectionPromise}startRateLimiting(e){this.rateLimitTimeout||(this.rateLimitTimeout=new Promise(t=>{setTimeout(t,e)}))}resetRateLimiter(){this.egressRateControlIntervalStart=Date.now(),this.egressMessageCount=0,this.egressByteCount=0}clearEgressControlTimeout(){this.egressRateControlTimer&&(clearInterval(this.egressRateControlTimer),this.egressRateControlTimer=void 0)}validateSyncMessage(e,t){if(!(void 0===t||void 0===e||t<=this.prevSeq)){if(t&&t!==this.prevSeq+1){const e=new g({operationName:"NetworkRateControllerAbandonedSyncMessage",success:!0,dimension3:"networkMode: ".concat(this.networkMode)}).start();e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Gap in sync message",e.dimension0="".concat(this.prevSeq),e.dimension1="".concat(t),e.dimension2="".concat(t-this.prevSeq),O.info(507834370,Y.CoreDefault,e.stop())}this.prevSeq=t}}logEgressActivity(e,t,s,o){var n,i,r,a;const c=new g({operationName:"NetworkRateControllerEgress",dimension3:"networkMode: ".concat(this.networkMode)}).start();c.setClientMetadata(this.clientMetadata,!0),c.success=e,c.resultDescription=t,c.resultSignature=s,o&&(c.dimension0=null!==(n=o[0])&&void 0!==n?n:"",c.dimension1=null!==(i=o[1])&&void 0!==i?i:"",c.dimension2=null!==(r=o[2])&&void 0!==r?r:"",c.dimension3=null!==(a=o[3])&&void 0!==a?a:""),O.info(507626007,Y.CoreDefault,c.stop())}logEgressCount(e){const t=Date.now();t-this.egressRateControlIntervalStart>To&&((this.egressMessageCount>50||this.egressByteCount>mo)&&(this.egressRateLogOp.start(),this.egressRateLogOp.resultDescription=this.egressMessageCount>50?"rps logging threshold exceeded":"",this.egressRateLogOp.resultDescription=this.egressByteCount>mo?"bps logging threshold exceeded":"",this.egressRateLogOp.dimension0=(t-this.egressRateControlIntervalStart).toString(),this.egressRateLogOp.dimension1="".concat(this.egressMessageCount),this.egressRateLogOp.dimension2="".concat(this.egressByteCount),this.egressRateLogOp.dimension3="networkMode: ".concat(this.networkMode),O.info(508843792,Y.CoreDefault,this.egressRateLogOp.stop())),this.egressRateControlIntervalStart=t,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=null!==e&&void 0!==e?e:0}}var wo,Co;!function(e){e[e.JSWebSockets=0]="JSWebSockets",e[e.LocalWorkflowsOnly=1]="LocalWorkflowsOnly",e[e.HostWebSockets=2]="HostWebSockets",e[e.HttpFallback=3]="HttpFallback"}(wo||(wo={})),function(e){e.Workflow="Workflow",e.Client="Client",e.HttpEndpoint="HttpEndpoint"}(Co||(Co={}));class So{constructor(e,t,s,o,n,i,r,a,c){this.logCountLimiter=new bs(So.className),this.isWorkerReady=!1,this.permanentlyClosed=!1,this.currentReconnectAttempt=0,this.lastInitializationAttemptTimeMs=0,this.offlineInterval=void 0,this.alreadyLoggedReconnectAttempt=!1,this.httpTestsLeft=5,this.httpTestsSuccessCount=0,this.workerOpenCount=0,this.testHttpConnection=e=>{const t=ks.convertWebSocketUrlToHttp(this.globalUrl),s=!e,o=null!==e&&void 0!==e?e:new g({operationName:"HttpsTest",resourceId:ie(t),success:!1,resultDescription:"",resultSignature:"HttpResponse:"}).start();js(t,{method:"POST",headers:{"content-type":"application/json","X-CorrelationId":o.cv},body:JSON.stringify(ks.createHealthCheckRequest(this.clientMetadata))},(e,t)=>{e?(o.dimension1="HttpErr",o.resultDescription+="HttpErr: ".concat(e.message)):t&&t.ok?(o.dimension1="HttpOK",this.leaveOfflineMode(),this.httpTestsSuccessCount++,s&&(o.success=!0)):(o.dimension1="HttpNoResp",o.resultDescription+="HttpStatus: ".concat(null===t||void 0===t?void 0:t.status)),s&&o.stop(),this.logCountLimiter.log(()=>{O.info(508843780,Y.CoreDefault,o)})})},this.globalUrl=e,this.clientMetadata=t,this.workerFactory=s,this.sessionInitializer=o,this.ingress=n,this.onConnectionClose=i,this.sessionCorrelationVector=r,this.reducedPingPongRetryEnabled=a.reducedPingPongRetryEnabled,this.networkWorkerLogOp=new g({operationName:"CreateNetworkWorker",success:!0}),this.networkMode=c||wo.JSWebSockets,this.initNetworkMode=this.networkMode}init(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(this.permanentlyClosed)return Promise.reject(new Error("permanentlyClosed"));if(this.isWorkerReady||this.pendingInitPromise)return this.pendingInitPromise?this.pendingInitPromise:Promise.resolve();this.extensionConfigs=e||this.extensionConfigs;const o=()=>{if(s||!this.alreadyLoggedReconnectAttempt){const e=s?So.initialAttemptTimeout:So.reconnectAttemptTimeout;this.connTimeout=setTimeout(()=>{const t=new g({operationName:"ConnectionFailingOrSlow",dimension0:s?"Initial":"Reconnect",dimension1:e.toString(),dimension2:this.currentReconnectAttempt.toString()});O.info(508843787,Y.CoreDefault,t),this.alreadyLoggedReconnectAttempt=!s,this.connTimeout=void 0},e)}};return t?this.pendingInitPromise=t().catch(e=>{const t=new g({operationName:"WorkerManagerCustomInit",success:!1,resultDescription:"".concat(e)});O.error(508843786,Y.CoreDefault,t)}).then(()=>{o(),this.initInternal()}):(this.pendingInitPromise=Promise.resolve(),o(),this.initInternal()),this.pendingInitPromise}egress(e,t){return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(()=>{this.egressInternal(e,t)}):(this.egressInternal(e,t),Promise.resolve())}egressBytes(e){return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(()=>{this.egressBytesInternal(e)}):(this.egressBytesInternal(e),Promise.resolve())}getNetworkMode(){return this.networkMode}getInitNetworkMode(){return this.initNetworkMode}onRateLimitErrorResponse(e){this.getNetworkRateController().onRateLimitErrorResponse(e)}close(e){this.isWorkerReady=!1,this.networkRateController&&this.getNetworkRateController().close(),this.worker&&(this.worker.close(),this.worker=null),this.networkRateController=null,this.permanentlyClosed=e||this.permanentlyClosed,this.permanentlyClosed&&(this.leaveOfflineMode(),clearTimeout(this.connTimeout))}initInternal(){if(this.isWorkerReady=!1,this.permanentlyClosed||this.isOffline()){const e=new g({operationName:"WorkerManagerInitOffline",success:!0,resultSignature:this.permanentlyClosed?"PermanentlyClosed":"Offline"});return void O.info(508843785,Y.CoreDefault,e)}this.currentReconnectAttempt>0?setTimeout(()=>{this.tryToConnectAndInitializeSession()},((e,t,s)=>{let o=0;const n=ks.getCurrentTimeMs()?ks.getCurrentTimeMs()-t:0,i=[1e3,2e3,5e3,1e4,6e4];return o=i[Math.max(0,Math.min(i.length-1,e-1))],o=Math.max(o-n,1e3),o=s&&s>0?Math.min(5e3,o):o,o})(this.currentReconnectAttempt,this.lastInitializationAttemptTimeMs,this.httpTestsSuccessCount)):this.getNetworkMode()===wo.HttpFallback?setTimeout(()=>{this.tryToConnectAndInitializeSession()},100):this.tryToConnectAndInitializeSession()}egressInternal(e,t){if(!this.isWorkerReady&&!De.h.matchesTypesFor(e,[Xe.getTypeName()]))return void(De.h.matchesTypesFor(e,[He.getTypeName()])||O.error(508843784,Y.CoreDefault,new g({operationName:"UnexpectedEgressCall",resultDescription:"isWorkerReady: ".concat(this.isWorkerReady)})));let s,o;if(De.h.matchesTypesFor(e,[ft.getTypeName()])?(this.castBinaryData(e),s=Hs.serialize(e)):s=JSON.stringify(e),gt.typeGuard(e)&&(o=e.seq),this.bypassRateController(e))return void this.worker.egress({obj:s});const n=Xe.typeGuard(e)&&this.getNetworkMode()===wo.HttpFallback;this.getNetworkRateController().egress({obj:s,isHttpSessionInitMessage:n,messageId:e.messageId,seqId:o},t)}bypassRateController(e){return ot.typeGuard(e)}egressBytesInternal(e){this.isWorkerReady?this.getNetworkRateController().egress({obj:e}):O.error(508843783,Y.CoreDefault,new g({operationName:"UnexpectedEgressBytesCall",resultDescription:"isWorkerReady: ".concat(this.isWorkerReady)}))}tryToConnectAndInitializeSession(){this.currentReconnectAttempt++,this.lastInitializationAttemptTimeMs=ks.getCurrentTimeMs();const e=t=>{if(this.permanentlyClosed||this.isOffline())return;const s=this.sliceUrl?this.sliceUrl:this.globalUrl;t.setDataField("connectionUrl",ie(s)),this.connect(s),this.sessionInitializer.initSession({isTokenRefresh:!1,isReconnectOnSameSlice:!!this.sliceUrl,extensionConfigs:this.extensionConfigs,onResponse:(s,o)=>{if(t.success=!s,t.resourceId=o?ie(o.sliceUrl):"",t.dimension2=this.getNetworkModeLogString(),this.getNetworkMode()===wo.HttpFallback?(t.resultDescription=s?"HTTP Error: ".concat(s.error):"",t.dimension0=t.success?"HTTPOK":"HTTPFail"):(t.resultDescription=s?"WS Error: ".concat(s.error):"",t.dimension0=t.success?"WSOK":"WSFail"),s||!this.worker)return this.sliceUrl=void 0,this.close(),this.httpTestsLeft>0?(this.httpTestsLeft--,this.testHttpConnection(t.stop())):(this.getNetworkMode()===wo.JSWebSockets?0===this.workerOpenCount&&this.httpTestsSuccessCount>=5?(t.dimension1="WSBlocked",t.dimension3="HTTP Fallback",this.networkMode=wo.HttpFallback,this.currentReconnectAttempt=0,this.resetHttpTestsCounter()):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),t.dimension1="WSOffline"):0===this.httpTestsSuccessCount&&(this.startOfflineMode(),t.dimension1="HTTPOffline"),this.logCountLimiter.log(()=>{O.info(508843782,Y.CoreDefault,t.stop())})),void this.initInternal();if(this.logCountLimiter.log(()=>{O.info(508843781,Y.CoreDefault,t.stop())}),o.forceReconnect){this.close();const t=new g({operationName:"ForcedReconnect"}).start();t.resultSignature="globalUrl: ".concat(this.globalUrl,". sliceUrl: ").concat(this.sliceUrl),this.sliceUrl=void 0,setTimeout(()=>{e(t)},1e3)}else clearTimeout(this.connTimeout),this.sliceUrl=o.sliceUrl,this.getNetworkRateController().setRpsBps(o.maxRPS,o.maxBPS),this.ready();this.resetHttpTestsCounter()}})},t=new g({operationName:"TryToConnectAndInitializeSession",resultSignature:"Reconnection attempt #".concat(this.currentReconnectAttempt)}).start();e(t)}getNetworkRateController(){return this.networkRateController||(this.networkRateController=new vo({reducedPingPongRetryEnabled:this.reducedPingPongRetryEnabled})),this.networkRateController}connect(e){const t=this.getNetworkMode();this.networkWorkerLogOp.start(),this.networkWorkerLogOp.resultDescription=this.getNetworkModeLogString(),this.networkWorkerLogOp.dimension0=t.toString(),this.logCountLimiter.log(()=>O.info(508372418,Y.CoreDefault,this.networkWorkerLogOp.stop())),this.worker=this.workerFactory(t),this.worker.init(e,this.getNetworkRateController().ingressFromWorker.bind(this.networkRateController),()=>{this.workerOpenCount++,this.getNetworkRateController().open(),this.leaveOfflineMode()},e=>{this.close(),this.onConnectionClose(e)},this.clientMetadata),this.getNetworkRateController().init(this.worker,this.ingress,t,this.clientMetadata,this.sessionCorrelationVector)}ready(){this.isWorkerReady=!0,this.pendingInitPromise=void 0,this.currentReconnectAttempt=0}castBinaryData(e){if(e){if(Array.isArray(e.__binaryMembers__))for(const t of e.__binaryMembers__)ArrayBuffer.isView(e[t])||(e[t]=new Uint8Array(e[t]));for(const t of Object.keys(e))"object"===typeof e[t]&&null!==e[t]&&this.castBinaryData(e[t])}}isOffline(){return!!this.offlineInterval}startOfflineMode(){this.offlineInterval=setInterval(()=>{this.testHttpConnection()},6e4)}leaveOfflineMode(){this.isOffline()&&(clearInterval(this.offlineInterval),this.offlineInterval=void 0,this.resetHttpTestsCounter(),this.tryToConnectAndInitializeSession())}resetHttpTestsCounter(){this.httpTestsLeft=5,this.httpTestsSuccessCount=0}getNetworkModeLogString(){return"NetworkMode: "+(this.getNetworkMode()===wo.JSWebSockets?"WebSocket":"HTTP")}}So.initialAttemptTimeout=1e5,So.reconnectAttemptTimeout=2e4,So.className="NetworkWorkerManager";class ko extends Xt.EventEmitter{constructor(e,t,s,o,n,i,r,a,c){super(),this.cvParent=new pe,this.logOp=new g({operationName:"SessionState",success:!0}).start(),this.sessionStateChangeLogCountLimiter=new bs("SessionState"),this.logRetryTelemetry=!0,this.isImproveRetriesChangeGateEnabled=!0,this.shouldNotRetryOnSessionClosedError=!0,this.stats=t,this.allStates={[Ps.Initing]:new Rs(this),[Ps.Running]:new Bs(this),[Ps.Disconnected]:new Ls(this),[Ps.Closed]:new Ws(this)},this.setState(Ps.Initing),this.messageEndpoint=new Qt({messageIdPrefix:"c",responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}),this.messageEndpoint.setClientMetadata(n),this.messageEndpoint.setEgress(this.egress.bind(this)),this.messageEndpoint.onMessage(ot.getTypeName(),(e,t)=>{this.onSessionCloseMessage(e,t)}),this.networkWorkerManager=new So(e,n,s,o,this.ingress.bind(this),this.onConnectionClose.bind(this),this.getCorrelationVector.bind(this),r,c),this.messageQueue=new Ns({sendMessage:(e,t,s,o)=>this.state.sendMessage(e,t,s,o),sendBytes:this.sendBytes.bind(this),canSendMessage:()=>this.state.canSendMessage()}),o.on("connect",(e,t,s,o,n,i,r,a)=>{this.setState(Ps.Running,"",{isSessionReseedingStarted:e&&t}),this.emit("connect",e,s,o,n,i,r,a)}),o.on("reconnect",()=>this.emit("reconnect")),o.on("serverAuthenticationStateChange",e=>this.emit("serverAuthenticationStateChange",e)),this.resetNextSyncSequenceId=()=>this.emit("resetNextSyncSequenceId"),this.tokenRefreshManager=i,this.gateUtils=a,this.gateUtils&&(this.gateUtils.isChangeGateEnabled("LogRetryMessageEventV2").then(e=>{this.logRetryTelemetry=e}).catch(()=>{}),this.gateUtils.isChangeGateEnabled("ImproveClientRetries").then(e=>{this.isImproveRetriesChangeGateEnabled=e}).catch(()=>{}),this.gateUtils.isChangeGateEnabled("ShouldNotRetryOnSessionClosedError").then(e=>{this.shouldNotRetryOnSessionClosedError=e}).catch(()=>{}))}setState(e,t,s){if(this.state&&e===this.state.stateName)return;const o=this.state?Ps[this.state.stateName]:"undefined",n=this.state?this.state.possibleNextStates.indexOf(e)>=0:e===Ps.Initing;this.sessionStateChangeLogCountLimiter.log(()=>{this.logOp.stop(),this.logOp.resourceId="New state: ".concat(n?Ps[e]:o),this.logOp.resultDescription="Previous state: ".concat(o),this.logOp.dimension0="Attempted state: ".concat(Ps[e]||"undefined"),this.logOp.resultSignature=t+(this.state&&!n?"Unexpected state change":""),this.logOp.success=n,O.info(508843791,Y.CoreDefault,this.logOp)}),n&&(this.state=this.allStates[e],this.logOp.start(),this.state.onEnter(s))}init(e,t){return this.extensionConfigs=e,this.customInitPromise=t,this.networkWorkerManager.init(this.extensionConfigs,this.customInitPromise,!0)}sendMessage(e,t,s){this.retrySendMessage(e,t,ko.maxRetries,s)}sendBytes(e){this.state.sendBytes(e)}onMessage(e,t){this.messageEndpoint.onMessage(e,t)}getCorrelationVector(){return this.cvParent}getNetworkWorkerManager(){return this.networkWorkerManager}forceReconnect(e){return this.extensionConfigs=e||this.extensionConfigs,this.networkWorkerManager.close(!1),new Promise(e=>setTimeout(()=>{e(this.networkWorkerManager.init(this.extensionConfigs))},100))}closeSession(e){this.sendMessage(new ot),this.networkWorkerManager.close(!0);const t=e||new tt({reasonDescription:"ClientRequested"});this.onSessionClose(new ot({reconnectAllowed:!1,reason:t}),"ClientRequested")}ingress(e,t){let s;try{s=JSON.parse(e)}catch(o){O.error(508843790,Y.CoreDefault,new g({operationName:"ProcessMessage",resourceId:"Unknown",success:!1,resultSignature:"ParseError",resultDescription:o.message,durationMs:0}))}if(s){if(t&&He.typeGuard(s)&&t(s),this.networkWorkerManager.getNetworkMode()===wo.HttpFallback&&et.typeGuard(s)){const e=s;if(e.batch)for(const t of e.batch)this.messageEndpoint.ingress(t,(e,t)=>this.egress(e||t,()=>{}));return}this.messageEndpoint.ingress(s,(e,t)=>this.egress(e||t,()=>{}))}}egress(e,t,s){e&&this.networkWorkerManager.egress(e,s).then(()=>t()).catch(e=>t(e))}onSessionCloseMessage(e,t){e.reconnectAllowed?this.networkWorkerManager.close():this.onSessionClose(e,"CloseMessageReceived"),t()}onSessionClose(e,t){this.setState(Ps.Closed,t),this.tokenRefreshManager.clearAllTimeouts(),this.onConnectionClose(void 0),e&&this.emit("sessionClose",e)}onConnectionClose(e){this.state.onConnectionClose(),this.stats.lastConnectionClose=ks.getCurrentTimeMs(),this.emit("disconnect",e)}retrySendMessage(e,t,s,o,n){const i=ko.maxRetries-s;this.state.sendMessage(e,(r,a)=>{var c,l,u,h,p,d;n&&(r&&0==s?(n.dimension0=(i+1).toString(),n.success=!1,O.info(507025311,Y.CoreDefault,n.stop())):r&&s>0?(n.dimension0=(i+1).toString(),n.dimension1=null!==(l=null===(c=r.code)||void 0===c?void 0:c.toString())&&void 0!==l?l:"NoErrorCode",n.resultSignature=null!==(u=r.error)&&void 0!==u?u:"NoErrorMessage"):(n.success=!0,O.info(507025310,Y.CoreDefault,n.stop()))),r&&s>0&&this.canBeRetried(e)&&this.isTransientError(r)?(this.logRetryTelemetry&&!n&&((n=new g({operationName:"RetrySendMessage",success:!0,dimension0:(i+1).toString()}).start()).resourceId=De.h.getTypeNameFor(e),n.dimension1=null!==(p=null===(h=r.code)||void 0===h?void 0:h.toString())&&void 0!==p?p:"NoErrorCode",n.resultSignature=null!==(d=r.error)&&void 0!==d?d:"NoErrorMessage",n.resultDescription="Retrying message with messageId: ".concat(e.messageId).concat(gt.typeGuard(e)?", seq: ".concat(e.seq):"")),De.h.matchesTypesFor(r,[Ye.getTypeName()])&&this.networkWorkerManager.onRateLimitErrorResponse(r),this.retrySendMessage(e,t,s-1,o,n)):t&&t(r,a)},i,o)}canBeRetried(e){return!De.h.matchesTypesFor(e,[Xe.getTypeName(),ft.getTypeName(),oo.getTypeName()])}isTransientError(e){const t=e.error,s=e.code;return!(this.isImproveRetriesChangeGateEnabled&&s===Be.TokenValidationError||s===Be.TokenDecryptError||s===Be.SyncMessageTooLateOrDuplicate||this.shouldNotRetryOnSessionClosedError&&s===Be.Gone)&&(t!==zt.SyncMessageUnsupportedBatch&&t!==zt.UnexpectedSeedMessage&&t!==zt.UnsupportedSyncMessage&&t!==zt.AnnotationTokenNotFound&&t!==_s.ArrivedBeforeReseeding&&t!==_s.DroppedAsOldestInQueue&&t!==_s.DroppedBecauseClientDisconnected)}}var bo;ko.maxRetries=2,function(e){e[e.NotAuthenticated=0]="NotAuthenticated",e[e.Pending=1]="Pending",e[e.Authenticated=2]="Authenticated",e[e.WacUserInfoAuthenticated=3]="WacUserInfoAuthenticated",e[e.TokenMissingInteractionRequired=4]="TokenMissingInteractionRequired"}(bo||(bo={}));var Ao,_o,Mo,Io,No,Po,Eo,xo,Do,Oo,Ro,Bo,Lo,Wo,Fo,Go,Uo,Ho,qo,Vo;!function(e){e[e.None=0]="None",e[e.HttpsGetDownloadUrl=1]="HttpsGetDownloadUrl",e[e.AlCodedLocation=2]="AlCodedLocation",e[e.Token=3]="Token",e[e.SpeAlCodedLocation=4]="SpeAlCodedLocation"}(Ao||(Ao={})),function(e){e[e.NewDocument=0]="NewDocument",e[e.EditDocument=1]="EditDocument",e[e.ViewOnlyDocument=2]="ViewOnlyDocument"}(_o||(_o={}));class jo{}jo.lowerIndexBound=1,jo.maxNumberOfRows=1048576,jo.maxNumberOfColumns=16384,jo.firstColumnName="A",jo.lastColumnName="XFD";class zo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){De.h.assign(zo,this,e)}static getTypeName(){return"AugLoop_Core_Apology"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[zo.getTypeName()])}}zo.H_={T_:zo.getTypeName(),B_:zo.getBaseTypes()};class Jo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){De.h.assign(Jo,this,e)}static getTypeName(){return"AugLoop_Core_SecondaryApology"}static getBaseTypes(){return["AugLoop_Core_Apology","AugLoop_Core_Annotation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Jo.getTypeName()])}}Jo.H_={T_:Jo.getTypeName(),B_:Jo.getBaseTypes()};class Ko{constructor(e){De.h.assign(Ko,this,e)}static getTypeName(){return"AugLoop_Core_WorkflowActivationFailureDetails"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[Ko.getTypeName()])}}Ko.H_={T_:Ko.getTypeName(),B_:Ko.getBaseTypes()};class Qo{constructor(e){De.h.assign(Qo,this,e)}static getTypeName(){return"AugLoop_Core_AuthTokenIsMissingDetails"}static getBaseTypes(){return["AugLoop_Core_WorkflowActivationFailureDetails"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Qo.getTypeName()])}}Qo.H_={T_:Qo.getTypeName(),B_:Qo.getBaseTypes()};class Yo{get metadata(){return this.M_}set metadata(e){this.M_=e}constructor(e){De.h.assign(Yo,this,e)}static getTypeName(){return"AugLoop_Core_NotActivatedWorkflowApology"}static getBaseTypes(){return["AugLoop_Core_Apology","AugLoop_Core_Annotation"]}static typeGuard(e){return De.h.matchesTypesFor(e,[Yo.getTypeName()])}}Yo.H_={T_:Yo.getTypeName(),B_:Yo.getBaseTypes()},function(e){e[e.Unknown=0]="Unknown",e[e.LiveId=1]="LiveId",e[e.OrgId=2]="OrgId",e[e.ActiveDirectory=3]="ActiveDirectory",e[e.ADAL=4]="ADAL",e[e.SSPI=5]="SSPI",e[e.OAuth2=6]="OAuth2",e[e.Badger=7]="Badger"}(Mo||(Mo={})),function(e){e[e.Augloop=0]="Augloop",e[e.Substrate=1]="Substrate"}(Io||(Io={})),function(e){e[e.Unknown=0]="Unknown",e[e.TokenMissingInteractionRequired=1]="TokenMissingInteractionRequired"}(No||(No={}));class Xo{constructor(e,t,s,o){this.sendMessage=e,this.annotationType=t,this.options=s,this.token="".concat(t,"-").concat(Xo.nextActivationResultBatchId++),this.annotationDoesNotExistOnServiceEnabled=o}activate(e,t,s){return new Promise((o,n)=>{this.sendMessage(new rt({annotationType:this.annotationType,token:this.token,config:this.options?this.options.config:void 0,ignoreExistingAnnotations:e,sendStateUpdates:this.options?!!this.options.stateUpdateCallback:void 0,forceReturnCachedAnnotations:this.options?this.options.forceReturnCachedAnnotations:void 0,returnAnnotationDoesNotExist:this.annotationDoesNotExistOnServiceEnabled||!1,sendApologies:s}),(e,t)=>{e?n(new Error(e.error)):(at.typeGuard(t)&&this.annotationDoesNotExistOnServiceEnabled&&(this.annotationDoesNotExistOnService=t.annotationNotExists),o({token:this.token}))},t)})}release(){return new Promise((e,t)=>{this.annotationDoesNotExistOnService&&this.annotationDoesNotExistOnServiceEnabled?e(!1):this.sendMessage(new lt({token:this.token}),(s,o)=>{s?t(new Error(s.error)):e(o.lastRelease)})})}}Xo.nextActivationResultBatchId=1,function(e){e[e.Input=0]="Input",e[e.Exception=1]="Exception",e[e.WaitOn=2]="WaitOn",e[e.StopAndFilterWorkflow=3]="StopAndFilterWorkflow"}(Po||(Po={})),function(e){e[e.Unknown=0]="Unknown",e[e.NoOutput=1]="NoOutput",e[e.Authentication=2]="Authentication",e[e.JoinTimedOut=3]="JoinTimedOut",e[e.LambdaThrow=4]="LambdaThrow",e[e.LambdaErrorCallback=5]="LambdaErrorCallback"}(Eo||(Eo={})),function(e){e[e.ExceedingMaxSize=0]="ExceedingMaxSize",e[e.GroupComplete=1]="GroupComplete",e[e.BatchIntervalElapsed=2]="BatchIntervalElapsed"}(xo||(xo={}));class Zo{constructor(e,t,s,o,n){this.batchesByGroupingKey=new Map,this.getOrderOfMagnitudeDimension=e=>e<0?"Negative":0===e?"0":1===e?"1":"Magnitude ".concat(e.toString().length),this.submit=e,this.onSummary=o,this.reduceBatchOperationsEnabled=t,this.batchMessagesEnabled=s,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=n}addBatchItem(e,t,s,o,n,i){const{delayMs:r,delayMsMax:a,maxInputSize:c,estimateSize:l,groupingKeyExtractor:u}=t,h=l(e),p=u(e);if(t.split&&h>c){let r;try{r=t.split(e)}catch(g){const e=new Error("Split error: "+g.message);return void(i?i(e):O.error(573366352,Y.CoreDefault,e))}if(r&&Array.isArray(r.inputs)&&r.inputs.length>1){let e;const a=[],c=i?(t,s)=>{if(e=e||t,a.push(s),a.length===r.inputs.length){let s;try{s=r.join(a)}catch(t){return void i(new Error("Join error: "+t.message))}i(e,s)}}:void 0;for(let i=0;i<r.inputs.length;i++){const e=r.inputs[i];this.addBatchItem(e,t,s,o,n&&i===r.inputs.length-1,c)}return}}let d=this.batchesByGroupingKey.get(p);if(d&&d.size+h>c&&(this.executeBatch(p,d,t,xo.ExceedingMaxSize),d=void 0),d||(d={items:[],size:0,hasItemsWithCallbacks:!1,context:s,creationTime:Date.now()},this.batchesByGroupingKey.set(p,d)),this.batchMessagesEnabled){const t=d.items[d.items.length-1];t&&t.cv===o&&t.callback===i?(t.input=[...t.input,...e],t.size+=h):d.items.push({input:e,size:h,cv:o,callback:i})}else d.items.push({input:e,size:h,callback:i});d.size+=h,d.hasItemsWithCallbacks=d.hasItemsWithCallbacks||!!i,this.batchMessagesEnabled||(d.cv=o),d.groupComplete=n,d.groupComplete?this.executeBatch(p,d,t,xo.GroupComplete):(Date.now()-d.creationTime+r<a&&(clearTimeout(d.timeout),d.timeout=void 0),d.timeout||(d.timeout=setTimeout(()=>{this.executeBatch(p,d,t,xo.BatchIntervalElapsed)},r)))}removeAllBatchedItems(){this.batchesByGroupingKey.forEach(e=>{e.timeout&&clearTimeout(e.timeout)}),this.batchesByGroupingKey.clear()}reduceBatchOperations(e){const t=new g({operationName:"ReduceBatchOperations"}).start();let s=0,o=0,n=0;const i=new Set,r=[],a=(e,t)=>e.parentPath.toString()+"/"+e.parentRevId+"/"+t.id;for(const c of e.input.reverse()){const e=[];for(const t of c.input.reverse())if(ps.typeGuard(t)){const r=[];for(const e of t.items){n++;const c=a(t,e);i.has(c)?o++:(r.push(e),i.add(c),s++)}0!==r.length&&(t.items=r,e.push(t))}else if(ls.typeGuard(t)){for(const e of t.items){const s=a(t,e);i.delete(s)}e.push(t)}else e.push(t);0!==e.length&&r.push({input:e.reverse(),size:c.size,cv:c.cv,callback:c.callback})}e.input=r.reverse(),0!=n&&(t.dimension0="".concat(this.getOrderOfMagnitudeDimension(o)),t.dimension1="noOp: ".concat(0===o)),t.success=n-o==s,O.info(507839488,Y.CoreDefault,t.stop())}maxNumberOfDeltaUpdateOpsPerItemPerBatch(e){const t=(e,t)=>e.parentPath.toString()+"/"+t.id;let s=0;const o=new Map;for(const n of e.input)if(vs.typeGuard(n))for(const e of n.items){const i=t(n,e);o.has(i)||o.set(i,0),o.set(i,o.get(i)+1),s=Math.max(s,o.get(i))}return s}executeBatch(e,t,s,o){clearTimeout(t.timeout),t.timeout=void 0,this.batchesByGroupingKey.delete(e);const n=t.items,i=new g({operationName:"ExecuteBatch",cv:this.batchMessagesEnabled?"":t.cv,resourceId:t.context.name,resultDescription:"batching duration: ".concat(Date.now()-t.creationTime,"ms"),dimension0:"".concat(this.batchMessagesEnabled?"Batched items count":"Batched ops count:"," ").concat(this.getOrderOfMagnitudeDimension(n.length)),dimension1:"Size ".concat(this.getOrderOfMagnitudeDimension(t.size)),dimension2:o.toString()}).start(),r=(e,s,o)=>{let r;if(s&&s.exceptionType===Eo.NoOutput)i.success=!0,O.info(573366353,Y.CoreDefault,i.stop());else{const o="".concat(e," error: ").concat(s?s.message||s:"Unknown error");r=s||new Error(o),i.success=!1,i.resultDescription="Batch of ".concat(n.length," items of size ").concat(t.size," with ").concat(o),i.resultSignature="".concat(e," Error"),O.error(573366354,Y.CoreDefault,i.stop())}if(t.hasItemsWithCallbacks)for(const t of n)t.callback&&t.callback(r,o)};let a;try{a=s.multiplex(this.batchMessagesEnabled?n:n.map(e=>e.input))}catch(c){return void r("Multiplex",c)}this.reduceBatchOperationsEnabled&&this.batchMessagesEnabled&&"operations"==e&&this.reduceBatchOperations(a),!this.batchMessagesEnabled&&"operations"==e&&this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled&&(i.dimension3=this.getOrderOfMagnitudeDimension(this.maxNumberOfDeltaUpdateOpsPerItemPerBatch(a))),this.submit(a.input,t,(e,o)=>{if(e||o&&("exceptionType"in o||o instanceof Error))r("Submit",e||o,o);else if(t.hasItemsWithCallbacks||s.summaryExtractor){let c,l,u;if(t.hasItemsWithCallbacks)try{if(c=a.demultiplex(o),c.length!==n.length)throw new Error("Mismatched output length")}catch(e){return void r("Demultiplex",e)}if(s.summaryExtractor)try{[u,l]=s.summaryExtractor(o)}catch(e){return void r("SummaryExtractor",e)}if(i.success=!0,O.info(573366342,Y.CoreDefault,i.stop()),t.hasItemsWithCallbacks)for(let e=0;e<n.length;e++)n[e].callback&&n[e].callback(void 0,c[e]);l&&this.onSummary(u,l,t.context)}else i.success=!0,O.info(573366343,Y.CoreDefault,i.stop())})}}!function(e){e[e.SingleItem=0]="SingleItem",e[e.Reduce=1]="Reduce",e[e.Grid=2]="Grid",e[e.DynamicText=3]="DynamicText",e[e.Join=4]="Join",e[e.Generic=5]="Generic"}(Do||(Do={})),function(e){e.Default="Default",e.Copilot="Copilot"}(Oo||(Oo={})),function(e){e[e.None=0]="None",e[e.ContentFiltering_M365Copilot=1]="ContentFiltering_M365Copilot"}(Ro||(Ro={})),function(e){e[e.Default=0]="Default",e[e.LocalOnly=1]="LocalOnly",e[e.Exclusive=2]="Exclusive"}(Bo||(Bo={})),function(e){e[e.PreActivate=0]="PreActivate",e[e.Default=1]="Default",e[e.DelayActivate=1]="DelayActivate",e[e.NeverActivate=2]="NeverActivate"}(Lo||(Lo={})),function(e){e[e.Required=-3]="Required",e[e.Optional=-1]="Optional"}(Wo||(Wo={})),function(e){e[e.Never=0]="Never",e[e.Always=1]="Always"}(Fo||(Fo={})),function(e){e[e.PreSeed=1]="PreSeed",e[e.OnSeed=2]="OnSeed",e[e.PostSeed=4]="PostSeed",e[e.All=5]="All"}(Go||(Go={})),function(e){e[e.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady",e[e.AnnotationMetadataUpdated=1]="AnnotationMetadataUpdated",e[e.DeltaUpdate=2]="DeltaUpdate",e[e.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals"}(Uo||(Uo={})),function(e){e[e.Character=1]="Character",e[e.Paragraph=2]="Paragraph"}(Ho||(Ho={})),function(e){e.Input="Input",e.Delta="Delta",e.UILanguage="UILanguage",e.MaxInputCount="MaxInputCount",e.ExtensionLimits="ExtensionLimits"}(qo||(qo={})),function(e){e.SetPredefinedAnnotation="SetPredefinedAnnotation",e.ClearAnnotations="ClearAnnotations"}(Vo||(Vo={}));const $o=(e,t)=>{const s=[];for(const o of null!==e&&void 0!==e?e:[])if(void 0===t||t===o.cardinality)for(const e of o.contextTypes)s.push([e,o.cardinality,o.producerWaitPolicy]);return s},en="\\",tn=(e,t)=>Object.assign(Object.assign({},t),{parentPath:e}),sn=e=>Array.isArray(e)?5===e.length?"".concat(e[0]).concat(en).concat(e[1]).concat(en).concat(e[2]).concat(en).concat(e[3]).concat(en).concat(e[4]):4===e.length?"".concat(e[0]).concat(en).concat(e[1]).concat(en).concat(e[2]).concat(en).concat(e[3]):3===e.length?"".concat(e[0]).concat(en).concat(e[1]).concat(en).concat(e[2]):2===e.length?"".concat(e[0]).concat(en).concat(e[1]):1===e.length?e[0]:e.join(en):"(malformed path)";var on;!function(e){e[e.Local=0]="Local",e[e.External=1]="External"}(on||(on={}));class nn{constructor(){this.graphNodeByLocationAndWorkflowId=new Map}getWorkflow(e,t){var s;const o=this.getLocation(t);return null===(s=this.graphNodeByLocationAndWorkflowId.get(o))||void 0===s?void 0:s.get(e)}addWorkflow(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.getWorkflow(e.id,t)){const s=new g({operationName:"AddWorkflowToGraphFailure",success:!1,resourceId:e.id,resultDescription:"Adding a new with workflow with a duplicated workflowId: ".concat(t)}).start();return void O.error(524300630,Y.CoreDefault,s.stop())}const s=this.getLocation(t),o=new rn(e,s);this.addWorkflowAsDependency(o);let n=this.graphNodeByLocationAndWorkflowId.get(s);n||(n=new Map,this.graphNodeByLocationAndWorkflowId.set(s,n)),n.set(e.id,o)}getUpstreamRuntimeVisibleWorkflows(){const e=[];for(const t of this.graphNodeByLocationAndWorkflowId.values()||[])for(const s of t.values()||[]){const t=this.createWorkflowDefinition(s.workflow);s.workflow.visibility===Bo.LocalOnly?this.compressDownstreamWorkflows(t,s):t.outputTypes.push(...s.workflow.outputTypes),0!==t.inputTypes.length&&e.push(t)}return e}removeWorkflows(e){const t=this.getLocation(e),s=this.graphNodeByLocationAndWorkflowId.get(t),o=Array.from((null===s||void 0===s?void 0:s.values())||[]);for(const n of o){for(const e of n.upstreamWorkflows.values())e.downstreamWorkflows.delete(n);for(const e of n.downstreamWorkflows.values())e.upstreamWorkflows.delete(n);s.delete(n.workflow.id)}}getWorkflowsDefinitions(){const e=[];for(const t of this.graphNodeByLocationAndWorkflowId.values()||[])for(const s of t.values()||[])e.push(s.workflow);return e}getWorkflowNodes(e){const t=[];for(const s of this.graphNodeByLocationAndWorkflowId.values())for(const e of s.values())t.push(e);return t}getLocation(e){return e?on.External:on.Local}createWorkflowDefinition(e){return Object.assign(Object.assign({},e),{outputTypes:[]})}compressDownstreamWorkflows(e,t){for(const s of t.downstreamWorkflows)if(s.workflow.visibility!==Bo.LocalOnly){if(s.workflow.kind!==Do.Join||-1!==e.inputTypes.indexOf(s.workflow.collectionScopeType))for(const t of s.workflow.outputTypes)-1===e.outputTypes.indexOf(t)&&e.outputTypes.push(t)}else this.compressDownstreamWorkflows(e,s)}addWorkflowAsDependency(e){for(const t of this.graphNodeByLocationAndWorkflowId.values())for(const s of t.values()){for(const t of s.workflow.inputTypes)-1!==e.workflow.outputTypes.indexOf(t)&&this.addWorkflowChain(e,s);for(const t of s.workflow.outputTypes)-1!==e.workflow.inputTypes.indexOf(t)&&this.addWorkflowChain(s,e)}}addWorkflowChain(e,t){e.downstreamWorkflows.add(t),t.upstreamWorkflows.add(e)}}class rn{constructor(e,t){this.isActivated=!0,this.upstreamWorkflows=new Set,this.downstreamWorkflows=new Set,this.location=t,this.workflow=Object.assign(Object.assign({},e),{inputTypes:Array.isArray(e.inputTypes)?e.inputTypes:[],outputTypes:Array.isArray(e.outputTypes)?e.outputTypes:[]})}}new Pe("enableRichContentApis",!1);const an=e=>({id:e.id,kind:e.kind,visibility:e.visibility,collectionScopeType:e.collectionScopeType,inputTypes:e.inputTypes,outputTypes:e.outputTypes,correlatedSignals:e.correlatedSignals}),cn=(e,t)=>void 0!==e&&null!==e&&(void 0!==t&&null!==t&&(e.length>0&&(e===t||0===t.indexOf(e)&&"."===t.charAt(e.length))));class ln{constructor(){this.workflowDefByWorkflowAndContextId=new Map,this.workflowDefByWorkflow=new Map}static mergeDefinitions(e,t,s){return Object.assign(Object.assign(Object.assign({},e),t),s)}mergeWorkflowDefinition(e,t,s){if(s){const o=((e,t,s)=>{let o=e.get(t);return o||(o=s(),e.set(t,o)),o})(this.workflowDefByWorkflowAndContextId,e.id,()=>new Map);o.set(s,ln.mergeDefinitions(e,o.get(s),t))}else this.workflowDefByWorkflow.set(e.id,ln.mergeDefinitions(e,this.workflowDefByWorkflow.get(e.id),t))}getWorkflowDefinition(e,t){var s;let o;return t&&(o=null===(s=this.workflowDefByWorkflowAndContextId.get(e.id))||void 0===s?void 0:s.get(t)),o||(o=this.workflowDefByWorkflow.get(e.id)),o||(o=e),o}deleteWorkflowDefinition(e,t){const s=this.workflowDefByWorkflowAndContextId.get(e.id);s&&(s.delete(t),0===s.size&&this.workflowDefByWorkflowAndContextId.delete(e.id))}}var un;!function(e){e.JsClient="C",e.Server="S"}(un||(un={}));const hn=new Set([ls.getTypeName(),ps.getTypeName(),Cs.getTypeName(),vs.getTypeName()]);class pn{constructor(e,t){this.nextId=1,this.runtimeKind=e,this.workflowGraph=t}static isParentContextId(e,t){return cn(e,t)}applyContextIdOnOperations(e){for(const t of e){const e=De.h.getTypeNameFor(t);if(this.isSupportedOperation(e))for(const s of t.items)s.contextId?s.source&&this.workflowGraph.getWorkflow(s.source,!1)?s.contextId=this.addNewContextId(s.contextId):this.tryLogMessage(new g({operationName:"ApplyContextIdOnOperations",success:!0}).start(),"Item with a contextId but without a workflow source atribute"):s.contextId=this.addNewContextId()}}addNewContextId(e){const t="".concat(this.runtimeKind).concat(this.nextId++);return e?"".concat(e,".").concat(t):t}isSupportedOperation(e){return hn.has(e)}tryLogMessage(e,t){let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];e&&(e.success=s,e.resultDescription=t,O.verbose(527308633,Y.CoreDefault,e.stop()))}}var dn;!function(e){e[e.Idle=1]="Idle",e[e.Pending=2]="Pending",e[e.Running=3]="Running",e[e.Executed=4]="Executed"}(dn||(dn={}));class gn{constructor(e){this.scopeItemsByContextId=new Map,this.itemsByWorkflowAndContextId=new Map,this.workflowDefinitionManager=e}setScopeItem(e,t){var s;const o=e.contextId;if(o)if(this.itemsByWorkflowAndContextId.has(t.id)||this.itemsByWorkflowAndContextId.set(t.id,new Map),this.itemsByWorkflowAndContextId.get(t.id).set(o,[]),this.scopeItemsByContextId.has(o)){if(null===(s=this.itemsByWorkflowAndContextId.get(t.id))||void 0===s?void 0:s.has(o)){const s=new g({resultDescription:"Trying to set new scope item: ".concat(e.id," with already existing contextId ").concat(o," for workflow ").concat(t.id),operationName:"WIS.setScopeItem",resourceId:t.id,success:!0}).start();O.verbose(527291288,Y.CoreDefault,s.stop())}}else this.scopeItemsByContextId.set(o,e)}updateScopeItemPath(e,t,s){var o,n;if(!e)return;const i=this.scopeItemsByContextId.get(e);if(!i)return;const r=i.parentPath;this.scopeItemsByContextId.set(e,tn(t,i));const a=null!==(n=null===(o=this.itemsByWorkflowAndContextId.get(s.id))||void 0===o?void 0:o.get(e))&&void 0!==n?n:[];for(let c=0;c<a.length;c++)a[c]=tn([...t,...a[c].parentPath.slice(0,r.length)],a[c])}getScopeItem(e,t){var s;for(const o of(null===(s=this.itemsByWorkflowAndContextId.get(t.id))||void 0===s?void 0:s.keys())||[])if(cn(o,e))return this.scopeItemsByContextId.get(o)}addItemToWorkflowList(e,t){const s=e.contextId;if(!s)return;const o=this.itemsByWorkflowAndContextId.get(t.id);if(o)for(const[n,i]of o)if(cn(n,s)){i.push(e);const s=new g({resultDescription:"Items for contextId ".concat(n,": [").concat(i.map(e=>e.id).join(","),"]"),operationName:"WIS.addItemOnContextIdList",resourceId:t.id,success:!0}).start();O.info(526403808,Y.CoreDefault,s.stop())}}isWorkflowReady(e,t){const s=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.getGeneratedItems(e,t).length>=s}getItemsToExecute(e,t){const s=this.getGeneratedItems(e,t);return this.itemsByWorkflowAndContextId.get(t.id).delete(e),s}onWorkflowExecuted(e,t){const s=e.contextId,o=this.itemsByWorkflowAndContextId.get(t.id);o&&(o.delete(s),0===o.size&&this.itemsByWorkflowAndContextId.delete(t.id)),this.hasWorkflowsAwaitingExecution(s)||this.scopeItemsByContextId.delete(s)}getGeneratedItems(e,t){var s;if(!(null===(s=this.itemsByWorkflowAndContextId.get(t.id))||void 0===s?void 0:s.get(e)))return[];const o=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.itemsByWorkflowAndContextId.get(t.id).get(e).slice(0,o)}hasWorkflowsAwaitingExecution(e){for(const t of this.itemsByWorkflowAndContextId.values())for(const s of t.keys())if(s===e)return!0;return!1}}var fn,mn,yn,Tn=s(34331);!function(e){e[e.Add=0]="Add",e[e.Delete=1]="Delete",e[e.Update=2]="Update",e[e.CursorUpdate=3]="CursorUpdate",e[e.FormattingUpdate=4]="FormattingUpdate",e[e.OtherNonContentUpdate=5]="OtherNonContentUpdate",e[e.AttributionUpdate=6]="AttributionUpdate"}(fn||(fn={})),function(e){e[e.Chars=0]="Chars",e[e.Word=1]="Word",e[e.PartialSentence=2]="PartialSentence",e[e.Sentence=3]="Sentence",e[e.Paragraph=4]="Paragraph"}(mn||(mn={})),function(e){e[e.SessionUser=0]="SessionUser",e[e.Programmatic=1]="Programmatic",e[e.Collaborator=2]="Collaborator"}(yn||(yn={}));class vn{constructor(e){De.h.assign(vn,this,e)}static getTypeName(){return"AugLoop_Text_TextTileDelta"}static getBaseTypes(){return["AugLoop_Core_ItemDelta"]}static typeGuard(e){return De.h.matchesTypesFor(e,[vn.getTypeName()])}}vn.H_={T_:vn.getTypeName(),B_:vn.getBaseTypes()};class wn{constructor(e){De.h.assign(wn,this,e)}static getTypeName(){return"AugLoop_Text_FormattedTextTileDelta"}static getBaseTypes(){return["AugLoop_Text_TextTileDelta","AugLoop_Core_ItemDelta"]}static typeGuard(e){return De.h.matchesTypesFor(e,[wn.getTypeName()])}}function Cn(e,t){let s,o,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i={firstDiffLeft:0,firstDiffRight:t.length};return e.length<t.length?(s=e,o=t):(s=t,o=e),0===o.indexOf(s)?(i.firstDiffLeft=s.length,i.firstDiffRight=0):o.endsWith(s)?(i.firstDiffLeft=0,i.firstDiffRight=s.length):(i=function(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const o={firstDiffLeft:0,firstDiffRight:t.length};let n;for(n=0;n<e.length&&n<t.length;n+=1){const o=e.charCodeAt(n),i=t.charCodeAt(n);if(o!==i&&(!Sn(o,s)||!Sn(i,s)))break}for(o.firstDiffLeft=n,n=0;n<e.length&&n<t.length;n+=1){const o=e.charCodeAt(e.length-n-1),i=t.charCodeAt(t.length-n-1);if(o!==i&&(!Sn(o,s)||!Sn(i,s)))break}return o.firstDiffRight=n,o}(e,t,n),i.firstDiffLeft+i.firstDiffRight>s.length&&(i.firstDiffRight=s.length-i.firstDiffLeft)),function(e,t,s){if(e.firstDiffLeft>0){const o=e.firstDiffLeft<t.length&&kn(t,e.firstDiffLeft),n=e.firstDiffLeft<s.length&&kn(s,e.firstDiffLeft);(o||n)&&(e.firstDiffLeft-=1)}if(e.firstDiffRight>1){const o=e.firstDiffRight<t.length&&kn(t,t.length-e.firstDiffRight),n=e.firstDiffRight<s.length&&kn(s,s.length-e.firstDiffRight);(o||n)&&(e.firstDiffRight-=1)}}(i,e,t),i}function Sn(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];switch(e){case 12288:case 8197:case 32:case 11:case 9:case 160:return!0;case 13:case 10:case 65532:return!t}return!1}function kn(e,t){return e.charCodeAt(t)>=56320&&e.charCodeAt(t)<=57343}wn.H_={T_:wn.getTypeName(),B_:wn.getBaseTypes()};const bn=/[ \u00a0\u2000-\u200a\u202f\u205f\u3000\t]/g,An=/[.!?]/g;function _n(e,t){const s=[],o=In(e,t);return o&&s.push(o),s}function Mn(e,t){const s=[],o=In(e,t);o&&s.push(o);const n=function(e,t,s){var o,n,i,r,a,c;const l=e,u=t;if((null===l||void 0===l?void 0:l.ipPosition)===(null===u||void 0===u?void 0:u.ipPosition)&&(null===l||void 0===l?void 0:l.isColdIp)===(null===u||void 0===u?void 0:u.isColdIp))return;if((null===l||void 0===l?void 0:l.isColdIp)===(null===u||void 0===u?void 0:u.isColdIp)&&s)if(s.deltaType===fn.Add){if((null===u||void 0===u?void 0:u.ipPosition)===(null!==(o=s.position)&&void 0!==o?o:0)+(null!==(n=s.length)&&void 0!==n?n:0))return}else if(s.deltaType===fn.Update){if((null===u||void 0===u?void 0:u.ipPosition)===(null!==(i=s.position)&&void 0!==i?i:0)+(null!==(a=null===(r=s.content)||void 0===r?void 0:r.length)&&void 0!==a?a:0))return}else if(s.deltaType===fn.Delete&&(null===u||void 0===u?void 0:u.ipPosition)===(null!==(c=s.position)&&void 0!==c?c:0))return;return new wn({deltaType:fn.CursorUpdate,cursorData:{ipPosition:null===u||void 0===u?void 0:u.ipPosition,isColdIp:null===u||void 0===u?void 0:u.isColdIp}})}(e,t,o);n&&s.push(n);const i=function(e,t,s){var o,n,i,r,a,c,l;const u=e,h=t;if((null===(o=h.formattedRanges)||void 0===o?void 0:o.length)<=(null===(n=u.formattedRanges)||void 0===n?void 0:n.length))if(s){let e=u.formattedRanges?[...u.formattedRanges]:[];const t=function(e,t,s){if(!e)return;if(t.deltaType===fn.Add){const t=e.find(e=>e.start===s&&0===e.length);if(t)return t;s=Math.max(s-1,0)}const o=e.find(e=>0===e.length?e.start===s:e.start<=s&&s<e.start+e.length);return o}(u.formattedRanges,s,s.position),o=t?e.indexOf(t):-1;if(-1!==o&&(s.position+(s.length||0)>t.start+t.length?t.length=s.position+(null!==(i=s.content)&&void 0!==i?i:"").length-t.start:t.length+=(null!==(r=s.content)&&void 0!==r?r:"").length-(s.length||0),e[o]=t),e.length>0){for(const t of e.slice(o+1))t.start<s.position||(s.position+(s.length||0)>t.start?(t.length=t.start+t.length-(s.position+(s.length||0)),t.start=s.position+(null!==(a=s.content)&&void 0!==a?a:"").length):t.start+=(null!==(c=s.content)&&void 0!==c?c:"").length-(s.length||0));e=e.filter(e=>e.length>0)}const n=null!==(l=null===h||void 0===h?void 0:h.formattedRanges)&&void 0!==l?l:[];if(Ae()(e,n)||0===e.length&&0===n.length)return}else if(Ae()(null===u||void 0===u?void 0:u.formattedRanges,null===h||void 0===h?void 0:h.formattedRanges))return;return new wn({deltaType:fn.FormattingUpdate,formattedRanges:null===h||void 0===h?void 0:h.formattedRanges})}(e,t,o);i&&s.push(i);const r=function(e,t,s){var o;const n=e,i=t;if(!(null===n||void 0===n?void 0:n.attributionRanges)&&!i.attributionRanges&&!(null===(o=null===s||void 0===s?void 0:s.attributionData)||void 0===o?void 0:o.ranges)||Ae()(null===n||void 0===n?void 0:n.attributionRanges,null===i||void 0===i?void 0:i.attributionRanges))return;if(n.attributionRanges&&i.attributionRanges){const e=[];for(const t of i.attributionRanges)n.attributionRanges.some(e=>Ae()(e,t))||e.push(t);if(0===e.length)return;return new wn({deltaType:fn.AttributionUpdate,attributionData:{ranges:e}})}return new wn({deltaType:fn.AttributionUpdate,attributionData:{ranges:null===i||void 0===i?void 0:i.attributionRanges}})}(e,t,o);r&&s.push(r);const a=function(e,t){const s=e,o=t;let n;const i={};let r=!1;for(n in o)-1===["ipPosition","isColdIp","content","formattedRanges","attributionRanges"].indexOf(n)&&(Ae()(o[n],s[n])||(r=!0,i[n]=o[n]));if(r)return new wn({deltaType:fn.OtherNonContentUpdate,otherNonContentData:i});return}(e,t);return a&&s.push(a),s}function In(e,t){const s=e.content,o=t.content,n=Cn(s,o),i=n.firstDiffLeft,r=s.length-n.firstDiffRight,a=o.length-n.firstDiffRight;let c,l=fn.Update;if(s.length!==o.length)r===i?(l=fn.Add,c=s[s.length-1]):a===i&&(l=fn.Delete,c=o[o.length-1]);else if(s===o)return;let u,h=0;switch(l){case fn.Update:h=r-i,u=o.substring(i,a);break;case fn.Add:u=o.substring(i,a);break;case fn.Delete:h=r-i,u=s.substring(i,r)}const p=function(e,t){const s=Array.from(e.matchAll(bn));if(bn.lastIndex=0,0===s.length)return mn.Chars;if(1===s.length){if(0===s[0].index)return t&&An.test(t)?mn.Sentence:t&&!bn.test(t)?mn.Word:mn.Chars;if(s[0].index+1===e.length)return An.test(e[s[0].index-1])?mn.Sentence:bn.test(e[s[0].index-1])?mn.Chars:mn.Word;if(e[s[0].index-1]){const t=e[s[0].index-1];if(An.test(t))return mn.Sentence;if(bn.test(t))return mn.Chars}return mn.Word}const o=Array.from(e.matchAll(An));if(An.lastIndex=0,0===o.length)return mn.PartialSentence;if(o.length>1)return mn.Paragraph;if(o[0].index+1<=e.length)return bn.test(e[o[0].index+1])?mn.Sentence:mn.Paragraph;return}(u,c);if(void 0!==p)return new wn({content:l!==fn.Delete?u:void 0,deltaType:l,unit:p,position:i,length:l!==fn.Add?h:0})}class Nn{constructor(){this.deltaBuilderHandlers=new Map,this.registerDeltaBuilderHandler(Tn.qf.getTypeName(),_n),this.registerDeltaBuilderHandler(Tn.Cg.getTypeName(),Mn)}registerDeltaBuilderHandler(e,t){this.deltaBuilderHandlers.set(e,t)}executeDeltaBuilderHandler(e,t,s){const o=this.deltaBuilderHandlers.get(e);return o?o(t,s):[]}}const Pn=(e,t)=>t?En([...t,e]):e,En=e=>e.join("\\");class xn{constructor(e){this.createTextTileDeltasFromItem=(e,t)=>{var s;const o=new g({operationName:"CreateTextTileDeltaFromItem",success:!0}).start();try{if(!e)return o.success=!1,o.resultDescription="Unable to create text tile delta, parent item is undefined",void O.info(524883085,Y.CoreDefault,o.stop());if(!e.body)return o.success=!1,o.resultDescription="Unable to create text tile delta, parent item has undefined body",void O.info(524883086,Y.CoreDefault,o.stop());const n=e.body;if(!Tn.qf.typeGuard(n))return o.success=!1,void(o.resultDescription="Unable to create text tile delta, parent item body is not proper type: expected ".concat(Tn.qf.getTypeName(),", received ").concat(De.h.getTypeNameFor(n)));const i=Pn(e.id,t),r=null!==(s=this.lastSeenTileByTileId.get(i))&&void 0!==s?s:new Tn.qf({content:""}),a=this.createDeltas(r,n);return a&&0!==a.length?(o.dimension0=a.length.toString(),this.lastSeenTileByTileId.set(i,n)):(o.dimension0="0",o.resultDescription="No delta differences found"),O.info(524883087,Y.CoreDefault,o.stop()),a}catch(n){return o.success=!1,o.resultDescription="Error creating text tile delta: ".concat(n),void O.info(524883088,Y.CoreDefault,o.stop())}},this.lastSeenTileByTileId=null!==e&&void 0!==e?e:new Map,this.deltaBuilder=new Nn}addItemToLocalMap(e,t){const s=Pn(e.id,t),o=e.body;Tn.qf.typeGuard(o)&&!this.lastSeenTileByTileId.has(s)&&this.lastSeenTileByTileId.set(s,o)}deleteItemFromLocalMap(e,t){const s=Pn(e.id,t);this.lastSeenTileByTileId.has(s)&&this.lastSeenTileByTileId.delete(s)}moveItemsInLocalMap(e,t,s){const o=new Set(s),n=En(t),i=En(e),r=[],a=(e,t)=>e.length>t.length?e.substring(t.length+1).split("\\")[0]:void 0;for(const[c,l]of this.lastSeenTileByTileId)if(c.startsWith(n)){const e=a(c,n);if(void 0===e||o.has(e)){const e=c.replace(n,i);r.push({item:l,newPathKey:e,prevPathKey:c})}}for(const c of r)this.lastSeenTileByTileId.delete(c.prevPathKey),this.lastSeenTileByTileId.set(c.newPathKey,c.item)}createDeltas(e,t){return this.deltaBuilder.executeDeltaBuilderHandler(De.h.getTypeNameFor(t),e,t)}}function Dn(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}const On=e=>Rn(e,Number.POSITIVE_INFINITY),Rn=(e,t)=>{let s=0;const o=[],n=[e];for(;n.length>0;){const e=n.pop(),i=typeof e;if("boolean"===i)s+=4;else if("string"===i)s+=2*e.length;else if("number"===i)s+=8;else if("object"===i&&e&&-1===o.indexOf(e))if(e instanceof Uint8Array)s+=e.length;else{o.push(e);for(const t in e)n.push(e[t])}if(s>t)return s}return s};var Bn=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};function Ln(e,t){return Bn(this,void 0,void 0,function*(){const{authToken:s,origin:o,sessionUrl:n}=e,{body:i,cv:r,method:a,requestUrl:c}=t,l=yield(0,qs.fetch)(c||n,{method:a,headers:Object.assign({Authorization:"Bearer ".concat(s),"x-origin":o,"x-correlationid":r},t.headers),body:i});if(200!==l.status)throw new Error("Unexpected status code: ".concat(l.status));return l})}const Wn=(e,t)=>{t?(e.resultDescription=t,e.success=!1,O.error(507646878,Y.CoreDefault,e.stop())):O.info(507646877,Y.CoreDefault,e.stop())};function Fn(e,t,s,o){let n;Ln(e,{headers:{"Content-Type":"application/jsond"},body:Hs.serialize(t),cv:s.cv,method:"POST"}).then(e=>e.json()).catch(e=>{n=new Ke({messageId:t.messageId,error:e.message})}).then(e=>{Wn(s,n?n.error:void 0),o(n,e)})}function Gn(e,t,s,o){let n;Ln(e,{headers:{"Content-Type":"application/octet-stream"},body:t,cv:s.cv,method:"POST",requestUrl:"".concat(e.sessionUrl,"/blob")}).then(e=>e.json()).catch(e=>{n=new Ke({error:e.message})}).then(e=>{Wn(s,n?n.error:void 0),o(n,e)})}function Un(e,t,s,o){const{sessionUrl:n}=e;let i;Ln(e,{cv:o.cv,method:"GET",requestUrl:t.refType===Ao.AlCodedLocation?"".concat(n,"/blob/").concat(t.value):t.value}).then(e=>e.arrayBuffer()).then(e=>new Uint8Array(e)).catch(e=>{i=e}).then(e=>{Wn(o,i?i.message:void 0),s(i,e)})}class Hn extends Xt.EventEmitter{init(){return Promise.resolve()}sendMessage(e,t,s){}onMessage(e,t){}forceReconnect(){return Promise.resolve()}closeSession(){}sendBytes(e){}getCorrelationVector(){return new pe}getNetworkWorkerManager(){}setState(e){}}var qn=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})},Vn=function(e){return this instanceof Vn?(this.v=e,this):new Vn(e)},jn=function(e,t,s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var o,n=s.apply(e,t||[]),i=[];return o={},r("next"),r("throw"),r("return"),o[Symbol.asyncIterator]=function(){return this},o;function r(e){n[e]&&(o[e]=function(t){return new Promise(function(s,o){i.push([e,t,s,o])>1||a(e,t)})})}function a(e,t){try{(s=n[e](t)).value instanceof Vn?Promise.resolve(s.value.v).then(c,l):u(i[0][2],s)}catch(o){u(i[0][3],o)}var s}function c(e){a("next",e)}function l(e){a("throw",e)}function u(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}};var zn;!function(e){e[e.LocalWorkflow=0]="LocalWorkflow",e[e.ServerWorkflow=1]="ServerWorkflow",e[e.Submitted=2]="Submitted"}(zn||(zn={}));const Jn=(e,t)=>{t?(e.resultDescription=t,e.success=!1,O.error(509203144,Y.CoreDefault,e.stop())):O.info(509203143,Y.CoreDefault,e.stop())},Kn=e=>!e.items.some(e=>e.source&&0===e.source.indexOf("ThirdParty"));class Qn{constructor(e){var t,s;this.annotationActivationTrackers=new Map,this.annotationCallbacks=new Map,this.apologyCallbacks=new Map,this.annotationResultStates=new Map,this.tokensByAnnotationType=new Map,this.registeredContextTypes=new Set,this.availableContexts=new Map,this.nextSyncSequenceId=1,this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.hasSessionConnected=!1,this.isSessionClosed=!1,this.serverAuthenticationState=bo.NotAuthenticated,this.sessionCloseCallbacks=new Map,this.connectCallbacks=new Map,this.reconnectCallbacks=new Map,this.disconnectCallbacks=new Map,this.sessionStateCallbackToken=0,this.workflowGraph=new nn,this.workflowDefinitionManager=new ln,this.contextIdManager=new pn(un.JsClient,this.workflowGraph),this.workflowItemStorage=new gn(this.workflowDefinitionManager),this.pendingConnectCallbacks=[],this.onAnnotationsSubmittedEnabled=!1,this.reduceBatchOperationsEnabled=!1,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=!1,this.batchMessagesEnabled=!1,this.seedingStatus=Ge.NotStarted,this.isChangeGateForceUserInteractiveAuth=void 0,this.onConnectTelemetryCG=void 0,this.cachedClaimsChallenge={claimsVersion:0,actionRequired:!1},this.tokenMessageVersion=1,this.hostCallbacks=e.hostCallbacks,this.sessionManager=e.sessionManager,this.batchMessagesEnabled=e.batchMessagesEnabled||!1,this.reduceBatchOperationsEnabled=e.reduceBatchOperationsEnabled||!1,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=e.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||!1,this.operationBatchConfig=e.batchOptions?this.getOperationBatchConfig(e.batchOptions):void 0,this.extensionConfigs=e.extensionConfigs,this.clientMetadata=e.clientMetadata,this.userContext=e.userContext,this.localWorkflowManager=e.localWorkflowManager,this.annotationResultsProcessor=e.annotationResultsProcessor,this.gateUtils=e.gateUtils,this.localRegisteredWorkflows=e.localRegisteredWorkflows||[],this.enableRemoteExecutionNotification=e.enableRemoteExecutionNotification||!1,this.networkMode=e.networkMode,this.egress=e.egress,this.serverAuthenticationStateChangeCallback=[],this.claimsChallengeCallback=[],this.seedingStatusChangeCallbacks=[],this.onAnnotationsSubmittedEnabled=e.onAnnotationsSubmittedEnabled||!1,this.annotationDoesNotExistOnServiceEnabled=e.annotationDoesNotExistOnServiceEnabled||!1,this.sessionManager.on("sessionClose",this.onSessionClose.bind(this)),this.sessionManager.on("reconnect",this.onReconnect.bind(this)),this.sessionManager.on("connect",this.onConnect.bind(this)),this.sessionManager.on("disconnect",this.onDisconnect.bind(this)),this.sessionManager.on("resetNextSyncSequenceId",this.resetNextSyncSequenceId.bind(this)),this.sessionManager.on("serverAuthenticationStateChange",this.onServerAuthenticationStateChange.bind(this)),this.sessionManager.onMessage(Tt.getTypeName(),this.onAnnotationResultsFromServer.bind(this)),this.sessionManager.onMessage(ct.getTypeName(),this.onAnnotationResultStateMessage.bind(this)),this.sessionManager.onMessage(At.getTypeName(),this.onWorkflowExecutionCompleteMessage.bind(this)),this.sessionManager.onMessage(Wt.getTypeName(),this.onClaimsChallengeMessage.bind(this)),this.sessionManager.onMessage(_t.getTypeName(),this.onSeedingStatusChangeMessage.bind(this)),e.isDeltaGeneratorEnabled&&(this.enableSyncDeltaSending=!e.disableSyncDeltaSending,this.syncDeltaTimeout=null!==(t=e.syncDeltaTimeout)&&void 0!==t?t:700,this.enableDeltaGenerator()),this.setServerAuthenticationStateChangeCallback(this.updateGraphOnAuthStateChange.bind(this)),(null===(s=this.gateUtils)||void 0===s?void 0:s.isChangeGateEnabledSync(Xi))||this.setClaimsChallengeCallback(this.requestAuthTokenWithClaims.bind(this))}enabledRemoteExecutionNotification(){return this.enableRemoteExecutionNotification}getSessionReconnectParams(){if(!this.connectParams)throw new Error("Session has not been established yet.");return{sessionUrl:this.connectParams.sessionUrl,origin:this.connectParams.origin,authToken:this.connectParams.authToken,nextSyncSequenceId:this.nextSyncSequenceId}}setNextSequenceId(e){this.nextSyncSequenceId=e}tryGetDocSessionId(){if(this.clientMetadata&&this.clientMetadata.docSessionId)return this.clientMetadata.docSessionId}getSessionStateCallbackToken(e){var t;return e+"-callback-"+(null!==(t=this.tryGetDocSessionId())&&void 0!==t?t:"unknown")+"-"+this.sessionStateCallbackToken++}updateGraphOnAuthStateChange(e){this.tryActivateWorkflows()}tryActivateWorkflows(){if(this.enableRemoteExecutionNotification){const e=new g({operationName:"GraphServerWorkflowActivation",success:!0}).setClientMetadata(this.clientMetadata).start(),t=[];this.workflowGraph.getWorkflowNodes().filter(e=>e.location===on.External).forEach(e=>{this.localWorkflowManager.canActivateWorkflow(e,this)?e.isActivated=!0:(this.localWorkflowManager.deactivateServerWorkflow(e,this),t.push(e.workflow.id))}),e.resultDescription="deactivated workflows: [".concat(t.join(),"]"),O.info(508879493,Y.CoreDefault,e.stop())}}initialize(){return qn(this,void 0,void 0,function*(){return this.localWorkflowManager&&this.localWorkflowManager.addSession(this),this.registerLocalWorkflowsWithoutGraphInit(this.localRegisteredWorkflows),this.gateUtils&&!this.onConnectTelemetryCG&&(this.onConnectTelemetryCG=yield this.gateUtils.isChangeGateEnabled("OnConnectTelemetry")),yield this.sessionManager.init(this.extensionConfigs,this.hostCallbacks.onInitSession?this.hostCallbacks.onInitSession:void 0,this.egress),this.localWorkflowManager&&this.localWorkflowManager.setTokenCallback(this.getAuthToken.bind(this)),this})}isLocalWorkflowRegistered(e){return this.getLocalRegisteredWorkflows().some(t=>e===t.id)}get isConnected(){return!!this.connectParams}get hasConnected(){return this.hasSessionConnected}get isClosed(){return this.isSessionClosed}getServerAuthenticationState(){return this.serverAuthenticationState}getContextIdManager(){return this.contextIdManager}getWorkflowItemStorage(){return this.workflowItemStorage}getWorkflowDefinition(e,t){return this.workflowDefinitionManager.getWorkflowDefinition(e,t)}registerLocalWorkflows(e){this.registerLocalWorkflowsWithoutGraphInit(e),this.trySendWorkflowGraphInitMessage()}registerLocalWorkflowsWithoutGraphInit(e){if(e.length&&this.localWorkflowManager)for(const t of e)this.localWorkflowManager.registerLocalWorkflow(t,this)}registerLocalWorkflow(e){this.registerLocalWorkflows([e]);const t=new g({operationName:"SessionRegisterLocalWorkflow",resourceId:e.id,success:!0}).setClientMetadata(this.clientMetadata).start();Jn(t)}activateAnnotation(e,t,s){var o;const n=new Xo(this.sendMessageToSession.bind(this),e,t,this.annotationDoesNotExistOnServiceEnabled),i=(t,s)=>{let o=t.get(e);o||(o=new Map,t.set(e,o)),o.set(n.token,s)};(null===t||void 0===t?void 0:t.callback)&&i(this.annotationCallbacks,null===t||void 0===t?void 0:t.callback),(null===t||void 0===t?void 0:t.apologyCallback)&&i(this.apologyCallbacks,null===t||void 0===t?void 0:t.apologyCallback);const r=null!==(o=this.tokensByAnnotationType.get(e))&&void 0!==o?o:[];return-1===r.indexOf(n.token)&&r.push(n.token),this.tokensByAnnotationType.set(e,r),this.annotationActivationTrackers.set(n.token,n),this.activateAnnotationForTracker(n,{ignoreExistingAnnotations:!1,sendOnlyIfConnected:!1,sendApologies:void 0!==(null===t||void 0===t?void 0:t.apologyCallback)})}activateServerRequestResponse(e,t,s){return qn(this,void 0,void 0,function*(){yield this.activateAnnotation(e,{callback:(e,s)=>{for(const o of e.items){const e=new g({operationName:"ServerRequestResponseAnnotationReceived",success:!0}).setClientMetadata(this.clientMetadata).start(),s=o.body;if(!(null===s||void 0===s?void 0:s.workflowExecutionCorrelation)){const t="Received annotation without workflowExecutionCorrelation";throw Jn(e,t),new Error(t)}let n=!1;const i=(t,o)=>{if(n){const t="Final response has already been sent for this annotation";throw Jn(e,t),new Error(t)}n=void 0===o||o;const i=new Ht({workflowExecutionCorrelation:s.workflowExecutionCorrelation,finalResponse:n,content:t}),r=this.submitCustomMessage(i).catch(t=>{throw Jn(e,"Error submitting response: ".concat(t.message)),t});return o&&Jn(e),r};null===t||void 0===t||t.onAnnotationCallback(s,i).catch(t=>{Jn(e,"Error in onAnnotationCallback: ".concat(t.message))})}}},s)})}activateAnnotationForTracker(e,t){const s=new g({operationName:"ActivateAnnotation",resourceId:e.annotationType,success:!0}).setClientMetadata(this.clientMetadata).start();return s.setDataField("StartTimestamp",Date.now()),e.activate(t.ignoreExistingAnnotations,t.sendOnlyIfConnected,t.sendApologies).then(o=>(s.resultSignature="Ok",s.resultDescription="Activated annotation ".concat(e.annotationType," with token ").concat(e.token,"; sendOnlyIfConnected: ").concat(t.sendOnlyIfConnected),Jn(s),o)).catch(o=>{throw Jn(s,"error on activate annotation type ".concat(e.annotationType,": ").concat(o,"; sendOnlyIfConnected: ").concat(t.sendOnlyIfConnected)),o})}updateAnnotationConfig(e,t){const s=new ht({token:e,config:t});this.sendMessageToSession(s);const o=this.annotationActivationTrackers.get(e);o&&o.options&&(o.options.config=t)}releaseAnnotation(e){const t=this.annotationActivationTrackers.get(e);if(t){this.annotationActivationTrackers.delete(e);const s=s=>{const o=s.get(t.annotationType);o&&(o.delete(e),0==o.size&&s.delete(t.annotationType))};return s(this.annotationCallbacks),s(this.apologyCallbacks),t.release()}return Promise.resolve(!1)}setAnnotationState(e,t,s){const o={state:s};this.submitOperation(new hs({parentPath:e,items:[{id:t}],M_:o}))}setAnnotationMetadata(e,t,s){this.submitOperation(new hs({parentPath:e,items:[{id:t}],M_:s}))}submitOperation(e,t){this.submitOperations([e],t)}submitOperations(e,t){var s,o;if(t||(t=this.generateCorrelationId()),po(e,t,Date.now(),"SubmitInRuntimeClient",new g({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start()),this.contextIdManager.applyContextIdOnOperations(e),this.updateWorkflowExecutionStates(e),!this.onAnnotationsSubmittedEnabled){const[s,o]=this.partitionAnnotationOperations(e);this.executeCallbacksOnAnnotationSubmitted(s,t)}const n=e.filter(this.filterOperationsForSession.bind(this)).filter(Kn),i=[];if(this.deltaGenerator){const e=new g({operationName:"ExecuteDeltaGenerator",success:!0}).setClientMetadata(this.clientMetadata).start();for(const t of n)if(ps.typeGuard(t))i.push(...this.createDeltasFromUpdateOperation(t));else{const e=t;for(const n of e.items)ls.typeGuard(t)?this.deltaGenerator.addItemToLocalMap(n,e.parentPath):ds.typeGuard(t)?this.deltaGenerator.deleteItemFromLocalMap(n,e.parentPath):us.typeGuard(t)&&this.deltaGenerator.moveItemsInLocalMap(t.parentPath,t.prevParentPath,null!==(o=null===(s=t.items)||void 0===s?void 0:s.map(e=>e.id))&&void 0!==o?o:[]);i.push(t)}Jn(e)}if(this.onAnnotationsSubmittedEnabled){const[e,s]=this.partitionAnnotationOperations(i.length?i:n);this.onAnnotationsSubmitted(e,t),this.submitOperationsToSession(s,t)}else this.submitOperationsToSession(i.length?i:n,t);this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e,this,!0)}submitSeedOperations(e,t){if(!this.allowSeed)throw new Error("Cannot submit seed operations more than once per session");if(this.networkMode===wo.LocalWorkflowsOnly&&this.localWorkflowManager)return void this.localWorkflowManager.runLocalWorkflows(e,this);t||(t=this.generateCorrelationId()),this.allowSeed=!1,this.allowGroupSeed=!1;const[s,o]=this.partitionAnnotationOperations(e);this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(s,t):this.executeCallbacksOnAnnotationSubmitted(s,t),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?o:e,!0,t):this.sendMessageToSession(new gt({cv:t,seq:0,ops:this.onAnnotationsSubmittedEnabled?o:e}))}submitSeedGroupOperations(e,t,s){if(!this.allowGroupSeed)throw new Error("Seed operations are not allowed for this session");if(this.networkMode===wo.LocalWorkflowsOnly&&this.localWorkflowManager)return void this.localWorkflowManager.runLocalWorkflows(e,this);s||(s=this.generateCorrelationId()),t&&(this.allowGroupSeed=!1),this.allowSeed=!1;const[o,n]=this.partitionAnnotationOperations(e);this.executeCallbacksOnAnnotationSubmitted(o,s),this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(o,s):this.executeCallbacksOnAnnotationSubmitted(o,s),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?n:e,!!t,s):(this.seedGroupSize++,this.sendMessageToSession(new gt({cv:s,seq:0,ops:this.onAnnotationsSubmittedEnabled?n:e,groupId:"Seed",groupSize:t?this.seedGroupSize:void 0,groupComplete:t||void 0})))}submitCustomMessage(e){return new Promise((t,s)=>{this.sendMessageToSession(e,(o,n)=>{o?s(new Error("".concat(o.error,"; for message type: ").concat(De.h.getTypeNameFor(e)))):t(n)})})}submitLargeBinaryDataMessage(e){return new Promise((t,s)=>{this.sendMessageToSessionPostEndpoint(e,(e,o)=>{e?s(new Error(e.error)):t(o)})})}submitBinaryStreamUploadMessage(e){return new Promise((t,s)=>{const o=new g({operationName:"sendBinaryStreamUploadMessage",success:!0}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Gn(this.connectParams,e,o,(e,o)=>{e?s(new Error(e.error)):t(o)});else{const n=(n=>Gn(n,e,o,(e,o)=>{e?s(new Error(e.error)):t(o)})).bind(this);this.pendingConnectCallbacks.push(n)}})}requestBinaryDataForBlob(e){return e.data?Promise.resolve(e.data):e.dataPointer&&e.dataPointer.refType!==Ao.None?new Promise((t,s)=>{this.requestBinaryDataFromSessionBlobEndpoint(e.dataPointer,(e,o)=>{e?s(e):t(o)})}):Promise.reject(new Error("Blob does not have a data pointer"))}requestCacheDump(e){if(e)throw new Error("NYI");return this.submitCustomMessage(new nt)}forceReconnect(e){return this.extensionConfigs=e,this.sessionManager.forceReconnect(e)}close(e){this.isSessionClosed=!0,this.sessionManager.closeSession(e),this.localWorkflowManager&&this.localWorkflowManager.closeSession(this),this.graphInitMessageTimer&&(clearTimeout(this.graphInitMessageTimer),this.graphInitMessageTimer=void 0)}authenticateInteractive(e){return qn(this,void 0,void 0,function*(){this.gateUtils&&!this.isChangeGateForceUserInteractiveAuth&&(this.isChangeGateForceUserInteractiveAuth=yield this.gateUtils.isChangeGateEnabled("CGForceUserInteractiveAuth"));if(!(this.isChangeGateForceUserInteractiveAuth&&e&&e.forceUserPrompt)&&this.cachedClaimsChallenge.claimsVersion>0&&!this.cachedClaimsChallenge.actionRequired)return;const t=yield this.requestAuthTokenInteractive(this.cachedClaimsChallenge,{interactive:!0});if(wt.typeGuard(t))throw new Error(t.reason)})}getClientMetadata(){return this.clientMetadata}getUserContext(){return this.userContext}setSessionCloseCallback(e){const t=this.getSessionStateCallbackToken("close");return e&&this.sessionCloseCallbacks.set(t,e),t}setConnectCallback(e){const t=this.getSessionStateCallbackToken("connect");return e&&this.connectCallbacks.set(t,e),t}setDisconnectCallback(e){const t=this.getSessionStateCallbackToken("disconnect");return e&&this.disconnectCallbacks.set(t,e),t}setReconnectCallback(e){const t=this.getSessionStateCallbackToken("reconnect");return e&&this.reconnectCallbacks.set(t,e),t}removeSessionStateCallback(e){function t(t){return!!t.has(e)&&(t.delete(e),!0)}return t(this.sessionCloseCallbacks)||t(this.reconnectCallbacks)||t(this.disconnectCallbacks)||t(this.connectCallbacks)}setServerAuthenticationStateChangeCallback(e){this.serverAuthenticationStateChangeCallback.push(e),e(this.serverAuthenticationState)}setClaimsChallengeCallback(e){this.cachedClaimsChallenge.actionRequired&&e(this.cachedClaimsChallenge),this.claimsChallengeCallback.push(e)}setSeedingStatusChangeCallback(e){e(new _t({newStatus:this.seedingStatus})),this.seedingStatusChangeCallbacks.push(e)}getConnectParams(){return this.connectParams}setOfflineMode(){this.sessionManager=new Hn}onAnnotationResults(e,t,s){O.info(508916486,Y.CoreDefault,new g({operationName:"OnAnnotationResultsEgress",dimension0:null===e||void 0===e?void 0:e.annotationType,success:!0,cv:e.cv})),s(void 0,new He),t===zn.LocalWorkflow&&this.contextIdManager.applyContextIdOnOperations(e.ops),this.updateWorkflowExecutionStates(e.ops),this.egress&&this.egress(e,()=>{}),this.annotationResultsProcessor.process(e,(e,s)=>{this.applyOperationForContext(e,s,t)},(s,o)=>{const n=Date.now();this.triggerRegisteredAnnotationCallbacks(s,e.annotationType,o,e.areApologies),t===zn.ServerWorkflow&&go(e,n,"CallbackInRuntimeClient",!0,new g({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start())},e=>{if(t!==zn.ServerWorkflow){const t=e.ops.filter(this.filterOperationsForSession.bind(this)).filter(Kn);this.submitOperationsToSession(t,e.cv)}this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e.ops,this)})}onAnnotationResultStateMessage(e,t){var s;t(void 0,new He);for(const o of e.updates){const{annotationType:e,state:t}=o;if(!this.tokensByAnnotationType.has(e))continue;let n;n=this.annotationResultStates.has(e)?this.annotationResultStates.get(e):t===Fe.Idle?Fe.Pending:Fe.Idle;for(const o of this.tokensByAnnotationType.get(e)){const e=this.annotationActivationTrackers.get(o);(null===(s=e.options)||void 0===s?void 0:s.stateUpdateCallback)&&e.options.stateUpdateCallback(n,t)}}}submitOperationsToSession(e,t){t||(t=this.generateCorrelationId());const s=e.filter(e=>Cs.typeGuard(e)),o=e.filter(e=>!Cs.typeGuard(e));if(s.length>0&&this.sendMessageToSession(new gt({cv:t,ops:s})),o.length>0)if(this.operationBatchConfig){if(!this.batchedOperationsManager){let e;e=this.batchMessagesEnabled?(e,t,s)=>{if(e.length){const t=new dt;t.messages=[],e.forEach(e=>{t.messages.push(new gt({cv:e.cv,seq:this.nextSyncSequenceId++,ops:e.input}))}),this.sendMessageToSession(t,e=>{s(e?new Error(e.error):void 0)})}}:(e,t,s)=>{this.sendMessageToSession(new gt({cv:t.cv,seq:this.nextSyncSequenceId++,ops:e}),e=>{s(e?new Error(e.error):void 0)})},this.batchedOperationsManager=new Zo(e,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled,void 0,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled)}this.batchedOperationsManager.addBatchItem(o,this.operationBatchConfig,{name:"SubmitOperations"},t)}else this.sendMessageToSession(new gt({cv:t,seq:this.nextSyncSequenceId++,ops:o}))}sendMessageToSession(e,t){this.sessionManager.sendMessage(e,t),ot.typeGuard(e)&&this.close()}sendMessageToSessionPostEndpoint(e,t){const s=new g({operationName:"SendLargeBinaryDataMessage",success:!0,cv:e.cv}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Fn(this.connectParams,e,s,t);else{const o=(o=>Fn(o,e,s,t)).bind(this);this.pendingConnectCallbacks.push(o)}}requestBinaryDataFromSessionBlobEndpoint(e,t){const s=new g({operationName:"RequestBinaryData",success:!0,cv:(new pe).toString()}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Un(this.connectParams,e,t,s);else{const o=(o=>Un(o,e,t,s)).bind(this);this.pendingConnectCallbacks.push(o)}}registerContextTypes(e){for(const t of e)this.activateAnnotation(t),this.registeredContextTypes.add(t)}applyOperationForContext(e,t,s){let o=De.h.getTypeNameFor(e);if(o!=ls.getTypeName()&&o!=as.getTypeName()&&o!=ps.getTypeName()&&o!=ds.getTypeName())return;o==as.getTypeName()&&(o=ls.getTypeName());const n=tn(this.resolvePlaceholdersInOperationParentPath(e.parentPath),t),i=sn(n.parentPath);if(o==ls.getTypeName()||o==ps.getTypeName()){if(!n.body)return;const e=De.h.getTypeNameFor(n.body);if(!this.registeredContextTypes.has(e))return;let t=this.availableContexts.get(e);t||(t=new Map,this.availableContexts.set(e,t));let r=t.get(s);if(r||(r=[],t.set(s,r)),n.id||this.localWorkflowManager&&(n.id=this.localWorkflowManager.getNextClientAnnotationId()),o==ls.getTypeName())0==r.filter(e=>sn(e.parentPath)==i&&e.id==n.id).length?r.push(n):O.info(540848911,Y.CoreDefault,"AddOperation for (".concat(s,", ").concat(n.id,", ").concat(n.source,") can't be applied as the context item with matching path and ID already exists. Use UpdateOperation instead."));else for(let o=0;o<r.length;o++)if(r[o].id==n.id&&sn(r[o].parentPath)==i){if(r[o].source==n.source){r[o]=n;break}O.warn(540848912,Y.CoreDefault,"UpdateOperation for (".concat(s,", ").concat(n.id,", ").concat(n.source,") can't be applied as the context item with provided path and ID has different source: ").concat(r[o].source))}else O.warn(540848913,Y.CoreDefault,"UpdateOperation for (".concat(s,", ").concat(n.id,", ").concat(n.source,") can't be applied as the context item with matching path and ID was not found. AddOperation should be used instead"))}else if(o==ds.getTypeName()){if(!n.id)return;this.availableContexts.forEach((e,t)=>{let o=e.get(s);o&&(o=o.filter(e=>!(sn(e.parentPath)==i&&e.id==n.id)),0==o.length?e.delete(s):e.set(s,o),0==e.size?this.availableContexts.delete(t):this.availableContexts.set(t,e))})}}updateWorkflowExecutionStates(e){if(this.localWorkflowManager){const t=this.enableRemoteExecutionNotification?this.workflowGraph.getWorkflowNodes().map(e=>e.workflow):this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this);for(const s of e)if(hn.has(De.h.getTypeNameFor(s)))for(const e of s.items)for(const s of t||[])this.localWorkflowManager.preProcessItemToWorkflow(s,e,this)}}resolveRequestedContexts(e){const t=[];for(const[s,o,n]of $o(e.requestedContextTypesRules)){if(!this.availableContexts.has(s)){if(o==Wo.Required)return[!1,[]];continue}const e=Array.from(this.availableContexts.get(s).values()).reduce((e,t)=>e.concat(t),[]);if(0==e.length)throw new Error("Assert: availableContexts have the entry for ".concat(s," which does not contain any context annotation."));t.push(...e)}return[!0,this.removeDuplicatedContextItems(t)]}removeDuplicatedContextItems(e){return e.filter((e,t,s)=>s.findIndex(t=>ks.deepEquals(t,e))===t)}getContextAnnotations(e,t,s,o){var n,i;const r=s?sn(s):void 0;return null===(i=null===(n=this.availableContexts.get(e))||void 0===n?void 0:n.get(t))||void 0===i?void 0:i.filter(e=>(!r||sn(e.parentPath)==r)&&(!o||e.source==o))}onWorkflowDefinitionOverrideMessage(e){const t=new g({operationName:"WorkflowDefinitionOverride",success:!0}).setClientMetadata(this.clientMetadata).start(),s=e=>{throw Jn(t,e),Error("WorkflowDefinitionOverride: ".concat(e))};if(!this.localWorkflowManager)return void s("Not supported by this local SessionProxy instance.");const o=this.localWorkflowManager.getWorkflowDefinitionsByName(this),n=o.get(e.sourceWorkflowId);if(!n)return void s("Workflow registration for source workflow '".concat(e.targetWorkflowId,"' was not found."));t.resourceId=n.id;const i=o.get(e.targetWorkflowId);i&&(i.allowDefinitionOverride?n.definitionOverrideTargetWorkflows&&-1!==n.definitionOverrideTargetWorkflows.indexOf(i.id)?(this.workflowDefinitionManager.mergeWorkflowDefinition(i,e.definition,e.contextId),t.resultDescription="Updated config for workflow: ".concat(e.targetWorkflowId,", context id: ").concat(e.contextId),Jn(t)):s("Workflow '".concat(n.id,"' does not allow workflow definition for workflow '").concat(i.id,"'.")):s("Workflow '".concat(i.id,"' does not allow workflow definition override.")))}applyContextIdOnOperations(e){this.contextIdManager.applyContextIdOnOperations(e)}attachToWorkflowGraph(e){this.addToWorkflowGraph(e),this.attachExecutionTrackerToEachWorkflow()}triggerRegisteredAnnotationCallbacks(e,t,s,o){if(this.callAnnotationCallbacks(e,t,s,o),this.hostCallbacks.onAnnotationResult)try{o?this.hostCallbacks.onApologyResult&&this.hostCallbacks.onApologyResult(e,s):this.hostCallbacks.onAnnotationResult(e,s)}catch(n){O.error(540301151,Y.CoreDefault,new g({operationName:"HostCallbackOnAnnotationResultError",dimension0:t,resultDescription:"onAnnotationResult error: ".concat(n)}))}}attachExecutionTrackerToEachWorkflow(){this.localWorkflowManager&&this.localWorkflowManager.attachExecutionTrackerToEachWorkflow(this.workflowGraph,this,this.onWorkflowExecutionComplete.bind(this))}onWorkflowExecutionCompleteMessage(e,t){t(void 0,new He),this.localWorkflowManager&&this.localWorkflowManager.onExternalWorkflowExecuted(e.contextId,e.workflowId,this)}onWorkflowExecutionComplete(e,t){}enableDeltaGenerator(){var e,t;this.deltaGenerator=null!==(e=this.deltaGenerator)&&void 0!==e?e:new xn,this.syncDeltaTimers=null!==(t=this.syncDeltaTimers)&&void 0!==t?t:new Map}createDeltasFromUpdateOperation(e){var t,s;const o=[];O.info(523776396,Y.CoreDefault,"Calling delta create for UpdateOperation under parent path [".concat(e.parentPath,"] (").concat(null===(t=e.items)||void 0===t?void 0:t.length," item(s), first item id: ").concat((null===(s=e.items)||void 0===s?void 0:s.length)>0?e.items[0].id:"(no items)",")"));let n=[...e.parentPath];for(const i of e.items){const t=[],s=this.deltaGenerator.createTextTileDeltasFromItem(i,e.parentPath);if(null===s||void 0===s?void 0:s.length){for(const o of s){const s=Dn();n=[...e.parentPath,i.id];const r={id:s,revId:i.revId,body:o,contextId:i.contextId,source:i.source};t.push(r)}t.length>0&&(o.push(new vs({parentPath:n,items:t})),this.enableSyncDeltaSending&&this.setupSyncDeltaAfterDelay(i,n,t))}else O.info(523329632,Y.CoreDefault,"Failed to create delta on item ".concat(i.id))}return o}setupSyncDeltaAfterDelay(e,t,s){var o,n,i;const r=this.syncDeltaTimers.get(e.id);r&&(clearTimeout(r),this.syncDeltaTimers.delete(e.id));const a=s.find(e=>{var t;return(null===(t=e.body)||void 0===t?void 0:t.unit)===mn.Chars});if(a){const s=a.body,r={content:"",deltaType:fn.Update,length:0,position:(null!==(o=null===s||void 0===s?void 0:s.position)&&void 0!==o?o:0)+(null!==(i=null===(n=null===s||void 0===s?void 0:s.content)||void 0===n?void 0:n.length)&&void 0!==i?i:0),unit:mn.Sentence},c=Tn.Cg.typeGuard(e.body)?new wn(r):new vn(r),l={id:Dn(),revId:e.revId,body:c,contextId:e.contextId,source:e.source},u=new vs({parentPath:t,items:[l]}),h=setTimeout((e,t)=>{this.submitOperation(e),this.syncDeltaTimers.delete(t)},this.syncDeltaTimeout,u,e.id);this.syncDeltaTimers.set(e.id,h)}}addToWorkflowGraph(e){this.workflowGraph.addWorkflow(an(e))}getAnnotations(e,t){var s,o,n;const i=null!==(s=e.cv)&&void 0!==s?s:this.sessionManager.getCorrelationVector().newChild().toString(),r=new g({operationName:"GetAnnotations",success:!0,resultSignature:"GetAnnotationsEntry",resourceId:"".concat(e.sourceInfo.featureId,"-").concat(e.sourceInfo.entryPoint),cv:i}).setClientMetadata(this.clientMetadata).start();r.setDataFields({AnnotationType:null===(o=e.annotationType)||void 0===o?void 0:o.toString(),MaxDelayMs:null===(n=e.maxDelayMs)||void 0===n?void 0:n.toString()});const a=new oo({annotationTypes:e.annotationType,transientItems:e.transientItems,configs:e.configs,maxDelayMs:e.maxDelayMs,sourceInfo:e.sourceInfo,caller:Co.Client,tryResolveUpstreamDependencies:e.tryResolveUpstreamDependencies,correlationInfo:{cvString:i},cv:i}),c=[];let l;Jn(r),this.sendMessageToSession(a,(e,s)=>{(null===t||void 0===t?void 0:t.IsCancellationRequested)||(c.push({error:e,response:s}),null===l||void 0===l||l(!0))});const u=this;let h=!1;const p=new Promise((e,s)=>{null===t||void 0===t||t.onCancel(t=>{h?e():s(new Error(Qn.requestCancelledError))})});return{[Symbol.asyncIterator](){var e,s,o,n,i,a,d;return jn(this,arguments,function*(){for(;!h;)try{0===c.length&&(yield Vn(Promise.race([new Promise(e=>l=e),p]))),r.resultSignature="AnnotationReceived";const g=c.shift();if(null===t||void 0===t?void 0:t.IsCancellationRequested)throw new Error(Qn.requestCancelledError);h=(null===(e=g.response)||void 0===e?void 0:e.finalResponse)||void 0!==g.error,r.setDataField("FinalResponse",h);const f=ho(g.response);let m,y,T;if(r.setDataField("FirstUserPerceivedResponse",f),g.error){const e="ErrorCode: ".concat(g.error.code,", Error: ").concat(g.error.error,", Retryable: ").concat(g.error.retryable);r.setDataField("ServerError",e),T=g.error.error,m={serviceError:[{code:Oe.ServerError,error:g.error.error,retryable:null===u||void 0===u?void 0:u.canBeRetried(g.error)}]}}else if((null===(o=null===(s=g.response)||void 0===s?void 0:s.errorInfo)||void 0===o?void 0:o.length)>0){const e=g.response.errorInfo.map(e=>"ErrorCode: ".concat(e.code,", Error: ").concat(e.error,", Retryable: ").concat(e.retryable,", ResourceId: ").concat(e.resourceId)).join("\n");r.setDataField("WorkflowErrors",e),T="Workflow execution error",m={serviceError:g.response.errorInfo}}else r.resultDescription="OK";if((null===(i=null===(n=g.response)||void 0===n?void 0:n.warningInfo)||void 0===i?void 0:i.length)>0){y={serviceError:g.response.warningInfo};const e=g.response.warningInfo.map(e=>"ErrorCode: ".concat(e.code,", Error: ").concat(e.error,", Retryable: ").concat(e.retryable,", ResourceId: ").concat(e.resourceId)).join("\n");r.setDataField("WorkflowWarnings",e)}Jn(r,T),yield yield Vn({content:null===(a=g.response)||void 0===a?void 0:a.content,error:null!==m&&void 0!==m?m:void 0,warning:null!==y&&void 0!==y?y:void 0,finalResponse:null===(d=g.response)||void 0===d?void 0:d.finalResponse})}catch(g){const e=g.message===Qn.requestCancelledError?Re.RequestCancelled:Re.Unknown;r.setDataField("ClientError","ErrorCode: ".concat(e,", Error: ").concat(g.message)),Jn(r,null===g||void 0===g?void 0:g.message),yield yield Vn({content:void 0,error:{clientError:{code:e,error:null===g||void 0===g?void 0:g.message}}}),h=!0;break}})}}}isHttpFallback(){const e=this.sessionManager.getNetworkWorkerManager();return!(!e||e.getInitNetworkMode()!==wo.JSWebSockets||e.getNetworkMode()!==wo.HttpFallback)}canBeRetried(e){return(null===e||void 0===e?void 0:e.code)===Be.TooManyRequests||(null===e||void 0===e?void 0:e.code)===Be.RequestTimeout||e.error.includes(zt.ClientDisconnected)}getAuthToken(e,t){const s={Tickets:[]};this.clientMetadata.docSessionId&&(s.DocSessionId=this.clientMetadata.docSessionId);const o=(e=>{if(e===f.Substrate)return Io.Substrate})(e);o&&(s.TokenType=o),this.hostCallbacks.requestAuthToken(s).then(s=>{var o;if(!s)throw new Error("Missing AuthTokenResponse from requestAuthToken");if(!s.Token)throw new Error("Missing Token from requestAuthToken");t(void 0,s.Token,{returnedTokenType:e,timeToLiveSec:null===(o=s.TokenProperties)||void 0===o?void 0:o.timeToLiveSec})}).catch(e=>{t(e)})}resetNextSyncSequenceId(){this.nextSyncSequenceId=1}onReconnect(){if(this.annotationActivationTrackers.forEach(e=>{var t;this.activateAnnotationForTracker(e,{ignoreExistingAnnotations:!0,sendOnlyIfConnected:!0,sendApologies:void 0!==(null===(t=e.options)||void 0===t?void 0:t.apologyCallback)}).catch(()=>{})}),this.reconnectCallbacks.forEach((e,t)=>{e()}),!this.connectParams)throw new Error("Expected onConnect before onReconnect")}onSessionClose(e){this.isSessionClosed=!0,this.connectParams=void 0,this.sessionCloseCallbacks.forEach((t,s)=>{t(e)})}onConnect(e,t,s,o,n,i,r){const a=new g({operationName:"OnConnect",success:!0}).setClientMetadata(this.clientMetadata).start();a.setDataField("HasSessionConnected",this.hasSessionConnected),a.setDataField("IsSeedingRequired",e),a.setDataField("SeedingStatus",this.seedingStatus);let c=!1;e&&(this.hasSessionConnected&&(this.allowSeed=!0,this.allowGroupSeed=!0,c=this.changeSeedingStatus(Ge.NotStarted,"ReconnectReset",!1),this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.seedBatchedOperationsManager&&(this.seedBatchedOperationsManager.removeAllBatchedItems(),this.seedBatchedOperationsManager=void 0),this.batchedOperationsManager&&(this.batchedOperationsManager.removeAllBatchedItems(),this.batchedOperationsManager=void 0)),this.cachedClaimsChallenge=Object.assign(Object.assign({},this.cachedClaimsChallenge),{claimsVersion:0})),this.enableRemoteExecutionNotification&&!this.hasSessionConnected&&this.addDownstreamWorkflowsIntoClientGraph(i),this.connectParams={isSeedingRequired:e,sessionUrl:t,origin:s,authToken:o,routingSessionKey:r},this.hasSessionConnected=!0,this.tryActivateWorkflows();for(const l of this.pendingConnectCallbacks)l(this.connectParams);this.connectCallbacks.forEach((n,i)=>{n(e,t,s,o,r)}),c&&this.triggerSeedingStatusChangeCallbacks(),this.serverInputTypes=n,this.onConnectTelemetryCG&&Jn(a)}onDisconnect(e){this.connectParams=void 0,this.disconnectCallbacks.forEach((t,s)=>{t(e)})}onSeedingStatusChangeMessage(e,t){t(void 0,new He),this.changeSeedingStatus(e.newStatus,"SeedingStatusChangeMessage")}changeSeedingStatus(e,t){let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const o=new g({operationName:"SeedingStatusChange",success:!0}).setClientMetadata(this.clientMetadata).start();return o.setDataField("Status",Ge[e]),o.setDataField("Reason",t),Jn(o),this.seedingStatus!=e&&(this.seedingStatus=e,s&&this.triggerSeedingStatusChangeCallbacks(),!0)}triggerSeedingStatusChangeCallbacks(){this.seedingStatusChangeCallbacks.forEach(e=>{e(new _t({newStatus:this.seedingStatus}))})}onServerAuthenticationStateChange(e){if(e!=this.serverAuthenticationState){if(this.serverAuthenticationState==bo.Authenticated&&e==bo.Pending)return;const t=new g({operationName:"ServerAuthStateChange",dimension0:bo[e],dimension1:bo[this.serverAuthenticationState],success:!0}).setClientMetadata(this.clientMetadata).start();t.resultDescription="Changing Server Authentication State newState: ".concat(bo[e],", previousState: ").concat(bo[this.serverAuthenticationState]),Jn(t),this.serverAuthenticationState=e;for(const e of this.serverAuthenticationStateChangeCallback)e(this.serverAuthenticationState)}}callAnnotationCallbacks(e,t,s,o){if(0===this.annotationCallbacks.size&&0===this.apologyCallbacks.size)return;const n=o?this.apologyCallbacks.get(t):this.annotationCallbacks.get(t);n&&n.forEach(t=>{t(e,s)})}getOperationBatchConfig(e){let t;t=this.batchMessagesEnabled?e=>({input:e,demultiplex:()=>[[]]}):e=>({input:e.filter(e=>e.length).reduce((e,t)=>e.concat(t),[]),demultiplex:()=>[[]]});return{delayMs:e.delayMs,delayMsMax:e.delayMsMax,maxInputSize:e.maxInputSize,estimateSize:On,groupingKeyExtractor:()=>"operations",multiplex:t,split:e=>{if(!(e.length<=1))return{inputs:e.reduce((e,t)=>(e.push([t]),e),[]),join:()=>[]}}}}sendSeedMessagesViaBatchManager(e,t,s){if(!this.seedBatchedOperationsManager){let e;e=this.batchMessagesEnabled?(e,t,s)=>{if(this.batchedSeedMessageGroupSize+=e.length,e.length){const o=new dt;o.messages=[],e.forEach(e=>{o.messages.push(new gt({cv:e.cv,seq:0,ops:e.input,groupId:"Seed",groupSize:t.groupComplete?this.batchedSeedMessageGroupSize:void 0,groupComplete:t.groupComplete?t.groupComplete:void 0}))}),this.sendMessageToSession(o,e=>{s(e?new Error(e.error):void 0)})}}:(e,t,s)=>{this.seedGroupSize++,this.sendMessageToSession(new gt({cv:t.cv,seq:0,ops:e,groupId:"Seed",groupSize:t.groupComplete?this.seedGroupSize:void 0,groupComplete:t.groupComplete?t.groupComplete:void 0}),e=>{s(e?new Error(e.error):void 0)})},this.seedBatchedOperationsManager=new Zo(e,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled,void 0,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled)}this.seedBatchedOperationsManager.addBatchItem(e,this.operationBatchConfig,{name:"SubmitSeedOperations"},s,t)}onAnnotationResultsFromServer(e,t){go(e,Date.now(),"ReceiveFromNetwork",!0,new g({operationName:"AugloopClientPerfTracker",success:!0}).setClientMetadata(this.clientMetadata).start()),this.onAnnotationResults(e,zn.ServerWorkflow,t)}getLocalRegisteredWorkflows(){return this.localWorkflowManager?this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this).map(e=>an(e)):[]}sendWorkflowGraphInitMessage(){const e=this.getLocalRegisteredWorkflows(),t=new g({operationName:"WorkflowGraphInit",success:!0}).setClientMetadata(this.clientMetadata).start(),s=new kt({upstreamRuntimeWorkflows:e});this.sendMessageToSession(s,(s,o)=>{s?Jn(t,s.error):(t.resultDescription="local workflows: ".concat(e.map(e=>e.id),", remote workflows: ").concat(o.downstreamRuntimeWorkflows.map(e=>e.id)),Jn(t),this.onWorkflowGraphInitResponse(o))})}trySendWorkflowGraphInitMessage(){!this.graphInitMessageTimer&&this.enableRemoteExecutionNotification&&(this.graphInitMessageTimer=setTimeout(()=>{this.graphInitMessageTimer=void 0,this.sendWorkflowGraphInitMessage()},10))}onWorkflowGraphInitResponse(e){this.addDownstreamWorkflowsIntoClientGraph(e.downstreamRuntimeWorkflows),this.tryActivateWorkflows()}addDownstreamWorkflowsIntoClientGraph(e){this.workflowGraph.removeWorkflows(!0);for(const t of e||[])this.workflowGraph.addWorkflow(t,!0);this.attachExecutionTrackerToEachWorkflow()}resolvePlaceholdersInOperationParentPath(e){let t=e;return 3==t.length&&"session"==t[0]&&"user"==t[1]&&t[2].startsWith("user_")&&(O.info(540848914,Y.CoreDefault,"Replacing user context placeholder for: ".concat(sn(e),".")),t=["session","#userContext#"]),3==t.length&&"session"==t[0]&&"user"==t[1]&&t[2].startsWith("tenant_")&&(O.info(540848915,Y.CoreDefault,"Replacing tenant context placeholder for: ".concat(sn(e),".")),t=["session","#tenantContext#"]),t}filterOperationsForSession(e){return((e,t)=>{if(!Array.isArray(t)||0===t.length)return!0;if(vs.typeGuard(e)||hs.typeGuard(e))return!0;for(const s of e.items)if(!s.body||De.h.matchesTypesFor(s.body,t))return!0;return!1})(e,this.serverInputTypes)}executeCallbacksOnAnnotationSubmitted(e,t){const{annotationOpsMap:s,apologyOpsMap:o}=this.getAnnotationOperationsByType(e);s.forEach((e,s)=>{Array.from(e).forEach(e=>this.triggerRegisteredAnnotationCallbacks(e,s,t,!1))}),o.forEach((e,s)=>{Array.from(e).forEach(e=>this.triggerRegisteredAnnotationCallbacks(e,s,t,!0))})}partitionAnnotationOperations(e){return e.reduce((e,t)=>{let[s,o]=e;return t.items.some(e=>e.body&&Zt.typeGuard(e.body))?[[...s,t],o]:[s,[...o,t]]},[[],[]])}onAnnotationsSubmitted(e,t){const{annotationOpsMap:s,apologyOpsMap:o}=this.getAnnotationOperationsByType(e);s.forEach((e,s)=>{const o=Array.from(e);this.onAnnotationResults(new Tt({annotationType:s,ops:o,cv:t,areApologies:!1}),zn.Submitted,()=>{})}),o.forEach((e,s)=>{const o=Array.from(e);this.onAnnotationResults(new Tt({annotationType:s,ops:o,cv:t,areApologies:!0}),zn.Submitted,()=>{})})}getAnnotationOperationsByType(e){const t=new Map,s=new Map;for(const o of e)for(const e of o.items)if(e.body&&Zt.typeGuard(e.body)){const n=(e,t)=>{const s=e.get(t)||new Set;s.add(o),e.set(t,s)};zo.typeGuard(e.body)?n(s,e.body.annotationTypeName):n(t,De.h.getTypeNameFor(e.body))}return{annotationOpsMap:t,apologyOpsMap:s}}onClaimsChallengeMessage(e,t){var s;const o=new g({operationName:"OnClaimsChallengeMessage",dimension0:e.claimsVersion.toString(),dimension1:e.error,success:!0}).setClientMetadata(this.clientMetadata).start(),n=e.claims&&e.claims.length>0;o.resultSignature="HasClaims: ".concat(n),o.resultDescription="Received Claims Challenge Message from Server",Jn(o),e.claimsVersion>this.cachedClaimsChallenge.claimsVersion&&(this.cachedClaimsChallenge=Object.assign(Object.assign({},e),{actionRequired:!0})),(null===(s=this.gateUtils)||void 0===s?void 0:s.isChangeGateEnabledSync(Xi))?this.requestAuthTokenInteractive(e).then(e=>{wt.typeGuard(e)&&this.invokeClaimsChallengeCallbacks()}).catch(()=>{}):this.invokeClaimsChallengeCallbacks(),t(void 0,new He)}generateCorrelationId(){return this.sessionManager.getCorrelationVector().newChild().toString()}onTokenProvisionResponse(e){if(!e)return;const t=e.tokenType&&e.tokenType==f.WacUserInfo?bo.WacUserInfoAuthenticated:bo.Authenticated;this.onServerAuthenticationStateChange(t)}invokeClaimsChallengeCallbacks(){for(const e of this.claimsChallengeCallback)e(this.cachedClaimsChallenge)}requestAuthTokenWithClaims(e){this.requestAuthTokenInteractive(e).catch(()=>{})}requestAuthTokenInteractive(e,t){var s;const o=new g({operationName:"RequestAuthTokenInteractive",success:!0,dimension0:"isInteractive: ".concat(null!==(s=null===t||void 0===t?void 0:t.interactive)&&void 0!==s&&s)}).start();o.dimension1="HasClaims: ".concat(!!e.claims&&e.claims.length>0);const n={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:Io.Augloop,ConnectParams:this.connectParams,Claims:e.claims,Interactive:null===t||void 0===t?void 0:t.interactive};return this.hostCallbacks.requestAuthToken(n).then(t=>{if(!t)throw new Error("Missing AuthTokenResponse from requestAuthToken claims");if(!t.Token)throw new Error("Missing Token from requestAuthToken claims");return o.resultSignature="Token",new vt({authToken:t.Token,version:++this.tokenMessageVersion,claimsVersion:e.claimsVersion})}).catch(t=>(o.resultSignature="NoToken",o.dimension2=t.message,new wt({reason:t.message,version:++this.tokenMessageVersion,claimsVersion:e.claimsVersion,clientHandlesResponse:!0}))).then(e=>new Promise((t,s)=>{this.sendMessageToSession(e,(n,i)=>{Jn(o,null===n||void 0===n?void 0:n.error),n?s(new Error(n.error)):(vt.typeGuard(e)&&(this.cachedClaimsChallenge.actionRequired=!1,this.onTokenProvisionResponse(i)),t(e))})}))}}Qn.requestCancelledError="Request cancelled";class Yn{}var Xn;!function(e){e[e.Anonymous=0]="Anonymous",e[e.Host=1]="Host"}(Xn||(Xn={}));class Zn{constructor(){this.timers=new Map}scheduleRefresh(e,t,s,o){let n=this.timers.get(e);n||(n={numberOfAttempts:0},this.timers.set(e,n)),n.refreshTimeoutId&&(clearTimeout(n.refreshTimeoutId),n.refreshTimeoutId=void 0),n.expiredTimeoutId&&(clearTimeout(n.expiredTimeoutId),n.expiredTimeoutId=void 0);let i=1e3*t-Zn.tokenRefreshBufferMs,r=1e3*t-Zn.tokenExpirationBufferMs;i>0?n.numberOfAttempts=0:(++n.numberOfAttempts,i=Zn.tokenRefreshBackoffIntervalMs,r=Zn.tokenExpirationBufferMs),n.numberOfAttempts<=Zn.tokenRefreshMaximumAttempts&&(n.refreshTimeoutId=setTimeout(()=>{s()},i)),o&&(n.expiredTimeoutId=setTimeout(()=>{o()},r))}clearRefreshTimeouts(){this.clearTimeouts(!1)}clearAllTimeouts(){this.clearTimeouts(!0)}clearTimeouts(e){this.timers.forEach((t,s)=>{t.refreshTimeoutId&&(clearTimeout(t.refreshTimeoutId),t.refreshTimeoutId=void 0),e&&t.expiredTimeoutId&&(clearTimeout(t.expiredTimeoutId),t.expiredTimeoutId=void 0),t.expiredTimeoutId||this.timers.delete(s)})}}Zn.tokenRefreshBufferMs=24e4,Zn.tokenExpirationBufferMs=12e4,Zn.tokenRefreshBackoffIntervalMs=3e4,Zn.tokenRefreshMaximumAttempts=3;var $n=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};class ei extends Xt.EventEmitter{constructor(e,t,s,o,n){if(super(),this.getSessionStats=e,this.clientMetadata=t,this.tokenRefreshManager=s,this.sendMessage=o,this.options=n||{},this.options.overrideSessionInitMessage=this.options.overrideSessionInitMessage||(e=>e),this.clientMetadata&&!this.clientMetadata.userSystemTimezone)try{this.clientMetadata.userSystemTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(i){}}initSession(e){e.onResponse=e.onResponse||(()=>{});const t=ks.getCurrentTimeMs(),s=this.getSessionStats().lastConnectionClose&&t-this.getSessionStats().lastConnectionClose,o=this.getSessionStats().lastSyncMessage&&t-this.getSessionStats().lastSyncMessage,n=new g({operationName:"SessionInit"}).start(),i={sessionKey:this.sessionKey,sessionId:this.clientMetadata.sessionId,timeSinceLastConnectionClose:s,timeSinceLastSyncMessage:o,isTokenRefresh:e.isTokenRefresh,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,error:void 0,isSeedingRequired:void 0,enableCreateBlobStorageContainer:this.options.createBlobStorageContainerEnabled},r=this.options.overrideSessionInitMessage(new Xe({protocolVersion:2,clientMetadata:this.clientMetadata,sessionKey:this.sessionKey,origin:this.origin,authToken:this.anonymousToken,extensionConfigs:e.extensionConfigs,returnWorkflowInputTypes:!0,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,createBlobStorageContainer:this.options.createBlobStorageContainerEnabled}));this.sendMessage(r,(t,s)=>{if(n.success=!t,n.resultSignature=this.getSessionStats().lastConnectionClose?"Reconnect":"FirstConnect",n.resourceId=ie(null===s||void 0===s?void 0:s.sliceUrl),n.setClientMetadata(this.clientMetadata),(null===s||void 0===s?void 0:s.sessionKey)&&i.sessionKey!==s.sessionKey&&(i.sessionKey=s.sessionKey),t&&(i.error=t.error),i.isSeedingRequired=this.sessionKey!==(null===s||void 0===s?void 0:s.sessionKey),n.resultDescription=JSON.stringify(i),O.info(508843779,Y.CoreDefault,n.stop()),e.onResponse(t,s),t)this.emit("serverAuthenticationStateChange",bo.NotAuthenticated);else if(e.isReconnectOnSameSlice&&s.forceReconnect)this.emit("serverAuthenticationStateChange",bo.NotAuthenticated);else{if(!s.anonymousToken||!s.tokenExpirationSeconds)return this.emit("serverAuthenticationStateChange",bo.NotAuthenticated),void O.error(508843778,Y.CoreDefault,"AL Anonymous token was not generated for the session");this.anonymousToken=s.anonymousToken,this.onSuccessfulSessionInitOnServerSide(s)}})}onSuccessfulSessionInitOnServerSide(e){var t,s;this.tokenRefreshManager.scheduleRefresh(Xn.Anonymous,e.tokenExpirationSeconds,this.initSession.bind(this,{isTokenRefresh:!0}),()=>{this.anonymousToken=void 0}),this.connectParams={isSeedingRequired:this.sessionKey!==e.sessionKey,sessionUrl:"".concat(e.sessionUrlBase,"/").concat(e.sessionKey),origin:e.origin,authToken:this.anonymousToken},(null===(t=this.options)||void 0===t?void 0:t.dontSendTokenOnReconnectChangeGate)&&e.existingTokenProvisionResponse&&(null===(s=e.existingTokenProvisionResponse)||void 0===s?void 0:s.tokenType)===f.AugLoopLowPrivilege||(this.options.sendTokenFailureMessageChangeGate?this.initHostAuthTokenNew().catch(()=>{}):this.initHostAuthToken());const o=!!this.sessionKey;this.sessionKey=e.sessionKey,this.origin=e.origin,this.emit("connect",this.connectParams.isSeedingRequired,o,this.connectParams.sessionUrl,this.connectParams.origin,this.connectParams.authToken,e.workflowInputTypes,e.downstreamRuntimeWorkflows,e.routingSessionKey),o&&this.emit("reconnect")}getAuthToken(){const e={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:Io.Augloop,ConnectParams:this.connectParams};return this.options.requestAuthToken(e).then(e=>e).catch(()=>{})}getAuthTokenNew(){const e={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:Io.Augloop,ConnectParams:this.connectParams};return this.options.requestAuthToken(e).then(e=>e)}getAuthTokenTimeoutPromise(){const e=this.options.authTokenTimeoutMs;return new Promise((t,s)=>{setTimeout(()=>{s(new Error("Host auth token provision took longer than ".concat(e," ms")))},e)})}initHostAuthToken(){const e=this.getAuthToken.bind(this);if(this.options.requestAuthToken&&e){const t=new g({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();e().then(e=>{if(e){if(!e.Token)return e.TokenError==No.TokenMissingInteractionRequired?(this.emit("serverAuthenticationStateChange",bo.TokenMissingInteractionRequired),t.resultDescription="Host auth token provision failed interaction required"):(this.emit("serverAuthenticationStateChange",bo.NotAuthenticated),t.resultDescription="Host auth token provision failed"),t.success=!1,void O.info(508843777,Y.CoreDefault,t.stop());O.info(508843776,Y.CoreDefault,t.stop()),this.sendTokenProvisionMessage(e.Token)}else t.resultDescription="TokenResponse is not set"}).catch(e=>{this.emit("serverAuthenticationStateChange",bo.NotAuthenticated),t.success=!1,t.resultDescription="Error happened while attempting to fetch host token: ".concat(e),O.error(508843747,Y.CoreDefault,t.stop())})}}initHostAuthTokenNew(){return $n(this,void 0,void 0,function*(){const e=this.getAuthTokenNew.bind(this);if(this.options.requestAuthToken&&e){const s=new g({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();let o,n,i=bo.NotAuthenticated;try{if(o=this.options.authTokenTimeoutMs>0?yield Promise.race([e(),this.getAuthTokenTimeoutPromise()]):yield e(),!o)throw new Error("TokenResponse is not set");if(!o.Token)throw o.TokenError==No.TokenMissingInteractionRequired?(i=bo.TokenMissingInteractionRequired,new Error("Host auth token provision failed interaction required")):new Error("Host auth token provision failed")}catch(t){n=t.message,this.emit("serverAuthenticationStateChange",i),s.success=!1,s.resultDescription="Error happened while attempting to fetch host token: ".concat(t)}try{n?this.sendMessage(new wt({reason:n,version:ei.initialTokenVersion,clientHandlesResponse:!0})):this.sendTokenProvisionMessage(o.Token)}catch(t){n||(n=t.message,this.emit("serverAuthenticationStateChange",i),s.success=!1,s.resultDescription="Error happened while attempting to send host token: ".concat(t))}finally{n?O.error(506074845,Y.CoreDefault,s.stop()):O.info(506074846,Y.CoreDefault,s.stop())}}})}sendTokenProvisionMessage(e){const t=new vt({authToken:e,version:ei.initialTokenVersion});this.emit("serverAuthenticationStateChange",bo.Pending),this.sendMessage(t,this.onTokenProvisionResponse.bind(this),!0)}onTokenProvisionResponse(e,t){if(e||!t||!t.tokenExpirationSeconds)return void this.emit("serverAuthenticationStateChange",bo.NotAuthenticated);const s=t.tokenType&&t.tokenType==f.WacUserInfo?bo.WacUserInfoAuthenticated:bo.Authenticated;this.emit("serverAuthenticationStateChange",s),this.tokenRefreshManager.scheduleRefresh(Xn.Host,t.tokenExpirationSeconds,this.initHostAuthToken.bind(this))}}ei.initialTokenVersion=1;class ti{constructor(e){De.h.assign(ti,this,e)}static getTypeName(){return"AugLoop_Core_Blob"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[ti.getTypeName()])}}ti.H_={T_:ti.getTypeName(),B_:ti.getBaseTypes()};class si{constructor(e){De.h.assign(si,this,e)}static getTypeName(){return"AugLoop_Core_Binary"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[si.getTypeName()])}}si.H_={T_:si.getTypeName(),B_:si.getBaseTypes()};class oi{constructor(e){De.h.assign(oi,this,e)}static getTypeName(){return"AugLoop_Core_TileGroup"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[oi.getTypeName()])}}oi.H_={T_:oi.getTypeName(),B_:oi.getBaseTypes()};class ni{constructor(e){De.h.assign(ni,this,e)}static getTypeName(){return"AugLoop_Core_Session"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ni.getTypeName()])}}ni.H_={T_:ni.getTypeName(),B_:ni.getBaseTypes()};class ii{constructor(e){De.h.assign(ii,this,e)}static getTypeName(){return"AugLoop_Core_Document"}static getBaseTypes(){return["AugLoop_Core_TileGroup"]}static typeGuard(e){return De.h.matchesTypesFor(e,[ii.getTypeName()])}}ii.H_={T_:ii.getTypeName(),B_:ii.getBaseTypes()};class ri{constructor(e){De.h.assign(ri,this,e)}static getTypeName(){return"AugLoop_Core_SubDocument"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[ri.getTypeName()])}}ri.H_={T_:ri.getTypeName(),B_:ri.getBaseTypes()};class ai{constructor(e){De.h.assign(ai,this,e)}static getTypeName(){return"AugLoop_Core_GridCell"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[ai.getTypeName()])}}ai.H_={T_:ai.getTypeName(),B_:ai.getBaseTypes()};class ci{constructor(e){De.h.assign(ci,this,e)}static getTypeName(){return"AugLoop_Core_GridNeighborhoodContext"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[ci.getTypeName()])}}ci.H_={T_:ci.getTypeName(),B_:ci.getBaseTypes()};class li{constructor(e){De.h.assign(li,this,e)}static getTypeName(){return"AugLoop_Core_ItemFilter"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[li.getTypeName()])}}li.H_={T_:li.getTypeName(),B_:li.getBaseTypes()};class ui{constructor(e){De.h.assign(ui,this,e)}static getTypeName(){return"AugLoop_Core_DynamicContext"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[ui.getTypeName()])}}ui.H_={T_:ui.getTypeName(),B_:ui.getBaseTypes()};class hi{constructor(e){De.h.assign(hi,this,e)}static getTypeName(){return"AugLoop_Core_ContextHolder"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[hi.getTypeName()])}}hi.H_={T_:hi.getTypeName(),B_:hi.getBaseTypes()};class pi{constructor(e){De.h.assign(pi,this,e)}static getTypeName(){return"AugLoop_Core_UserContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(e){return De.h.matchesTypesFor(e,[pi.getTypeName()])}}pi.H_={T_:pi.getTypeName(),B_:pi.getBaseTypes()};class di{constructor(e){De.h.assign(di,this,e)}static getTypeName(){return"AugLoop_Core_TenantContextHolder"}static getBaseTypes(){return["AugLoop_Core_ContextHolder"]}static typeGuard(e){return De.h.matchesTypesFor(e,[di.getTypeName()])}}di.H_={T_:di.getTypeName(),B_:di.getBaseTypes()};class gi{constructor(e){De.h.assign(gi,this,e)}static getTypeName(){return"AugLoop_Core_EventsHolder"}static getBaseTypes(){return[]}static typeGuard(e){return De.h.matchesTypesFor(e,[gi.getTypeName()])}}gi.H_={T_:gi.getTypeName(),B_:gi.getBaseTypes()};class fi{constructor(e){De.h.assign(fi,this,e)}static getTypeName(){return"AugLoop_Core_UserCommandsHolder"}static getBaseTypes(){return["AugLoop_Core_EventsHolder"]}static typeGuard(e){return De.h.matchesTypesFor(e,[fi.getTypeName()])}}fi.H_={T_:fi.getTypeName(),B_:fi.getBaseTypes()};var mi,yi=s(61513);!function(e){e[e.JoinContext=0]="JoinContext",e[e.Session=1]="Session"}(mi||(mi={}));Error;var Ti={util:{},roots:{default:{}}},vi=(Ti.util,Ti.roots.default||(Ti.roots.default={}),function(){function e(e){if(e)for(var t in e)null!=e[t]&&(this[t]=e[t])}return e.prototype.sessionKey="",e.prototype.annotationType="",e.prototype.annotationState=0,e.prototype.workflowId="",e.prototype.traceId="",e.getTypeUrl=function(e){return void 0===e&&(e="type.googleapis.com"),e+"/AnnotationMetaDataChangeEvent"},e}());class wi extends vi{constructor(e){super(e),this.eventName="AnnotationMetaDataChange"}}class Ci{constructor(e){this.item=e,this.operation=e.op,this.delta=e.delta,this.deltas=e.deltas,this.id=sn(this.itemPath),this.revId=e.revId}get itemPath(){return[...this.item.parentPath,this.item.id]}getModelIterator(){throw new Error("Method not implemented.")}getBody(){return this.item.body}getItemReference(){throw new Error("Method not implemented.")}getParentItem(e){throw new Error("Method not implemented.")}getParentItemBody(e){throw new Error("Method not implemented.")}getPrevItem(e,t){throw new Error("Method not implemented.")}getPrevItemBody(e,t){throw new Error("Method not implemented.")}getNextItem(e,t){throw new Error("Method not implemented.")}getNextItemBody(e,t){throw new Error("Method not implemented.")}getChildItem(e){throw new Error("Method not implemented.")}getChildItemBody(e){throw new Error("Method not implemented.")}getChildItems(e){throw new Error("Method not implemented.")}getChildItemBodies(e){throw new Error("Method not implemented.")}getSubtreeItem(e){throw new Error("Method not implemented.")}getSubtreeItemBody(e){throw new Error("Method not implemented.")}getSubtreeItems(e){throw new Error("Method not implemented.")}getSubtreeItemBodies(e){throw new Error("Method not implemented.")}getContextItem(e){throw new Error("Method not implemented.")}getContextItemBody(e){throw new Error("Method not implemented.")}getContextItems(e){throw new Error("Method not implemented.")}getContextItemBodies(e){throw new Error("Method not implemented.")}addAnnotation(e,t){throw new Error("Method not implemented.")}updateAnnotation(e,t){throw new Error("Method not implemented.")}deleteAnnotation(e){throw new Error("Method not implemented.")}loadSubtree(e){throw new Error("Method not implemented.")}getSourceTimestamp(){return this.item.sourceTimestamp}getContextId(){return this.item.contextId}}class Si{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.scopeItem=void 0,this.rootItem=void 0,this.normalizeFilter=e=>{if(!e)return e=>void 0!==e;if("function"===typeof e)throw new Error("Not implemented yet");if((e.id?1:0)+(e.ids?1:0)+(e.itemType?1:0)+(e.itemTypes?1:0)!==1)throw new Error("Exactly one condition expected on IItemFilter");if(e.itemType)return t=>t&&De.h.matchesTypesFor(t.body,[e.itemType]);if(e.itemTypes)return t=>t&&De.h.matchesTypesFor(t.body,e.itemTypes);throw new Error("Not implemented yet")},this.items=[...t,e],this.scopeItem=new Ci(e)}getItem(e){throw new Error("Method not implemented.")}getItems(e){throw new Error("Method not implemented.")}getItemBody(e){return this.getItemBodies(e)[0]}getItemBodies(e){const t=this.normalizeFilter(e);return this.items.filter(t).map(e=>e.body)}getItemByReference(e){throw new Error("Method not implemented.")}getItemBodyByReference(e){throw new Error("Method not implemented.")}}const ki=[fn.CursorUpdate,fn.FormattingUpdate,fn.OtherNonContentUpdate,fn.AttributionUpdate];function bi(e,t,s){const o=new g({operationName:"ApplyTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();try{if(!t)return o.success=!1,o.resultDescription="Unable to apply text tile delta, parent tile is undefined",void O.info(538798173,Y.CoreDefault,o.stop());if(De.h.getTypeNameFor(t)!==Tn.qf.getTypeName())return o.success=!1,o.resultDescription="Unable to apply text tile delta, parent tile is not proper type: expected ".concat(vn.getTypeName(),", received ").concat(De.h.getTypeNameFor(t)),void O.info(538798174,Y.CoreDefault,o.stop());const s=e,n=t.content;let i="";if(void 0===s.position||s.position<0)return o.success=!1,o.resultDescription="Unable to apply text tile delta, invalid text tile position",void O.info(538798175,Y.CoreDefault,o.stop());switch(s.deltaType){case fn.Add:i=s.position<n.length?"".concat(n.slice(0,s.position)).concat(s.content).concat(n.slice(s.position,n.length)):n+s.content;break;case fn.Update:s.content||s.unit!==mn.Sentence||(o.dimension0="1"),i="".concat(n.slice(0,s.position)).concat(s.content).concat(n.slice(s.position+(s.length||0),n.length));break;case fn.Delete:i="".concat(n.slice(0,s.position)).concat(n.slice(s.position+(s.length||0),n.length))}return O.info(538837071,Y.CoreDefault,o.stop()),new Tn.qf({content:i})}catch(n){return o.success=!1,o.resultDescription="Error applying text tile delta: ".concat(n),void O.info(538798176,Y.CoreDefault,o.stop())}}function Ai(e,t){var s,o,n,i,r;const a=(null===(s=t.attributionData)||void 0===s?void 0:s.ranges)||t.attributionRanges;if((null===(o=t.attributionData)||void 0===o?void 0:o.isFullUpdate)||t.deltaType!==fn.AttributionUpdate&&void 0!==a)return a;if(!(null===(n=e.attributionRanges)||void 0===n?void 0:n.length)&&!a||t.deltaType===fn.Update&&0===t.length)return e.attributionRanges;let c=e.attributionRanges?[...e.attributionRanges]:[];if(t.deltaType!==fn.AttributionUpdate){const s=Mi(e.attributionRanges,t.deltaType,t.position),o=s?c.indexOf(s):-1;-1!==o&&(s.length=t.position-s.start);const n=(null!==(i=t.content)&&void 0!==i?i:"").length,a=null!==(r=t.length)&&void 0!==r?r:0,l=t.position+a,u=t.position+n;for(const e of c.slice(o+1)){if(e.start<t.position)continue;const s=e.start+e.length;l>e.start&&(e.length=s-l),e.start=Math.max(e.start+n-a,u)}return c=c.filter(e=>e.length>0),c}const l=[];for(const h of a)0!==l.length&&l[l.length-1].start+l[l.length-1].length>=h.start?l[l.length-1].length=h.start+h.length-l[l.length-1].start:l.push({start:h.start,length:h.length});c=c.filter(e=>e.length>0&&!(e=>{for(const t of l)if(t.start<=e.start&&t.start+t.length>=e.start+e.length)return!0;return!1})(e)),null===a||void 0===a||a.forEach(e=>{c.push(e)}),c.sort((e,t)=>e.start-t.start);const u=[];for(const h of c){const e=u.length>0?u[u.length-1]:void 0;e&&e.start+e.length>h.start&&(e.length=Math.max(h.start-e.start,0)),!e||!Pi(e,h)||h.start>e.start+e.length?u.push(h):e.length+=Math.max(h.start+h.length-(e.start+e.length),0)}return u}function _i(e,t,s){var o,n,i,r;const a=new g({operationName:"ApplyFormattedTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();a.clientFlights=s;try{if(!t)return a.success=!1,a.resultDescription="Unable to apply formatted text tile delta, parent tile is undefined",void O.info(538798177,Y.CoreDefault,a.stop());if(De.h.getTypeNameFor(t)!==Tn.Cg.getTypeName())return a.success=!1,a.resultDescription="Unable to apply formatted text tile delta, parent tile is not proper type: expected ".concat(Tn.Cg.getTypeName(),", received ").concat(De.h.getTypeNameFor(t)),void O.info(538798178,Y.CoreDefault,a.stop());const s=t,c=e,l=s.content;let u="";if((void 0===c.position||c.position<0)&&!Ni(c.deltaType))return a.success=!1,a.resultDescription="Unable to apply formatted text tile delta, invalid text tile position",void O.info(538798179,Y.CoreDefault,a.stop());if(void 0===c.content&&!Ni(c.deltaType))return a.success=!1,a.resultDescription="Unable to apply formatted text tile delta, non-delete, non-formatting, non-other-non-content-update and non-cursor-update operation without content defined",void O.info(538798208,Y.CoreDefault,a.stop());if(c.deltaType===fn.Add&&0!==c.length?O.info(538798209,Y.CoreDefault,new g({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta add operation with delta length, expected length 0",success:!0})):Ni(c.deltaType)&&void 0!==c.content&&O.info(538798210,Y.CoreDefault,new g({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta delete or non-content related operation with content defined, expected undefined",success:!0})),!Ii(c.deltaType)){const e=function(e,t){var s,o,n,i;const r=Mi(e.formattedRanges,t.deltaType,t.position);let a=e.formattedRanges?[...e.formattedRanges]:[];const c=r?a.indexOf(r):-1;-1!==c&&(t.position+(t.length||0)>r.start+r.length?r.length=t.position+(null!==(s=t.content)&&void 0!==s?s:"").length-r.start:r.length+=(null!==(o=t.content)&&void 0!==o?o:"").length-(t.length||0),a[c]=r);for(const l of a.slice(c+1))l.start<t.position||(t.position+(t.length||0)>l.start?(l.length=l.start+l.length-(t.position+(t.length||0)),l.start=t.position+(null!==(n=t.content)&&void 0!==n?n:"").length):l.start+=(null!==(i=t.content)&&void 0!==i?i:"").length-(t.length||0));return a=a.filter(e=>e.length>0),a}(s,c),t=Ai(s,c);let i=s.ipPosition;switch(c.deltaType){case fn.Add:u=c.position<l.length?"".concat(l.slice(0,c.position)).concat(c.content).concat(l.slice(c.position,l.length)):l+c.content,i=c.position+c.length;break;case fn.Update:c.content||c.unit!==mn.Sentence||(a.dimension0="1"),u="".concat(l.slice(0,c.position)).concat(c.content).concat(l.slice(c.position+(null!==(o=c.length)&&void 0!==o?o:0),l.length)),i=c.position+c.content.length;break;case fn.Delete:u="".concat(l.slice(0,c.position)).concat(l.slice(c.position+(null!==(n=c.length)&&void 0!==n?n:0),l.length)),i=c.position}const r=new Tn.Cg(Object.assign(Object.assign({},s),{ipPosition:i,content:u,formattedRanges:e,attributionRanges:t,queryRange:c.queryRange}));return O.info(538837073,Y.CoreDefault,a.stop()),r}if(c.deltaType===fn.CursorUpdate)return new Tn.Cg(Object.assign(Object.assign({},s),{ipPosition:null===(i=c.cursorData)||void 0===i?void 0:i.ipPosition,isColdIp:null===(r=c.cursorData)||void 0===r?void 0:r.isColdIp}));if(c.deltaType===fn.FormattingUpdate)return new Tn.Cg(Object.assign(Object.assign({},s),{formattedRanges:c.formattedRanges}));if(c.deltaType===fn.OtherNonContentUpdate){let e;const t={};for(e in c.otherNonContentData)t[e]=c.otherNonContentData[e];return new Tn.Cg(Object.assign(Object.assign({},s),t))}return c.deltaType===fn.AttributionUpdate?new Tn.Cg(Object.assign(Object.assign({},s),{attributionRanges:Ai(s,c)})):void 0}catch(c){return a.success=!1,a.resultDescription="Error applying formatted text tile delta: ".concat(c),void O.info(538798211,Y.CoreDefault,a.stop())}}function Mi(e,t,s){const o=new g({operationName:"FindRangeForDelta",success:!0});if(o.start(),!e)return o.resultDescription="No formatted ranges found within the tile, skipping.",void O.info(538798212,Y.CoreDefault,o.stop());if(t===fn.Add){const t=e.find(e=>e.start===s&&0===e.length);if(t)return o.resultDescription="Found a zero-length formatted range for add operation with start ".concat(t.start,"."),O.info(538798213,Y.CoreDefault,o.stop()),t;s=Math.max(s-1,0)}const n=e.find(e=>0===e.length?e.start===s:e.start<=s&&s<e.start+e.length);return n?(o.resultDescription="Updating formatted range for operation with start: ".concat(n.start," and length: ").concat(n.length),O.info(538798214,Y.CoreDefault,o.stop())):(o.resultDescription="Unable to find formatted range for operation at position ".concat(s,", skipping."),O.info(538798215,Y.CoreDefault,o.stop())),n}function Ii(e){return-1!==ki.indexOf(e)}function Ni(e){return Ii(e)||fn.Delete===e}function Pi(e,t){return e.attribution.userId===t.attribution.userId&&e.attribution.timestamp===t.attribution.timestamp&&e.attribution.dataSource===t.attribution.dataSource}function Ei(e){if(!e)return new xi([],new Set,new Map,new Map);const t=e.split(";"),s=new Set,o=new Map,n=new Map;for(const i of t){const e=i.trim();if(""===e)continue;s.add(xi.normalizeName(e));const[t,...r]=e.split(":"),a=r.join(":"),c=xi.normalizeName(t);if(c){o.set(c,a);const e=xi.parseName(c);e&&e!==c&&n.set(e,c)}}return new xi(t,s,o,n)}class xi{constructor(e,t,s,o){this.originalFlights=e,this.normalizedFlights=t,this.keyValueFlightsMap=s,this.parsedFlightsMap=o}static normalizeName(e){return null===e||void 0===e?void 0:e.toLowerCase()}static parseName(e){const t=null===e||void 0===e?void 0:e.split(".");return t?t[t.length-1]:void 0}hasFlight(e){const t=xi.normalizeName(e),s=this.normalizedFlights.has(t),o=this.keyValueFlightsMap.has(t),n=this.parsedFlightsMap.has(t);return s||o||n}getBooleanValue(e,t){var s,o;const n=null===(s=this.getStringValue(e))||void 0===s?void 0:s.toLowerCase(),i=null===(o=this.getStringValue(this.parsedFlightsMap.get(xi.normalizeName(e))))||void 0===o?void 0:o.toLowerCase();return"true"===n||"true"===i||"false"!==n&&"false"!==i&&t}getIntValue(e,t){const s=this.getStringValue(e),o=Number.parseInt(s,10);return Number.isNaN(o)?t:o}getStringValue(e,t){var s;return null!==(s=this.keyValueFlightsMap.get(xi.normalizeName(e)))&&void 0!==s?s:t}getAll(){return this.originalFlights}getAllParsed(){const e=[];return this.keyValueFlightsMap.forEach((t,s)=>{const o=null===t||void 0===t?void 0:t.toLowerCase();switch(o){case"true":e.push({name:s,value:!0});break;case"false":e.push({name:s,value:!1});break;default:{const n=Number.parseInt(o,10);Number.isNaN(n)?e.push({name:s,value:t}):e.push({name:s,value:n})}}}),e}}class Di{constructor(e){this.model=e.model,this.clientMetadata=e.clientMetadata,this.userContext=e.userContext,this.site=e.site,this.getTokenCallback=e.getTokenCallback}get flights(){var e;return null!==(e=this._flights)&&void 0!==e||(this._flights=Ei(this.clientMetadata.flights)),this._flights}getToken(e,t){return this.getTokenCallback(e,t)}getTokenAsync(e){return new Promise((t,s)=>{this.getToken(e,(e,o,n)=>{e?s(e):t(Object.assign(Object.assign({},n),{token:o}))})})}}class Oi{constructor(e,t,s){this.itemsContextId=new Set,this.executionState=new Map,this.graphNode=e,this.onContextIdWorkflowExecutionComplete=t,s&&(this.itemsContextId=s.itemsContextId,this.executionState=s.executionState)}addInputItemToProcess(e){this.itemsContextId.add(e)}removeProcessedInputItem(e){this.itemsContextId.delete(e)}countItemsToProcess(e){let t=0;for(const s of this.itemsContextId)0===s.indexOf(e)&&(t+=1);return t}getExecutionState(){return this.executionState}setExecutionState(e,t){return this.graphNode.isActivated?e?(this.executionState.set(e,t),!0):(O.info(520217546,Y.CoreDefault,new g({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:"Trying to set state ".concat(t," for a undefined contextId (setExecutionState)")})),!1):(O.info(508883415,Y.CoreDefault,new g({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:"Trying to set state ".concat(t," for a not activated workflow")})),!1)}beforeWorkflowExecution(e){this.setExecutionState(e,dn.Pending)}afterWorkflowExecution(e){this.setExecutionState(e,dn.Executed)&&this.tryToCompleteWorkflowExecution(e)}clearWorkflowExecutions(){this.executionState.forEach((e,t)=>this.afterWorkflowExecution(t))}tryToCompleteWorkflowExecution(e){if(this.executionState.get(e)===dn.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.graphNode.workflow.id,e);for(const t of this.downstreamWorkflowExecutionTrackers)for(const[s,o]of t.getExecutionState())o===dn.Executed&&pn.isParentContextId(e,s)&&t.tryToCompleteWorkflowExecution(s)}}canCompleteExecution(e){for(const t of this.upstreamWorkflowExecutionTrackers)for(const s of t.getExecutionState().keys())if(pn.isParentContextId(s,e))return!1;return!0}}var Ri;!function(e){e.Unknown="",e.InputReceived="input",e.JoinMaxAnnnotation="maxAnnotation",e.JoinMaxTimeout="maxTimeout",e.JoinEarlyCompletion="earlyCompletion"}(Ri||(Ri={}));class Bi{constructor(e,t,s){this.executionTrackersByWorkflowNameBySession=new Map,this.workflowsWithSessionAffinity=new Map,this.workflowDefinitionsWithSessionAffinity=[],this.workflowsWithoutSessionAffinity=[],this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.sweepIntervalMs=200,this.sweepTimers=new Map,this.getResourceAsArrayBuffer=(e,t,s)=>this.modelDownloader?this.modelDownloader.getResourceAsArrayBuffer(e,t,s):Promise.reject(new Error("Resource Downloader never created")),this.getResourceAsURL=(e,t,s)=>this.modelDownloader?this.modelDownloader.getResourceAsURL(e,t,s):Promise.reject(new Error("Resource Downloader never created")),this.createModel=e=>(!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory()),this.inferenceService?this.inferenceService.then(t=>t.createModel(e)):Promise.reject(new Error("Inference Service never created"))),this.createModelInputs=()=>{if(!this.inferenceService&&this.inferenceServiceFactory&&(this.inferenceService=this.inferenceServiceFactory()),this.inferenceService)return this.inferenceService.then(e=>e.createInputs());throw new Error("Inference Service never created")},this.nextAnnotationId=1,this.nextSignalId=1,this.modelDownloader=e,this.inferenceServiceFactory=t,s.enableDeltas&&(this.deltaHandlers=(new Map).set(De.h.getTypeNameFor(vn),bi).set(De.h.getTypeNameFor(wn),_i),this.itemsForDelta=new Map),this.enableEarlyJoin=s.enableEarlyJoin||!1,this.site={getResourceAsArrayBuffer:this.getResourceAsArrayBuffer,getResourceAsURL:this.getResourceAsURL,createModel:this.createModel,createModelInputs:this.createModelInputs}}getNextClientAnnotationId(){return"#AC"+this.nextAnnotationId++}getNextClientSignalId(){return"#SC"+this.nextSignalId++}registerLocalWorkflow(e,t){const s=new g({operationName:"WorkflowRegistration",resourceId:e.id}).start();if(0===e.inputTypes.length)throw new Error("Invalid workflow params");t?(this.workflowsWithSessionAffinity.get(t).push(this.createWorkflowImplementation(e,t)),t.registerContextTypes($o(e.requestedContextTypesRules).map(e=>{let[t,s]=e;return t})),t.attachToWorkflowGraph(e),s.setClientMetadata(t.getClientMetadata())):(e.isStateful?(this.workflowDefinitionsWithSessionAffinity.push(e),this.workflowsWithSessionAffinity.forEach((t,s)=>{t.push(this.createWorkflowImplementation(e,s))})):this.workflowsWithoutSessionAffinity.push(this.createWorkflowImplementation(e)),this.workflowsWithSessionAffinity.forEach((t,s)=>{s.registerContextTypes($o(e.requestedContextTypesRules).map(e=>{let[t,s]=e;return t})),s.attachToWorkflowGraph(e)})),s.success=!0,O.info(572838110,Y.CoreDefault,s.stop())}getAllRegisteredWorkflowsFromSession(e){const t=[];return t.push(...this.workflowsWithoutSessionAffinity||[]),t.push(...this.workflowsWithSessionAffinity.get(e)||[]),t.map(e=>e.workflow)}getWorkflowDefinitionsByName(e){var t;const s=new Map;return null===(t=this.workflowsWithSessionAffinity.get(e))||void 0===t||t.forEach(e=>s.set(e.workflow.id,e.workflow)),s}getWorkflowDefinitionsWithSessionAffinity(){return this.workflowDefinitionsWithSessionAffinity}attachExecutionTrackerToEachWorkflow(e,t,s){const o=e.getWorkflowNodes(),n=this.executionTrackersByWorkflowNameBySession.get(t),i=(e,o)=>{if(s&&s(e,o),this.enableEarlyJoin){const e=()=>{var e;for(const s of(null===(e=this.executionTrackersByWorkflowNameBySession.get(t))||void 0===e?void 0:e.values())||[])if(s.graphNode.workflow.kind===Do.Join)for(const e of s.getExecutionState().keys())if(pn.isParentContextId(e,o))return!0;return!1};e()&&(this.cancelSweepTimer(t),this.ensureSweepTimer(t),this.sweepScopeExecutionNotifications())}};if(n){for(const e of o){const t=n.get(e.workflow.id),s=new Oi(e,i.bind(this),t);n.set(e.workflow.id,s)}for(const e of n.values())this.setDownstreamWorkflowExecutionTrackers(e,n),this.setUpstreamWorkflowExecutionTrackers(e,n)}}canActivateWorkflow(e,t){var s;return e.location===on.Local||!!t.hasConnected&&!((null===(s=e.workflow.requiredTokenTypes)||void 0===s?void 0:s.length)>0&&t.getServerAuthenticationState()===bo.NotAuthenticated)}setDownstreamWorkflowExecutionTrackers(e,t){if(void 0!==e.downstreamWorkflowExecutionTrackers)return;e.downstreamWorkflowExecutionTrackers=new Set;const{graphNode:s}=e;for(const o of s.downstreamWorkflows||[]){const s=t.get(o.workflow.id);this.setDownstreamWorkflowExecutionTrackers(s,t),e.downstreamWorkflowExecutionTrackers.add(s)}}setUpstreamWorkflowExecutionTrackers(e,t){if(void 0!==e.upstreamWorkflowExecutionTrackers)return;e.upstreamWorkflowExecutionTrackers=new Set;const{graphNode:s}=e;for(const o of s.upstreamWorkflows||[]){const s=t.get(o.workflow.id);this.setUpstreamWorkflowExecutionTrackers(s,t),e.upstreamWorkflowExecutionTrackers.add(s)}}deactivateServerWorkflow(e,t){var s,o;e.location!==on.Local&&(null===(o=null===(s=this.executionTrackersByWorkflowNameBySession.get(t))||void 0===s?void 0:s.get(e.workflow.id))||void 0===o||o.clearWorkflowExecutions(),e.isActivated=!1)}addSession(e){this.isWorkflowTrackingEnabled(e)&&this.executionTrackersByWorkflowNameBySession.set(e,new Map);const t=[];for(const s of this.workflowDefinitionsWithSessionAffinity)t.push(this.createWorkflowImplementation(s)),e.attachToWorkflowGraph(s);this.workflowsWithSessionAffinity.set(e,t);for(const s of this.workflowsWithoutSessionAffinity)e.attachToWorkflowGraph(s.workflow)}isWorkflowTrackingEnabled(e){return this.enableEarlyJoin||e.enabledRemoteExecutionNotification()}closeSession(e){this.cancelSweepTimer(e);for(const t of this.workflowsWithSessionAffinity.get(e)||[])t.workflowLambda.dispose();this.workflowsWithSessionAffinity.delete(e),this.isWorkflowTrackingEnabled(e)&&this.executionTrackersByWorkflowNameBySession.delete(e)}setTokenCallback(e){this.getAuthTokenCallback=e}preProcessItemToWorkflow(e,t,s){var o;const n=null===(o=this.executionTrackersByWorkflowNameBySession.get(s))||void 0===o?void 0:o.get(e.id);n&&(e.kind===Do.Join&&De.h.matchesTypesFor(t.body,e.inputTypes)&&n.addInputItemToProcess(t.contextId),(e.kind===Do.SingleItem&&De.h.matchesTypesFor(t.body,e.inputTypes)||e.kind===Do.Join&&De.h.matchesTypesFor(t.body,[e.collectionScopeType]))&&n.beforeWorkflowExecution(t.contextId))}isReadyToEarlyJoin(e,t,s){if(!e)return!1;const o=o=>{var n;const i=Array.from(null!==(n=o.states)&&void 0!==n?n:[]).map(e=>"".concat(e[0],": ").concat(e[1].map(e=>e.join()))).join(),r=new g({operationName:"EarlyJoinCompletion",resourceId:e.graphNode.workflow.id,joinContextId:t,success:!0}).start();r.setClientMetadata(s),r.resultDescription="isReadyToEarlyJoin (".concat(this.enableEarlyJoin,") -> hasProcessedAllInputItems: ").concat(o.hasProcessedAllInputItems,", allUpstreamComplete: ").concat(o.allUpstreamComplete,", states: ").concat(i),O.info(512550800,Y.CoreDefault,r.stop())},n=0===e.countItemsToProcess(t);if(!n)return this.enableEarlyJoin||o({hasProcessedAllInputItems:n}),!1;const{allUpstreamComplete:i,states:r}=this.areAllUpstreamWorkflowComplete(e,t);return this.enableEarlyJoin?i:(o({hasProcessedAllInputItems:n,allUpstreamComplete:i,states:r}),!1)}areAllUpstreamWorkflowComplete(e,t){const s=new Map;for(const o of e.upstreamWorkflowExecutionTrackers){const e=[];for(const[n,i]of o.getExecutionState())if(e.push([n,i]),pn.isParentContextId(t,n))return s.set(o.graphNode.workflow.id,e),{allUpstreamComplete:!1,states:s};e.length>0&&s.set(o.graphNode.workflow.id,e)}return{allUpstreamComplete:!0,states:s}}runLocalWorkflows(e,t){var s,o,n;const i=(e,s,o)=>{var n,i;const r=t.getWorkflowItemStorage(),{workflow:a}=e,c=null===(n=this.executionTrackersByWorkflowNameBySession.get(t))||void 0===n?void 0:n.get(a.id),l=a.inputTypes.concat(a.kind===Do.Join?a.collectionScopeType:[]),u=new g({operationName:"RunLocalWorkflows",success:!0,resourceId:a.id,joinContextId:s.contextId}).start();if(u.setClientMetadata(t.getClientMetadata()),De.h.matchesTypesFor(s.body,l)){const n=tn(o.parentPath,s);if(a.kind===Do.Join){if(De.h.matchesTypesFor(n.body,[a.collectionScopeType]))return r.setScopeItem(n,a),u.resultDescription="Scope item: ".concat(s.id," (").concat(De.h.getTypeNameFor(s.body),")"),O.info(524126153,Y.CoreDefault,u.stop()),void this.setScopeExecutionNotification(t,e,n);{null===c||void 0===c||c.removeProcessedInputItem(n.contextId);const e=r.getScopeItem(n.contextId,a);if(!e)return u.resultDescription="Filtered out join invalidation: out of scope type (".concat(a.collectionScopeType,"), item id: ").concat(n.id),void O.info(541173894,Y.CoreDefault,u.stop());r.addItemToWorkflowList(n,a),u.joinContextId=e.contextId,u.resultDescription="Input item: ".concat(s.id," (").concat(De.h.getTypeNameFor(s.body),")")}}if(De.h.getBaseTypesFor(n.body).indexOf(hi.getTypeName())>=0){const e=[...n.parentPath,n.id];let s=!0;for(const o of null!==(i=a.outputTypes)&&void 0!==i?i:[])if(!t.getContextAnnotations(o,zn.LocalWorkflow,e,a.id)){s=!1;break}if(s)return}const l=()=>{var o;const[i,h]=t.resolveRequestedContexts(a);if(!i)return u.resultDescription="Required contexts are not ready for ".concat(a.id,". Retrying execution in ").concat(500," milliseconds..."),O.info(545837259,Y.CoreDefault,u.stop()),void setTimeout(l,500);if(a.kind===Do.SingleItem)this.queueWorkflow({workflowInfo:e,scopeItem:n,inputItems:[n],requestedContexts:h,session:t,triggerReason:Ri.InputReceived,onCompleteCallback:this.onWorkflowExecuted.bind(this,n,a,t)}).then(()=>{O.info(509154263,Y.WorkflowDefault,u.stop())}).catch(e=>{u.resultDescription=e,O.error(572838111,Y.CoreDefault,u.stop())});else if(a.kind===Do.Join){const n=s.contextId,i=r.getScopeItem(n,e.workflow);if(!i)return u.resultDescription="No scope item for ".concat(a.id," workflow from contextId ").concat(n),void O.info(526758475,Y.CoreDefault,u.stop());const l=this.isReadyToEarlyJoin(c,i.contextId,t.getClientMetadata()),p=l?Ri.JoinEarlyCompletion:Ri.JoinMaxAnnnotation;if(r.isWorkflowReady(i.contextId,a)||l){if(!(null===(o=this.pendingScopeExecutionNotificationsByWorkflow.get(a.id))||void 0===o?void 0:o.get(i.contextId)))return u.resultDescription="Workflow ".concat(a.id,", contextId ").concat(i.contextId,", already queued, skipping new scope execution"),void O.info(528048977,Y.CoreDefault,u.stop());const s=r.getItemsToExecute(i.contextId,a);this.queueWorkflow({workflowInfo:e,scopeItem:i,inputItems:s,requestedContexts:h,session:t,triggerReason:p,onCompleteCallback:this.onWorkflowExecuted.bind(this,i,a,t)}).then(()=>{O.info(509154262,Y.WorkflowDefault,u.stop())}).catch(e=>{u.resultDescription=e,O.error(541173895,Y.CoreDefault,u.stop())}),this.pendingScopeExecutionNotificationsByWorkflow.get(a.id).delete(i.contextId),0===this.pendingScopeExecutionNotificationsByWorkflow.get(a.id).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(a.id)}}};l()}};let r=e;arguments.length>2&&void 0!==arguments[2]&&arguments[2]&&(r=[new ls({parentPath:["session"],items:[{id:"#userContext#",body:new pi}]}),new ls({parentPath:["session"],items:[{id:"#tenantContext#",body:new di}]})],t.getContextIdManager().applyContextIdOnOperations(r),r=r.concat(e));for(const a of r){const e=De.h.getTypeNameFor(a);for(const r of a.items)if(t.applyOperationForContext(a,r,zn.Submitted),e!==ds.getTypeName()){if(r.body)if(e===vs.getTypeName()&&this.deltaHandlers&&this.itemsForDelta)this.handleLocalDeltaUpdate(r,a,t);else{null===(o=this.itemsForDelta)||void 0===o||o.set(a.parentPath.concat(r.id).toString(),r);for(const e of this.workflowsWithoutSessionAffinity)i(e,r,a);for(const e of null!==(n=this.workflowsWithSessionAffinity.get(t))&&void 0!==n?n:[])i(e,r,a)}}else null===(s=this.itemsForDelta)||void 0===s||s.delete(a.parentPath.concat(r.id).toString())}}handleLocalDeltaUpdate(e,t,s){const o=new g({operationName:"LocalDeltaUpdate",dimension0:De.h.getTypeNameFor(e.body),success:!0});o.start();try{const n=this.deltaHandlers.get(De.h.getTypeNameFor(e.body)),i=this.itemsForDelta.get(t.parentPath.toString());if(n&&i){const r=t.parentPath.length>0?t.parentPath.slice(0,t.parentPath.length-1):t.parentPath,a=n(e.body,i.body);if(a){const t={id:i.id,revId:e.revId,body:a,parentPath:r,delta:e.body,contextId:e.contextId},n=new as({parentPath:t.parentPath,items:[t]});O.info(539637591,Y.CoreDefault,o.stop()),this.runLocalWorkflows([n],s)}else o.success=!1,o.resultDescription="Failed because the handler did not produce valid updated item",O.info(539637592,Y.CoreDefault,o.stop())}else o.success=!1,o.resultDescription="Failed due to lack of handler or parent item",O.info(539637593,Y.CoreDefault,o.stop())}catch(n){o.success=!1,o.resultDescription="Failed to apply delta, error: ".concat(n),O.info(539637594,Y.CoreDefault,o.stop())}}createWorkflowImplementation(e,t){const s=e.factory();return{workflow:e,workflowLambda:s,initPromise:this.initWorkflow(e.kind,s,t)}}initWorkflow(e,t,s){const o=new Di({model:void 0,clientMetadata:s?s.getClientMetadata():void 0,userContext:s?s.getUserContext():void 0,site:this.site,getTokenCallback:this.getAuthTokenCallback});return e===Do.SingleItem||e===Do.Join?t.init(this.site,o):Promise.resolve()}queueWorkflow(e){var t,s;return null===(s=null===(t=this.executionTrackersByWorkflowNameBySession.get(e.session))||void 0===t?void 0:t.get(e.workflowInfo.workflow.id))||void 0===s||s.setExecutionState(e.scopeItem.contextId,dn.Running),this.executeLocalWorkflow(e.workflowInfo,e.scopeItem,e.inputItems,e.session,e.requestedContexts,e.triggerReason).then(t=>{this.processAnnotationResults(t,e.session),e.onCompleteCallback()}).catch(t=>{throw e.onCompleteCallback(),t})}processAnnotationResults(e,t){for(const s of e)t.onAnnotationResults(s,zn.LocalWorkflow,()=>{})}executeLocalWorkflow(e,t,s,o,n,i){return new Promise((r,a)=>{var c,l,u;const h=[],p=e.workflow,d=new g({operationName:"ExecuteWorkflow",resourceId:p.id,joinContextId:null!==(c=null===t||void 0===t?void 0:t.contextId)&&void 0!==c?c:"",resultDescription:null!==i&&void 0!==i?i:"",success:!0}).setClientMetadata(o.getClientMetadata());d.start();const f=null!==(l=null===t||void 0===t?void 0:t.contextId)&&void 0!==l?l:s[0].contextId,m=null!==(u=null===t||void 0===t?void 0:t.revId)&&void 0!==u?u:s[0].revId,y=(()=>{const e=new Map;if(t&&(t.parentPath||O.error(525382231,Y.CoreDefault,"Missing scope item parent. Workflow: ".concat(p.id,". Type: ").concat(De.h.getTypeNameFor(t.body))),e.set(t.body,t)),Array.isArray(s))for(const t of s)t&&t.body&&(t.parentPath||O.error(525382232,Y.CoreDefault,"Missing parent. Workflow: ".concat(p.id,". Type: ").concat(De.h.getTypeNameFor(t.body))),e.set(t.body,t));return e})(),T=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d;if(e)return t.success=!1,t.resultDescription+="string"===typeof e?e:e.message,t.resultSignature="Exception",O.error(572838112,Y.CoreDefault,t.stop()),"string"===typeof e?new Error(e):e;O.info(572838113,Y.CoreDefault,t.stop())},v=new Di({model:new Si(s[0],n),clientMetadata:o.getClientMetadata(),userContext:o.getUserContext(),site:this.site,getTokenCallback:this.getAuthTokenCallback}),w=e=>{T(e?e.message:void 0),e?a(e):r(h)},C={setAnnotations:(n,i,r,c)=>{var l;const u=new g({operationName:"SetAnnotations",resourceId:i,joinContextId:null!==(l=null===t||void 0===t?void 0:t.contextId)&&void 0!==l?l:"",success:!0}).setClientMetadata(o.getClientMetadata());u.start();const d=t=>{O.info(555866112,Y.CoreDefault,new wi({annotationType:i,annotationState:t,workflowId:e.workflow.id}))};for(const e of r)e.metadata=Object.assign(Object.assign({},e.metadata),{state:yi.r.Created}),d(yi.r.Created);const v=y.get(n),w=De.h.getTypeNameFor(v.body),C=(()=>{var e;if(p.kind===Do.SingleItem&&s[0].body!==n){const e="Expected obj to be ".concat(s[0].body," but instead it was ").concat(n);return T(e,u),void a(T(e))}let t,l;if(Array.isArray(r))if(!p.outputTypes||p.outputTypes.indexOf(i)<0)t="Workflow said it would output one of [".concat(p.outputTypes,"] but instead output ").concat(i);else if(v)for(const s of r)De.h.matchesTypesFor(s,[Zt.getTypeName()])?De.h.getTypeNameFor(s)!==i&&(t="Workflow produced inconsistent annotation types in setAnnotations call (".concat(De.h.getTypeNameFor(s)," did not match expected ").concat(i,")")):t="Workflow produced an output that is not an annotation ".concat(De.h.getTypeNameFor(s));else t="No item provided";else t="Workflow produced an invalid annotation array";if(t)return T(t,u),void a(T(t));l=c&&c.isSessionAnnotation?["session"]:c&&c.ancestorType?v.parentPath:v.parentPath.concat(v.id);const h=[],g=[];for(const s of r){s.metadata=Object.assign(Object.assign({},s.metadata),{state:yi.r.Sent}),d(yi.r.Sent);const t=s.id,n=t?null===(e=o.getContextAnnotations(i,zn.LocalWorkflow,l,p.id))||void 0===e?void 0:e.filter(e=>{var s;return(null===(s=e.body)||void 0===s?void 0:s.id)==t}):void 0;1==(null===n||void 0===n?void 0:n.length)?1==n.length?g.push({id:n[0].id,source:p.id,revId:m,body:s,contextId:f}):O.error(545837260,Y.CoreDefault,"Assert: Multiple existing context annotations with body id ".concat(t," found for ").concat(i," and local workflow ").concat(p.id,").")):h.push({id:this.getNextClientAnnotationId(),source:p.id,revId:m,body:s,contextId:f})}const y=[];return h.length>0&&y.push(new ls({parentPath:l,items:h,parentRevId:m})),g.length>0&&y.push(new ps({parentPath:l,items:g,parentRevId:m})),new Tt({annotationType:i,ops:y})})();C?(c&&c.immediate?o.onAnnotationResults(C,zn.LocalWorkflow,()=>{}):h.push(C),(w==pi.getTypeName()||w==di.getTypeName()||De.h.matchesTypesFor(v.body,[ii.getTypeName(),ri.getTypeName()]))&&o.submitOperationsToSession(C.ops),O.info(509644822,Y.CoreDefault,u.stop())):O.info(509644823,Y.CoreDefault,u.stop())},submitSignals:e=>{const t=new g({operationName:"submitSignalsAction",resourceId:p.id,success:!0}).setClientMetadata(o.getClientMetadata());for(const o of e){const e=De.h.getTypeNameFor(o);De.h.matchesTypesFor(o,[ss.getTypeName()])||(t.resultDescription="Workflow produced an output that is not an signal (".concat(De.h.getTypeNameFor(o),")"),O.info(521413954,Y.CoreDefault,t)),p.outputTypes&&-1!==p.outputTypes.indexOf(e)||(t.resultDescription="Workflow said it would output one of [".concat(p.outputTypes,"] but instead output ").concat(e),O.info(521413953,Y.CoreDefault,t)),o.timestamp&&(Bi.logTimestampUsageByWorkflowId.has(p.id)||(Bi.logTimestampUsageByWorkflowId.add(p.id),t.resultDescription='Workflow "'.concat(p.id,'" sets signal.timeStamp'),O.info(509212803,Y.CoreDefault,t)))}const s=e.map(e=>({id:this.getNextClientSignalId(),source:p.id,revId:m,body:e,contextId:f})),n=new Cs({parentPath:["session"],parentRevId:m,items:s});o.submitOperations([n])},done:w,overrideWorkflowDefinition:(e,s,n)=>{let i;switch(n){case mi.JoinContext:if(!t.contextId){const e="ContextId is not defined for this scope item.";throw O.error(527472289,Y.CoreDefault,e),new Error(e)}i=t.contextId;break;case mi.Session:i=void 0;break;default:{const e="Defined scope is not supported. "+n;throw O.error(527472290,Y.CoreDefault,e),new Error(e)}}const r=new so({definition:s,contextId:i,sourceWorkflowId:p.id,targetWorkflowId:e});o.onWorkflowDefinitionOverrideMessage(r)},getDynamicAnnotations:void 0,setBillingDomain:void 0,sendClientRequest:void 0,sendClientRequestStreaming:void 0},S=e.workflowLambda;if(p.kind===Do.SingleItem){1!==s.length&&w(new Error("Single item workflows expect a single input")),v.delta=s[0].delta,v.deltas=s[0].deltas;try{const t=S;e.initPromise||(e.initPromise=t.init(this.site,v)),e.initPromise.then(()=>{t.execute(s[0].body,v,C)}).catch(e=>{T(e)})}catch(k){T(k)}}else if(p.kind===Do.Join){0===s.length&&w(new Error("Join workflows expect an inputs array")),v.delta=t.delta,v.deltas=t.deltas;try{const o=S;e.initPromise||(e.initPromise=o.init(this.site,v)),e.initPromise.then(()=>{o.execute(t.body,s.map(e=>e.body),v,C)}).catch(e=>{T(e)})}catch(k){T(k)}}else T("Workflow kind ".concat(p.kind," not supported"))})}ensureSweepTimer(e){if(!this.sweepTimers.get(e)){const t=setInterval(this.onSweep.bind(this),this.sweepIntervalMs);this.sweepTimers.set(e,t)}}cancelSweepTimer(e){const t=this.sweepTimers.get(e);this.sweepTimers.get(e)&&(clearInterval(t),this.sweepTimers.delete(e))}onSweep(){this.sweepScopeExecutionNotifications()}setScopeExecutionNotification(e,t,s){var o,n;const i=Date.now(),r={session:e,workflowImplementation:t,scopeItem:s,startTime:i,minTime:i+As(t.workflow.minDelayMs,1e3),maxTime:i+As(t.workflow.maxDelayMs,5e3)},a=t.workflow.kind===Do.Join?s.contextId:r.scopeItem.parentPath.concat(s.id).join("\\");this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(t.workflow.id,new Map);if(this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).get(a)){const o=new g({resultDescription:"Duplicated pending scope execution for ".concat(t.workflow.id," at ").concat(a),operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:null!==(n=null===s||void 0===s?void 0:s.contextId)&&void 0!==n?n:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();O.info(509727899,Y.CoreDefault,o.stop())}else{const n=new g({resultDescription:"New pending scope execution for ".concat(t.workflow.id," at ").concat(a),operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:null!==(o=null===s||void 0===s?void 0:s.contextId)&&void 0!==o?o:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();O.info(539883075,Y.CoreDefault,n.stop()),this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).set(a,r)}this.ensureSweepTimer(e)}sweepScopeExecutionNotifications(){var e,t;const s=new Set(Array.from(this.sweepTimers.keys()));for(const[o,n]of Array.from(this.pendingScopeExecutionNotificationsByWorkflow.entries()))for(const[i,r]of Array.from(n.entries())){const{session:n,workflowImplementation:{workflow:a}}=r,c=n.getWorkflowItemStorage(),l=new g({operationName:"LocalScopeExecutionNotification",resourceId:a.id,joinContextId:null!==(t=null===(e=r.scopeItem)||void 0===e?void 0:e.contextId)&&void 0!==t?t:"",success:!0}).setClientMetadata(n.getClientMetadata()).start(),u=()=>{var e;if(a.kind===Do.Join){const t=Date.now(),{workflow:s}=r.workflowImplementation,o=r.scopeItem.contextId,i=n.getWorkflowDefinition(s,o).maxDelayMs;return c.isWorkflowReady(o,s)?(l.resultDescription="Join Workflow: ".concat(s.id," queuing by maxAnnotation, contextId: ").concat(o),O.info(528048978,Y.CoreDefault,l.stop()),{isValid:!0,triggerReason:Ri.JoinMaxAnnnotation}):r.startTime+i<t?(l.resultDescription="Join Workflow: ".concat(s.id," queuing by maxTimeout, contextId: ").concat(o),O.info(528048979,Y.CoreDefault,l.stop()),{isValid:!0,triggerReason:Ri.JoinMaxTimeout}):this.isReadyToEarlyJoin(null===(e=this.executionTrackersByWorkflowNameBySession.get(n))||void 0===e?void 0:e.get(s.id),o,n.getClientMetadata())?(O.info(512550856,Y.CoreDefault,"Workflow: ".concat(s.id," queuing by early completion, contextId: ").concat(o,", timeout: ").concat(i)),{isValid:!0,triggerReason:Ri.JoinEarlyCompletion}):{isValid:!1,triggerReason:Ri.Unknown}}return{isValid:!0,triggerReason:Ri.Unknown}};(()=>{const{isValid:e,triggerReason:t}=u();if(!e)return!1;const[s,o]=n.resolveRequestedContexts(a);if(!s)return!1;try{if(a.kind===Do.Join){const e=r.scopeItem.contextId,s=c.getScopeItem(e,a);if(s){const i=c.getItemsToExecute(s.contextId,a);if(0===i.length)return l.resultDescription="Failed to retrieve items for workflow: ".concat(a.id,", contextId: ").concat(e,", skipping execution"),O.info(527472291,Y.CoreDefault,l.stop()),this.onWorkflowExecuted(s,a,n),!0;this.queueWorkflow({workflowInfo:r.workflowImplementation,scopeItem:s,inputItems:i,requestedContexts:o,session:n,triggerReason:t,onCompleteCallback:this.onWorkflowExecuted.bind(this,s,a,n)}).catch(e=>{l.success=!1,l.resultDescription=e.message,O.error(509092189,Y.CoreDefault,l.stop())})}else l.resultDescription="ContextId no longer exists, skipping workflow execution",O.info(539883076,Y.CoreDefault,l.stop())}else l.resultDescription="Workflow in type ".concat(a.kind," is not supported"),O.error(539883077,Y.CoreDefault,l.stop())}catch(i){l.resultDescription="Trying to execute ".concat(a.id," caused an exception: ").concat(i),O.warn(539883078,Y.CoreDefault,l.stop())}return!0})()?(this.pendingScopeExecutionNotificationsByWorkflow.get(o).delete(i),0===this.pendingScopeExecutionNotificationsByWorkflow.get(o).size&&this.pendingScopeExecutionNotificationsByWorkflow.delete(o)):s.delete(n)}if(0!==s.size)for(const o of Array.from(s)){const e=new g({resultDescription:"No pending scope notifications left, cancelling sweep timer",operationName:"LocalScopeExecutionNotification",success:!0}).start();O.debug(539883079,Y.CoreDefault,e.stop()),this.cancelSweepTimer(o)}}onExternalWorkflowExecuted(e,t,s){const o={id:"",parentPath:[],contextId:e},n={id:t};this.onWorkflowExecuted(o,n,s,!1)}onWorkflowExecuted(e,t,s){let o=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];var n,i;null===(i=null===(n=this.executionTrackersByWorkflowNameBySession.get(s))||void 0===n?void 0:n.get(t.id))||void 0===i||i.afterWorkflowExecution(e.contextId),o&&t.kind===Do.Join&&s.getWorkflowItemStorage().onWorkflowExecuted(e,t)}}class Li{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.prevSeq=-1,this.bufferingTimeMs=e,this.rejectOutdatedSequenceNumbers=t}sequence(e){return new Promise((t,s)=>{if(e<this.prevSeq){if(this.rejectOutdatedSequenceNumbers){const t=new Error("BufferingSequencer: Item out of order. Expecting seqId > ".concat(this.prevSeq,". Actual seqId ").concat(e));return t.name=Li.Rejected,void s(t)}this.prevSeq=-1}e!=this.prevSeq+1&&O.warn(542712385,Y.CoreDefault,"BufferingSequencer: got out of order sequence number. Got ".concat(e,", expected ").concat(this.prevSeq+1));const o={seq:e,resolve:t};this.insertItem(o),this.runInOrder(o,!0,!1)})}insertItem(e){if(!this.firstQueueItem)return this.firstQueueItem=e,void(this.lastQueueItem=e);let t=this.lastQueueItem,s=null;do{if(e.seq>t.seq)return e.prev=t,t.next=e,void(s?(s.prev=e,e.next=s):this.lastQueueItem=e);s=t,t=t.prev}while(t);s&&(s.prev=e),e.next=s,this.firstQueueItem=e}runInOrder(e,t,s){let o=this.prevSeq,n=!1;const i=[];for(;this.firstQueueItem;){const t=this.firstQueueItem;if(o+1!=t.seq&&(!s||t.seq>e.seq))break;o=t.seq,t.timeout&&clearTimeout(t.timeout),i.push(t),e==t&&(n=!0),this.firstQueueItem=this.firstQueueItem.next,this.firstQueueItem&&(this.firstQueueItem.prev=null)}i.length>0&&setTimeout(()=>{for(const e of i)e.resolve(e.seq)},0),this.prevSeq=o,!n&&t&&(e.timeout=setTimeout(()=>{this.runInOrder(e,!1,!0)},this.bufferingTimeMs))}}Li.Rejected="SequenceItemRejected";class Wi{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;this.bufferingTimeMs=500,this.workflowIdToSequencersMap=new Map,this.bufferingTimeMs=e}create(e){if(!e.ownerId)return null;let t=this.workflowIdToSequencersMap.get(e.ownerId);return t||(t=new Li(this.bufferingTimeMs),this.workflowIdToSequencersMap.set(e.ownerId,t)),t}}var Fi=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};class Gi{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500,t=arguments.length>1?arguments[1]:void 0;this.sequencerFactory=null!==t&&void 0!==t?t:new Wi(e)}sequence(e){var t;return Fi(this,void 0,void 0,function*(){const s=null===(t=null===e||void 0===e?void 0:e.M_)||void 0===t?void 0:t.seq;if(null===s||void 0===s)return;const o=this.sequencerFactory.create(e);o&&(yield o.sequence(e.M_.seq))})}}class Ui{constructor(e){this.annotationSequencer=null!==e&&void 0!==e?e:new Gi}process(e,t,s,o){const n=[];for(const i of e.ops){const o=[];if(null===i||void 0===i?void 0:i.items)for(const e of i.items){const s=this.annotationSequencer.sequence(e.body).then(()=>{t(i,e)});o.push(s)}n.push(Promise.all(o).then(()=>{s(i,e.cv)}))}Promise.all(n).then(()=>o(e))}}class Hi{process(e,t,s,o){for(const n of e.ops){if(null===n||void 0===n?void 0:n.items)for(const e of n.items)t(n,e);s(n,e.cv)}o(e)}}class qi{constructor(e,t,s){this.isOrderingEnabled=e,this.orderedAnnotationResultsProcessor=null!==t&&void 0!==t?t:new Ui,this.unorderedAnnotationResultsProcessor=null!==s&&void 0!==s?s:new Hi}process(e,t,s,o){this.isOrderingEnabled()?this.orderedAnnotationResultsProcessor.process(e,t,s,o):this.unorderedAnnotationResultsProcessor.process(e,t,s,o)}}var Vi=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};class ji{constructor(e,t){this.changeGatesInitialized=!1,this.hostCallbacks=e,this.changeGateMap=t||new Map}init(){return Vi(this,void 0,void 0,function*(){const e=[];this.hostCallbacks&&this.hostCallbacks.isChangeGateEnabled&&this.changeGateMap.forEach((t,s)=>{e.push(this.hostCallbacks.isChangeGateEnabled(s).then(e=>{this.changeGateMap.set(s,e)}))}),yield Promise.all(e).then(()=>{this.changeGatesInitialized=!0}).catch(e=>{})})}isFeatureEnabled(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"None";return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled(e,s).catch(()=>Promise.resolve(t)):Promise.resolve(t)}isChangeGateEnabled(e){var t;return Vi(this,void 0,void 0,function*(){return!this.changeGateMap||(this.changeGatesInitialized&&this.changeGateMap.has(e)?this.changeGateMap.get(e):!(!this.changeGatesInitialized&&(null===(t=this.hostCallbacks)||void 0===t?void 0:t.isChangeGateEnabled))||(yield this.hostCallbacks.isChangeGateEnabled(e)))})}isChangeGateEnabledSync(e){var t;if(!this.changeGatesInitialized&&(null===(t=this.hostCallbacks)||void 0===t?void 0:t.isChangeGateEnabled)){const t=new g({operationName:"GateUtilsNotInitialized",success:!1,resultDescription:"".concat(e)});O.error(505529628,Y.CoreDefault,t)}return!this.changeGateMap||(!this.changeGatesInitialized||!this.changeGateMap.has(e)||this.changeGateMap.get(e))}isChangeGatesInitialized(){return this.changeGatesInitialized}getChangeGateMap(){return this.changeGateMap}}var zi=function(e,t,s,o){return new(s||(s=Promise))(function(n,i){function r(e){try{c(o.next(e))}catch(t){i(t)}}function a(e){try{c(o.throw(e))}catch(t){i(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(r,a)}c((o=o.apply(e,t||[])).next())})};const Ji="CloseSessionsOnRuntimeUninit",Ki="ShouldAppendClientFeatureFlights",Qi="DontSendNewTokenOnReconnect",Yi="WebSocketWorkerShouldLogEgressCount",Xi="FixIncorrectInvocationOfClaimsCallbacks";class Zi{constructor(e,t,s,o){this.sessionsByDocSessionId=new Map,this.isDeltaGeneratorEnabled=!1,this.disableSyncDeltaSending=!1,this.hasBeenInitialized=!1,this.telemetryLogger=null,this.changeGateList=new Map([["SkipCheckingCachedClaimsChallenge",!0],["LogRetryMessageEvent",!0],["ImproveClientRetries",!0],["ShouldNotRetryOnSessionClosedError",!0],[Ji,!0],[Ki,!0],[Qi,!0],[Yi,!0],[Xi,!0]]),this.settings={annotationsOrderingEnabled:!0,deltaOperationsEnabled:!1,defaultBatchingEnabled:!0,batchingWith20msIntervalEnabled:!0,onAnnotationsSubmittedEnabled:!1,reduceBatchOperationsEnabled:!1,batchMessagesEnabled:!1,removeDuplicateFlights:!0,annotationDoesNotExistOnService:!0,reducedPingPongRetryEnabled:!1,maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled:!1,sendTokenFailureMessage:!0,closeSessionsOnRuntimeUninit:!1,shouldAppendClientFeatureFlights:!0,authTokenTimeoutMs:0,doNotSendNewTokenOnReconnect:!1,webSocketWorkerShouldLogEgressCount:!0,createBlobStorageContainerEnabled:!1},this.settingToChangeGateName={closeSessionsOnRuntimeUninit:Ji,shouldAppendClientFeatureFlights:Ki,doNotSendNewTokenOnReconnect:Qi,webSocketWorkerShouldLogEgressCount:Yi},this.isDownloaderCompatible=()=>"undefined"!==typeof Array&&"undefined"!==typeof Array.from&&"undefined"!==typeof URL&&"undefined"!==typeof URL.createObjectURL,o&&(this.settings=o),this.workerFactory=e||(e=>e&&e===wo.HttpFallback?new uo:new he(void 0,this.settings));const n=this.createDefaultSessionManagerFactory();this.sessionManagerFactory=function(){return(null===t||void 0===t?void 0:t(...arguments))||n(...arguments)},this.sessionFactory=s||(e=>new Qn(e))}init(e,t,n,i){var r,a,c,l,u,h,p,d,f,m;const y=new g({operationName:"InitRuntime",resourceId:ie(e),dimension1:this.hasBeenInitialized.toString()});y.start(),this.hasBeenInitialized=!0,this.hostCallbacks=n,this.gateUtils=new ji(this.hostCallbacks,this.changeGateList),this.clientMetadata=t,this.clientMetadata&&(this.clientMetadata.runtimeVersion=s(60244).r),this.telemetryLogger=new re(this.hostCallbacks),this.shouldAddLogger(y)?(O.addLogger(this.telemetryLogger),this.addLoggingAggregator(i)):(O.clearLoggers(),O.addLogger(this.telemetryLogger)),Zi.haveCalledInit=!0,this.annotationResultsProcessor=new qi(()=>this.settings.annotationsOrderingEnabled),this.inferenceServiceFactory=i.inferenceServiceFactory,y.dimension2=G(o.info).toString();const T=[];e&&(this.defaultServiceUrl=ks.convertServiceUrlToWebSocket(e),this.serviceProtocol=this.defaultServiceUrl.split(":")[0].toLowerCase()),T.push(this.gateUtils.init().then(()=>zi(this,void 0,void 0,function*(){yield Promise.all(Object.keys(this.settingToChangeGateName).map(e=>zi(this,void 0,void 0,function*(){try{const t=yield this.gateUtils.isChangeGateEnabled(this.settingToChangeGateName[e]);this.settings[e]=t}catch(t){this.settings[e]=!1}})))}))),T.push(this.isFeatureEnabled("AnnotationsOrderingEnabled",!0).then(e=>{this.settings.annotationsOrderingEnabled=e})),T.push(this.isFeatureEnabled("DefaultBatchingDisabled").then(e=>{var t;(t=this.settings).defaultBatchingEnabled&&(t.defaultBatchingEnabled=!e)})),T.push(this.isFeatureEnabled("BatchingWith20msIntervalDisabled").then(e=>{var t;(t=this.settings).batchingWith20msIntervalEnabled&&(t.batchingWith20msIntervalEnabled=!e)})),T.push(this.isFeatureEnabled("OnAnnotationsSubmittedDisabled").then(e=>{var t;(t=this.settings).onAnnotationsSubmittedEnabled&&(t.onAnnotationsSubmittedEnabled=!e)})),T.push(this.isFeatureEnabled("ReduceBatchOperationsEnabled").then(e=>{var t;(t=this.settings).reduceBatchOperationsEnabled||(t.reduceBatchOperationsEnabled=e)})),T.push(this.isFeatureEnabled("BatchMessagesEnabled").then(e=>{var t;(t=this.settings).batchMessagesEnabled||(t.batchMessagesEnabled=e)})),T.push(ks.isChangeGateEnabled(this.hostCallbacks,"AnnotationDoesNotExistOnService").then(e=>{this.settings.annotationDoesNotExistOnService=e})),T.push(ks.isFeatureEnabled(this.hostCallbacks,"ReducedPingPongRetryEnabled").then(e=>{var t;(t=this.settings).reducedPingPongRetryEnabled||(t.reducedPingPongRetryEnabled=e)})),T.push(this.isFeatureEnabled("MaxNumberOfDeltaUpdateOpsPerItemPerBatch").then(e=>{var t;(t=this.settings).maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||(t.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=e)})),T.push(ks.isChangeGateEnabled(this.hostCallbacks,"SendTokenFailureMessage").then(e=>{this.settings.sendTokenFailureMessage=e})),T.push(this.isFeatureEnabled("CreateBlobStorageContainerEnabled").then(e=>{var t;(t=this.settings).createBlobStorageContainerEnabled||(t.createBlobStorageContainerEnabled=e)}));const v={enableDeltas:!1,enableEarlyJoin:!1};T.push(Promise.all([this.isFeatureEnabled("DeltaOperationsEnabled").then(e=>v.enableDeltas=e).catch(()=>v.enableDeltas=!1),this.isFeatureEnabled("EarlyJoinCompletionEnabled").then(e=>v.enableEarlyJoin=e).catch(()=>v.enableEarlyJoin=!1)]).then(()=>{this.localWorkflowManager=new Bi(i.modelDownloader&&this.isDownloaderCompatible()?i.modelDownloader:void 0,this.inferenceServiceFactory,v)}));const w=Ei(null!==(r=t.flights)&&void 0!==r?r:"");var C;return this.isDeltaGeneratorEnabled=w.getBooleanValue("Microsoft.Office.WordOnline.AugloopDeltas",null!==(a=i.isDeltaGeneratorEnabled)&&void 0!==a&&a),this.disableSyncDeltaSending=w.getBooleanValue("Microsoft.Office.WordOnline.DisableSyncDeltaSending",null!==(c=i.disableSyncDeltaSending)&&void 0!==c&&c),this.syncDeltaTimeout=w.getIntValue("Microsoft.Office.WordOnline.SyncDeltaTimeout",i.syncDeltaTimeout),(l=this.settings).defaultBatchingEnabled&&(l.defaultBatchingEnabled=!w.getBooleanValue("DefaultBatchingDisabled",!1)),(u=this.settings).batchingWith20msIntervalEnabled&&(u.batchingWith20msIntervalEnabled=!w.getBooleanValue("BatchingWith20msIntervalDisabled",!1)),(h=this.settings).reduceBatchOperationsEnabled||(h.reduceBatchOperationsEnabled=w.getBooleanValue("ReduceBatchOperationsEnabled",!1)),(p=this.settings).batchMessagesEnabled||(p.batchMessagesEnabled=w.getBooleanValue("BatchMessagesEnabled",!1)),(d=this.settings).removeDuplicateFlights&&(d.removeDuplicateFlights=w.getBooleanValue("RemoveDuplicateFlights",!0)),(f=this.settings).reducedPingPongRetryEnabled||(f.reducedPingPongRetryEnabled=w.getBooleanValue("ReducedPingPongRetryEnabled",!1)),(m=this.settings).maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||(m.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=w.getBooleanValue("maxNumberOfDeltaUpdateOpsPerItemPerBatch",!1)),this.settings.authTokenTimeoutMs=w.getIntValue("AuthTokenTimeoutMs",0),y.setDataField("Flights",JSON.stringify(this.settings)),i&&i.loggableUrls&&(C=i.loggableUrls,oe.push(...C)),Promise.all(T).then(()=>{this.batchOptions=i.batchOptions,!this.batchOptions&&this.settings.defaultBatchingEnabled&&(this.batchOptions={delayMs:1,maxInputSize:1e6,delayMsMax:50},this.settings.batchingWith20msIntervalEnabled&&(this.batchOptions.delayMs=20)),this.batchOptions&&!this.batchOptions.delayMsMax&&(this.batchOptions.delayMsMax=50),i&&i.networkMode&&(this.networkMode=i.networkMode,i.networkMode===wo.LocalWorkflowsOnly&&(this.sessionManagerFactory=()=>new Hn)),y.dimension0=JSON.stringify(this.batchOptions),this.logOperation(y,!0)}).catch(e=>{this.logOperation(y,!1,"Error",e?e.message:"(no error)")})}getServiceProtocol(){return this.serviceProtocol}registerLocalWorkflow(e){this.localWorkflowManager.registerLocalWorkflow(e)}flushTelemetry(e){O.flushAggregators(e)}createSession(e){var t;const s=e&&e.docSessionId?e.docSessionId:Dn(),o=e&&e.documentId?e.documentId:void 0,n=this.sessionsByDocSessionId.get(s),i=new g({operationName:"CreateSession",resourceId:s,dimension1:this.hasBeenInitialized.toString()});if(i.start(),n&&!1===n.isClosed)throw this.logOperation(i,!1,"Error","docSessionId already exists"),new Error("docSessionId already exists");let r=e&&null!==(t=e.serviceUrl)&&void 0!==t?t:this.defaultServiceUrl;r=ks.convertServiceUrlToWebSocket(r),r||((e=e||{}).networkMode=wo.LocalWorkflowsOnly),!this.networkMode||void 0!==(null===e||void 0===e?void 0:e.networkMode)&&null!==(null===e||void 0===e?void 0:e.networkMode)||((e=e||{}).networkMode=this.networkMode),void 0!==(null===e||void 0===e?void 0:e.networkMode)&&null!==(null===e||void 0===e?void 0:e.networkMode)&&(null===e||void 0===e?void 0:e.networkMode)!==wo.JSWebSockets||!this.hasHttpFallbackSession()||((e=e||{}).networkMode=wo.HttpFallback);const a=Object.assign({},this.clientMetadata);if(a.docSessionId=s,o&&(a.documentId=o),e&&e.tid3pHost&&(a.tid3pHost=e.tid3pHost),e&&e.flights&&(a.flights=a.flights?a.flights+";"+e.flights:e.flights),this.settings.shouldAppendClientFeatureFlights){const e=["_acceptsClaimsChallengeMessages","_acceptsSeedingStatusChangeMessages"].join(";");a.flights=a.flights?"".concat(a.flights,";").concat(e):e}this.settings.removeDuplicateFlights&&a.flights&&(a.flights=function(e){if(!e)return"";const t=new Set,s=[];for(const o of e.split(";").reverse()){const e=o.split(":")[0],n=xi.normalizeName(e);t.has(n)||(t.add(n),s.push(o))}return s.reverse().join(";")}(a.flights)),i.setDataField("Flights",a.flights||"");const c=this.sessionFactory({hostCallbacks:this.hostCallbacks,sessionManager:this.sessionManagerFactory(a,r,e),batchOptions:this.batchOptions,extensionConfigs:(null===e||void 0===e?void 0:e.extensionConfigs)||[],clientMetadata:a,userContext:e?e.userContext:void 0,localWorkflowManager:this.localWorkflowManager,annotationResultsProcessor:this.annotationResultsProcessor,localRegisteredWorkflows:(null===e||void 0===e?void 0:e.localRegisteredWorkflows)||[],enableRemoteExecutionNotification:(null===e||void 0===e?void 0:e.enableRemoteExecutionNotification)||!1,networkMode:null===e||void 0===e?void 0:e.networkMode,egress:e?e.egress:void 0,isDeltaGeneratorEnabled:this.isDeltaGeneratorEnabled,onAnnotationsSubmittedEnabled:this.settings.onAnnotationsSubmittedEnabled,disableSyncDeltaSending:this.disableSyncDeltaSending,syncDeltaTimeout:this.syncDeltaTimeout,reduceBatchOperationsEnabled:this.settings.reduceBatchOperationsEnabled,batchMessagesEnabled:this.settings.batchMessagesEnabled,annotationDoesNotExistOnServiceEnabled:this.settings.annotationDoesNotExistOnService,maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled:this.settings.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled,gateUtils:this.gateUtils});return this.sessionsByDocSessionId.set(s,c),e&&(e.onSessionConnect&&c.setConnectCallback(e.onSessionConnect),e.onSessionDisconnect&&c.setDisconnectCallback(e.onSessionDisconnect),e.onSessionReconnect&&c.setReconnectCallback(e.onSessionReconnect),e.onSessionClose&&c.setSessionCloseCallback(e.onSessionClose),e.onServerAuthenticationStateChangeCallback&&c.setServerAuthenticationStateChangeCallback(e.onServerAuthenticationStateChangeCallback),e.onClaimsChallengeCallback&&c.setClaimsChallengeCallback(e.onClaimsChallengeCallback),e.onSeedingStatusChangeCallback&&c.setSeedingStatusChangeCallback(e.onSeedingStatusChangeCallback)),this.logOperation(i,!0),c.initialize?c.initialize():Promise.resolve(c)}getSession(e){return this.sessionsByDocSessionId.get(e)}getSessionManagerFactory(){return this.sessionManagerFactory}shouldAddLogger(e){if(Zi.haveCalledInit){const t=new Error("Runtime already initialized");return e.dimension3=t.stack,e.dimension2=G(o.info).toString(),this.logOperation(e,!1,"Error",t.message),!1}return!0}createDefaultSessionManagerFactory(){return(e,t,s)=>{if(s&&s.networkMode==wo.LocalWorkflowsOnly)return new Hn;const o=new Zn,n=new Yn;let i=()=>{O.error(573321615,Y.CoreDefault,"Unexpectedly not set sendMessage")};const r=new ei(()=>n,e,o,(e,t,s)=>{i(e,t,s)},{requestAuthToken:this.hostCallbacks.requestAuthToken,overrideSessionInitMessage:this.hostCallbacks.overrideSessionInitMessage,enableRemoteExecutionNotification:(null===s||void 0===s?void 0:s.enableRemoteExecutionNotification)||!1,sendTokenFailureMessageChangeGate:this.settings.sendTokenFailureMessage,authTokenTimeoutMs:this.settings.authTokenTimeoutMs,dontSendTokenOnReconnectChangeGate:this.settings.doNotSendNewTokenOnReconnect,createBlobStorageContainerEnabled:this.settings.createBlobStorageContainerEnabled}),a=new ko(ks.convertServiceUrlToWebSocket(t),n,this.workerFactory,r,e,o,this.settings,this.gateUtils,null===s||void 0===s?void 0:s.networkMode);return i=a.sendMessage.bind(a),a.on("disconnect",()=>o.clearRefreshTimeouts()),a.on("connect",(e,t,s,o)=>{e&&this.hostCallbacks.setSessionData&&this.hostCallbacks.setSessionData(t,s,o);const n=t.substring(t.lastIndexOf("/")+1);this.telemetryLogger.setServerSessionKey(n)}),a}}isFeatureEnabled(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"None";return ks.isFeatureEnabled(this.hostCallbacks,e,t,s)}hasHttpFallbackSession(){let e=!1;return this.sessionsByDocSessionId.forEach(t=>{t.isHttpFallback()&&(e=!0)}),e}logOperation(e,t,s,o){e.stop(),e.success=t,e.resultSignature=s,e.resultDescription=o,O.info(573321622,Y.CoreDefault,e)}addLoggingAggregator(e){var t,s,o,n;"Dogfood"!==this.clientMetadata.releaseAudienceGroup&&"Automation"!==this.clientMetadata.releaseAudienceGroup&&(O.addAggregator(ne("Operation","operationName",["ExecuteBatch","ReduceBatchOperations","ProcessResponse","LocalDeltaUpdate","ApplyFormattedTextTileDeltaForLocalWorkflows","ApplyTextTileDeltaForLocalWorkflows","FindRangeForDelta","RunModelForInferencing","GetResource","CreateTextTileDeltaFromItem","NetworkEgressControl","HttpEgress","LongPollNoOp","NetworkRateControllerAbandonedSyncMessage","NetworkRateControllerEgress","NetworkRateControllerQueueItem","NetworkRateControllerOnRateLimitResponse","NetworkRateControllerOnRateLimitError","NetworkRateControllerRateLimitsSet"],null!==(t=e.telemetryAggregationIntervalSec)&&void 0!==t?t:30)),O.addAggregator(ne("Operation","operationName",["ExecuteWorkflow","ExecuteLambda","EarlyJoinCompletion","OnLongPollMessage","OnAnnotationResultsEgress"],null!==(s=e.telemetryAggregationIntervalSec)&&void 0!==s?s:60)),O.addAggregator(ne("Operation","operationName",["LocalScopeExecutionNotification","RunLocalWorkflows","EarlyJoinCompletion","SetAnnotations","WIS.addItemOnContextIdList","WIS.setScopeItem"],null!==(o=e.telemetryAggregationIntervalSec)&&void 0!==o?o:120)),O.addAggregator(ne("SessionHealth","sessionHealthEventName",["SendMessage","ProcessMessage"],null!==(n=e.telemetryAggregationIntervalSec)&&void 0!==n?n:60)))}uninitialize(){this.settings.closeSessionsOnRuntimeUninit&&(this.sessionsByDocSessionId.forEach(e=>{e.close()}),this.sessionsByDocSessionId.clear()),this.flushTelemetry(!0),this.hostCallbacks=null,this.hasBeenInitialized=!1,this.telemetryLogger=null,Zi.haveCalledInit=!1,O.clearAggregators(),O.clearLoggers()}}new Zi;!function(){function e(t){De.h.assign(e,this,t)}e.getTypeName=function(){return"AugLoop_PlannerFileRecommendations_PlannerTaskDetails"},e.getBaseTypes=function(){return[]},e.typeGuard=function(t){return De.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()}}();var $i=function(){function e(t){De.h.assign(e,this,t)}return e.getTypeName=function(){return"AugLoop_PlannerFileRecommendations_PlannerTask"},e.getBaseTypes=function(){return[]},e.typeGuard=function(t){return De.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}(),er=s(41089),tr=function(){function e(t){De.h.assign(e,this,t)}return e.getTypeName=function(){return"AugLoop_PlannerFileRecommendations_RecommendationTraceSignal"},e.getBaseTypes=function(){return["AugLoop_Signals_Signal"]},e.typeGuard=function(t){return De.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}(),sr=s(73141),or=s(18751),nr=s(83324),ir=function(){function e(t){De.h.assign(e,this,t)}return e.getTypeName=function(){return"AugLoop_TextToImage_TextToImageTraceSignal"},e.getBaseTypes=function(){return["AugLoop_Signals_Signal"]},e.typeGuard=function(t){return De.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}(),rr=s(86178),ar=s.n(rr),cr=s(91246),lr=s(82841);class ur{get name(){return"AugLoopApi"}initialize(e,t,s){if(!this.isEnabled)return this.loggers.traceLogger.logTrace(507855490,i.k.Verbose,"Not initializing runtime client because AL is disabled"),Promise.resolve();const o={onResult:(e,t,s,o)=>{},onAnnotationResult:t=>{this.onAnnotationResultWrapper(t,e)},requestAuthToken:e=>new Promise((e,t)=>{this.authTokenProvider().then(t=>{e({Token:t})}).catch(e=>{this.loggers.traceLogger.logTrace(507855489,i.k.Error,"Failed to get an auth token from the service ".concat((0,lr.s8)(e))),t(e)})}),sendTelemetryEvent:(e,t,s,o,n,r)=>{var a,c,l,u;const h=null!==(a=null===s||void 0===s?void 0:s.ResourceId)&&void 0!==a?a:"",p=null!==(c=null===s||void 0===s?void 0:s.ResultDescription)&&void 0!==c?c:"",d=null!==(l=null===s||void 0===s?void 0:s.ResultSignature)&&void 0!==l?l:"",g=null!==(u=null===n||void 0===n?void 0:n.CV)&&void 0!==u?u:"";this.loggers.traceLogger.logTrace(507855488,i.k.Verbose,"".concat(t," [ResourceId=").concat(h,"][ResultDescription=").concat(p,"][ResultSignature=").concat(d,"][cv=").concat(g,"]"))},isFeatureEnabled:(e,t)=>Promise.resolve(!1),executeLocalLambda:(e,t,s,o)=>Promise.reject(new Error("NYI")),areLicenseFeaturesEnabled:()=>Promise.resolve(!0)};return new Promise((e,n)=>{this.runtime.init(r.B.clientSettings.augmentationLoopServiceUrl,{appName:"Planner",appPlatform:"Web",uiLanguage:t,flights:s},o,{telemetryAggregationIntervalSec:0,batchOptions:{maxInputSize:4096,delayMs:500}}).then(()=>this.initializeSession()).then(()=>{this.isInitialized=!0,e()}).catch(e=>{this.loggers.traceLogger.logTrace(507855459,i.k.Error,"Initialize AL runtime client failed [Error=".concat(e,"]")),n(e)})})}getImageRecommendations(e,t){var s;if(!this.isEnabled||!this.isInitialized)return this.loggers.traceLogger.logTrace(507855458,i.k.Verbose,"Not fetching recommended images because AL is disabled"),Promise.resolve();const o=cr.o.generate(),n=[];n[this.operationIdIndex]=o;const r=new ls({parentPath:n,items:[{id:t,body:new or.KG({content:e})}]}),a=null!==(s=this.annotationOperationTimeoutDuration[nr.to.getTypeName()])&&void 0!==s?s:this.defaultOperationTimeoutDuration;return this.submitOperationWithTimeout(r,!0,a)}getFileRecommendations(e){var t;if(!this.isEnabled||!this.isInitialized)return this.loggers.traceLogger.logTrace(507855457,i.k.Verbose,"Not fetching recommended files because AL is disabled"),Promise.resolve();const s=cr.o.generate(),o=[];o[this.operationIdIndex]=s;const n=new ls({parentPath:o,items:[{id:e.id,body:new $i(e)}]}),r=null!==(t=this.annotationOperationTimeoutDuration[er.g.getTypeName()])&&void 0!==t?t:this.defaultOperationTimeoutDuration;return this.submitOperationWithTimeout(n,!0,r)}sendFileRecommendationFeedback(e,t,s,o,a,c){const l={id:s,traceId:t,tenantId:r.B.tenantId,logicalId:o,localTime:ar()().toISOString()},u=new tr({annotationContextId:e,metadata:{interactionData:{traceSignalType:a,searchFeedback:a===sr.EE.Feedback?(0,n.A)((0,n.A)({},l),{},{feedbackResponseValue:c}):void 0,searchEntityAction:a===sr.EE.EntityAction?(0,n.A)((0,n.A)({},l),{},{eventType:c}):void 0}}}),h=new ls({parentPath:[],items:[{id:cr.o.generate(),body:u}]});this.submitOperation(h),this.loggers.traceLogger.logTrace(507855456,i.k.Verbose,"Sending FileRecommendationTraceSignal [cv=".concat(u.annotationContextId,"]"))}queueTextToImageTrace(e,t,s,o){if(this.sentImageSuggestionTraceCv.indexOf(t)>-1)return;const n={annotationContextId:t,metadata:{state:s,interactionData:s!==yi.r.Seen?{interactedWithId:e,category:o}:void 0}};this.pendingImageSuggestionsTraces[t]=n}sendPendingTextToImageTraces(){this.isEnabled&&this.isInitialized?(Object.keys(this.pendingImageSuggestionsTraces).forEach(e=>{const t=new ls({parentPath:[],items:[{id:cr.o.generate(),body:new ir(this.pendingImageSuggestionsTraces[e])}]});this.submitOperation(t),this.sentImageSuggestionTraceCv.push(e),this.loggers.traceLogger.logTrace(507855454,i.k.Verbose,"Sending TextToImageTrace [cv=".concat(e,"]"))}),this.pendingImageSuggestionsTraces={}):this.loggers.traceLogger.logTrace(507855455,i.k.Verbose,"Not sending textToImageTrace signal because AL is disabled")}initializeSession(){return new Promise((e,t)=>{this.runtime.createSession({onSessionConnect:this.onSessionConnectCallback}).then(e=>(this.session=e,Promise.all([e.activateAnnotation(nr.to.getTypeName()),e.activateAnnotation(er.g.getTypeName())]))).then(t=>{this.loggers.traceLogger.logTrace(507855453,i.k.Verbose,"Session initialized"),e()}).catch(e=>{this.loggers.traceLogger.logTrace(507855452,i.k.Error,"Initialize session failed [Error=".concat(e,"]")),t(e)})})}checkSessionHealth(){return this.session.isConnected||this.loggers.traceLogger.logTrace(507855451,i.k.Verbose,"Session is not connected"),this.session.isClosed?(this.loggers.traceLogger.logTrace(507855450,i.k.Verbose,"Session is closed, reinitializing"),this.initializeSession()):Promise.resolve()}submitOperationWithTimeout(e,t,s){const o=e.parentPath[this.operationIdIndex];return this.pendingOperations[o]=e,this.submitOperation(e),new Promise((n,r)=>{setTimeout(()=>{const a=this.pendingOperations[o];if(null!=a){var c,l;const u=De.h.getTypeNameFor(a),h=null!==(c=a.items[0])&&void 0!==c&&c.body?De.h.getTypeNameFor(null===(l=a.items[0])||void 0===l?void 0:l.body):"",p="".concat(u,".").concat(h," timed out before results were returned");return this.loggers.traceLogger.logTrace(507855449,i.k.Warning,p),delete this.pendingOperations[o],t?(this.loggers.traceLogger.logTrace(507855448,i.k.Verbose,"Retrying operation"),this.resubmitOperationWithTimeout(e,!1,s).then(n).catch(r)):r(p)}return n()},s)})}resubmitOperationWithTimeout(e,t,s){const o=cr.o.generate();return e.parentPath[this.operationIdIndex]=o,this.submitOperationWithTimeout(e,t,s)}submitOperation(e){this.checkSessionHealth().then(()=>{const t=e.parentPath.length>this.operationIdIndex?e.parentPath[this.operationIdIndex]:"";this.loggers.traceLogger.logTrace(507855447,i.k.Verbose,"Submitting operation [OperationId=".concat(t,"]")),this.session.submitOperation(e)}).catch(e=>{this.loggers.traceLogger.logTrace(507855446,i.k.Error,"Error submitting operation [Error=".concat(e,"]"))})}onAnnotationResultWrapper(e,t){const s=e.parentPath[this.operationIdIndex],o=this.pendingOperations[s];null!=o?(this.loggers.traceLogger.logTrace(507855445,i.k.Verbose,"Received annotation result [OperationId=".concat(s,"]")),t(o,e),delete this.pendingOperations[s]):this.loggers.traceLogger.logTrace(507855444,i.k.Verbose,"Annotation received after operation timeout [OperationId=".concat(s,"]"))}seedOperation(){this.loggers.traceLogger.logTrace(507855443,i.k.Verbose,"Seeding session");const e=new as({parentPath:["seed"],items:[]});this.session.submitSeedOperations([e])}constructor(e,t,s){this.loggers=s,this.defaultOperationTimeoutDuration=3e3,this.operationIdIndex=0,this.onSessionConnectCallback=e=>{this.loggers.traceLogger.logTrace(507855442,i.k.Verbose,"Session connected"),e&&this.seedOperation()},this.runtime=new Zi,this.isEnabled=e,this.authTokenProvider=t,this.isInitialized=!1,this.pendingOperations={},this.pendingImageSuggestionsTraces={},this.sentImageSuggestionTraceCv=[],this.annotationOperationTimeoutDuration={},this.annotationOperationTimeoutDuration[nr.to.getTypeName()]=4e3,this.annotationOperationTimeoutDuration[er.g.getTypeName()]=5e3}}},17283:e=>{"use strict";var t=Object.prototype.hasOwnProperty,s="~";function o(){}function n(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function i(e,t,o,i,r){if("function"!==typeof o)throw new TypeError("The listener must be a function");var a=new n(o,i||e,r),c=s?s+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function r(e,t){0===--e._eventsCount?e._events=new o:delete e._events[t]}function a(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(s=!1)),a.prototype.eventNames=function(){var e,o,n=[];if(0===this._eventsCount)return n;for(o in e=this._events)t.call(e,o)&&n.push(s?o.slice(1):o);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},a.prototype.listeners=function(e){var t=s?s+e:e,o=this._events[t];if(!o)return[];if(o.fn)return[o.fn];for(var n=0,i=o.length,r=new Array(i);n<i;n++)r[n]=o[n].fn;return r},a.prototype.listenerCount=function(e){var t=s?s+e:e,o=this._events[t];return o?o.fn?1:o.length:0},a.prototype.emit=function(e,t,o,n,i,r){var a=s?s+e:e;if(!this._events[a])return!1;var c,l,u=this._events[a],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,o),!0;case 4:return u.fn.call(u.context,t,o,n),!0;case 5:return u.fn.call(u.context,t,o,n,i),!0;case 6:return u.fn.call(u.context,t,o,n,i,r),!0}for(l=1,c=new Array(h-1);l<h;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var p,d=u.length;for(l=0;l<d;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),h){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,o);break;case 4:u[l].fn.call(u[l].context,t,o,n);break;default:if(!c)for(p=1,c=new Array(h-1);p<h;p++)c[p-1]=arguments[p];u[l].fn.apply(u[l].context,c)}}return!0},a.prototype.on=function(e,t,s){return i(this,e,t,s,!1)},a.prototype.once=function(e,t,s){return i(this,e,t,s,!0)},a.prototype.removeListener=function(e,t,o,n){var i=s?s+e:e;if(!this._events[i])return this;if(!t)return r(this,i),this;var a=this._events[i];if(a.fn)a.fn!==t||n&&!a.once||o&&a.context!==o||r(this,i);else{for(var c=0,l=[],u=a.length;c<u;c++)(a[c].fn!==t||n&&!a[c].once||o&&a[c].context!==o)&&l.push(a[c]);l.length?this._events[i]=1===l.length?l[0]:l:r(this,i)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&r(this,t)):(this._events=new o,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=s,a.EventEmitter=a,e.exports=a},18751:(e,t,s)=>{"use strict";s.d(t,{KG:()=>n});var o=s(52071),n=function(){function e(t){o.h.assign(e,this,t)}return e.getTypeName=function(){return"AugLoop_TextToImage_TextToImageSignal"},e.getBaseTypes=function(){return["AugLoop_TextToSuggestions_TextToSuggestionSignal","AugLoop_Signals_Signal"]},e.typeGuard=function(t){return o.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}();(function(){function e(t){o.h.assign(e,this,t)}e.getTypeName=function(){return"AugLoop_TextToImage_TextToGettyImageSignal"},e.getBaseTypes=function(){return["AugLoop_Signals_Signal"]},e.typeGuard=function(t){return o.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()}})(),function(){function e(t){o.h.assign(e,this,t)}e.getTypeName=function(){return"AugLoop_TextToImage_TextToMultiTierImageSignal"},e.getBaseTypes=function(){return["AugLoop_Signals_Signal"]},e.typeGuard=function(t){return o.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()}}()},34331:(e,t,s)=>{"use strict";s.d(t,{Cg:()=>i,Ne:()=>h,qf:()=>n});var o=s(52071);class n{constructor(e){o.h.assign(n,this,e)}static getTypeName(){return"AugLoop_Text_TextTile"}static getBaseTypes(){return[]}static typeGuard(e){return o.h.matchesTypesFor(e,[n.getTypeName()])}}n.H_={T_:n.getTypeName(),B_:n.getBaseTypes()};class i{constructor(e){o.h.assign(i,this,e)}static getTypeName(){return"AugLoop_Text_FormattedTextTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return o.h.matchesTypesFor(e,[i.getTypeName()])}}i.H_={T_:i.getTypeName(),B_:i.getBaseTypes()};class r{constructor(e){o.h.assign(r,this,e)}static getTypeName(){return"AugLoop_Text_InlineTile"}static getBaseTypes(){return["AugLoop_Text_TextTile"]}static typeGuard(e){return o.h.matchesTypesFor(e,[r.getTypeName()])}}r.H_={T_:r.getTypeName(),B_:r.getBaseTypes()};class a{constructor(e){o.h.assign(a,this,e)}static getTypeName(){return"AugLoop_Text_DynamicTextContext"}static getBaseTypes(){return["AugLoop_Core_DynamicContext"]}static typeGuard(e){return o.h.matchesTypesFor(e,[a.getTypeName()])}}a.H_={T_:a.getTypeName(),B_:a.getBaseTypes()};class c{constructor(e){o.h.assign(c,this,e)}static getTypeName(){return"AugLoop_Text_TaskTile"}static getBaseTypes(){return["AugLoop_Text_FormattedTextTile","AugLoop_Text_TextTile"]}static typeGuard(e){return o.h.matchesTypesFor(e,[c.getTypeName()])}}c.H_={T_:c.getTypeName(),B_:c.getBaseTypes()};class l{constructor(e){o.h.assign(l,this,e)}static getTypeName(){return"AugLoop_Text_PersonTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(e){return o.h.matchesTypesFor(e,[l.getTypeName()])}}l.H_={T_:l.getTypeName(),B_:l.getBaseTypes()};class u{constructor(e){o.h.assign(u,this,e)}static getTypeName(){return"AugLoop_Text_DateTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(e){return o.h.matchesTypesFor(e,[u.getTypeName()])}}u.H_={T_:u.getTypeName(),B_:u.getBaseTypes()};class h{constructor(e){o.h.assign(h,this,e)}static getTypeName(){return"AugLoop_Text_LinkTile"}static getBaseTypes(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}static typeGuard(e){return o.h.matchesTypesFor(e,[h.getTypeName()])}}h.H_={T_:h.getTypeName(),B_:h.getBaseTypes()};class p{constructor(e){o.h.assign(p,this,e)}static getTypeName(){return"AugLoop_Text_CommentTile"}static getBaseTypes(){return[]}static typeGuard(e){return o.h.matchesTypesFor(e,[p.getTypeName()])}}p.H_={T_:p.getTypeName(),B_:p.getBaseTypes()}},41089:(e,t,s)=>{"use strict";s.d(t,{g:()=>n});var o=s(52071),n=function(){function e(t){o.h.assign(e,this,t)}return Object.defineProperty(e.prototype,"metadata",{get:function(){return this.M_},set:function(e){this.M_=e},enumerable:!1,configurable:!0}),e.getTypeName=function(){return"AugLoop_PlannerFileRecommendations_PlannerTaskRecommendations"},e.getBaseTypes=function(){return["AugLoop_Core_Annotation"]},e.typeGuard=function(t){return o.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}()},52071:(e,t,s)=>{"use strict";s.d(t,{h:()=>o});class o{constructor(e){o.assign(o,this,e)}static getTypeName(){return"AugLoop_Core_SchemaObject"}static getBaseTypes(){return[]}static getTypeNameFor(e){return e&&e.H_?e.H_.T_:void 0}static getBaseTypesFor(e){return e&&e.H_&&e.H_.B_&&Array.isArray(e.H_.B_)?e.H_.B_:[]}static getAllTypesFor(e){const t=o.getTypeNameFor(e);return t?[t,...o.getBaseTypesFor(e)]:[]}static matchesTypesFor(e,t){if(!Array.isArray(t)||0===t.length)return!0;const s=o.getTypeNameFor(e),n=o.getBaseTypesFor(e);for(const o of t){if(o===s)return!0;if(n.indexOf(o)>=0)return!0}return!1}static assign(e,t,s){if(s)for(const o of Object.keys(s))t[o]=s[o];return t.H_=e.H_,t}}o.H_={T_:o.getTypeName(),B_:o.getBaseTypes()}},60244:e=>{"use strict";e.exports={r:"2.35.2407"}},61513:(e,t,s)=>{"use strict";var o;s.d(t,{r:()=>o}),function(e){e[e.Undefined=0]="Undefined",e[e.Created=10]="Created",e[e.Sent=20]="Sent",e[e.Duplicated=30]="Duplicated",e[e.Seen=40]="Seen",e[e.Tried=50]="Tried",e[e.Kept=60]="Kept",e[e.Rejected=70]="Rejected"}(o||(o={}))},73141:(e,t,s)=>{"use strict";var o,n,i;s.d(t,{EE:()=>o,MK:()=>n,aC:()=>i}),function(e){e.Feedback="feedback",e.EntityAction="entityAction"}(o||(o={})),function(e){e.Yes="Yes",e.No="No"}(n||(n={})),function(e){e.EntityClicked="entityclicked",e.PreviewOpen="previewopen",e.PreviewClose="previewclose",e.MouseHover="mousehover"}(i||(i={}))},78299:function(e,t,s){!function(e){"use strict";function t(e){for(var t=0,s=Math.min(65536,e.length+1),o=new Uint16Array(s),n=[],i=0;;){var r=t<e.length;if(!r||i>=s-1){var a=o.subarray(0,i);if(n.push(String.fromCharCode.apply(null,a)),!r)return n.join("");e=e.subarray(t),t=0,i=0}var c=e[t++];if(0===(128&c))o[i++]=c;else if(192===(224&c)){var l=63&e[t++];o[i++]=(31&c)<<6|l}else if(224===(240&c)){l=63&e[t++];var u=63&e[t++];o[i++]=(31&c)<<12|l<<6|u}else if(240===(248&c)){var h=(7&c)<<18|(l=63&e[t++])<<12|(u=63&e[t++])<<6|63&e[t++];h>65535&&(h-=65536,o[i++]=h>>>10&1023|55296,h=56320|1023&h),o[i++]=h}}}var s="Failed to ",o=function(e,t,o){if(e)throw new Error("".concat(s).concat(t,": the '").concat(o,"' option is unsupported."))},n="function"==typeof Buffer&&Buffer.from,i=n?function(e){return Buffer.from(e)}:function(e){for(var t=0,s=e.length,o=0,n=Math.max(32,s+(s>>>1)+7),i=new Uint8Array(n>>>3<<3);t<s;){var r=e.charCodeAt(t++);if(r>=55296&&r<=56319){if(t<s){var a=e.charCodeAt(t);56320===(64512&a)&&(++t,r=((1023&r)<<10)+(1023&a)+65536)}if(r>=55296&&r<=56319)continue}if(o+4>i.length){n+=8,n=(n*=1+t/e.length*2)>>>3<<3;var c=new Uint8Array(n);c.set(i),i=c}if(0!==(4294967168&r)){if(0===(4294965248&r))i[o++]=r>>>6&31|192;else if(0===(4294901760&r))i[o++]=r>>>12&15|224,i[o++]=r>>>6&63|128;else{if(0!==(4292870144&r))continue;i[o++]=r>>>18&7|240,i[o++]=r>>>12&63|128,i[o++]=r>>>6&63|128}i[o++]=63&r|128}else i[o++]=r}return i.slice?i.slice(0,o):i.subarray(0,o)};function r(){this.encoding="utf-8"}r.prototype.encode=function(e,t){return o(t&&t.stream,"encode","stream"),i(e)};var a=!n&&"function"==typeof Blob&&"function"==typeof URL&&"function"==typeof URL.createObjectURL,c=["utf-8","utf8","unicode-1-1-utf-8"],l=t;n?l=function(e,t){return(e instanceof Buffer?e:Buffer.from(e.buffer,e.byteOffset,e.byteLength)).toString(t)}:a&&(l=function(e){try{return function(e){var t;try{var s=new Blob([e],{type:"text/plain;charset=UTF-8"});t=URL.createObjectURL(s);var o=new XMLHttpRequest;return o.open("GET",t,!1),o.send(),o.responseText}finally{t&&URL.revokeObjectURL(t)}}(e)}catch(s){return t(e)}});var u="construct 'TextDecoder'",h="".concat(s," ").concat(u,": the ");function p(e,t){if(o(t&&t.fatal,u,"fatal"),e=e||"utf-8",!(n?Buffer.isEncoding(e):-1!==c.indexOf(e.toLowerCase())))throw new RangeError("".concat(h," encoding label provided ('").concat(e,"') is invalid."));this.encoding=e,this.fatal=!1,this.ignoreBOM=!1}p.prototype.decode=function(e,t){var s;return o(t&&t.stream,"decode","stream"),s=e instanceof Uint8Array?e:e.buffer instanceof ArrayBuffer?new Uint8Array(e.buffer):new Uint8Array(e),l(s,this.encoding)},e.TextEncoder=e.TextEncoder||r,e.TextDecoder=e.TextDecoder||p}("undefined"!==typeof window?window:"undefined"!==typeof s.g?s.g:this)},83324:(e,t,s)=>{"use strict";s.d(t,{to:()=>n});var o=s(52071),n=function(){function e(t){o.h.assign(e,this,t)}return Object.defineProperty(e.prototype,"metadata",{get:function(){return this.M_},set:function(e){this.M_=e},enumerable:!1,configurable:!0}),e.getTypeName=function(){return"AugLoop_TextToImage_TextToImageAnnotation"},e.getBaseTypes=function(){return["AugLoop_Core_Annotation"]},e.typeGuard=function(t){return o.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()},e}();(function(){function e(t){o.h.assign(e,this,t)}Object.defineProperty(e.prototype,"metadata",{get:function(){return this.M_},set:function(e){this.M_=e},enumerable:!1,configurable:!0}),e.getTypeName=function(){return"AugLoop_TextToImage_TextToGettyImageAnnotation"},e.getBaseTypes=function(){return["AugLoop_Core_Annotation"]},e.typeGuard=function(t){return o.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()}})(),function(){function e(t){o.h.assign(e,this,t)}Object.defineProperty(e.prototype,"metadata",{get:function(){return this.M_},set:function(e){this.M_=e},enumerable:!1,configurable:!0}),e.getTypeName=function(){return"AugLoop_TextToImage_TextToMultiTierImageAnnotation"},e.getBaseTypes=function(){return["AugLoop_Core_Annotation"]},e.typeGuard=function(t){return o.h.matchesTypesFor(t,[e.getTypeName()])},e.H_={T_:e.getTypeName(),B_:e.getBaseTypes()}}()},99038:(e,t,s)=>{var o="undefined"!==typeof globalThis&&globalThis||"undefined"!==typeof self&&self||"undefined"!==typeof s.g&&s.g,n=function(){function e(){this.fetch=!1,this.DOMException=o.DOMException}return e.prototype=o,new e}();!function(e){!function(t){var o="undefined"!==typeof e&&e||"undefined"!==typeof self&&self||"undefined"!==typeof s.g&&s.g||{},n="URLSearchParams"in o,i="Symbol"in o&&"iterator"in Symbol,r="FileReader"in o&&"Blob"in o&&function(){try{return new Blob,!0}catch(e){return!1}}(),a="FormData"in o,c="ArrayBuffer"in o;if(c)var l=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],u=ArrayBuffer.isView||function(e){return e&&l.indexOf(Object.prototype.toString.call(e))>-1};function h(e){if("string"!==typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(e)||""===e)throw new TypeError('Invalid character in header field name: "'+e+'"');return e.toLowerCase()}function p(e){return"string"!==typeof e&&(e=String(e)),e}function d(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return i&&(t[Symbol.iterator]=function(){return t}),t}function g(e){this.map={},e instanceof g?e.forEach(function(e,t){this.append(t,e)},this):Array.isArray(e)?e.forEach(function(e){if(2!=e.length)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function f(e){if(!e._noBody)return e.bodyUsed?Promise.reject(new TypeError("Already read")):void(e.bodyUsed=!0)}function m(e){return new Promise(function(t,s){e.onload=function(){t(e.result)},e.onerror=function(){s(e.error)}})}function y(e){var t=new FileReader,s=m(t);return t.readAsArrayBuffer(e),s}function T(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function v(){return this.bodyUsed=!1,this._initBody=function(e){var t;this.bodyUsed=this.bodyUsed,this._bodyInit=e,e?"string"===typeof e?this._bodyText=e:r&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:a&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:n&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():c&&r&&((t=e)&&DataView.prototype.isPrototypeOf(t))?(this._bodyArrayBuffer=T(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):c&&(ArrayBuffer.prototype.isPrototypeOf(e)||u(e))?this._bodyArrayBuffer=T(e):this._bodyText=e=Object.prototype.toString.call(e):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||("string"===typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):n&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},r&&(this.blob=function(){var e=f(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer){var e=f(this);return e||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer))}if(r)return this.blob().then(y);throw new Error("could not read as ArrayBuffer")},this.text=function(){var e=f(this);if(e)return e;if(this._bodyBlob)return function(e){var t=new FileReader,s=m(t),o=/charset=([A-Za-z0-9_-]+)/.exec(e.type),n=o?o[1]:"utf-8";return t.readAsText(e,n),s}(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),s=new Array(t.length),o=0;o<t.length;o++)s[o]=String.fromCharCode(t[o]);return s.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},a&&(this.formData=function(){return this.text().then(S)}),this.json=function(){return this.text().then(JSON.parse)},this}g.prototype.append=function(e,t){e=h(e),t=p(t);var s=this.map[e];this.map[e]=s?s+", "+t:t},g.prototype.delete=function(e){delete this.map[h(e)]},g.prototype.get=function(e){return e=h(e),this.has(e)?this.map[e]:null},g.prototype.has=function(e){return this.map.hasOwnProperty(h(e))},g.prototype.set=function(e,t){this.map[h(e)]=p(t)},g.prototype.forEach=function(e,t){for(var s in this.map)this.map.hasOwnProperty(s)&&e.call(t,this.map[s],s,this)},g.prototype.keys=function(){var e=[];return this.forEach(function(t,s){e.push(s)}),d(e)},g.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),d(e)},g.prototype.entries=function(){var e=[];return this.forEach(function(t,s){e.push([s,t])}),d(e)},i&&(g.prototype[Symbol.iterator]=g.prototype.entries);var w=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function C(e,t){if(!(this instanceof C))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var s=(t=t||{}).body;if(e instanceof C){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new g(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,s||null==e._bodyInit||(s=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new g(t.headers)),this.method=function(e){var t=e.toUpperCase();return w.indexOf(t)>-1?t:e}(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal||function(){if("AbortController"in o)return(new AbortController).signal}(),this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&s)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(s),("GET"===this.method||"HEAD"===this.method)&&("no-store"===t.cache||"no-cache"===t.cache)){var n=/([?&])_=[^&]*/;if(n.test(this.url))this.url=this.url.replace(n,"$1_="+(new Date).getTime());else{this.url+=(/\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}}function S(e){var t=new FormData;return e.trim().split("&").forEach(function(e){if(e){var s=e.split("="),o=s.shift().replace(/\+/g," "),n=s.join("=").replace(/\+/g," ");t.append(decodeURIComponent(o),decodeURIComponent(n))}}),t}function k(e){var t=new g;return e.replace(/\r?\n[\t ]+/g," ").split("\r").map(function(e){return 0===e.indexOf("\n")?e.substr(1,e.length):e}).forEach(function(e){var s=e.split(":"),o=s.shift().trim();if(o){var n=s.join(":").trim();try{t.append(o,n)}catch(i){console.warn("Response "+i.message)}}}),t}function b(e,t){if(!(this instanceof b))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=void 0===t.statusText?"":""+t.statusText,this.headers=new g(t.headers),this.url=t.url||"",this._initBody(e)}C.prototype.clone=function(){return new C(this,{body:this._bodyInit})},v.call(C.prototype),v.call(b.prototype),b.prototype.clone=function(){return new b(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new g(this.headers),url:this.url})},b.error=function(){var e=new b(null,{status:200,statusText:""});return e.ok=!1,e.status=0,e.type="error",e};var A=[301,302,303,307,308];b.redirect=function(e,t){if(-1===A.indexOf(t))throw new RangeError("Invalid status code");return new b(null,{status:t,headers:{location:e}})},t.DOMException=o.DOMException;try{new t.DOMException}catch(M){t.DOMException=function(e,t){this.message=e,this.name=t;var s=Error(e);this.stack=s.stack},t.DOMException.prototype=Object.create(Error.prototype),t.DOMException.prototype.constructor=t.DOMException}function _(e,s){return new Promise(function(n,i){var a=new C(e,s);if(a.signal&&a.signal.aborted)return i(new t.DOMException("Aborted","AbortError"));var l=new XMLHttpRequest;function u(){l.abort()}if(l.onload=function(){var e={statusText:l.statusText,headers:k(l.getAllResponseHeaders()||"")};0===a.url.indexOf("file://")&&(l.status<200||l.status>599)?e.status=200:e.status=l.status,e.url="responseURL"in l?l.responseURL:e.headers.get("X-Request-URL");var t="response"in l?l.response:l.responseText;setTimeout(function(){n(new b(t,e))},0)},l.onerror=function(){setTimeout(function(){i(new TypeError("Network request failed"))},0)},l.ontimeout=function(){setTimeout(function(){i(new TypeError("Network request timed out"))},0)},l.onabort=function(){setTimeout(function(){i(new t.DOMException("Aborted","AbortError"))},0)},l.open(a.method,function(e){try{return""===e&&o.location.href?o.location.href:e}catch(t){return e}}(a.url),!0),"include"===a.credentials?l.withCredentials=!0:"omit"===a.credentials&&(l.withCredentials=!1),"responseType"in l&&(r?l.responseType="blob":c&&(l.responseType="arraybuffer")),s&&"object"===typeof s.headers&&!(s.headers instanceof g||o.Headers&&s.headers instanceof o.Headers)){var d=[];Object.getOwnPropertyNames(s.headers).forEach(function(e){d.push(h(e)),l.setRequestHeader(e,p(s.headers[e]))}),a.headers.forEach(function(e,t){-1===d.indexOf(t)&&l.setRequestHeader(t,e)})}else a.headers.forEach(function(e,t){l.setRequestHeader(t,e)});a.signal&&(a.signal.addEventListener("abort",u),l.onreadystatechange=function(){4===l.readyState&&a.signal.removeEventListener("abort",u)}),l.send("undefined"===typeof a._bodyInit?null:a._bodyInit)})}_.polyfill=!0,o.fetch||(o.fetch=_,o.Headers=g,o.Request=C,o.Response=b),t.Headers=g,t.Request=C,t.Response=b,t.fetch=_,Object.defineProperty(t,"__esModule",{value:!0})}({})}(n),n.fetch.ponyfill=!0,delete n.fetch.polyfill;var i=o.fetch?o:n;(t=i.fetch).default=i.fetch,t.fetch=i.fetch,t.Headers=i.Headers,t.Request=i.Request,t.Response=i.Response,e.exports=t}}]);
//# sourceMappingURL=augloopapi.4320f6a7.chunk.js.map