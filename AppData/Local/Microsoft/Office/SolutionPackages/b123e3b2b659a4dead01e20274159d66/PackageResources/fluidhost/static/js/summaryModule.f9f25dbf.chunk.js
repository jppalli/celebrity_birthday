/*! For license information please see summaryModule.f9f25dbf.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[11133],{52076:(e,t,n)=>{n.d(t,{hK:()=>s});var a=n(86664),r=n(84693);function s(e){const t=e.type===r.Z.Handle?e.handleType:e.type;switch(t){case r.Z.Blob:case r.Z.Attachment:return"blob";case r.Z.Tree:return"tree";default:(0,a.$)(t,"Unknown type: ".concat(t))}}},67300:(e,t,n)=>{n.r(t),n.d(t,{OdspSummaryUploadManager:()=>p});var a=n(27051),r=n(41818),s=n(85038),o=n(86664),c=n(84693),i=n(34904),l=n(52076),d=n(63520),h=n(27250),u=n(58358),m=n(70530);class p{constructor(e,t,n,a,r){this.snapshotUrl=e,this.getAuthHeader=t,this.epochTracker=a,this.relayServiceTenantAndSessionId=r,this.mc=(0,d.Ln)(n)}async writeSummaryTree(e,t){void 0!==this.lastSummaryProposalHandle&&this.lastSummaryProposalHandle!==t.proposalHandle&&this.mc.logger.sendTelemetryEvent({eventName:"LastSummaryProposedHandleMismatch",ackedSummaryProposedHandle:t.proposalHandle,lastSummaryProposalHandle:this.lastSummaryProposalHandle});const n=await this.writeSummaryTreeCore(t.ackHandle,t.referenceSequenceNumber,e),a=n?n.id:void 0;if(!n||!a)throw new Error("Failed to write summary tree");return this.lastSummaryProposalHandle=a,a}async writeSummaryTreeCore(e,t,n){const r=(0,i.ub)(n),{snapshotTree:s,blobs:o}=await this.convertSummaryToSnapshotTree(e,n,".app"),c={entries:s.entries,message:"app",sequenceNumber:t,type:r||void 0===e?"container":"channel"};return(0,m.gO)(async n=>{const r="".concat(this.snapshotUrl,"/snapshot"),s=await this.getAuthHeader((0,a.A)((0,a.A)({},n),{},{request:{url:r,method:"POST"}}),"WriteSummaryTree"),i=(0,u.b)(s);i["Content-Type"]="application/json";const l=this.relayServiceTenantAndSessionId();void 0!==l&&(i["If-Match"]="fluid:sessionid=".concat(l).concat(e?";containerid=".concat(e):""));const d=JSON.stringify(c);return h.Bt.timedExecAsync(this.mc.logger,{eventName:"uploadSummary",attempt:n.refresh?2:1,hasClaims:!!n.claims,hasTenantId:!!n.tenantId,blobs:o,size:d.length,referenceSequenceNumber:t,type:c.type},async()=>(await this.epochTracker.fetchAndParseAsJSON(r,{body:d,headers:i,method:"POST"},"uploadSummary")).content)})}async convertSummaryToSnapshotTree(e,t,n){var i;let d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null===(i=this.mc.config.getBoolean("Fluid.Driver.Odsp.MarkUnreferencedNodes"))||void 0===i||i;const h={type:"tree",entries:[]};let u=0;const m=Object.keys(t.tree);for(const p of m){(0,s.vA)(!p.includes("/"),2509);const i=t.tree[p];let m,y,b,S;switch(i.type){case c.Z.Tree:{const t=await this.convertSummaryToSnapshotTree(e,i,n);y=t.snapshotTree,b=d?i.unreferenced:void 0,S=i.groupId,u+=t.blobs;break}case c.Z.Blob:y="string"===typeof i.content?{type:"blob",content:i.content,encoding:"utf-8"}:{type:"blob",content:(0,r.Km)(i.content,"base64"),encoding:"base64"},u++;break;case c.Z.Handle:{if(!e)throw new Error("Parent summary does not exist to reference by handle.");let t=i.handle;t.length>0&&!t.startsWith("/")&&(t="/".concat(t));const a="".concat(n).concat(t);m="".concat(e,"/").concat(a);break}case c.Z.Attachment:m=i.id;break;default:(0,o.$)(i,"Unknown type: ".concat(i.type))}const f={path:p,type:(0,l.hK)(i)};let v;if(y)(0,s.vA)(void 0===m,173),v=(0,a.A)((0,a.A)({value:y},f),{},{unreferenced:b,groupId:S});else{if(!m)throw new Error("Invalid tree entry for ".concat(i.type));v=(0,a.A)((0,a.A)({},f),{},{id:m})}h.entries.push(v)}return{snapshotTree:h,blobs:u}}}},86664:(e,t,n)=>{function a(e){throw new Error(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unreachable Case")}n.d(t,{$:()=>a})}}]);
//# sourceMappingURL=summaryModule.f9f25dbf.chunk.js.map