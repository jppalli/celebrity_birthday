/*! For license information please see createNewModule.0eb57762.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[72883],{1725:(e,t,n)=>{n.d(t,{e:()=>a});var r=n(87804),o=n(39521);class a extends o.iq{constructor(e){super(e,{usageError:!0}),this.errorType=r.a.usageError,this.canRetry=!1}}},39480:(e,t,n)=>{n.r(t),n.d(t,{convertCreateNewSummaryTreeToTreeAndBlobs:()=>T,createNewContainerOnExistingFile:()=>P,createNewFluidFile:()=>F,renameEmptyFluidFile:()=>O});var r=n(27051),o=n(85038),a=n(54813),c=n(93586),i=n(63520),s=n(27250),l=n(93220),d=n(57471),u=n(58358),p=n(11137),m=n(27015),h=n(70530),f=n(27612),y=n(62951),w=n(41818),v=n(86664),A=n(84693),b=n(34904),g=n(52076),k=n(14826);function T(e,t){const n=e.tree[".protocol"],r=(0,b.YG)(n).sequenceNumber,o=new Map,a=N(e,o);a.id=t;return{snapshotTree:a,blobContents:o,ops:[],sequenceNumber:r,latestSequenceNumber:r,snapshotFormatV:1}}function N(e,t){const n={blobs:{},trees:{},unreferenced:e.unreferenced,groupId:e.groupId},r=Object.keys(e.tree);for(const o of r){const r=e.tree[o];switch(r.type){case A.Z.Tree:n.trees[o]=N(r,t);break;case A.Z.Blob:{const e="string"===typeof r.content?(0,w.Xg)(r.content,"utf8"):r.content,a=(0,k.A)();n.blobs[o]=a,t.set(a,e);break}case A.Z.Handle:case A.Z.Attachment:throw new Error("No ".concat(r.type," should be present for detached summary!"));default:(0,v.$)(r,"Unknown tree type ".concat(r.type))}}return n}function I(e){var t;if(!(0,b.ub)(e))throw new Error("App and protocol summary required for create new path!!");const n=e.tree[".app"],r=e.tree[".protocol"],o=(0,b.YG)(r),a={type:A.Z.Blob,content:JSON.stringify(o)};r.tree.attributes=a;return{entries:null!==(t=C({type:A.Z.Tree,tree:{".protocol":r,".app":n}}).entries)&&void 0!==t?t:[],message:"app",sequenceNumber:o.sequenceNumber,type:"container"}}function C(e){const t={type:"tree",entries:[]},n=Object.keys(e.tree);for(const a of n){var r;(0,o.vA)(!a.includes("/"),2508);const n=e.tree[a];let c,i,s;switch(n.type){case A.Z.Tree:c=C(n),i=n.unreferenced,s=n.groupId;break;case A.Z.Blob:c={type:"blob",content:"string"===typeof n.content?n.content:(0,w.Km)(n.content,"base64"),encoding:"string"===typeof n.content?"utf-8":"base64"};break;case A.Z.Handle:throw new Error("No handle should be present for first summary!!");default:throw new Error("Unknown tree type ".concat(n.type))}const l={path:a,type:(0,g.hK)(n),value:c,unreferenced:i,groupId:s};null===(r=t.entries)||void 0===r||r.push(l)}return t}async function U(e){const{containerSnapshot:t,getAuthHeader:n,logger:o,initialUrl:a,epochTracker:c,telemetryName:i,fetchType:l,validateResponseCallback:d}=e,p=(0,m.ir)(a);return(0,h.gO)(async e=>s.Bt.timedExecAsync(o,{eventName:i,details:{internalFarmType:p}},async s=>{const p=JSON.stringify(t);let m,f,w=!1;const v=(0,k.A)(),A=new URL(a);A.searchParams.set("ump","1");const b=A.href,g="POST",T=await n((0,r.A)((0,r.A)({},e),{},{request:{url:b,method:g}}),i),N="--".concat(v,"\r\n")+"Authorization: ".concat(T,"\r\n")+"X-HTTP-Method-Override: POST\r\nContent-Type: application/json\r\n_post: 1\r\n"+"\r\n".concat(p,"\r\n")+"\r\n--".concat(v,"--");let I=p;if((new TextEncoder).encode(N).length<=h.K3&&null!==T&&void 0!==T&&T.startsWith("Bearer"))m=b,f={"Content-Type":"multipart/form-data;boundary=".concat(v)},w=!0,I=N;else{m=a;const t=await n((0,r.A)((0,r.A)({},e),{},{request:{url:m,method:g}}),i);f=(0,r.A)((0,r.A)({},(0,u.b)(t)),{},{"Content-Type":"application/json"}),I=p}const C=await(0,y.M)(async()=>c.fetchAndParseAsJSON(m,{body:I,headers:f,method:g},l,w),i,o);return null===d||void 0===d||d(C.content),s.end((0,r.A)({attempts:e.refresh?2:1},C.propsToLog)),C.content}))}const S=e=>/["*/:<>?\\|]+/g.test(e);async function F(e,t,n,w,v,A,b,g,k,N,C){var F,O;if(S(t.filename))throw new a.OI("Invalid filename for createNew",c.E.invalidFileNameError,{driverVersion:f.z});let E,P,H,R="";if(void 0===w){const o=await async function(e,t,n,o){const i=L(t.filePath),l=encodeURIComponent("".concat(t.filename,".tmp")),d="".concat((0,m.lA)(new URL(t.siteUrl)),"/drives/").concat(t.driveId,"/items/root:/").concat(i,"/").concat(l,":/content?@name.conflictBehavior=rename&select=id,name,parentReference");return(0,h.gO)(async i=>{const l=d,p="PUT",h=await e((0,r.A)((0,r.A)({},i),{},{request:{url:l,method:p}}),"CreateNewFile"),w=(0,m.ir)(t.siteUrl);return s.Bt.timedExecAsync(n,{eventName:"createNewEmptyFile",details:{internalFarmType:w}},async e=>{const t=(0,u.b)(h);t["Content-Type"]="application/json";const i=await(0,y.M)(async()=>o.fetchAndParseAsJSON(l,{body:void 0,headers:t,method:p},"createFile"),"createFile",n),s=i.content;if(null===s||void 0===s||!s.id)throw new a.OI("ODSP CreateFile call returned no item ID (for empty file)",c.E.incorrectServerResponse,{driverVersion:f.z});return e.end((0,r.A)({},i.propsToLog)),{itemId:s.id,fileName:s.name}},{end:!0,cancel:"error"})})}(e,t,n,v);E=o.itemId,P=t.filename}else{const o=await async function(e,t,n,r,o,i){const s=L(t.filePath),l=encodeURIComponent(t.filename),d="".concat((0,m.lA)(new URL(t.siteUrl)),"/drives/").concat(t.driveId,"/items/root:")+"".concat(s,"/").concat(l),u=I(r),p=(0,h.wF)(t.createLinkType),y="".concat(d,":/opStream/snapshots/snapshot").concat(p?"?".concat(p):"");return U({containerSnapshot:u,getAuthHeader:e,logger:n,initialUrl:y,forceAccessTokenViaAuthorizationHeader:i,epochTracker:o,telemetryName:"CreateNewFile",fetchType:"createFile",validateResponseCallback:e=>{if(null===e||void 0===e||!e.itemId)throw new a.OI("ODSP CreateFile call returned no item ID",c.E.incorrectServerResponse,{driverVersion:f.z})}})}(e,t,n,w,v,g);E=o.itemId,R=o.id,H=function(e,t){let n;if(t){const{sharing:t}=e;if(!t)return;n={createLink:{link:t.sharingLink?(0,r.A)({scope:t.sharingLink.scope,role:t.sharingLink.type,webUrl:t.sharingLink.webUrl},t.sharingLink):void 0,error:t.error,shareId:t.shareId}}}return n}(o,N)}const Z=(0,d.m)((0,r.A)((0,r.A)({},t),{},{itemId:E,dataStorePath:"/"})),q=new p.Y,B=await q.resolve({url:Z,headers:{[l.t.isClpCompliantApp]:k}});if(A.docId=B.hashedDocumentId,A.resolvedUrl=B,B.context=null===C||void 0===C?void 0:C.context,B.appName=null===C||void 0===C?void 0:C.appName,B.codeHint=null!==(F=B.codeHint)&&void 0!==F&&F.containerPackageName?B.codeHint:null===C||void 0===C?void 0:C.codeHint,null!==(O=H)&&void 0!==O&&null!==(O=O.createLink)&&void 0!==O&&O.link){var x,z;let e=H.createLink.link.webUrl;e=(0,h.z6)(e,B,null!==(x=B.dataStorePath)&&void 0!==x?x:"/",null===(z=B.codeHint)||void 0===z?void 0:z.containerPackageName),H.createLink.link.webUrl=e}if(B.shareLinkInfo=H,B.pendingRename=P,void 0!==w&&b){(0,o.vA)(void 0!==R,515);const e=T(w,R);await v.put((0,h.wL)(B,(0,h.JH)((0,i.Ln)(n).config)),e)}return B}function L(e){return e?encodeURIComponent(e.startsWith("/")?e:"/".concat(e)):""}async function O(e,t,n,o,i){const l="".concat((0,m.lA)(new URL(t.siteUrl)),"/drives/").concat(t.driveId,"/items/").concat(t.itemId,"?@name.conflictBehavior=rename");return(0,h.gO)(async t=>{const d=l,p=await e((0,r.A)((0,r.A)({},t),{},{request:{url:d,method:"PATCH"}}),"renameFile");return s.Bt.timedExecAsync(o,{eventName:"renameFile"},async e=>{const t=(0,u.b)(p);t["Content-Type"]="application/json";const s=await(0,y.M)(async()=>i.fetchAndParseAsJSON(d,{body:JSON.stringify({name:n}),headers:t,method:"PATCH"},"renameFile"),"renameFile",o),l=s.content;if(null===l||void 0===l||!l.id)throw new a.OI("ODSP RenameFile call returned no item ID (for empty file)",c.E.incorrectServerResponse,{driverVersion:f.z});return e.end((0,r.A)({},s.propsToLog)),l},{end:!0,cancel:"error"})})}var E=n(1725);async function P(e,t,n,o,a,c,s,u,f){if(void 0===o)throw new E.e("createNewSummary must exist to create a new container");const y="".concat((0,m.lA)(new URL(t.siteUrl)),"/drives/").concat(t.driveId,"/items/").concat(t.itemId),w=I(o),v="".concat(y,"/opStream/snapshots/snapshot"),{id:A}=await U({containerSnapshot:w,getAuthHeader:e,logger:n,initialUrl:v,forceAccessTokenViaAuthorizationHeader:u,epochTracker:a,telemetryName:"CreateNewContainerOnExistingFile",fetchType:"uploadSummary"}),b=(0,d.m)((0,r.A)((0,r.A)({},t),{},{dataStorePath:"/"})),g=new p.Y,k=await g.resolve({url:b,headers:{[l.t.isClpCompliantApp]:f}});if(c.docId=k.hashedDocumentId,c.resolvedUrl=k,s){const e=T(o,A);await a.put((0,h.wL)(k,(0,h.JH)((0,i.Ln)(n).config)),e)}return k}},52076:(e,t,n)=>{n.d(t,{hK:()=>a});var r=n(86664),o=n(84693);function a(e){const t=e.type===o.Z.Handle?e.handleType:e.type;switch(t){case o.Z.Blob:case o.Z.Attachment:return"blob";case o.Z.Tree:return"tree";default:(0,r.$)(t,"Unknown type: ".concat(t))}}},86664:(e,t,n)=>{function r(e){throw new Error(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unreachable Case")}n.d(t,{$:()=>r})}}]);
//# sourceMappingURL=createNewModule.0eb57762.chunk.js.map