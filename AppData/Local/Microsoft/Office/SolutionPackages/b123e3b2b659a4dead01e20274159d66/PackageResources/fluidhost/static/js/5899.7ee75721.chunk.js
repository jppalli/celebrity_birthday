/*! For license information please see 5899.7ee75721.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkfluidhost=self.webpackChunkfluidhost||[]).push([[5899],{5899:(e,t,o)=>{o.d(t,{I:()=>Je});var s=o(27051),r=o(34904),n=o(30636),i=o(27250),a=o(14826);async function c(e,t){return t(await o.e(72883).then(o.bind(o,39480)).then(t=>(e.sendTelemetryEvent({eventName:"createNewModuleLoaded"}),t)).catch(t=>{throw e.sendErrorEvent({eventName:"createNewModuleLoadFailed"},t),t}))}var h=o(91119),l=o(33669),d=o(20611);class u{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:36e5;this.snapshotExpiryPolicy=e,this.cache=new Map,this.docIdExpirationMap=new Map}async get(e){const t=(0,d.V$)(e);return this.cache.get(t)}async put(e,t){const o=(0,d.V$)(e);this.cache.set(o,t),this.updateExpirationEntry(e.file.docId)}async removeEntries(e){this.removeDocIdEntriesFromCache(e.docId)}removeDocIdEntriesFromCache(e){return this.removeExpirationEntry(e),[...this.cache].filter(t=>{let[o]=t;if(o.split("_")[0]===e)return!0}).map(e=>{let[t]=e;this.cache.delete(t)})}removeExpirationEntry(e){const t=this.docIdExpirationMap.get(e);void 0!==t&&(clearTimeout(t),this.docIdExpirationMap.delete(e))}updateExpirationEntry(e){this.removeExpirationEntry(e),this.docIdExpirationMap.set(e,setTimeout(()=>{this.removeDocIdEntriesFromCache(e)},this.snapshotExpiryPolicy))}}l.o;class p{constructor(){this.sessionJoinCache=new l.o,this.fileUrlCache=new l.o,this.snapshotPrefetchResultCache=new l.o}}var g=o(88826),v=o(85038),m=o(63520);function f(e,t,o,s){let r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(0!==t.length){const n=t[0].sequenceNumber,i=t.length,a=t[i-1].sequenceNumber;if(a+1!==o+i){if(r||o!==n)t.length=0;else{let e=1;for(;e<t.length&&t[e].sequenceNumber===t[e-1].sequenceNumber+1;)e++;t.length=e}s.sendErrorEvent({eventName:"OpsFetchViolation",reason:e,from:o,start:n,last:a,length:i,details:JSON.stringify({validLength:t.length,lastValidOpSeqNumber:t.length>0?t[t.length-1].sequenceNumber:void 0,strict:r})})}}}var b=o(87615),y=o(8018),S=o(54813);function w(e,t,o){const r=(0,s.A)({},t),n=null===o||void 0===o?void 0:o.online;if(r.online="string"===typeof n?n:S.WA[(0,S.sc)()],"object"===typeof navigator&&null!==navigator){var i,a;const e=navigator,t=null!==(i=null!==(a=e.connection)&&void 0!==a?a:e.mozConnection)&&void 0!==i?i:e.webkitConnection;null!==t&&"object"===typeof t&&(r.connectionType=t.type)}r.category=(0,S.YU)(o)?"generic":"error",e.sendTelemetryEvent(r,o)}var T=o(65199),C=o(70354);class A{get working(){return"working"===this.workingState}get canceled(){return"canceled"===this.workingState}constructor(e,t,o,s,r,n){this.to=t,this.payloadSize=o,this.logger=s,this.requestCallback=r,this.responseCallback=n,this.results=new Map,this.workingState="working",this.requestsInFlight=0,this.endEvent=new y.c,this.requests=0,this.latestRequested=e,this.nextToDeliver=e,this.knewTo=void 0!==t}cancel(){this.working&&(this.workingState="canceled",this.endEvent.resolve())}async run(e){(0,v.vA)(e>0,258),(0,v.vA)(this.working,259);let t=e;for(;t>0;)t--,this.addRequest();return this.dispatch(),this.endEvent.promise}done(){(0,v.vA)(void 0!==this.to,260),(0,v.vA)(this.nextToDeliver>=this.to,261),this.working&&(this.workingState="done",this.endEvent.resolve())}fail(e){this.working&&(this.workingState="done",this.endEvent.reject(e))}dispatch(){for(;this.working;){const e=this.results.get(this.nextToDeliver);if(void 0===e)break;this.results.delete(this.nextToDeliver),(0,v.vA)(e.length<=this.payloadSize,473),this.nextToDeliver+=e.length,this.responseCallback(e)}this.working&&(0===this.requestsInFlight?((0,v.vA)(0===this.results.size,263),this.done()):void 0!==this.to&&this.nextToDeliver>=this.to&&((0,v.vA)(!this.knewTo,264),this.done()))}getNextChunk(){if(!this.working)return;const e=this.latestRequested;return void 0!==this.to&&this.to<=e?void 0:(this.latestRequested+=this.payloadSize,void 0!==this.to&&(this.latestRequested=Math.min(this.to,this.latestRequested)),(0,v.vA)(e<this.latestRequested,265),{from:e,to:this.latestRequested})}addRequest(){const e=this.getNextChunk();void 0!==e&&this.addRequestCore(e.from,e.to).catch(this.fail.bind(this))}async addRequestCore(e,t){(0,v.vA)(this.working,266);let o=e,s=t;for(this.requestsInFlight++;this.working;){const e=s-o;(0,v.vA)(e>0,267),void 0!==this.to&&((0,v.vA)(o<this.to,268),(0,v.vA)(s<=this.to,269)),this.requests++;const t=this.requestCallback(this.requests,o,s,void 0!==this.to,{});this.dispatch();const{payload:r,cancel:n,partial:i}=await t;if(n&&this.cancel(),void 0!==this.to&&o>=this.to){(0,v.vA)(!this.knewTo,270),0!==r.length&&this.logger.sendErrorEvent({eventName:"ParallelRequests_GotExtra",from:o,to:s,end:this.to,length:r.length});break}if(this.working){const t=o,n=r.length;let a=e<=n;if(0!==n){e<n&&this.logger.sendTelemetryEvent({eventName:"ParallelRequests_Over",from:o,to:s,length:n});const t=r.splice(0,e);this.results.set(o,t),o+=t.length}else(0,v.vA)(!i,271),(0,v.vA)(!this.knewTo,272);if(!i&&!a){if(!this.knewTo){(void 0===this.to||this.to>o)&&(this.to=o);break}this.logger.sendPerformanceEvent({eventName:"ParallelRequests_Partial",from:t,to:s,length:n})}if(s===this.latestRequested){for(;0!==r.length;){const t=r.splice(0,e);this.results.set(o,t),o+=t.length}this.latestRequested=o,a=!0}if(a){const e=this.getNextChunk();if(void 0===e)break;o=e.from,s=e.to}}}this.requestsInFlight--,this.dispatch()}}class k{constructor(){this.queue=[],this.done=!1}pushValue(e){this.pushCore(Promise.resolve({done:!1,value:e}))}pushError(e){this.pushCore(Promise.reject(e)),this.done=!0}pushDone(){this.pushCore(Promise.resolve({done:!0})),this.done=!0}pushCore(e){(0,v.vA)(!this.done,274),this.deferred?((0,v.vA)(0===this.queue.length,275),this.deferred.resolve(e),this.deferred=void 0):this.queue.push(e)}async read(){(0,v.vA)(void 0===this.deferred,276);const e=this.queue.shift();return void 0!==e?e:((0,v.vA)(!this.done,277),this.deferred=new y.c,this.deferred.promise)}}const E=async()=>{var e;if(!1===(null===(e=globalThis.navigator)||void 0===e?void 0:e.onLine)&&void 0!==globalThis.addEventListener)return new Promise(e=>{const t=()=>{e(),globalThis.removeEventListener("online",t)};globalThis.addEventListener("online",t)})};function N(e,t,o,r,n,a,c,h){let l,d=0,u=0;const p=new k,g={fromTotal:o,toTotal:r},m=i.Bt.start(a,(0,s.A)((0,s.A)({eventName:"GetDeltas"},g),{},{reason:h})),f=new A(o,r,n,a,async(t,o,r,n,l)=>(d++,async function(e,t,o,r,n,a){let c,h,l=0,d=0,u=0,p=50;for(;!0!==(null===n||void 0===n?void 0:n.aborted);){let n;d++;const m=(0,b.l)();try{const{messages:r,partialResult:n}=await e((0,s.A)((0,s.A)({},t),{},{retry:d}));var g;if(0!==r.length||!o)return null===(g=h)||void 0===g||g.end((0,s.A)((0,s.A)({duration:l},t),{},{reason:a})),{payload:r,cancel:!1,partial:n};if(void 0===c)c=(0,b.l)();else if((0,b.l)()-c>3e4)throw(0,S.ix)("Failed to retrieve ops from storage (Too Many Retries)",{canRetry:!1},(0,s.A)({retry:d,driverVersion:T.z},t))}catch(v){n=v;const e=(0,S.YU)(v),o=(0,S.E9)(v);if(w(r,(0,s.A)((0,s.A)({eventName:"GetDeltas_Error"},t),{},{retry:d,duration:(0,b.l)()-m,retryAfter:o,reason:a}),v),!e)throw v}void 0===h&&(u=(0,b.l)(),h=i.Bt.start(r,{eventName:"GetDeltasWaitTime"})),p=(0,C.F)(p,n),await new Promise(e=>{setTimeout(e,p)}),await E(),l+=(0,b.l)()-u}return{partial:!1,cancel:!0,payload:[]}}(async t=>e(o,r,t),(0,s.A)((0,s.A)({request:t,from:o,to:r},g),l),n,a,c,h)),e=>{void 0===l?(0,v.vA)(e[0].sequenceNumber===o,621):(0,v.vA)(e[0].sequenceNumber===l+1,622),l=e[e.length-1].sequenceNumber,(0,v.vA)(l-e[0].sequenceNumber+1===e.length,623),u+=e.length,p.pushValue(e)}),y=e=>{f.cancel()};return void 0!==c&&c.addEventListener("abort",y),f.run(t).finally(()=>{void 0!==c&&c.removeEventListener("abort",y)}).then(()=>{const e={lastFetch:l,length:u,requests:d};f.canceled?m.cancel((0,s.A)((0,s.A)({},e),{},{error:"ops request cancelled by client"})):((0,v.vA)(void 0===r||void 0!==l&&l>=r-1,624),m.end(e)),p.pushDone()}).catch(e=>{m.cancel({lastFetch:l,length:u,requests:d},e),p.pushError(e)}),p}var I=o(70530);class L{constructor(e,t,o,s){this.deltaFeedUrl=e,this.getAuthHeader=t,this.epochTracker=o,this.logger=s}async get(e,t,o,r){return(0,I.gO)(async n=>{const c=this.buildUrl(e,t),h="POST",l=await this.getAuthHeader((0,s.A)((0,s.A)({},n),{},{request:{url:c,method:h}}),"DeltaStorage");return i.Bt.timedExecAsync(this.logger,(0,s.A)((0,s.A)({eventName:"OpsFetch",attempts:n.refresh?2:1,from:e,to:t},o),{},{reason:r}),async e=>{const t=(0,a.A)();let o="--".concat(t,"\r\n");o+="Authorization: ".concat(l,"\r\n"),o+="X-HTTP-Method-Override: GET\r\n",o+="_post: 1\r\n",o+="\r\n--".concat(t,"--");const n={"Content-Type":"multipart/form-data;boundary=".concat(t)},i=new AbortController,d=setTimeout(()=>i.abort(),3e4),u=await this.epochTracker.fetchAndParseAsJSON(c,{headers:n,body:o,method:h,signal:i.signal},"ops",!0,r);clearTimeout(d);const p=u.content,g=p.value.length>0&&"op"in p.value[0]?p.value.map(e=>e.op):p.value;return e.end((0,s.A)({length:g.length},u.propsToLog)),{messages:g,partialResult:!1}})})}buildUrl(e,t){const o=encodeURIComponent("sequenceNumber ge ".concat(e," and sequenceNumber le ").concat(t-1)),s="?ump=1&filter=".concat(o);return"".concat(this.deltaFeedUrl).concat(s)}}class P{constructor(e,t,o,s,r,n,i,a,c){this.snapshotOps=e,this.logger=t,this.batchSize=o,this.concurrency=s,this.getFromStorage=r,this.getCached=n,this.requestFromSocket=i,this.opsReceived=a,this.storageManagerGetter=c,this.useCacheForOps=!0}fetchMessages(e,t,o,s,r){var n;(0,v.vA)(!s||void 0===t,483),this.useCacheForOps=this.useCacheForOps&&!1===(null===(n=this.storageManagerGetter())||void 0===n?void 0:n.isFirstSnapshotFromNetwork);let i=0,a=0,c=0;const h=async(e,t,o)=>{if(void 0!==this.snapshotOps&&this.snapshotOps.length>0){const o=this.snapshotOps.filter(o=>o.sequenceNumber>=e&&o.sequenceNumber<t);if(f("cached",o,e,this.logger),o.length>0&&o[0].sequenceNumber===e)return this.snapshotOps=this.snapshotOps.filter(e=>e.sequenceNumber>=t),i+=o.length,{messages:o,partialResult:!0};this.snapshotOps=void 0}if(this.requestFromSocket(e,t),this.useCacheForOps){const o=await this.getCached(e,t);if(f("cached",o,e,this.logger),this.useCacheForOps=e+o.length>=t,o.length>0)return a+=o.length,{messages:o,partialResult:!0}}if(s)return{messages:[],partialResult:!1};const n=await this.getFromStorage(e,t,o,r);return f("storage",n.messages,e,this.logger),c+=n.messages.length,this.opsReceived(n.messages),n};return function(e,t){return{read:async()=>{const o=await e.read();return t(o),o}}}(N(async(e,t,o)=>{const s=await h(e,t,o);return f("catch all",s.messages,e,this.logger),s},this.concurrency,e,t,this.batchSize,this.logger,o,r),e=>{e.done&&i+a+c!==0&&this.logger.sendPerformanceEvent({eventName:"CacheOpsRetrieved",opsFromSnapshot:i,opsFromCache:a,opsFromStorage:c,reason:r})})}}var R,B,F=o(97813),O=o(14365);!function(e){e[e.NoCaching=0]="NoCaching",e[e.Prefetch=1]="Prefetch"}(R||(R={})),function(e){e.default="default",e.noCache="noCache"}(B||(B={}));var q,U,D,x=o(21673),M=o(93586),z=o(39521),G=o(68194);!function(e){e.NoOp="noop",e.ClientJoin="join",e.ClientLeave="leave",e.Propose="propose",e.Reject="reject",e.Accept="accept",e.Summarize="summarize",e.SummaryAck="summaryAck",e.SummaryNack="summaryNack",e.Operation="op",e.NoClient="noClient",e.RoundTrip="tripComplete",e.Control="control"}(q||(q={})),function(e){e.ClientJoin="join",e.ClientLeave="leave"}(U||(U={})),function(e){e.ThrottlingError="ThrottlingError",e.InvalidScopeError="InvalidScopeError",e.BadRequestError="BadRequestError",e.LimitExceededError="LimitExceededError"}(D||(D={}));var _=o(84295),W=o(83533);class V{get buffer(){return this.data}constructor(e){this.data=e,this.index=0,Object.freeze(e.buffer)}get eof(){return this.index===this.data.length}get pos(){return this.index}get length(){return this.data.length}slice(e,t){return this.data.slice(e,t)}reset(){this.index=0}read(){let e=0,t=1,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;for(;o>0;)(0,v.vA)(!this.eof,547),e+=this.data[this.index]*t,this.index++,t*=256,o--;return e}skip(e){(0,v.vA)(e>=0,548),this.index+=e,(0,v.vA)(this.index<=this.data.length,988)}}var H,j,J,X=o(41818),K=o(27612);!function(e){e[e.BoolTrue=11]="BoolTrue",e[e.BoolFalse=12]="BoolFalse",e[e.StringEmpty=13]="StringEmpty",e[e.String8Length=14]="String8Length",e[e.String16Length=15]="String16Length",e[e.String32Length=16]="String32Length",e[e.ConstString8Id=17]="ConstString8Id",e[e.ConstString16Id=18]="ConstString16Id",e[e.ConstString32Id=19]="ConstString32Id",e[e.ConstStringDeclare=20]="ConstStringDeclare",e[e.ConstStringDeclareBig=21]="ConstStringDeclareBig",e[e.Int0=1]="Int0",e[e.UInt8=3]="UInt8",e[e.UInt16=5]="UInt16",e[e.UInt32=7]="UInt32",e[e.UInt64=9]="UInt64",e[e.Int8=2]="Int8",e[e.Int16=4]="Int16",e[e.Int32=6]="Int32",e[e.Int64=8]="Int64",e[e.BinaryEmpty=32]="BinaryEmpty",e[e.BinarySingle8=33]="BinarySingle8",e[e.BinarySingle16=34]="BinarySingle16",e[e.BinarySingle32=35]="BinarySingle32",e[e.BinarySingle64=36]="BinarySingle64"}(H||(H={})),function(e){e[e.list=49]="list",e[e.set=51]="set"}(j||(j={})),function(e){e[e.list=50]="list",e[e.set=52]="set"}(J||(J={}));const Q={1:0,2:1,3:1,4:2,5:2,6:4,7:4,8:8,9:8,13:0,14:1,15:2,16:4,17:1,18:2,19:4,20:1,21:4,32:0,33:1,34:2,35:4,36:8};function Y(e,t){const o=e[t];return(0,v.vA)(void 0!==o,647),o}function $(e){const t={};for(const[o,s]of e.iteratePairs()){t[re(o,"keynode should be a string")]=s}return t}class Z{constructor(){}}class ee extends Z{constructor(e){super(),this.data=e}get buffer(){return this.data}get arrayBuffer(){return 0===(e=this.buffer).byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);var e}static read(e,t){const o=e.read(t),s=new Uint8Array(o);for(let r=0;r<o;r++)s[r]=e.read();return new ee(s)}}class te extends Z{constructor(e,t,o){super(),this.data=e,this.start=t,this.end=o}get buffer(){return this.data.subarray(this.start,this.end)}get arrayBuffer(){const e=this.data.byteOffset;return this.data.buffer.slice(this.start+e,this.end+e)}static read(e,t){const o=e.read(t),s=e.pos;return e.skip(o),new te(e.buffer,s,s+o)}}class oe{get nodes(){return this.children}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"set";this.type=e,this.children=[]}[Symbol.iterator](){return this.children[Symbol.iterator]()}iteratePairs(){return(0,v.vA)(this.length%2===0,556),function(e){const t={next:()=>{const t=e.next();if(t.done)return{value:void 0,done:!0};const o=e.next();return(0,v.vA)(!0!==o.done,555),{value:[t.value,o.value],done:o.done}},[Symbol.iterator]:()=>t};return t}(this[Symbol.iterator]())}get length(){return this.children.length}get(e){return this.children[e]}getString(e){return re(this.children[e],"getString should return string")}getMaybeString(e){return function(e){const t=e;if(t._stringElement)return t.content}(this.children[e])}getBlob(e){const t=this.children[e];return ne(t,"getBlob should return a blob"),t}getNode(e){const t=this.children[e];return ie(t,"getNode should return a node"),t}getNumber(e){const t=this.children[e];return ae(t,"getNumber should return a number"),t}getBool(e){const t=this.children[e];return ce(t,"getBool should return a boolean"),t}addNode(e){const t=new oe(e);return this.children.push(t),t}addBlob(e){this.children.push(new ee(e))}addDictionaryString(e){this.children.push({content:e,dictionary:!0,_stringElement:!0})}addString(e){this.children.push({content:e,dictionary:!1,_stringElement:!0})}addNumber(e){(0,v.vA)(Number.isInteger(e),561),(0,v.vA)(void 0!==e&&e>=0,562),this.children.push(e)}addBool(e){this.children.push(e)}static readString(e,t,o){const s=Y(Q,t),r=e.read(s),n=e.pos;e.skip(r);return{dictionary:o,_stringElement:!0,startPos:n,endPos:e.pos}}load(e,t){const[o,s]=(0,I.xP)(()=>this.loadStructure(e,t)),[,r]=(0,I.xP)(()=>this.loadStrings(e,o,t));return{durationStructure:s,durationStrings:r}}loadStructure(e,t){const o=[],s=[],r=[];let n=this.children;for(;!e.eof;){const t=e.read();switch(t){case j.list:case j.set:{const e=new oe(t===j.set?"set":"list");n.push(e),o.push(n),n=e.children;continue}case H.ConstStringDeclare:case H.ConstStringDeclareBig:{const o=e.read(Y(Q,t)),n=oe.readString(e,t,!0);s.push(n),r[o]=n;continue}case H.ConstString8Id:case H.ConstString16Id:case H.ConstString32Id:{const o=r[e.read(Y(Q,t))];(0,v.vA)(void 0!==o,990),n.push(o);continue}case H.StringEmpty:case H.String8Length:case H.String16Length:case H.String32Length:{const o=oe.readString(e,t,!1);s.push(o),n.push(o);continue}case H.BinaryEmpty:case H.BinarySingle8:case H.BinarySingle16:case H.BinarySingle32:case H.BinarySingle64:n.push(te.read(e,Y(Q,t)));continue;case H.Int0:n.push(0);continue;case H.UInt8:case H.UInt16:case H.UInt32:case H.UInt64:case H.Int8:case H.Int16:case H.Int32:case H.Int64:n.push(e.read(Y(Q,t)));continue;case H.BoolTrue:n.push(!0);continue;case H.BoolFalse:n.push(!1);continue;case J.list:case J.set:n=o.pop();continue;default:throw new Error("Invalid code: ".concat(t))}}return(0,v.vA)(n===this.children,999),s}loadStrings(e,t,o){let s=0;for(const a of t)s+=a.endPos-a.startPos+1;const r=new Uint8Array(s);s=0;const n=e.buffer;(0,v.vA)(0===n.byteOffset,1e3);for(const a of t){for(let e=a.startPos;e<a.endPos;e++)r[s]=n[e],s++;r[s]=0,s++}(0,v.vA)(s===r.length,1048);const i=(0,X.Km)(r,"utf8").split(String.fromCodePoint(0));if(i.length===t.length+1)for(let a=0;a<t.length;a++)t[a].content=i[a];else{o.sendErrorEvent({eventName:"StringParsingError"});for(const e of t)(0,v.vA)(e.content===(0,X.Km)(n.subarray(e.startPos,e.endPos),"utf8"),1002)}}}class se extends oe{static load(e,t){const o=new se,s=o.load(e,t);return(0,v.vA)(e.eof,563),{builder:o,telemetryProps:s}}}function re(e,t){const o=e;if(o._stringElement)return o.content;he(e,"BlobCore",t)}function ne(e,t){e instanceof Z||he(e,"BlobCore",t)}function ie(e,t){e instanceof oe||he(e,"NodeCore",t)}function ae(e,t){"number"!==typeof e&&he(e,"Number",t)}function ce(e,t){"boolean"!==typeof e&&he(e,"Boolean",t)}function he(e,t,o){throw new S.OI("Buffer parsing exception: ".concat(o),M.E.incorrectServerResponse,{nodeType:le(e),expectedNodeType:t,driverVersion:K.z})}function le(e){return"number"===typeof e?"Number":e instanceof Z?"BlobCore":e instanceof oe?"NodeCore":"boolean"===typeof e?"Boolean":e._stringElement?"String":"UnknownType"}const de="1.0";function ue(e){ie(e,"Deltas should be of type NodeCore");const t=[],o=$(e);ae(o.firstSequenceNumber,"Seq number should be a number"),ie(o.deltas,"Deltas should be a Node");for(let s=0;s<o.deltas.length;++s)t.push(JSON.parse(o.deltas.getString(s)));return(0,v.vA)(0===t.length||o.firstSequenceNumber.valueOf()===t[0].sequenceNumber,640),t}function pe(e){let t=0,o=0;const s={},r={blobs:{},trees:s};for(const n of e){ie(n,"tree nodes should be nodes");const e=n.length;if(e>0&&"name"===n.getMaybeString(0))switch(e){case 2:s[n.getString(1)]={blobs:{},trees:{}};continue;case 4:{const e=n.getMaybeString(2);if("children"===e){const e=pe(n.getNode(3));s[n.getString(1)]=e.snapshotTree,t+=e.slowTreeStructureCount,o+=e.treeStructureCountWithGroupId;continue}if("value"===e){r.blobs[n.getString(1)]=n.getString(3);continue}break}case 6:if("nodeType"===n.getMaybeString(2)&&"value"===n.getMaybeString(4)){r.blobs[n.getString(1)]=n.getString(5);continue}if("unreferenced"===n.getMaybeString(2)&&"children"===n.getMaybeString(4)){const e=pe(n.getNode(5));s[n.getString(1)]=e.snapshotTree,t+=e.slowTreeStructureCount,o+=e.treeStructureCountWithGroupId,(0,v.vA)(n.getBool(3),987),r.unreferenced=!0;continue}}t++;const i=$(n);void 0!==i.unreferenced&&(ce(i.unreferenced,"Unreferenced flag should be bool"),(0,v.vA)(i.unreferenced,641),r.unreferenced=!0);const a=re(i.name,"Path name should be string");if(void 0!==i.value)r.blobs[a]=re(i.value,"Blob value should be string");else if(void 0!==i.children){ie(i.children,"Trees should be of type NodeCore");const e=pe(i.children);if(s[a]=e.snapshotTree,void 0!==i.groupId){const e=re(i.groupId,"groupId should be a string");s[a].groupId=e,o++}t+=e.slowTreeStructureCount,o+=e.treeStructureCountWithGroupId}else s[a]={blobs:{},trees:{}}}return{snapshotTree:r,slowTreeStructureCount:t,treeStructureCountWithGroupId:o}}function ge(e){ie(e,"Snapshot should be of type NodeCore");const t=$(e);ie(t.treeNodes,"TreeNodes should be of type NodeCore"),ae(t.sequenceNumber,"sequenceNumber should be of type number");const{snapshotTree:o,slowTreeStructureCount:s,treeStructureCountWithGroupId:r}=pe(t.treeNodes);o.id=re(t.id,"snapshotId should be string");return{sequenceNumber:t.sequenceNumber.valueOf(),snapshotTree:o,slowTreeStructureCount:s,treeStructureCountWithGroupId:r}}function ve(e,t){const{builder:o,telemetryProps:r}=se.load(new V(e),t);(0,v.vA)(1===o.length,537);const n=$(o.getNode(0)),i=re(n.mrv,"minReadVersion should be string"),a=re(n.cv,"createVersion should be string");void 0!==n.lsn&&ae(n.lsn,"lsn should be a number"),(0,v.vA)(Number.parseFloat("1.0")>=Number.parseFloat(i),527),(0,v.vA)(Number.parseFloat(a)>=Number.parseFloat("1.0"),528),(0,v.vA)(de===a,706);const[c,h]=(0,I.xP)(()=>ge(n.snapshot)),[l,d]=(0,I.xP)(()=>function(e){ie(e,"TreeBlobs should be of type NodeCore");let t=0;const o=new Map;for(const s of e)if(ie(s,"blob should be node"),4===s.length&&"id"===s.getMaybeString(0)&&"data"===s.getMaybeString(2))o.set(s.getString(1),s.getBlob(3).arrayBuffer);else{t+=1;const e=$(s);ne(e.data,"data should be of BlobCore type");const r=re(e.id,"blob id should be string");o.set(r,e.data.arrayBuffer)}return{blobContents:o,slowBlobStructureCount:t}}(n.blobs));return(0,s.A)((0,s.A)({},c),{},{blobContents:l.blobContents,ops:void 0===n.deltas?[]:ue(n.deltas),latestSequenceNumber:n.lsn,snapshotFormatV:1,telemetryProps:(0,s.A)((0,s.A)({},r),{},{durationSnapshotTree:h,durationBlobs:d,slowTreeStructureCount:c.slowTreeStructureCount,slowBlobStructureCount:l.slowBlobStructureCount,treeStructureCountWithGroupId:c.treeStructureCountWithGroupId})})}var me=o(24217);function fe(e){let t="";for(const o of Object.keys(e))if(void 0!==e[o]){t+="".concat(""===t?"?":"&").concat(o,"=").concat(encodeURIComponent(e[o]))}return t}var be=o(58358),ye=o(46402);function Se(e){const t={},o={id:e.id,blobs:{},trees:{}};t[""]=o;for(const s of e.entries){const e=s.path.lastIndexOf("/"),o=s.path.slice(0,Math.max(0,e)),r=s.path.slice(e+1),n=t[o];if("tree"===s.type){const e={blobs:{},trees:{},unreferenced:s.unreferenced,groupId:s.groupId};n.trees[r]=e,t[s.path]=e}else"blob"===s.type&&(n.blobs[r]=s.id)}return o}function we(e){var t,o;const s=new Map;if(e.blobs)for(const i of e.blobs){var r;(0,v.vA)("base64"===i.encoding||void 0===i.encoding,164),s.set(i.id,(0,X.Xg)(i.content,null!==(r=i.encoding)&&void 0!==r?r:"utf8"))}const n=null===e||void 0===e?void 0:e.trees[0].sequenceNumber;return{blobContents:s,ops:null!==(t=null===(o=e.ops)||void 0===o?void 0:o.map(e=>e.op))&&void 0!==t?t:[],sequenceNumber:n,snapshotTree:Se(e.trees[0]),latestSequenceNumber:e.ops&&e.ops.length>0?e.ops[e.ops.length-1].sequenceNumber:n,snapshotFormatV:1}}var Te,Ce=o(27015);async function Ae(e,t,o,r,n,a,c,h,l,d){const u=e.sharingLinkToRedeem;return u&&(e.shareLinkInfo=(0,s.A)((0,s.A)({},e.shareLinkInfo),{},{sharingLinkToRedeem:u})),ke(e,t,o,n,a,c,l,d).catch(async r=>{if(d&&function(e,t){var o;if(void 0!==(null===(o=e.shareLinkInfo)||void 0===o?void 0:o.sharingLinkToRedeem)&&"object"===typeof t&&null!==t&&(t.errorType===M.E.authorizationError||t.errorType===M.E.fileNotFoundOrAccessDeniedError))return!0;return!1}(e,r)){await async function(e,t,o){await i.Bt.timedExecAsync(o,{eventName:"RedeemShareLink"},async()=>{var n,i;(0,v.vA)(!(null===(n=e.shareLinkInfo)||void 0===n||!n.sharingLinkToRedeem),493);const a=function(e){let t=(0,G.O0)(encodeURI(e));return t=t.replace(/=+$/g,"").replace(/\//g,"_").replace(/\+/g,"-"),t="u!".concat(t),t}(null===(i=e.shareLinkInfo)||void 0===i?void 0:i.sharingLinkToRedeem);let c;async function h(e){await(0,I.gO)(async o=>{c="".concat(e,"/_api/v2.0/shares/").concat(a,"/driveItem");const r=c,n="GET",i=await t((0,s.A)((0,s.A)({},o),{},{request:{url:r,method:n}}),"RedeemShareLink"),h=(0,be.b)(i);h.prefer="redeemSharingLink",await(0,I.bf)(r,{headers:h,method:n})})}if(!(0,m.Ln)(o).config.getBoolean("Fluid.Driver.Odsp.DisableUsingTenantDomainForSharesApi"))try{return void await h(new URL(e.siteUrl).origin)}catch(r){var l,d,u;o.sendTelemetryEvent({eventName:"ShareLinkRedeemFailedWithTenantDomain",details:JSON.stringify({length:null===(l=c)||void 0===l?void 0:l.length,shareLinkUrlLength:null===(d=e.shareLinkInfo)||void 0===d?void 0:d.sharingLinkToRedeem.length,queryParamsLength:new URL(null===(u=e.shareLinkInfo)||void 0===u?void 0:u.sharingLinkToRedeem).search.length,useHeaders:!0})},r)}await h(e.siteUrl)})}(e,t,n);const h=(0,s.A)((0,s.A)({},e),{},{shareLinkInfo:(0,s.A)((0,s.A)({},e.shareLinkInfo),{},{sharingLinkToRedeem:void 0})});return n.sendTelemetryEvent({eventName:"RedeemFallback",errorType:r.errorType},r),ke(h,t,o,n,a,c,l)}throw r}).catch(async e=>{throw("object"===typeof e&&null!==e&&e.errorType===M.E.authorizationError||e.errorType===M.E.fileNotFoundOrAccessDeniedError)&&await h(),e})}async function ke(e,t,o,r,n,a,c,h){return(0,I.gO)(async l=>{var d;const u=(0,I.vh)(c),p=u?"TreesLatestForGroup":"TreesLatest",g=(0,Ce.ir)(e.siteUrl),m={eventName:p,attempts:l.refresh?2:1,shareLinkPresent:void 0!==(null===(d=e.shareLinkInfo)||void 0===d?void 0:d.sharingLinkToRedeem),isSummarizer:e.summarizer,redeemFallbackEnabled:h,details:{internalFarmType:g}};if(void 0!==o)for(const[e,t]of Object.entries(o))void 0!==t&&(m["snapshotOption_".concat(e)]=t);return i.Bt.timedExecAsync(r,m,async i=>{var h,d,p,g,m,f,b;let y,w;void 0!==(null===o||void 0===o?void 0:o.timeout)&&(y=new AbortController,w=setTimeout(()=>y.abort(),o.timeout));const[T,C]=await(0,I.jL)(async()=>n(e,t,l,c,o,y)).finally(()=>{void 0!==w&&(clearTimeout(w),w=void 0)}),A=T.odspResponse,k=A.headers.get("content-type"),E=(0,s.A)((0,s.A)({},A.propsToLog),{},{contentType:k,accept:T.requestHeaders.accept,driverVersion:K.z});let N,L,P,R;null!==k&&void 0!==k&&k.includes("application/ms-fluid")?L="application/ms-fluid":null!==k&&void 0!==k&&k.includes("application/json")&&(L="application/json");try{switch(L){case"application/json":{let e,t;[e,R]=await(0,I.jL)(async()=>A.content.text().then(e=>(0===e.length&&(0,_.lJ)("Response from browser is empty",_.TX,A.content,void 0,E),e)).catch(e=>(0,_.lJ)("Error while parsing fetch response",_.TX,A.content,void 0,E))),E.bodySize=e.length,[t,P]=(0,I.xP)(()=>JSON.parse(e)),function(e){(0,v.vA)(void 0!==e.trees,512),(0,v.vA)(void 0!==e.blobs,513)}(t);const o=we(t);N=(0,s.A)((0,s.A)({},A),{},{content:(0,s.A)((0,s.A)({},o),{},{telemetryProps:{}})});break}case"application/ms-fluid":{var B,F,O;let e,t;if([e,R]=await(0,I.jL)(async()=>A.content.arrayBuffer().then(e=>(0===e.byteLength&&(0,_.lJ)("Response from browser is empty",_.TX,A.content,void 0,E),e)).catch(e=>(0,_.lJ)("Error while parsing fetch response",_.TX,A.content,void 0,E))),E.bodySize=e.byteLength,[t,P]=(0,I.xP)(()=>ve(new Uint8Array(e),r)),void 0===t.snapshotTree.trees||void 0===t.snapshotTree.blobs)throw new S.OI("Returned odsp snapshot is malformed. No trees or blobs!",M.E.incorrectServerResponse,E);const o=t.telemetryProps,n=null!==(B=o.slowTreeStructureCount)&&void 0!==B?B:0,i=null!==(F=o.slowBlobStructureCount)&&void 0!==F?F:0,a=null!==(O=o.treeStructureCountWithGroupId)&&void 0!==O?O:0;(n-a>10||i>10)&&r.sendErrorEvent({eventName:"SlowSnapshotParseCodePaths",slowTreeStructureCount:n,slowBlobStructureCount:i,treeStructureCountWithGroupId:a}),N=(0,s.A)((0,s.A)({},A),{},{content:t});break}default:throw new S.OI("Unknown snapshot content type",M.E.incorrectServerResponse,E)}}catch(V){if((0,W.X)(V))throw V.addTelemetryProperties(E),V;throw(0,z.J4)(V,e=>new S.OI("Error parsing snapshot response: ".concat(e),M.E.genericError,E))}(0,v.vA)(void 0!==N,786);const U=N.content,D="true"!==A.headers.get("disablebrowsercachingofusercontent")&&!u,x=null!==(h=U.sequenceNumber)&&void 0!==h?h:0,G=U.ops&&U.ops.length>0?U.ops[0].sequenceNumber-1:void 0;if(!Number.isInteger(x)||void 0!==G&&G!==x)r.sendErrorEvent({eventName:"fetchSnapshotError",sequenceNumber:x,seqNumberFromOps:G}),U.sequenceNumber=void 0;else if(D){const e=A.headers.get("x-fluid-epoch");(0,v.vA)(void 0!==e,486);const t={value:(0,s.A)((0,s.A)({},U),{},{cacheEntryTime:Date.now()}),fluidEpoch:e,version:me.F};a(t)}return i.end((0,s.A)((0,s.A)((0,s.A)((0,s.A)({},Ee(U)),{},{blobs:null!==(d=null===(p=U.blobContents)||void 0===p?void 0:p.size)&&void 0!==d?d:0,sequenceNumber:x,ops:null!==(g=null===(m=U.ops)||void 0===m?void 0:m.length)&&void 0!==g?g:0,fetchSnapshotForLoadingGroup:u,useLegacyFlowWithoutGroups:(0,I.Ss)(c),userOps:null!==(f=null===(b=U.ops)||void 0===b?void 0:b.filter(e=>e.type===q.Operation).length)&&void 0!==f?f:0,fetchTime:C,parseTime:P,receiveContentTime:R},function(e,t){var o,s,r;let n,i,a,c,h,l,d,u;const p=null!==(o=null===(s=(r=globalThis.performance).getEntriesByType)||void 0===s?void 0:s.call(r,"resource"))&&void 0!==o?o:[];for(let g=p.length-1;g>0;g--){const o=p[g],s=o.name.toString();if(0===o.initiatorType.localeCompare(t)&&s.includes(e)){i=o.redirectEnd-o.redirectStart,u=o.fetchStart,n=o.domainLookupEnd-o.domainLookupStart,a=o.connectEnd-o.connectStart,c=o.secureConnectionStart>0?o.connectEnd-o.secureConnectionStart:0,h=o.responseStart>0?o.responseEnd-o.responseStart:void 0,l=o.fetchStart>0?o.responseEnd-o.fetchStart:void 0,d=o.requestStart>0?o.responseEnd-o.requestStart:void 0;break}}return{dnsLookupTime:n,w3cStartTime:u,redirectTime:i,tcpHandshakeTime:a,secureConnectionTime:c,responseNetworkTime:h,fetchStartToResponseEndTime:l,reqStartToResponseEndTime:d}}(T.requestUrl,"fetch")),{},{sltelemetry:A.headers.get("x-fluid-sltelemetry")},E),N.content.telemetryProps)),U}).catch(e=>{throw"object"!==typeof e||null===e||e.errorType!==M.E.fetchFailure&&e.errorType!==M.E.fetchTimeout||(e[I.TV]=!0),e})})}function Ee(e){const t={trees:0,leafTrees:0,blobNodes:0};Ne(e.snapshotTree,t);let o=0;for(const[s,r]of e.blobContents)o+=r.byteLength;return(0,s.A)((0,s.A)({},t),{},{encodedBlobsSize:o})}function Ne(e,t){t.blobNodes+=Object.entries(e.blobs).length,t.trees++;const o=Object.entries(e.trees);if(0===o.length)t.leafTrees++;else for(const[s,r]of o)t.trees++,Ne(r,t)}!function(e){e[e.Json=0]="Json",e[e.Binary=1]="Binary",e[e.JsonAndBinary=2]="JsonAndBinary"}(Te||(Te={}));const Ie=(0,ye.p)(async(e,t,o,r,n,i,c,h,l)=>{var d;const u=e.sharingLinkToRedeem;u&&(e.shareLinkInfo=(0,s.A)((0,s.A)({},e.shareLinkInfo),{},{sharingLinkToRedeem:u}));const p=e.endpoints.snapshotStorageUrl,g={ump:1};if(void 0!==n)for(const[s,a]of Object.entries(n))void 0!==a&&"timeout"!==s&&(g[s]=a);void 0!==r&&(g.groupId=r.join(","));const m=fe(g),f="".concat(p,"/trees/latest").concat(m),b="POST",y=await t((0,s.A)((0,s.A)({},o),{},{request:{url:f,method:b}}),"downloadSnapshot");(0,v.vA)(null!==y,485);const{body:S,headers:w}=function(e,t,o){var s;const r=(0,a.A)(),n=[];if(n.push("--".concat(r),"Authorization: ".concat(t),"X-HTTP-Method-Override: GET"),void 0!==o)for(const[a,c]of Object.entries(o))void 0!==c&&n.push("".concat(a,": ").concat(c));var i;return null!==(s=e.shareLinkInfo)&&void 0!==s&&s.sharingLinkToRedeem&&n.push("sl: ".concat(null===(i=e.shareLinkInfo)||void 0===i?void 0:i.sharingLinkToRedeem)),n.push("_post: 1","\r\n--".concat(r,"--")),{body:n.join("\r\n"),headers:{"Content-Type":"multipart/form-data;boundary=".concat(r)}}}(e,y,{prefer:"manualredirect"}),T={body:S,headers:w,signal:null===c||void 0===c?void 0:c.signal,method:b};if(i===Te.Binary)w.accept="application/ms-fluid; v=".concat(de);else w.accept="application/json, application/ms-fluid; v=".concat(de);return{odspResponse:await(null!==(d=null===h||void 0===h?void 0:h.fetch(f,T,"treesLatest",!0,l))&&void 0!==d?d:(0,I.ZR)(f,T)),requestHeaders:w,requestUrl:f}});class Le{constructor(){this.deferBlobCacheClear=!1,this._blobCache=new Map,this.blobsEvicted=new Set,this.blobCacheTimeoutDuration=12e4,this.purgeEnabled=!1}get value(){return this._blobCache}addBlobs(e){for(const[t,o]of e.entries())this._blobCache.set(t,o);this.scheduleClearBlobsCache()}scheduleClearBlobsCache(){if(void 0!==this.blobCacheTimeout)this.deferBlobCacheClear=!0;else if(this.purgeEnabled){const e=()=>{if(this.blobCacheTimeout=void 0,this.deferBlobCacheClear)this.deferBlobCacheClear=!1,this.scheduleClearBlobsCache();else{for(const e of this._blobCache.keys())this.blobsEvicted.add(e);this._blobCache.clear()}};this.blobCacheTimeout=setTimeout(e,this.blobCacheTimeoutDuration),this.blobCacheTimeoutDuration=1e4}}getBlob(e){this.scheduleClearBlobsCache();return{blobContent:this._blobCache.get(e),evicted:this.blobsEvicted.has(e)}}setBlob(e,t){if(t.byteLength<262144)return this.scheduleClearBlobsCache(),this._blobCache.set(e,t);this.blobsEvicted.add(e)}}class Pe{constructor(e){this.commitCache=new Map,this.blobCache=new Le;const t=e.getBoolean("Fluid.Driver.Odsp.TestOverride.DisableSnapshotCache")?0:d.Pb;this.policies={caching:R.NoCaching,maximumCacheDurationMs:t}}set ops(e){(0,v.vA)(void 0===this._ops,165),this._ops=e}get ops(){return this._ops}get snapshotSequenceNumber(){return this._snapshotSequenceNumber}async readBlobCore(e){const{blobContent:t,evicted:o}=this.blobCache.getBlob(e);return null!==t&&void 0!==t?t:this.fetchBlobFromStorage(e,o)}async readBlob(e){return this.readBlobCore(e)}async getSnapshotTree(e,t){let o;if(null!==e&&void 0!==e&&e.id)o=e.id;else{const e=await this.getVersions(null,1,t);if(!e||0===e.length)return null;o=e[0].id}const s=await this.readTree(o,t);return s?this.combineProtocolAndAppSnapshotTree(s):null}async downloadSummary(e){throw new Error("Not implemented yet")}setRootTree(e,t){this.commitCache.set(e,t)}initBlobsCache(e){this.blobCache.addBlobs(e)}async readTree(e,t){let o=this.commitCache.get(e);return o||(o=await this.fetchTreeFromSnapshot(e,t)),null!==o&&void 0!==o?o:null}combineProtocolAndAppSnapshotTree(e){const t=e.trees[".app"],o=e.trees[".protocol"],r={blobs:(0,s.A)({},t.blobs),trees:(0,s.A)({},t.trees),id:e.id};return void 0!==o&&(r.trees[".protocol"]=o),r}initializeFromSnapshot(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this._snapshotSequenceNumber=e.sequenceNumber;const{snapshotTree:s,blobContents:r,ops:n}=e;let i;return s&&(i=s.id,(0,v.vA)(void 0!==i,545),o&&this.setRootTree(i,s)),void 0!==r&&this.initBlobsCache(r),t&&(this.ops=n),i}}class Re extends Pe{constructor(e,t,o,s,r,n,i,a,c,h){super((0,m.Ln)(o).config),this.odspResolvedUrl=e,this.getAuthHeader=t,this.logger=o,this.fetchFullSnapshot=s,this.cache=r,this.hostPolicy=n,this.epochTracker=i,this.flushCallback=a,this.relayServiceTenantAndSessionId=c,this.snapshotFormatFetchType=h,this.odspSummaryModuleLoaded=!1,this.firstSnapshotFetchCall=!0,this.maxSnapshotSizeLimit=5e8,this.maxSnapshotFetchTimeout=12e4,this.createBlobRateLimiter=new x.v(1),this.documentId=this.odspResolvedUrl.hashedDocumentId,this.snapshotUrl=this.odspResolvedUrl.endpoints.snapshotStorageUrl,this.attachmentPOSTUrl=this.odspResolvedUrl.endpoints.attachmentPOSTStorageUrl,this.attachmentGETUrl=this.odspResolvedUrl.endpoints.attachmentGETStorageUrl,this.config=(0,m.Ln)(o).config}get isFirstSnapshotFromNetwork(){return this._isFirstSnapshotFromNetwork}async createBlob(e){this.checkAttachmentPOSTUrl();return(await(0,I.gO)(async t=>{const o="".concat(this.attachmentPOSTUrl,"/content"),r="POST",n=await this.getAuthHeader((0,s.A)((0,s.A)({},t),{},{request:{url:o,method:r}}),"CreateBlob"),a=(0,be.b)(n);return a["Content-Type"]="application/octet-stream",i.Bt.timedExecAsync(this.logger,{eventName:"createBlob",size:e.byteLength,waitQueueLength:this.createBlobRateLimiter.waitQueueLength},async t=>{const n=await this.createBlobRateLimiter.schedule(async()=>this.epochTracker.fetchAndParseAsJSON(o,{body:e,headers:a,method:r},"createBlob"));return t.end((0,s.A)({blobId:n.content.id},n.propsToLog)),n})})).content}async fetchBlobFromStorage(e,t){this.checkAttachmentGETUrl();const o=await(0,I.gO)(async o=>{const r="".concat(this.attachmentGETUrl,"/").concat(encodeURIComponent(e),"/content"),n=await this.getAuthHeader((0,s.A)((0,s.A)({},o),{},{request:{url:r,method:"GET"}}),"GetBlob"),a=(0,be.b)(n);return i.Bt.timedExecAsync(this.logger,{eventName:"readDataBlob",blobId:e,evicted:t,waitQueueLength:this.epochTracker.rateLimiter.waitQueueLength},async t=>{const n=await this.epochTracker.fetchArray(r,{headers:a},"blob");t.end((0,s.A)((0,s.A)({waitQueueLength:this.epochTracker.rateLimiter.waitQueueLength},n.propsToLog),{},{attempts:o.refresh?2:1}));const i=n.headers.get("cache-control");return void 0!==i&&(i.includes("private")||i.includes("public"))||this.logger.sendErrorEvent((0,s.A)({eventName:"NonCacheableBlob",cacheControl:i,blobId:e},n.propsToLog)),n.content})});return this.blobCache.setBlob(e,o),o}async getSnapshotTree(e,t){return this.snapshotUrl?super.getSnapshotTree(e,t):null}async getSnapshot(e){var t;const{snapshot:o}=await this.fetchSnapshot((0,s.A)((0,s.A)({},e),{},{fetchSource:(0,I.vh)(null===e||void 0===e?void 0:e.loadingGroupIds)?B.noCache:null===e||void 0===e?void 0:e.fetchSource,loadingGroupIds:null!==(t=null===e||void 0===e?void 0:e.loadingGroupIds)&&void 0!==t?t:[]}));return(0,s.A)((0,s.A)({},o),{},{snapshotTree:this.combineProtocolAndAppSnapshotTree(o.snapshotTree)})}async fetchSnapshot(e){var t;const o=this.hostPolicy.snapshotOptions,r=await i.Bt.timedExecAsync(this.logger,{eventName:(0,I.vh)(e.loadingGroupIds)?"ObtainSnapshotForGroup":"ObtainSnapshot",fetchSource:null===e||void 0===e?void 0:e.fetchSource},async t=>{const r={};let n,i,a=0,c=(0,b.l)();if(e.fetchSource===B.noCache)n=await this.fetchSnapshotFromNetwork(o,e.loadingGroupIds,e.scenarioName),i="networkOnly";else{const t=this.epochTracker.get((0,I.wL)(this.odspResolvedUrl,(0,I.JH)(this.config))).then(async e=>{if(void 0!==e){var t;const o=Date.now()-(null!==(t=e.cacheEntryTime)&&void 0!==t?t:Date.now()-2592e6);if(this.hostPolicy.summarizerClient){if(o>6e4)return void(r.cacheSummarizerExpired=!0);r.cacheSummarizerExpired=!1}if(r.cacheEntryAge=o,(0,I.IU)(e))return e;return{snapshotTree:e.snapshotTree,blobContents:e.blobs,ops:e.ops,latestSequenceNumber:e.latestSequenceNumber,sequenceNumber:e.sequenceNumber,snapshotFormatV:1}}});if(this.firstSnapshotFetchCall&&this.hostPolicy.concurrentSnapshotFetch&&!this.hostPolicy.summarizerClient){const s=this.fetchSnapshotFromNetwork(o,e.loadingGroupIds,e.scenarioName),r=await async function(e){return new Promise((t,o)=>{e.forEach((e,s)=>{e.then(e=>t({index:s,value:e})).catch(o)})})}([t.catch(()=>{}),s.catch(()=>{})]);if(n=r.value,i=0===r.index?"cache":"network",void 0===n)try{1===r.index&&(n=await t,i="cache"),void 0===n&&(n=await s,i="network")}catch(l){const e=l.stack,t=(0,z.cQ)(l);t.addTelemetryProperties({innerStack:e});const o="<<STACK TRUNCATED: see innerStack property>> \n".concat((0,z.aX)());throw(0,z.kc)(t,o),t}}else{const s=(0,b.l)();n=await t,a=(0,b.l)()-s,i=void 0===n?"network":"cache",void 0===n&&(c=(0,b.l)(),n=await this.fetchSnapshotFromNetwork(o,e.loadingGroupIds,e.scenarioName))}}"network"===i&&(r.cacheEntryAge=void 0),this.firstSnapshotFetchCall&&(this._isFirstSnapshotFromNetwork="cache"!==i);const h=n.prefetchStartTime;return t.end((0,s.A)((0,s.A)((0,s.A)({},r),{},{method:i,fetchSnapshotForInitialLoad:this.firstSnapshotFetchCall,useLegacyFlowWithoutGroups:(0,I.Ss)(e.loadingGroupIds),avoidPrefetchSnapshotCache:this.hostPolicy.avoidPrefetchSnapshotCache},Ee(n)),{},{cacheLookupTimeInSerialFetch:a,prefetchSavedDuration:void 0!==h&&"cache"!==i?c-h:void 0})),n}),n=(0,b.l)(),a=this.initializeFromSnapshot(r,this.firstSnapshotFetchCall,null!==(t=null===e||void 0===e?void 0:e.cacheSnapshot)&&void 0!==t?t:this.firstSnapshotFetchCall);return this.logger.sendTelemetryEvent({eventName:"SnapshotInitializeTime",duration:(0,b.l)()-n},void 0,F.$.verbose),this.firstSnapshotFetchCall=!1,{snapshot:r,id:a}}async getVersions(e,t,o,r){if(e!==this.documentId&&e)return[{id:e,treeId:void 0}];if(!this.snapshotUrl)return[];if(1===t&&(null===e||e===this.documentId)){const{id:t}=await this.fetchSnapshot({cacheSnapshot:!0,scenarioName:o,versionId:null!==e&&void 0!==e?e:void 0,fetchSource:r});return t?[{id:t,treeId:void 0}]:[]}return(0,I.gO)(async e=>{const r="".concat(this.snapshotUrl,"/versions?top=").concat(t),n=await this.getAuthHeader((0,s.A)((0,s.A)({},e),{},{request:{url:r,method:"GET"}}),"GetVersions"),a=(0,be.b)(n),c=(await i.Bt.timedExecAsync(this.logger,{eventName:"getVersions"},async()=>this.epochTracker.fetchAndParseAsJSON(r,{headers:a},"versions",void 0,o))).content;if(!c)throw new S.OI("No response from /versions endpoint",M.E.genericNetworkError,{driverVersion:K.z});if(!Array.isArray(c.value))throw new S.OI("Incorrect response from /versions endpoint, expected an array",M.E.genericNetworkError,{driverVersion:K.z});return c.value.map(e=>({id:e.id,treeId:void 0}))})}async fetchSnapshotFromNetwork(e,t,o){return this.fetchSnapshotFromNetworkCore(e,t,o).catch(e=>{throw"object"===typeof e&&null!==e&&(e.canRetry=!1),e})}async fetchSnapshotFromNetworkCore(e,t,o){if(!this.hostPolicy.avoidPrefetchSnapshotCache&&this.firstSnapshotFetchCall){var r;const e=(0,d.V$)((0,I.wL)(this.odspResolvedUrl,(0,I.JH)(this.config))),t=await(null===(r=this.cache.snapshotPrefetchResultCache)||void 0===r||null===(r=r.get(e))||void 0===r?void 0:r.then(async t=>(this.cache.snapshotPrefetchResultCache.remove(e),await this.epochTracker.validateEpoch(t.fluidEpoch,"treesLatest"),t)).catch(async e=>{this.logger.sendTelemetryEvent({eventName:"PrefetchSnapshotError",concurrentSnapshotFetch:this.hostPolicy.concurrentSnapshotFetch},e)}));if(void 0!==t)return t}const n=(0,s.A)((0,s.A)({mds:this.maxSnapshotSizeLimit},e),{},{timeout:null!==e&&void 0!==e&&e.timeout?Math.min(e.timeout,this.maxSnapshotFetchTimeout):this.maxSnapshotFetchTimeout});this.hostPolicy.summarizerClient&&(n.mds=void 0,n.timeout=void 0);const i=async(e,t,s,r,n,i)=>Ie(e,t,s,r,n,this.snapshotFormatFetchType,i,this.epochTracker,o),a=async e=>this.cache.persistedCache.put((0,I.wL)(this.odspResolvedUrl,(0,I.JH)(this.config)),e.value),c=async()=>this.cache.persistedCache.removeEntries();try{var h;return await Ae(this.odspResolvedUrl,this.getAuthHeader,n,null===(h=this.hostPolicy.sessionOptions)||void 0===h||h.forceAccessTokenViaAuthorizationHeader,this.logger,i,a,c,t,this.hostPolicy.enableRedeemFallback)}catch(u){const o=u.errorType;if(o===M.E.snapshotTooBig&&void 0!==(null===e||void 0===e?void 0:e.mds)&&!0!==this.hostPolicy.summarizerClient)throw u;if((o===M.E.snapshotTooBig||o===M.E.fetchTimeout)&&n.blobs){var l;this.logger.sendErrorEvent({eventName:"TreeLatest_SecondCall",errorType:o});const e=(0,s.A)((0,s.A)({},n),{},{blobs:0,mds:void 0,timeout:void 0});return await Ae(this.odspResolvedUrl,this.getAuthHeader,e,null===(l=this.hostPolicy.sessionOptions)||void 0===l||l.forceAccessTokenViaAuthorizationHeader,this.logger,i,a,c,t,this.hostPolicy.enableRedeemFallback)}throw u}}async uploadSummaryWithContext(e,t){if(this.checkSnapshotUrl(),void 0===this.summaryModuleP&&(this.summaryModuleP=this.getDelayLoadedSummaryManager()),".protocol"in e.tree&&void 0!==t.ackHandle){let e=1;for(;;){var o;const r=await this.flushCallback(),n=r.lastPersistedSequenceNumber;if(void 0!==n&&n>=t.referenceSequenceNumber)break;if(e>3){this.logger.sendErrorEvent((0,s.A)((0,s.A)({eventName:"FlushFailure"},r),{},{retry:e,referenceSequenceNumber:t.referenceSequenceNumber}));break}this.logger.sendPerformanceEvent((0,s.A)((0,s.A)({eventName:"FlushExtraCall"},r),{},{retry:e,referenceSequenceNumber:t.referenceSequenceNumber})),e++,await(0,O.c)(1e3*(null!==(o=r.retryAfter)&&void 0!==o?o:1))}}this.odspSummaryUploadManager||(this.odspSummaryUploadManager=await this.summaryModuleP.then(async e=>(this.odspSummaryModuleLoaded=!0,e)).catch(e=>{throw this.odspSummaryModuleLoaded=!1,e})),(0,v.vA)(void 0!==this.odspSummaryUploadManager,1390);const r=await this.odspSummaryUploadManager.writeSummaryTree(e,t),{pendingRename:n}=this.odspResolvedUrl;if(void 0!==n&&!0!==this.config.getBoolean("Fluid.Driver.Odsp.disablePendingRename")){(0,v.vA)(void 0===t.ackHandle&&void 0===t.proposalHandle&&0===t.referenceSequenceNumber,2696);const e=await c(this.logger,async e=>e.renameEmptyFluidFile(this.getAuthHeader,this.odspResolvedUrl,n,this.logger,this.epochTracker));this.odspResolvedUrl.pendingRename=void 0,this.odspResolvedUrl.fileName=e.name}return r}async getDelayLoadedSummaryManager(){(0,v.vA)(!1===this.odspSummaryModuleLoaded,1391);const e=await o.e(11133).then(o.bind(o,67300)).then(e=>(this.logger.sendTelemetryEvent({eventName:"SummaryModuleLoaded"}),e)).catch(e=>{throw this.logger.sendErrorEvent({eventName:"SummaryModuleLoadFailed"},e),e});return this.odspSummaryUploadManager=new e.OdspSummaryUploadManager(this.odspResolvedUrl.endpoints.snapshotStorageUrl,this.getAuthHeader,this.logger,this.epochTracker,this.relayServiceTenantAndSessionId),this.odspSummaryUploadManager}checkSnapshotUrl(){if(!this.snapshotUrl)throw new S.OI("Method failed because no snapshot url was available",M.E.genericError,{driverVersion:K.z})}checkAttachmentPOSTUrl(){if(!this.attachmentPOSTUrl)throw new S.OI("Method failed because no attachment POST url was available",M.E.genericError,{driverVersion:K.z})}checkAttachmentGETUrl(){if(!this.attachmentGETUrl)throw new S.OI("Method failed because no attachment GET url was available",M.E.genericError,{driverVersion:K.z})}async fetchTreeFromSnapshot(e,t){return(0,I.gO)(async o=>{var r,n;const a=await async function(e,t,o,s,r,n){const a="/trees/".concat(t);let c={};o&&(c="latest"===t?{deltas:1,blobs:2}:{blobs:2});const h=fe(c),l="".concat(e).concat(a).concat(h);return we((await i.Bt.timedExecAsync(r,{eventName:"fetchSnapshot"},async()=>n(l))).content)}(this.snapshotUrl,e,this.fetchFullSnapshot,null===(r=this.hostPolicy.sessionOptions)||void 0===r||r.forceAccessTokenViaAuthorizationHeader,this.logger,async e=>{const r=await this.getAuthHeader((0,s.A)((0,s.A)({},o),{},{request:{url:e,method:"GET"}}),"ReadCommit"),n=(0,be.b)(r);return this.epochTracker.fetchAndParseAsJSON(e,{headers:n},"snapshotTree",void 0,t)});let c="";return a.snapshotTree&&((0,v.vA)(void 0!==a.snapshotTree.id,546),c=a.snapshotTree.id,this.setRootTree(c,a.snapshotTree)),a.blobContents&&this.initBlobsCache(a.blobContents),null!==(n=this.commitCache.get(e))&&void 0!==n?n:this.commitCache.get(c)})}}class Be{constructor(e,t,o,s,r,n){this.logger=t,this.cache=o,this.batchSize=s,this.timerGranularity=r,this.totalOpsToCache=n,this.batches=new Map;const i=this.batchSize-this.getPositionInBatchArray(e)-1;0!==i&&this.batches.set(this.getBatchNumber(e),{remainingSlots:i,batchData:this.initializeNewBatchDataArray(),dirty:!1})}dispose(){this.batches.clear(),void 0!==this.timer&&(clearTimeout(this.timer),this.timer=void 0)}flushOps(){for(const[e,t]of this.batches)null===t||!t.dirty||0===t.batchData.length||void 0===t.batchData[0]&&void 0===t.batchData[t.batchData.length-1]||(t.dirty=!1,this.write(e,t))}addOps(e){if(!(this.totalOpsToCache<=0))for(const t of e){const e=this.getBatchNumber(t.sequenceNumber),o=this.getPositionInBatchArray(t.sequenceNumber);let s=this.batches.get(e);if(void 0===s)s={remainingSlots:this.batchSize-1,batchData:this.initializeNewBatchDataArray(),dirty:!0},s.batchData[o]=t,this.batches.set(e,s);else{if(null===s||void 0!==s.batchData[o])return;s.batchData[o]=t,s.remainingSlots--,s.dirty=!0}if(0===s.remainingSlots?(this.write(e,s),this.batches.set(e,null)):this.scheduleTimer(),this.totalOpsToCache--,0===this.totalOpsToCache){this.logger.sendPerformanceEvent({eventName:"CacheOpsLimitHit"}),this.cache.remove(),this.dispose();break}}}async getCore(e,t){const o=[];let s=this.getBatchNumber(e);for(;;){const r=await this.cache.read("".concat(this.batchSize,"_").concat(s));if(void 0===r)return o;const n=JSON.parse(r),i=o.length;for(const s of n)if(s){if(void 0!==t&&s.sequenceNumber>=t)return o;if(0===o.length){if(s.sequenceNumber>e)return o;if(s.sequenceNumber<e)continue}o.push(s)}else if(o.length>0)return o;if(i===o.length)return o;s++}}async get(e,t){const o=(0,b.l)(),s=await this.getCore(e,t),r=(0,b.l)()-o;return(s.length>0||r>1e3)&&this.logger.sendPerformanceEvent({eventName:"CacheOpsUsed",from:e,to:t,length:s.length,duration:r}),s}write(e,t){this.cache.write("".concat(this.batchSize,"_").concat(e),JSON.stringify(t.batchData)).catch(()=>{this.totalOpsToCache=0})}scheduleTimer(){!this.timer&&this.timerGranularity>0&&(this.timer=setTimeout(()=>{this.timer=void 0,this.flushOps()},this.timerGranularity))}getBatchNumber(e){return Math.floor(e/this.batchSize)}getPositionInBatchArray(e){return e%this.batchSize}initializeNewBatchDataArray(){const e=[];return e.length=this.batchSize,e}}var Fe=o(34023);z.iq;class Oe extends z.iq{constructor(e,t){super(e,(0,s.A)((0,s.A)({},t),{},{usageError:!0})),this.errorType=Fe.k.usageError}}z.iq;z.iq;var qe=o(62951);class Ue{constructor(e,t){this.internalStorageService=e,this.logger=t,this._disposed=!1}get policies(){return this.internalStorageService.policies}get disposed(){return this._disposed}dispose(){this._disposed=!0}async getSnapshotTree(e){return this.runWithRetry(async()=>this.internalStorageService.getSnapshotTree(e),"storage_getSnapshotTree")}async getSnapshot(e){return this.runWithRetry(async()=>{if(void 0!==this.internalStorageService.getSnapshot)return this.internalStorageService.getSnapshot(e);throw new Oe("getSnapshot should exist in storage adapter in ODSP driver")},"storage_getSnapshot")}async readBlob(e){return this.runWithRetry(async()=>this.internalStorageService.readBlob(e),"storage_readBlob")}async getVersions(e,t,o,s){return this.runWithRetry(async()=>this.internalStorageService.getVersions(e,t,o,s),"storage_getVersions")}async uploadSummaryWithContext(e,t){return this.runWithRetry(async()=>this.internalStorageService.uploadSummaryWithContext(e,t),"storage_uploadSummaryWithContext")}async downloadSummary(e){return this.runWithRetry(async()=>this.internalStorageService.downloadSummary(e),"storage_downloadSummary")}async createBlob(e){return this.runWithRetry(async()=>this.internalStorageService.createBlob(e),"storage_createBlob")}checkStorageDisposed(){if(this._disposed)throw new z.iq("Storage Service is disposed. Cannot retry",{canRetry:!1})}async runWithRetry(e,t){return(0,qe.M)(e,t,this.logger,()=>this.checkStorageDisposed())}}class De extends g.X{static async create(e,t,o,s,r,n,i,a,c){return new De((0,I.Yn)(e),t,o,s,r,n,i,a,c)}constructor(e,t,o,r,n,i,a,c,h){super(),this.odspResolvedUrl=e,this.getAuthHeader=t,this.getWebsocketToken=o,this.cache=n,this.epochTracker=a,this.socketReferenceKeyPrefix=c,this.clientIsSummarizer=h,this.odspSocketModuleLoaded=!1,this._policies={storageOnly:void 0!==e.fileVersion,summarizeProtocolTree:!0,supportGetSnapshotApi:!0},this.mc=(0,m.CL)({logger:r,properties:{all:{odc:(0,Ce.je)(new URL(this.odspResolvedUrl.endpoints.snapshotStorageUrl))}}}),this.hostPolicy=i,this.hostPolicy.supportGetSnapshotApi=this._policies.supportGetSnapshotApi,this.clientIsSummarizer&&(this.hostPolicy=(0,s.A)((0,s.A)({},this.hostPolicy),{},{summarizerClient:!0}))}get resolvedUrl(){return this.odspResolvedUrl}get policies(){return this._policies}async connectToStorage(){return this.storageManager||(this.storageManager=new Re(this.odspResolvedUrl,this.getAuthHeader,this.mc.logger,!0,this.cache,this.hostPolicy,this.epochTracker,async()=>{var e;const t=null===(e=this.odspDelayLoadedDeltaStream)||void 0===e?void 0:e.currentDeltaConnection;if(void 0!==t&&!t.disposed)return t.flush();throw new Error("Disconnected while uploading summary (attempt to perform flush())")},()=>{var e;return null===(e=this.odspDelayLoadedDeltaStream)||void 0===e?void 0:e.relayServiceTenantAndSessionId},this.mc.config.getNumber("Fluid.Driver.Odsp.snapshotFormatFetchType"))),new Ue(this.storageManager,this.mc.logger)}async connectToDeltaStorage(){var e,t,o,s;const r=null!==(e=null===(t=this.storageManager)||void 0===t?void 0:t.ops)&&void 0!==e?e:[],n=new L(this.odspResolvedUrl.endpoints.deltaStorageUrl,this.getAuthHeader,this.epochTracker,this.mc.logger),i=null!==(o=this.hostPolicy.opsBatchSize)&&void 0!==o?o:5e3,a=null!==(s=this.hostPolicy.concurrentOpsBatches)&&void 0!==s?s:1;return new P(r,this.mc.logger,i,a,async(e,t,o,s)=>n.get(e,t,o,s),async(e,t)=>{var o;const s=await(null===(o=this.opsCache)||void 0===o?void 0:o.get(e,t));return null!==s&&void 0!==s?s:[]},(e,t)=>{var o;const s=null===(o=this.odspDelayLoadedDeltaStream)||void 0===o?void 0:o.currentDeltaConnection;void 0===s||s.disposed||s.requestOps(e,t)},e=>this.opsReceived(e),()=>this.storageManager)}async connectToDeltaStream(e){return void 0===this.socketModuleP&&(this.socketModuleP=this.getDelayLoadedDeltaStream()),this.socketModuleP.then(async t=>(this.odspSocketModuleLoaded=!0,t.connectToDeltaStream(e))).catch(e=>{throw this.socketModuleP=void 0,this.odspSocketModuleLoaded=!1,e})}async getDelayLoadedDeltaStream(){(0,v.vA)(!1===this.odspSocketModuleLoaded,1287);const e=await o.e(12956).then(o.bind(o,92024)).then(e=>(this.mc.logger.sendTelemetryEvent({eventName:"SocketModuleLoaded"}),e)).catch(e=>{throw this.mc.logger.sendErrorEvent({eventName:"SocketModuleLoadFailed"},e),e});return this.odspDelayLoadedDeltaStream=new e.OdspDelayLoadedDeltaStream(this.odspResolvedUrl,this._policies,this.getAuthHeader,this.getWebsocketToken,this.mc,this.cache,this.hostPolicy,this.epochTracker,e=>this.opsReceived(e),e=>this.emit("metadataUpdate",e),this.socketReferenceKeyPrefix),this.odspDelayLoadedDeltaStream}dispose(e){var t,o,s;void 0===e?null===(s=this._opsCache)||void 0===s||s.flushOps():this.epochTracker.removeEntries().catch(()=>{});null===(t=this._opsCache)||void 0===t||t.dispose(),null===(o=this.odspDelayLoadedDeltaStream)||void 0===o||o.dispose()}get opsCache(){var e,t,o,r,n,i,a;if(this._opsCache)return this._opsCache;const c=null===(e=this.storageManager)||void 0===e?void 0:e.snapshotSequenceNumber,h=null!==(t=null===(o=this.hostPolicy.opsCaching)||void 0===o?void 0:o.batchSize)&&void 0!==t?t:100;if(void 0===c||h<1)return;const l={type:"ops"};return this._opsCache=new Be(c,this.mc.logger,{write:async(e,t)=>this.cache.persistedCache.put((0,s.A)((0,s.A)({},l),{},{key:e}),t),read:async e=>this.cache.persistedCache.get((0,s.A)((0,s.A)({},l),{},{key:e})),remove:()=>{this.cache.persistedCache.removeEntries().catch(()=>{})}},h,null!==(r=null===(n=this.hostPolicy.opsCaching)||void 0===n?void 0:n.timerGranularity)&&void 0!==r?r:5e3,null!==(i=null===(a=this.hostPolicy.opsCaching)||void 0===a?void 0:a.totalOpsToCache)&&void 0!==i?i:5e3),this._opsCache}opsReceived(e){var t;0===e.length||this.odspResolvedUrl.summarizer||null===(t=this.opsCache)||void 0===t||t.addOps(e)}}class xe{get snapshotPrefetchResultCache(){return this.nonPersistentCache.snapshotPrefetchResultCache}get IRelaySessionAwareDriverFactory(){return this}async getRelayServiceSessionInfo(e){const t=(0,I.Yn)(e),o=await this.nonPersistentCache.sessionJoinCache.get((0,I.Q1)(t));return null===o||void 0===o?void 0:o.joinSessionResponse}async createContainer(e,t,o,a){const l=(0,I.Yn)(t),d={siteUrl:l.siteUrl,driveId:l.driveId,itemId:l.itemId};let u,p;if(l.itemId)u={type:"Existing",driveId:l.driveId,siteUrl:l.siteUrl,itemId:l.itemId};else{if(!l.fileName)throw new Error("A new or existing file must be specified to create container!");{const[,e]=l.url.split("?"),t=new URLSearchParams(e),o=t.get("path");if(void 0===o||null===o)throw new Error("File path should be provided!!");p=function(e,t){let o;if(e.enableSingleRequestForShareLinkWithCreate){const e=t.get("createLinkScope"),r=t.get("createLinkRole");e&&n.V[e]&&(o=(0,s.A)({scope:n.V[e]},r&&n.N[r]?{role:n.N[r]}:{}))}return o}(this.hostPolicy,t),u={type:"New",driveId:l.driveId,siteUrl:l.siteUrl,filePath:o,filename:l.fileName,createLinkType:p}}}if((0,r.ub)(e)){const t=(0,r.YG)(e.tree[".protocol"]);if(0!==(null===t||void 0===t?void 0:t.sequenceNumber))throw new Error("Seq number in detached ODSP container should be 0")}const g=(0,I.bP)(o),v={resolvedUrl:l,docId:l.hashedDocumentId},m=(0,h.iJ)(this.persistedCache,this.nonPersistentCache,v,g,a);return i.Bt.timedExecAsync(g,{eventName:"CreateNew",isWithSummaryUpload:!0,createShareLinkParam:p?JSON.stringify(p):void 0,enableSingleRequestForShareLinkWithCreate:this.hostPolicy.enableSingleRequestForShareLinkWithCreate},async t=>{const o=(0,I.bJ)(g,d,this.getStorageToken),s=await c(g,async t=>{var s,r,n,i;return(0,I.$o)(u)?t.createNewFluidFile(o,u,g,e,m.epochTracker,v,null===(s=this.hostPolicy.cacheCreateNewSummary)||void 0===s||s,!(null===(r=this.hostPolicy.sessionOptions)||void 0===r||!r.forceAccessTokenViaAuthorizationHeader),l.isClpCompliantApp,this.hostPolicy.enableSingleRequestForShareLinkWithCreate,l):t.createNewContainerOnExistingFile(o,u,g,e,m.epochTracker,v,null===(n=this.hostPolicy.cacheCreateNewSummary)||void 0===n||n,!(null===(i=this.hostPolicy.sessionOptions)||void 0===i||!i.forceAccessTokenViaAuthorizationHeader),l.isClpCompliantApp)}),r=this.createDocumentServiceCore(s,g,m,a);return t.end({docId:s.hashedDocumentId}),r})}constructor(e,t){var o;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new u,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.getStorageToken=e,this.getWebsocketToken=t,this.persistedCache=r,this.hostPolicy=n,this.nonPersistentCache=new p,!0===this.hostPolicy.isolateSocketCache&&(this.socketReferenceKeyPrefix=(0,a.A)()),this.hostPolicy.enableRedeemFallback=null===(o=this.hostPolicy.enableRedeemFallback)||void 0===o||o,this.hostPolicy.sessionOptions=(0,s.A)({forceAccessTokenViaAuthorizationHeader:!0},this.hostPolicy.sessionOptions)}async createDocumentService(e,t,o){return this.createDocumentServiceCore(e,(0,I.bP)(t),void 0,o)}async createDocumentServiceCore(e,t,o,s){const r=(0,i.pW)({logger:t}),n=(0,I.Yn)(e),a={siteUrl:n.siteUrl,driveId:n.driveId,itemId:n.itemId},c=null!==o&&void 0!==o?o:(0,h.iJ)(this.persistedCache,this.nonPersistentCache,{resolvedUrl:n,docId:n.hashedDocumentId},r,s),l=(0,I.bJ)(r,a,this.getStorageToken),d=void 0===this.getWebsocketToken?void 0:async e=>(0,I.yI)(r,a,this.getWebsocketToken,!1,!0)(e,"GetWebsocketToken");return De.create(e,l,d,r,c.cache,this.hostPolicy,c.epochTracker,this.socketReferenceKeyPrefix,s)}}class Me extends xe{constructor(e,t,o,s){super(e,t,o,s)}}var ze=o(25969),Ge=o(14836);const _e=["https://pushchannel.1drv.ms/pushchannel.readwrite.all"];function We(){return _e}function Ve(e,t,o,r,n){const i=(0,s.A)({},r);!1!==i.concurrentSnapshotFetch&&(i.concurrentSnapshotFetch=!0);return new Me(He(o=>e.getToken((0,ze.K)(o.siteUrl),(0,Ge.r)(o,t))),e.identityType&&["Consumer","UnauthenticatedGuest"].includes(e.identityType)?void 0:He(o=>e.getToken(We(),(0,Ge.r)(o,t))),o,i)}function He(e){return function(){return e(...arguments).then(e=>e||null)}}var je=o(29967);function Je(e,t,o,s,r,n,i){return{documentServiceFactory:Ve(e,t,o,s),urlResolver:(0,je.o)(e,t,r,i)}}},30636:(e,t,o)=>{var s,r;o.d(t,{N:()=>r,V:()=>s}),function(e){e.organization="organization",e.users="users",e.anonymous="anonymous",e.default="default"}(s||(s={})),function(e){e.view="view",e.edit="edit"}(r||(r={}))},34904:(e,t,o)=>{o.d(t,{YG:()=>n,ub:()=>r});var s=o(84693);function r(e){for(var t,o,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(void 0===(null===e||void 0===e?void 0:e.tree)||(null===(t=e.tree)||void 0===t||null===(t=t[".app"])||void 0===t?void 0:t.type)!==s.Z.Tree||(null===(o=e.tree)||void 0===o||null===(o=o[".protocol"])||void 0===o?void 0:o.type)!==s.Z.Tree)return!1;return 2===Object.keys(e.tree).filter(e=>!n.includes(e)).length}function n(e){const t=e.tree.attributes;return JSON.parse(t.content)}},48101:(e,t,o)=>{t.b=void 0;var s=o(87987);Object.defineProperty(t,"b",{enumerable:!0,get:function(){return s.EventEmitter}})},84693:(e,t,o)=>{var s;o.d(t,{Z:()=>s}),function(e){e.Tree=1,e.Blob=2,e.Handle=3,e.Attachment=4}(s||(s={}))},88826:(e,t,o)=>{o.d(t,{X:()=>r});var s=o(48101);class r extends s.b{constructor(){super(),this.addListener=super.addListener.bind(this),this.on=super.on.bind(this),this.once=super.once.bind(this),this.prependListener=super.prependListener.bind(this),this.prependOnceListener=super.prependOnceListener.bind(this),this.removeListener=super.removeListener.bind(this),this.off=super.off.bind(this)}}}}]);
//# sourceMappingURL=5899.7ee75721.chunk.js.map