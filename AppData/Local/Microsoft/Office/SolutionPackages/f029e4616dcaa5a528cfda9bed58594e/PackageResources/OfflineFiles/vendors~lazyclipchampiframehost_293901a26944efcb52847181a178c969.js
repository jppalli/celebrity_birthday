"use strict";(self.webpackChunkTypeScriptModule=self.webpackChunkTypeScriptModule||[]).push([[9397],{882012:(e,t,i)=>{i.r(t),i.d(t,{ClipchampIframeHost:()=>y});var s=i(903495),r=i(208520);const a={Dogfood:"https://clipchamp.df.onecdn.static.microsoft/clipchamp/copilot",SDFv2:"https://clipchamp.df.onecdn.static.microsoft/clipchamp/copilot",MSIT:"https://clipchamp.public.onecdn.static.microsoft/clipchamp/_1cdn_bucketedcontent/copilot",WW:"https://clipchamp.public.onecdn.static.microsoft/clipchamp/_1cdn_bucketedcontent/copilot",Prod:"https://clipchamp.public.onecdn.static.microsoft/clipchamp/_1cdn_bucketedcontent/copilot"},n={numRetries:5,delayBetweenRetriesMs:1e3};var o=i(61714);function c(e,t){return new URL(e).origin===new URL(t).origin}class d{constructor(e,t,i){this.targetOrigin=e,this.appWindow=t,this.iframeId=i,this.messageHandler=this.onMessage.bind(this),this.callbacks=new Map,this.appWindow.addEventListener("message",this.messageHandler)}setTarget(e){this.target=e}send(e,t){if(!this.target)throw new Error("Target window not set");this.target.postMessage({messageType:e,data:{...t??{},iframeId:this.iframeId}},this.targetOrigin)}on(e,t){if(this.callbacks.has(e))throw new Error(`Callback already registered for message type: ${e}`);this.callbacks.set(e,t)}off(e){if(e){if(!this.callbacks.has(e))throw new Error(`No callback registered for message type: ${e}`);this.callbacks.delete(e)}else this.callbacks.clear()}destroy(){this.off(),this.appWindow.removeEventListener("message",this.messageHandler),this.target=void 0,this.appWindow=void 0}onMessage(e){const{origin:t,data:i}=e,s=i?.data?.iframeId;if(!c(t,this.targetOrigin)||s&&s!==this.iframeId)return;const{messageType:r,data:a}=i,n=this.callbacks.get(r);n&&n(a)}}const l=["https://clipchamp.df.onecdn.static.microsoft/clipchamp/copilot","https://clipchamp.public.onecdn.static.microsoft/clipchamp/_1cdn_bucketedcontent/copilot"];class h{constructor(e){this.settings=e,this.iframeId=(0,o.A)(),this.hostWindow=this.settings.container.ownerDocument?.defaultView??window,this.appMessageHandler=new d(this.settings.iframeUrl.origin,this.hostWindow,this.iframeId),this.iframe=this.createAppFrame()}async initialize(e){this.settings.container.appendChild(this.iframe),this.iframe.contentWindow&&this.appMessageHandler.setTarget(this.iframe.contentWindow);let t=null;const i=e?.numRetries??1;for(let e=0;e<i;e++){try{return await this.doInitialize(),void this.settings.onInitializeSuccess?.(e,i)}catch(s){t=s,this.settings.onInitializeFailed?.(e,i,s)}this.reset()}throw t}async doInitialize(){(this.settings.disablePrivilegedAuthEnforcement||l.some((e=>c(e,this.settings.iframeUrl.origin))))&&this.handleAuthTokenRequest(),this.settings.persistResultsCallback&&this.handlePersistResults(),await new Promise(((e,t)=>{this.settings.iframeLoadTimeoutMs&&setTimeout((()=>t(new Error(`IFrame pointing to ${this.settings.iframeUrl} did not load before timeout of ${this.settings?.iframeLoadTimeoutMs}ms`))),this.settings.iframeLoadTimeoutMs),this.appMessageHandler.on("ready",(()=>{try{this.appMessageHandler.send("initialize",{context:this.settings.iframeContext}),this.appMessageHandler.off("ready"),e()}catch(e){t(e)}})),this.appMessageHandler.on("resize",(e=>{this.iframe.width=`${e.width}px`,this.iframe.height=`${e.height}px`})),this.iframe.onerror=e=>{t(new Error(`IFrame failed to load: ${e}`))}}))}reset(){this.iframe.src=this.iframe.src.toString(),this.appMessageHandler.off()}destroy(){this.appMessageHandler.destroy(),this.iframe.remove(),this.hostWindow=void 0,this.settings=void 0}createAppFrame(){const e=new URL(this.settings.iframeUrl.toString());e.searchParams.append("iframeId",this.iframeId),e.searchParams.append("lang",this.settings.locale),e.searchParams.append("origin",new URL(window.location.href).origin);const t=this.hostWindow.document.createElement("iframe");return t.allow="clipboard-write",t.width="100%",t.height="auto",t.frameBorder="0",t.scrolling="no",t.style.border="none",t.title="App Frame",t.src=e.toString(),this.settings.disableSandboxing||t.sandbox.add("allow-scripts","allow-same-origin","allow-downloads","allow-popups","allow-popups-to-escape-sandbox","allow-top-navigation"),this.settings.disableEmbeddedCSPEnforcement||t.setAttribute("csp","object-src 'none'; base-uri 'none'; require-trusted-types-for 'script'; trusted-types default; "),t}handleAuthTokenRequest(){this.appMessageHandler.on("auth_fetch",(e=>{const t=this.settings.tokenProviders[e.tokenType];t?t().then((e=>{this.appMessageHandler.send("auth_token",{token:e})})).catch((e=>{this.appMessageHandler.send("auth_error",{error:e})})):this.appMessageHandler.send("auth_error",{error:new Error("No host auth callback provided")})}))}handlePersistResults(){this.appMessageHandler.on("persist_results",(e=>{this.settings.persistResultsCallback?.(e),this.appMessageHandler.off("persist_results")}))}}function p(e,t,i,s,a,o,c,d,l){return function(e){const{iframeUrl:t,iframeContext:i,iframeLoadTimeoutMs:s,iframeLoadRetryOptions:a,tokenProviders:n,locale:o,disableEmbeddedCSPEnforcement:c,disablePrivilegedAuthEnforcement:d,disableSandboxing:l,persistResultsCallback:p,onInitializeSuccess:m,onInitializeFailed:f}=e,u=r.useRef(null),g=r.useRef(null),w=r.useRef(!1),[b,y]=r.useState(void 0);return r.useEffect((()=>{var e;return u.current&&!w.current&&(e=u.current,g.current=new h({iframeUrl:new URL(t),iframeContext:i,iframeLoadTimeoutMs:s,tokenProviders:n,locale:o,disableEmbeddedCSPEnforcement:c,disablePrivilegedAuthEnforcement:d,disableSandboxing:l,persistResultsCallback:p,container:e,onInitializeSuccess:m,onInitializeFailed:f}),g.current.initialize(a).catch((e=>{y(e)})),w.current=!0),()=>{g.current?.destroy(),w.current=!1}}),[]),{error:b,props:{ref:u}}}({iframeUrl:e,iframeContext:t,iframeLoadRetryOptions:n,iframeLoadTimeoutMs:5e3,tokenProviders:{augloop:a},locale:i,disableEmbeddedCSPEnforcement:!0})}var m=i(95975),f=i(758651);function u(e,t){if(t){const e=function(e){const t=e?.[0].body?.find((e=>e.type===m.R.Media));if(!t)return;const i="";try{const e=JSON.parse(i);if(!function(e){return!!e&&"object"==typeof e&&"handoffUrl"in e&&"project"in e}(e))return;return e}catch(e){return}}(t);if(e)return e}if(e)return function(e){try{const i=JSON.parse(e);return i&&"object"==typeof(t=i)&&"userPrompt"in t?(i.groundingData&&"string"==typeof i.groundingData&&(i.groundingData=JSON.parse(i.groundingData)),{prompt:i.userPrompt,groundingData:i.groundingData??[]}):void 0}catch(e){return void f.error("Failed to parse text response for Video message:",e)}var t}(e)}const g=(0,i(814168).Ex)("officeai-chat-clipchamp.m365chat.iframe.genericError");const w=(0,i(260623).n)({iFrameContainer:{width:"100%",height:"100%"},errorContainer:{padding:"24px 0"}}),b=e=>{const{iframeUrl:t,iframeContext:i,locale:a,conversationId:n,videoChatMessage:o,traceId:c,contextIndex:d,tokenProvider:l,updateVideoChatMessage:h}=e,m=(0,s.kQ)({IframeHostGenericErrorText:g}),f=w(),{error:u,props:b}=p(t,i,a,0,l);return u?r.createElement("div",{className:f.errorContainer},m.IframeHostGenericErrorText()):r.createElement("div",{className:f.iFrameContainer,...b})};const y=e=>{const{text:t,videoChatMessage:i,userId:s,tenantId:n,isEu:o,identityType:c,physicalRing:d,...l}=e,h=r.useMemo((()=>function(e,t,i,s,r,a,n){const o=u(r,n);if(o)return{...o,userId:e,tenantId:t,accountType:s,isEu:i,appName:"M365 Chat",scenario:"BizChatCreate",physicalRing:a}}(s,n,o,c,t,d,i?.adaptiveCards)),[s,n,o,c,t,i]);return h&&d&&a[d]?r.createElement(b,{iframeUrl:a[d],iframeContext:h,videoChatMessage:i,...l}):null}}}]);
//# sourceMappingURL=vendors~lazyclipchampiframehost.js.map