"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var a=Object.getOwnPropertyDescriptor(t,i);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,a)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetUserUploadedMediaScript=exports.MediaType=exports.SegmentationType=void 0;const JSAssetScriptBase_1=require("./JSAssetScriptBase"),JSAssetMP4Script_1=require("./JSAssetMP4Script"),APJS=require('amazingpro.js');var SegmentationType,MediaType,UploadEventType;!function(e){e[e.None=0]="None",e[e.Subject=1]="Subject",e[e.Portrait=2]="Portrait",e[e.Head=3]="Head"}(SegmentationType=exports.SegmentationType||(exports.SegmentationType={})),function(e){e[e.Invalid=-1]="Invalid",e[e.Image=0]="Image",e[e.Video=1]="Video"}(MediaType=exports.MediaType||(exports.MediaType={})),function(e){e[e.Upload=0]="Upload",e[e.Reset=1]="Reset"}(UploadEventType||(UploadEventType={}));class JSAssetUserUploadedMediaScript extends JSAssetScriptBase_1.JSAssetScriptBase{constructor(){super(),this._isUploaded=!1,this._cmdBuffer=new APJS.CommandBuffer,this._defaultTextureUpdated=!1,this._uploadedTextureUpdated=!1,this._isInitialized=!1,this._mediaResolution=new APJS.Vector2f(0,0),this._graphName="",this._uploadEventCallbacks=[[],[]],this._invertMask=!1,this._centerAlign=!1,this._uploadSingleImage=!1,this._videoAssetProcessMaterials=new APJS.Map,this._videoAssetSettings=new APJS.Map,this._amazingFeaturePath="",this._videoName="",this._appState=0,this._extName=".uumt",this._mediaType=MediaType.Image,this._index=0,this._cutOut=SegmentationType.None,this._transparentTexture=this.createTransparentTexture()}createTransparentTexture(){const e=new APJS.Texture2DCreateDesc;e.width=9,e.height=16,e.depth=1,e.filterMipmap=APJS.FilterMipmapMode.None;const t=APJS.TextureUtils.createTexture2D(e),i=new APJS.Vector4f(0,0,0,0),s=Array(144).fill(i);return t.getControl().setPixels(s),t}registerUpdateEvent(e,t){null!=e&&this._uploadEventCallbacks[t].push(e)}get mainObject(){return this._mainObject}set mainObject(e){if(this._mainObject=e,e&&APJS.TextureUtils.hasTextureProvider(e,APJS.TextureDelegateProvider)){this._transparentTexture||(this._transparentTexture=this.createTransparentTexture());e.getControl().internalTexture=this._transparentTexture}}get isUploaded(){return this._isUploaded}set isUploaded(e){this._isUploaded=e,e?this._uploadEventCallbacks[UploadEventType.Upload].forEach((e=>{e()})):this._uploadEventCallbacks[UploadEventType.Reset].forEach((e=>{e()}))}get mediaResolution(){return this.mainObject?(this._mediaResolution.x=this.mainObject.getWidth(),this._mediaResolution.y=this.mainObject.getHeight(),this._mediaResolution):this._mediaResolution}get extName(){return this._extName}get defaultTextureUpdated(){return this._defaultTextureUpdated}set defaultTextureUpdated(e){this._defaultTextureUpdated=e}get uploadedTextureUpdated(){return this._uploadedTextureUpdated}set uploadedTextureUpdated(e){this._uploadedTextureUpdated=e}get mediaType(){return this._mediaType}set mediaType(e){this._mediaType=e}get index(){return this._index}set index(e){this._index=e}get defaultTexture(){return this._defaultTexture}set defaultTexture(e){var t;e!==this.mainObject&&(e&&APJS.TextureUtils.hasTextureProvider(e,APJS.TextureProvider)?(this._defaultTexture=e,this._defaultTextureUpdated||null===(t=this._sameIndexAssets)||void 0===t||t.forEach((t=>{this!==t&&t.setDefaultTextureFromSameIndexAssets(e)}))):this._defaultTexture=void 0,this._defaultTextureUpdated=!0)}setDefaultTextureFromSameIndexAssets(e){this._defaultTexture=e,this._defaultTextureUpdated=!0}get sameIndexAssets(){return this._sameIndexAssets}set sameIndexAssets(e){this._sameIndexAssets=e}get uploadedTexture(){return this._uploadedTexture}set uploadedTexture(e){this._uploadedTexture=e}get invertMask(){return this._invertMask}set invertMask(e){this._invertMask=e}get centerAlign(){return this._centerAlign}set centerAlign(e){this._centerAlign=e}get cutOut(){return this._cutOut}set cutOut(e){this._cutOut=e}get graphName(){return this._graphName}set graphName(e){var t;this._graphName=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"graphName",e))}get nonAlphaMaterial(){return this._nonAlphaMaterial}set nonAlphaMaterial(e){this._nonAlphaMaterial=e}removeLocalVideo(){if(""===this._videoName||1===this._appState)return;const e={interface:"RemoveResources",body:{toRemoveResources:[this._amazingFeaturePath+"video/"+this._videoName]}},t=JSON.stringify(e);this.scene.postMessage(41,41,0,t),this._videoName=""}updateVideoAsset(e){if(this._assetMP4Script){this._assetMP4Script.reset(),this._assetMP4Script.videoAsset=void 0,this._assetMP4Script.controller=void 0;const e=this._assetMP4Script.mainObject.getControl();e&&(e.internalTexture=void 0)}else{this._assetMP4Script=new JSAssetMP4Script_1.JSAssetMP4Script,this._assetMP4Script.scene=this.scene;const e=APJS.TextureUtils.createTextureDelegate();this._assetMP4Script.mainObject=e,this._assetMP4Script.loopCount=-1,this._videoAssetProcessMaterials.set("yuv2rgb",this.nonAlphaMaterial),this._videoAssetSettings.set("targetRT_width_factor",1)}if(this._videoAsset&&(this._videoAsset=void 0),this.removeLocalVideo(),void 0===e)return;this._videoName=e;const t=new APJS.VideoAsset;t.getNative().assetMgr=this.scene.assetManager.getNative(),t.name="UserUploadedVideoAsset"+this.index.toString(),t.processMaterials=this._videoAssetProcessMaterials,t.settings=this._videoAssetSettings;const i=new APJS.Map;i.set("filePath","video/"+e),t.loadConfig=i,t.initController(),t.controller.scene=this.scene,this._videoAsset=t,this._assetMP4Script&&(this._assetMP4Script.videoAsset=t,this._assetMP4Script.controller=t.controller,this._assetMP4Script.playFromStart())}initialize(){if(this._amazingFeaturePath=this.scene.assetManager.rootDir,this._flipMat=this.createFlipBlitMaterial(),this._mediaType===MediaType.Image){this._defaultTexture&&this._mediaType===MediaType.Image&&(this.mainObject.getControl().setWidth(1),this.mainObject.getControl().setHeight(1),this.mainObject.getControl().needInitData=!0,this.cutOut===SegmentationType.None&&(this.blit(this._defaultTexture),this._defaultTextureUpdated=!1));const e=new APJS.Event;e.type=APJS.AppEventType.READY_FOR_RC_VALUE_CHANGE,APJS.EventManager.postEventAllScene(e)}this._isInitialized=!0}createFlipBlitMaterial(){const e=new APJS.Material,t=new APJS.XShader,i=new APJS.Pass,s=new APJS.Map;this.addShaderToMap(s,"gles2","precision highp float;\n    attribute vec3 attPosition;\n    attribute vec2 attTexcoord0;\n    varying vec2 uv;\n    void main() {\n        gl_Position = vec4(attPosition, 1.0);\n        uv = vec2(attTexcoord0.x, 1.0 - attTexcoord0.y);\n    }\n    ","precision highp float;\n    uniform sampler2D _MainTex;\n    varying vec2 uv;\n\n    void main() {\n      gl_FragColor = texture2D(_MainTex, uv);\n    }\n    "),this.addShaderToMap(s,"metal","#include <metal_stdlib>\n    #include <simd/simd.h>\n    using namespace metal;\n    struct main0_out\n    {\n        float2 uv [[user(locn0)]];\n        float4 gl_Position [[position]];\n    };\n    struct main0_in\n    {\n        float3 attPosition [[attribute(0)]];\n        float2 attTexcoord0 [[attribute(1)]];\n    };\n    vertex main0_out main0(main0_in in [[stage_in]])\n    {\n        main0_out out = {};\n        out.gl_Position = float4(in.attPosition, 1.0);\n        out.uv = float2(in.attTexcoord0.x, 1.0 - in.attTexcoord0.y);\n        out.gl_Position.z = (out.gl_Position.z + out.gl_Position.w) * 0.5;       // Adjust clip-space for Metal\n        return out;\n    }\n    ","#include <metal_stdlib>\n    #include <simd/simd.h>\n    using namespace metal;\n    \n    struct main0_out\n    {\n        float4 color [[color(0)]];\n    };\n    struct main0_in\n    {\n        float2 uv [[user(locn0)]];\n    };\n    fragment main0_out main0(main0_in in [[stage_in]], texture2d<float> _MainTex [[texture(0)]], sampler _MainTexSmplr [[sampler(0)]])\n    {\n        main0_out out = {};\n        out.color = _MainTex.sample(_MainTexSmplr, in.uv);\n        return out;\n    }\n    "),i.shaders=s;const a=new APJS.Map;a.insert("attPosition",APJS.VertexAttribType.POSITION),a.insert("attTexcoord0",APJS.VertexAttribType.TEXCOORD0),i.semantics=a;const n=new APJS.RenderState,r=new APJS.DepthStencilState;return r.depthTestEnable=!1,n.depthstencil=r,i.renderState=n,t.passes.pushBack(i),e.xshader=t,e}addShaderToMap(e,t,i,s){const a=new APJS.Shader;a.type=APJS.ShaderType.VERTEX,a.source=i;const n=new APJS.Shader;n.type=APJS.ShaderType.FRAGMENT,n.source=s;const r=new APJS.Vector;r.pushBack(a),r.pushBack(n),e.insert(t,r)}blit(e,t,i){null!=e&&(null==t&&(t=this.mainObject),this._cmdBuffer.clearAll(),t.getControl().setWidth(e.getWidth()),t.getControl().setHeight(e.getHeight()),i?this._cmdBuffer.blitWithMaterial(e,t,i,0,!1):this._cmdBuffer.blit(e,t),this.scene.commitCommandBuffer(this._cmdBuffer))}onUpdateImage(e){this._defaultTexture&&this._defaultTextureUpdated&&this.cutOut===SegmentationType.None&&(this.blit(this._defaultTexture),this._defaultTextureUpdated=!1),this._uploadedTextureUpdated&&(this._uploadedTexture?this._cutOut===SegmentationType.None&&(this.blit(this._uploadedTexture,void 0,this._flipMat),this._uploadedTextureUpdated=!1,this.isUploaded=!0):(this._cutOut===SegmentationType.None?this._defaultTexture&&this.blit(this._defaultTexture):this.defaultTextureUpdated=!0,this.isUploaded=!1,this._uploadedTextureUpdated=!1))}onUpdateVideo(e){var t;if(this._defaultTexture&&void 0===this._videoAsset){const e=this.mainObject.getControl();if(e)if(APJS.TextureUtils.hasTextureProvider(this._defaultTexture,APJS.TextureDelegateProvider)){const t=this._defaultTexture.getControl();t&&(e.internalTexture=t.internalTexture)}else this._transparentTexture&&this._defaultTexture&&(e.internalTexture=this._defaultTexture);this._uploadedTextureUpdated&&(this.isUploaded=!1,this._uploadedTextureUpdated=!1)}const i=this.mainObject.getControl();if(this._videoAsset&&(null===(t=this._assetMP4Script)||void 0===t?void 0:t.videoAsset)){this._assetMP4Script.onUpdate(e);const t=this._assetMP4Script.mainObject.getControl();t.internalTexture&&(i.internalTexture=t.internalTexture),this._uploadedTextureUpdated&&(this.isUploaded=!0,this._uploadedTextureUpdated=!1)}}onUpdate(e){if(this.mainObject&&this.scene&&this._isRunTime)switch(this._isInitialized||this.initialize(),this._mediaType){case MediaType.Image:this.onUpdateImage(e);break;case MediaType.Video:this.onUpdateVideo(e)}}onEvent(e){void 0!==this.mainObject&&null!==this.mainObject&&this._mediaType===MediaType.Video&&this.mediaEvent(e)}mediaEvent(e){var t;if(null!==this.mainObject&&void 0!==this.mainObject){if(this._mediaType===MediaType.Image)switch(e){case APJS.RenderCacheStatus.RC_STATUS_MODITY:{const e=this.index+1;if(this._uploadedTextureUpdated=!0,this._uploadedTexture=APJS.AmazingManager.getSingleton("BuiltinObject").getUserTexture("UUMT"+e),void 0===this._uploadedTexture||null===this._uploadedTexture){if(1!==e){this._uploadedTextureUpdated=!1;break}this._uploadSingleImage=!0,this._uploadedTexture=APJS.AmazingManager.getSingleton("BuiltinObject").getUserTexture("UUMT")}break}case APJS.RenderCacheStatus.RC_STATUS_REMOVE:this._uploadedTexture&&(this._uploadedTextureUpdated=!0,this._uploadedTexture=void 0)}if(this._mediaType===MediaType.Video&&e instanceof APJS.Event){null===(t=this._assetMP4Script)||void 0===t||t.onEvent(e);if(41===e.args[0]){const t=String(e.args[3]),i=APJS.AmazingManager.getSingleton("BuiltinObject").getUserStringValue(t);console.log("UUMT","Get VIDEO_PROCESS_RESULT: "+i);const s=JSON.parse(i);"VIDEO_PROCESS_RESULT"===s.interface&&s.body&&(s.body.videos.length>0?this.updateVideoAsset(s.body.videos[0].name):this.updateVideoAsset(),this._uploadedTextureUpdated=!0),"SWITCH_APP_STATE"===s.interface&&s.body&&("BACKGROUND"===s.body.app_state&&(this._appState=1),"FOREGROUND"===s.body.app_state&&(this._appState=0))}}}}onRelease(){if(this._isUploaded)if(this._uploadSingleImage)APJS.AmazingManager.getSingleton("BuiltinObject").removeUserTexture("UUMT");else{const e=this.index+1;APJS.AmazingManager.getSingleton("BuiltinObject").removeUserTexture("UUMT"+e)}this._defaultTexture=void 0,this._transparentTexture=void 0,this._uploadedTexture=void 0,this._sameIndexAssets=void 0,this.mediaType===MediaType.Video&&this.updateVideoAsset()}}exports.JSAssetUserUploadedMediaScript=JSAssetUserUploadedMediaScript;