"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,a)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetSegmentationScript=void 0;const JSAssetScriptBase_1=require("./JSAssetScriptBase"),Segmentation_1=require("./Segmentation"),APJS=require('amazingpro.js');class JSAssetSegmentationScript extends JSAssetScriptBase_1.JSAssetScriptBase{constructor(){super(...arguments),this._segmentationType=0,this._invertMask=!1,this._smoothness=1,this._headseg_whichface=[0],this._handseg_whichface=[0,1],this._earseg_whichface=[0,1],this._lipseg_whichface=[0],this._teethseg_whichface=[0],this._comp_faceSeg_whichFace=[0,1],this._eyeseg_whichface=[0],this._petseg_whichface=[1],this._tex=APJS.TextureUtils.createTexture2D(),this._isSingleMask=!0,this._graphName="",this._segScreenMesh=JSAssetScriptBase_1.MeshUtil.createQuadMesh(),this._skinDeley=!1,this._attachedMaterialPaths=[],this._segProvider=void 0,this._centerAlign=!1,this._captureOrder=0}get captureOrder(){return this._captureOrder}set captureOrder(e){this._captureOrder=e}init(e){Segmentation_1.Segmentation.getInstance().cmdBufferHelper=this.cmdBufferHelper,Segmentation_1.Segmentation.getInstance().scene=this._scene,Segmentation_1.Segmentation.getInstance().screenMesh=this.screenMesh,e&&e(Segmentation_1.Segmentation.getInstance(),Segmentation_1.Segmentation.getInstance().onUpdate)}set mainObject(e){this._mainObject=e}get mainObject(){return this._mainObject}get graphName(){return this._graphName}set graphName(e){var t;this._graphName=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"graphName",e))}get segmentationType(){return this._segmentationType}set segmentationType(e){this._segmentationType=e}get invertMask(){return this._invertMask}set invertMask(e){this._invertMask=e}get smoothness(){return this._smoothness}set smoothness(e){this._smoothness=e}get headseg_whichface(){return this._headseg_whichface}set headseg_whichface(e){var t,s,i,a,n,h;if(!(null==e||e.length<1)&&(this._headseg_whichface=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"headseg_whichface",e)),this._segProvider=Segmentation_1.Segmentation.getInstance().segProviderMap.get(this._segmentationType),e.length>1)){const e=null===(s=this._segProvider)||void 0===s?void 0:s.attachedMaterials.get(this.uuid);null==e||e.forEach((e=>{e.setVec4("u_Translation",new APJS.Vector4f(0,0,0,0)),e.setVec4("u_Scale",new APJS.Vector4f(1,1,1,1))})),null===(a=null===(i=this._segProvider)||void 0===i?void 0:i.attachedMaterials)||void 0===a||a.delete(this.uuid),null===(h=null===(n=this._segProvider)||void 0===n?void 0:n.whichFaceMap)||void 0===h||h.delete(this.uuid),this._centerAlign=!1}}get handseg_whichface(){return this._handseg_whichface}set handseg_whichface(e){var t;null==e||e.length<1||(this._handseg_whichface=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"handseg_whichface",e)))}get petseg_whichface(){return this._petseg_whichface}set petseg_whichface(e){var t;null==e||e.length<1||(this._petseg_whichface=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"petseg_whichface",e)))}get earseg_whichface(){return this._earseg_whichface}set earseg_whichface(e){var t;null==e||e.length<1||(this._earseg_whichface=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"earseg_whichface",e)))}set lipseg_whichface(e){var t;null==e||e.length<1||(this._lipseg_whichface=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"lipseg_whichface",e)))}get lipseg_whichface(){return this._lipseg_whichface}set teethseg_whichface(e){var t;null==e||e.length<1||(this._teethseg_whichface=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"teethseg_whichface",e)))}get teethseg_whichface(){return this._teethseg_whichface}set comp_faceSeg_whichFace(e){var t;null==e||e.length<1||(this._comp_faceSeg_whichFace=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"comp_faceSeg_whichFace",e)))}get comp_faceSeg_whichFace(){return this._comp_faceSeg_whichFace}set eyeseg_whichface(e){var t;null==e||e.length<1||(this._eyeseg_whichface=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"eyeseg_whichface",e)))}get eyeseg_whichface(){return this._eyeseg_whichface}set screenMat(e){this._screenMat=e}get screenMat(){return this._screenMat}set screenMat2Mask(e){this._screenMat2Mask=e}get screenMat2Mask(){return this._screenMat2Mask}get attachedMaterialPaths(){return void 0===this._attachedMaterialPaths&&(this._attachedMaterialPaths=[]),this._attachedMaterialPaths}set attachedMaterialPaths(e){this._attachedMaterialPaths=e}get centerAlign(){return this._centerAlign}set centerAlign(e){this._centerAlign=e}updateScreenMaterial(){var e,t,s,i,a,n,h,c,_,l,o,g,r,u,d,M,S,p,f,m,v,w,k,y,F,I,T,b,P,A,J,O,x,N,j,B,R,E,C,D,H,L,U,V,Y,q,G,z,Q,K,W,X,Z,$,ee,te,se,ie,ae,ne,he,ce,_e,le,oe,ge;const re=(null===(e=this.scene)||void 0===e?void 0:e.assetManager.getAllCustomAssetsProperty()).get(this.uuid);if(this.smoothness=re.get("smoothness"),this.invertMask=re.get("invertMask"),null===(t=this._screenMatInstance)||void 0===t||t.setFloat("_SegGetAlpha",0),null===(s=this._screenMatInstance)||void 0===s||s.setFloat("_SegFlipY",0),this.segmentationType===Segmentation_1.segMaskType.Hand){if(this.handseg_whichface=re.get("handseg_whichface"),null===this.handseg_whichface||void 0===this.handseg_whichface)return void console.log("return");void 0!==this.handseg_whichface&&null!==this.handseg_whichface||(this.handseg_whichface=this._headseg_whichface),null===(i=this._screenMatInstance)||void 0===i||i.setFloat("_SegMask_enable",0),null===(a=this._screenMatInstance)||void 0===a||a.setFloat("_SegMask2_enable",0);const e=this.handseg_whichface.toString();e.includes("0")&&(null===(n=this._screenMatInstance)||void 0===n||n.setFloat("_SegMask_enable",1)),e.includes("1")&&(null===(h=this._screenMatInstance)||void 0===h||h.setFloat("_SegMask2_enable",1)),null===(c=this._screenMatInstance)||void 0===c||c.setFloat("_SegMask3_enable",0),null===(_=this._screenMatInstance)||void 0===_||_.setFloat("_SegMask4_enable",0)}else if(this.segmentationType===Segmentation_1.segMaskType.Head){if(this.headseg_whichface=re.get("headseg_whichface"),null===this.headseg_whichface||void 0===this.headseg_whichface)return void console.log("return");null!==this.headseg_whichface&&void 0!==this.headseg_whichface||(this.headseg_whichface=this._headseg_whichface),null===(l=this._screenMatInstance)||void 0===l||l.setFloat("_SegMask_enable",0),null===(o=this._screenMatInstance)||void 0===o||o.setFloat("_SegMask2_enable",0);const e=this.headseg_whichface.toString();e.includes("0")&&(null===(g=this._screenMatInstance)||void 0===g||g.setFloat("_SegMask_enable",1)),e.includes("1")&&(null===(r=this._screenMatInstance)||void 0===r||r.setFloat("_SegMask2_enable",1)),null===(u=this._screenMatInstance)||void 0===u||u.setFloat("_SegMask3_enable",0),null===(d=this._screenMatInstance)||void 0===d||d.setFloat("_SegMask4_enable",0)}else if(this.segmentationType===Segmentation_1.segMaskType.Pet){if(this.petseg_whichface=re.get("petseg_whichface"),null===this.petseg_whichface||void 0===this.petseg_whichface)return void console.log("return");null!==this.petseg_whichface&&void 0!==this.petseg_whichface||(this.petseg_whichface=this._petseg_whichface);const e=this.petseg_whichface.toString(),t=APJS.AlgorithmManager.getGraphNode(this.graphName,"pet_matting_0");e.includes("1")&&e.includes("2")?t.setInt("output_type",1):e.includes("1")?t.setInt("output_type",3):e.includes("2")&&t.setInt("output_type",4),null===(M=this._screenMatInstance)||void 0===M||M.setFloat("_SegMask_enable",1),null===(S=this._screenMatInstance)||void 0===S||S.setFloat("_SegMask2_enable",0),null===(p=this._screenMatInstance)||void 0===p||p.setFloat("_SegFlipY",0)}else if(this.segmentationType===Segmentation_1.segMaskType.Ear){if(this.earseg_whichface=re.get("earseg_whichface"),null===this.earseg_whichface||void 0===this.earseg_whichface)return void console.log("earseg_whichface null return");null!==this.earseg_whichface&&void 0!==this.earseg_whichface||(this.earseg_whichface=this._earseg_whichface),null===(f=this._screenMatInstance)||void 0===f||f.setFloat("_SegMask_enable",0),null===(m=this._screenMatInstance)||void 0===m||m.setFloat("_SegMask2_enable",0),null===(v=this._screenMatInstance)||void 0===v||v.setFloat("_SegMask3_enable",0),null===(w=this._screenMatInstance)||void 0===w||w.setFloat("_SegMask4_enable",0),null===(k=this._screenMatInstance)||void 0===k||k.setFloat("_SegFlipY",1);const e=this.earseg_whichface.toString();e.includes("0")&&(null===(y=this._screenMatInstance)||void 0===y||y.setFloat("_SegMask_enable",1),null===(F=this._screenMatInstance)||void 0===F||F.setFloat("_SegMask2_enable",1)),e.includes("1")&&(null===(I=this._screenMatInstance)||void 0===I||I.setFloat("_SegMask3_enable",1),null===(T=this._screenMatInstance)||void 0===T||T.setFloat("_SegMask4_enable",1))}else if(this.segmentationType===Segmentation_1.segMaskType.Lip){if(this.lipseg_whichface=re.get("lipseg_whichface"),null===this.lipseg_whichface||void 0===this.lipseg_whichface)return void console.log("return");null!==this.lipseg_whichface&&void 0!==this.lipseg_whichface||(this.lipseg_whichface=this._lipseg_whichface),null===(b=this._screenMatInstance)||void 0===b||b.setFloat("_SegMask_enable",0),null===(P=this._screenMatInstance)||void 0===P||P.setFloat("_SegMask2_enable",0);const e=this.lipseg_whichface.toString();e.includes("0")&&(null===(A=this._screenMatInstance)||void 0===A||A.setFloat("_SegMask_enable",1)),e.includes("1")&&(null===(J=this._screenMatInstance)||void 0===J||J.setFloat("_SegMask2_enable",1)),null===(O=this._screenMatInstance)||void 0===O||O.setFloat("_SegMask3_enable",0),null===(x=this._screenMatInstance)||void 0===x||x.setFloat("_SegMask4_enable",0)}else if(this.segmentationType===Segmentation_1.segMaskType.Teeth){if(this.teethseg_whichface=re.get("teethseg_whichface"),null===this.teethseg_whichface||void 0===this.teethseg_whichface)return void console.log("return");null!==this.teethseg_whichface&&void 0!==this.teethseg_whichface||(this.teethseg_whichface=this._teethseg_whichface),null===(N=this._screenMatInstance)||void 0===N||N.setFloat("_SegMask_enable",0),null===(j=this._screenMatInstance)||void 0===j||j.setFloat("_SegMask2_enable",0);const e=this.teethseg_whichface.toString();e.includes("0")&&(null===(B=this._screenMatInstance)||void 0===B||B.setFloat("_SegMask_enable",1)),e.includes("1")&&(null===(R=this._screenMatInstance)||void 0===R||R.setFloat("_SegMask2_enable",1)),null===(E=this._screenMatInstance)||void 0===E||E.setFloat("_SegMask3_enable",0),null===(C=this._screenMatInstance)||void 0===C||C.setFloat("_SegMask4_enable",0)}else if(this.segmentationType===Segmentation_1.segMaskType.Face){if(this.comp_faceSeg_whichFace=re.get("comp_faceSeg_whichFace"),null===this.comp_faceSeg_whichFace||void 0===this.comp_faceSeg_whichFace)return void console.log("return");null!==this.comp_faceSeg_whichFace&&void 0!==this.comp_faceSeg_whichFace||(this.comp_faceSeg_whichFace=this._comp_faceSeg_whichFace),null===(D=this._screenMatInstance)||void 0===D||D.setFloat("_SegMask_enable",0),null===(H=this._screenMatInstance)||void 0===H||H.setFloat("_SegMask2_enable",0);const e=this.comp_faceSeg_whichFace.toString();e.includes("0")&&(null===(L=this._screenMatInstance)||void 0===L||L.setFloat("_SegMask_enable",1)),e.includes("1")&&(null===(U=this._screenMatInstance)||void 0===U||U.setFloat("_SegMask2_enable",1)),null===(V=this._screenMatInstance)||void 0===V||V.setFloat("_SegMask3_enable",0),null===(Y=this._screenMatInstance)||void 0===Y||Y.setFloat("_SegMask4_enable",0)}else if(this.segmentationType===Segmentation_1.segMaskType.Eye){if(this.eyeseg_whichface=re.get("eyeseg_whichface"),null===this.eyeseg_whichface||void 0===this.eyeseg_whichface)return void console.log("return");null!==this.eyeseg_whichface&&void 0!==this.eyeseg_whichface||(this.eyeseg_whichface=this._eyeseg_whichface),null===(q=this._screenMatInstance)||void 0===q||q.setFloat("_SegMask_enable",0),null===(G=this._screenMatInstance)||void 0===G||G.setFloat("_SegMask2_enable",0);const e=this.eyeseg_whichface.toString();e.includes("0")&&(null===(z=this._screenMatInstance)||void 0===z||z.setFloat("_SegMask_enable",1)),e.includes("1")&&(null===(Q=this._screenMatInstance)||void 0===Q||Q.setFloat("_SegMask2_enable",1)),null===(K=this._screenMatInstance)||void 0===K||K.setFloat("_SegMask3_enable",0),null===(W=this._screenMatInstance)||void 0===W||W.setFloat("_SegMask4_enable",0),null===(X=this._screenMatInstance)||void 0===X||X.setFloat("_SegFlipY",1)}else this.segmentationType===Segmentation_1.segMaskType.Skin&&(!1===this._skinDeley?this._skinDeley=!0:null===(Z=this._screenMatInstance)||void 0===Z||Z.setFloat("_SegGetAlpha",1));!0===this._isSingleMask?(null===($=this._screenMatInstance)||void 0===$||$.setTex("_SegMask",Segmentation_1.Segmentation.getMask(this.segmentationType)),null===(ee=this._screenMatInstance)||void 0===ee||ee.setFloat("_SegSmoothness",.9*(1-this.smoothness)),null===(te=this._screenMatInstance)||void 0===te||te.setFloat("_SegInvertMask",!0===this.invertMask?1:0)):!1===this._isSingleMask&&(this.segmentationType===Segmentation_1.segMaskType.Ear?(null===(se=this._screenMatInstance)||void 0===se||se.setTex("_SegMask",Segmentation_1.Segmentation.getMask(this.segmentationType,0,0)),null===(ie=this._screenMatInstance)||void 0===ie||ie.setTex("_SegMask2",Segmentation_1.Segmentation.getMask(this.segmentationType,0,1)),null===(ae=this._screenMatInstance)||void 0===ae||ae.setTex("_SegMask3",Segmentation_1.Segmentation.getMask(this.segmentationType,1,0)),null===(ne=this._screenMatInstance)||void 0===ne||ne.setTex("_SegMask4",Segmentation_1.Segmentation.getMask(this.segmentationType,1,1)),null===(he=this._screenMatInstance)||void 0===he||he.setFloat("_SegSmoothness",.9*(1-this.smoothness)),null===(ce=this._screenMatInstance)||void 0===ce||ce.setFloat("_SegInvertMask",!0===this.invertMask?1:0)):(null===(_e=this._screenMatInstance)||void 0===_e||_e.setTex("_SegMask",Segmentation_1.Segmentation.getMask(this.segmentationType)),null===(le=this._screenMatInstance)||void 0===le||le.setFloat("_SegSmoothness",.9*(1-this.smoothness)),null===(oe=this._screenMatInstance)||void 0===oe||oe.setFloat("_SegInvertMask",!0===this.invertMask?1:0),null===(ge=this._screenMatInstance)||void 0===ge||ge.setTex("_SegMask2",Segmentation_1.Segmentation.getMask(this.segmentationType,1))))}onStart(){var e,t,s,i;if(this.mainObject){if(this.isRunTime){this._segmentationType!==Segmentation_1.segMaskType.Hand&&this._segmentationType!==Segmentation_1.segMaskType.Head&&this._segmentationType!==Segmentation_1.segMaskType.Ear&&this._segmentationType!==Segmentation_1.segMaskType.Lip&&this._segmentationType!==Segmentation_1.segMaskType.Teeth&&this._segmentationType!==Segmentation_1.segMaskType.Eye&&this._segmentationType!==Segmentation_1.segMaskType.Face||(this._isSingleMask=!1),!0===this._isSingleMask&&void 0!==this._screenMat?this._screenMatInstance=null===(e=this._screenMat)||void 0===e?void 0:e.instantiate():!1===this._isSingleMask&&void 0!==this._screenMat2Mask&&(this._screenMatInstance=null===(t=this._screenMat2Mask)||void 0===t?void 0:t.instantiate());const s=this.mainObject.getControl();s.setDepth(1),s.filterMag=APJS.FilterMode.Linear,s.filterMin=APJS.FilterMode.Linear,s.filterMipmap=APJS.FilterMipmapMode.None,s.setAttachment(APJS.RenderTextureAttachment.NONE),this._tex.filterMin=APJS.FilterMode.Linear,this._tex.filterMag=APJS.FilterMode.Linear}if(this._skinDeley=!1,this._segmentationType===Segmentation_1.segMaskType.Eye?Segmentation_1.Segmentation.getInstance().graphNameEye=this.graphName:this._segmentationType===Segmentation_1.segMaskType.Ear&&(Segmentation_1.Segmentation.getInstance().graphNameEar=this.graphName),void 0===this._segProvider&&(this._segProvider=Segmentation_1.Segmentation.getInstance().segProviderMap.get(this._segmentationType)),this._centerAlign&&this.headseg_whichface.length<2){const e=new Set;this.attachedMaterialPaths.forEach((t=>{var s;const i=null===(s=this.scene)||void 0===s?void 0:s.assetManager.SyncLoad(t);i&&e.add(i)})),null===(s=this._segProvider)||void 0===s||s.attachedMaterials.set(this.uuid,e),this._segmentationType===Segmentation_1.segMaskType.Head&&(null===(i=this._segProvider)||void 0===i||i.whichFaceMap.set(this.uuid,this.headseg_whichface[0]))}}}onUpdate(e){var t,s;void 0!==this._screenMatInstance&&this.isRunTime&&(this.updateScreenMaterial(),null===(t=this.cmdBufferHelper)||void 0===t||t.setRenderTexture(this.mainObject),null===(s=this.cmdBufferHelper)||void 0===s||s.drawMesh(this._segScreenMesh,new APJS.Matrix4x4f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this._screenMatInstance,0,0,new APJS.MaterialPropertyBlock,!1))}onDestroy(){void 0===this._attachedMaterialPaths&&null===this._attachedMaterialPaths||(this._attachedMaterialPaths.length=0,this._attachedMaterialPaths=null)}}exports.JSAssetSegmentationScript=JSAssetSegmentationScript;