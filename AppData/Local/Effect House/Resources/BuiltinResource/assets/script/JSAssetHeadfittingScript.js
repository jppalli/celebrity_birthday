"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var a=Object.getOwnPropertyDescriptor(t,s);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,a)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetHeadfittingScript=void 0;const JSAssetScriptBase_1=require("./JSAssetScriptBase"),APJS=require('amazingpro.js');class JSAssetHeadfittingScript extends JSAssetScriptBase_1.JSAssetScriptBase{constructor(){super(...arguments),this._fillEyes=!0,this._fillMouth=!0,this._fillEar=!1,this._reCalculateNormal=!1,this._faceIndex=0}get fillEyes(){return this._fillEyes}set fillEyes(e){this._fillEyes=e}get fillMouth(){return this._fillMouth}set fillMouth(e){this._fillMouth=e}get fillEar(){return this._fillEar}set fillEar(e){this._fillEar=e}get reCalculateNormal(){return this._reCalculateNormal}set reCalculateNormal(e){this._reCalculateNormal=e}get path(){return this._path}set path(e){this._path=e}get faceIndex(){return this._faceIndex}set faceIndex(e){this._faceIndex=e}get staticMesh(){return this._staticMesh}set staticMesh(e){this._staticMesh=e}get mainObject(){if(this._mainObject)return this._mainObject}set mainObject(e){this._mainObject=e}get algoSubGraphName(){return this._algoSubGraphName}set algoSubGraphName(e){this._algoSubGraphName=e}get algoNodeName(){return this._algoNodeName}set algoNodeName(e){this._algoNodeName=e}init(e){if(super.init(),this.getMgrInstanceFunc){const e=this.getMgrInstanceFunc();this._screenMesh=null==e?void 0:e.addListenCompType("MorpherComponent")}}onStart(){if(this.scene&&this.staticMesh&&this.mainObject){this.staticMesh=this.staticMesh.clone();const e=this.mainObject;e.name=this.staticMesh.name,e.boundingBox=this.staticMesh.boundingBox,e.instanceData=this.staticMesh.instanceData,e.instanceDataStride=this.staticMesh.instanceDataStride,e.materialIndex=this.staticMesh.materialIndex,e.morphers=this.staticMesh.morphers,e.skin=this.staticMesh.skin,e.submeshes=this.staticMesh.submeshes,e.vertexAttribs=this.staticMesh.vertexAttribs,e.vertices=this.staticMesh.vertices,e.seqMesh=this.staticMesh.seqMesh,e.originalVertices=this.staticMesh.originalVertices,e.clearAfterUpload=this.staticMesh.clearAfterUpload,this.setUpMorpher(e,!1)}}updateMeshInfo(){if(this.staticMesh&&this.mainObject){const e=this.mainObject;e.morphers=this.staticMesh.morphers,e.skin=this.staticMesh.skin,e.submeshes=this.staticMesh.submeshes,e.vertexAttribs=this.staticMesh.vertexAttribs,e.vertices=this.staticMesh.vertices}}onUpdate(e){if(this.mainObject&&this.algoSubGraphName&&this.algoNodeName){(this._faceIndex<0||this._faceIndex>5)&&(this._faceIndex=0);const e=this.algoNodeName,t=APJS.AlgorithmManager.getGraphNode(this.algoSubGraphName,e);if(t.getInfoCount(0)<=this._faceIndex)return;const s=t.getInfo(this.faceIndex);if(!s)return;this.updateMesh(this.mainObject,s),this.setUpMorpher(this.mainObject,!0)}}updateMesh(e,t){let s=t.data.get("vertexes"),i=t.data.get("normals");this.fillEar&&t.data.get("vertexes_head_ear").size()>0&&(s=t.data.get("vertexes_head_ear"),i=t.data.get("normals_head_ear")),e.setVertexArray(s,0,0,!0),this._reCalculateNormal?e.reCalculateNormals():e.setNormalArray(i,0,0)}setUpMorpher(e,t){if(null!==e&&this.getMgrInstanceFunc){const s=this.getMgrInstanceFunc(),i=null==s?void 0:s.getListenedComponents();for(const s of i)if(s instanceof APJS.MorpherComponent&&s.basemesh.handle===e.handle)if(t)s.basemesh=e;else{const t=s.channelWeights.clone(),i=t.getVectorKeys(),a=s.channelAmplifiers.clone(),r=a.getVectorKeys();s.basemesh=null,s.basemesh=e;const h=s.channelWeights,n=s.channelAmplifiers;for(let e=0;e<t.size();e++)h.set(i.get(e),t.get(i.get(e)));for(let e=0;e<a.size();e++)n.set(r.get(e),a.get(r.get(e)))}}}}exports.JSAssetHeadfittingScript=JSAssetHeadfittingScript;