"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,s){void 0===s&&(s=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,s,i)}:function(e,t,r,s){void 0===s&&(s=r),e[s]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetAIDrawTextureScript=exports.dynamicPropertyKeyList=exports.dynamicPropertyList=exports.PromptStatus=exports.PromptStatusMap=void 0;const JSAssetServerAlgoScriptBase_1=require("./JSAssetServerAlgoScriptBase"),APJS=require('amazingpro.js'),inputConfig=new APJS.AlgorithmInputConfig,nodeName="aiDraw_0",NET_EVENT_NAME="effect_network_event",EFFECT_TYPE="aigc",EFFECT_SOURCE="eh";var CallbackType,PromptStatus;!function(e){e[e.Begin=0]="Begin",e[e.Stay=1]="Stay",e[e.Succeed=2]="Succeed",e[e.Fail=3]="Fail"}(CallbackType||(CallbackType={})),exports.PromptStatusMap=["Template","FreeWrite","Editing"],function(e){e[e.Template=0]="Template",e[e.FreeWrite=1]="FreeWrite",e[e.Editing=2]="Editing"}(PromptStatus=exports.PromptStatus||(exports.PromptStatus={}));class NetworkEventReporter{constructor(e){this.requestTime=0,this.jsAssetObj=void 0,this.jsAssetObj=e}packAnalyticsData(e){const t=new APJS.Map;return Object.entries(e).forEach((e=>{const[r,s]=e;t.set(r,s)})),t}reportAlgClientTimeout(e,t){const r=Date.now()-this.requestTime;this.sendAnalyticsEvent({clientRequestId:e,effectNetworkEventType:"netbridge_client_alg_timeout",clientDropOutTime:r,effect_type:"aigc",effect_source:"eh",dropOutType:t},NET_EVENT_NAME)}reportRequestSubmit(e){this.requestTime=Date.now(),this.sendAnalyticsEvent({clientRequestId:e,effect_type:"aigc",effect_source:"eh",effectNetworkEventType:"netbridge_request_submit"},NET_EVENT_NAME)}reportResponseSuccess(e,t){const r=Date.now()-this.requestTime;this.sendAnalyticsEvent({clientRequestId:e,effectNetworkEventType:"netbridge_response_success",logID:t,clientSuccessWaitTime:r,effect_type:"aigc",effect_source:"eh"},NET_EVENT_NAME)}reportResponseFailure(e,t){const r=Date.now()-this.requestTime,s=t.get("status_code"),i=t.get("log_id"),a=t.get("body"),n=JSON.parse(a),o=n.algo_status_code,u=n.rpc_gateway_status_code;let h="netbridge_response_failure";1e4!==u&&10001!==u&&10003!==u||(h="netbridge_timeout"),this.sendAnalyticsEvent({clientRequestId:e,effectNetworkEventType:h,logID:i,http_status_code:s,rpc_status_code:u,algo_status_code:o,clientFailWaitTime:r,effect_type:"aigc",effect_source:"eh"},NET_EVENT_NAME)}sendAnalyticsEvent(e,t){var r;const s=null!=e?e:{},i=null!=t?t:"AIGC_DEFAULT_EVENT";let a="None";if(null===(r=this.jsAssetObj)||void 0===r?void 0:r.scene.assetManager){a=this.jsAssetObj.scene.assetManager.rootDir;const e=a.split("/");e.length>2&&(a=e[e.length-3])}s.path_md5=a;const n=this.packAnalyticsData(s);try{const e=APJS.AmazingManager.getSingleton("AnalyticsManager");null==e||e.reportEvent(i,n)}catch(e){console.error(e)}}}function createPropertyList(e){return e}exports.dynamicPropertyList=createPropertyList(["dynamicProperty0","dynamicProperty1","dynamicProperty2","dynamicProperty3","dynamicProperty4","dynamicProperty5","dynamicProperty6","dynamicProperty7","dynamicProperty8","dynamicProperty9"]),exports.dynamicPropertyKeyList=createPropertyList(["dynamicPropertyKey0","dynamicPropertyKey1","dynamicPropertyKey2","dynamicPropertyKey3","dynamicPropertyKey4","dynamicPropertyKey5","dynamicPropertyKey6","dynamicPropertyKey7","dynamicPropertyKey8","dynamicPropertyKey9"]);class JSAssetAIDrawTextureScript extends JSAssetServerAlgoScriptBase_1.JSAssetServerAlgoScriptBase{constructor(){super(),this.captureRT=void 0,this.flipCaptureRT=void 0,this.referenceCaptureRT=void 0,this._graphName="",this.region="auto",this._algoConfig="",this._prompt="",this._strength=.5,this._style="",this._styleName="",this._promptStatus=exports.PromptStatusMap[PromptStatus.Template],this._activePropertyCount=0,this._dynamicPropertyKey0="",this._dynamicPropertyKey1="",this._dynamicPropertyKey2="",this._dynamicPropertyKey3="",this._dynamicPropertyKey4="",this._dynamicPropertyKey5="",this._dynamicPropertyKey6="",this._dynamicPropertyKey7="",this._dynamicPropertyKey8="",this._dynamicPropertyKey9="",this._dynamicProperty0=0,this._dynamicProperty1=0,this._dynamicProperty2=0,this._dynamicProperty3=0,this._dynamicProperty4=0,this._dynamicProperty5=0,this._dynamicProperty6=0,this._dynamicProperty7=0,this._dynamicProperty8=0,this._dynamicProperty9=0,this._referenceImageEnableFlags="[]",this._animation=0,this._play=!1,this.stopTrigger=!1,this._texture=void 0,this._referenceTexture=void 0,this.previousTexture=void 0,this._waitFrame=0,this._hasAlgoResult=!1,this.requestTimer=0,this.maxTimeout=60,this.errorWaitTimer=0,this.maxErrorWaitTime=2,this.requestSent=!1,this.responseReceived=!1,this.requestId=0,this.blendTimer=0,this.blendSpeed=1,this._instanceId=0,this._algoInited=!1,this._duration=1.5,this.networkEventReporter=void 0,this.timeoutEventSent=!1,this.identityMat=new APJS.Matrix4x4f,this.algorithmListeners=[],this.algorithmType="AIDrawTexture"}init(e){if(super.init(),this.getMgrInstanceFunc){const e=this.getMgrInstanceFunc();this._screenMesh=null==e?void 0:e.addListenCompType("Camera")}}registerAlgorithmListener(e){this.algorithmListeners.includes(e)||this.algorithmListeners.push(e)}removeAlgorithmListener(e){this.algorithmListeners=this.algorithmListeners.filter((t=>t!==e))}executeCallback(e,t=""){switch(e){case CallbackType.Begin:this.algorithmListeners.forEach((e=>{e.onBegin()}));break;case CallbackType.Stay:this.algorithmListeners.forEach((e=>{e.onStay()}));break;case CallbackType.Succeed:this.algorithmListeners.forEach((e=>{e.onSucceed()}));break;case CallbackType.Fail:this.algorithmListeners.forEach((e=>{e.onFail(t)}))}}startAlgorithm(){this.triggerStartAlgorithm()}stopAlgorithm(){this.triggerStopAlgorithm()}get prompt(){return this._prompt}set prompt(e){var t;this._prompt=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"prompt",e))}get promptStatus(){return this._promptStatus}set promptStatus(e){this._promptStatus=e}get strength(){return this._strength}set strength(e){var t;this._strength=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"strength",e))}set algoConfig(e){this._algoConfig=e}get algoConfig(){return this._algoConfig}set style(e){this._style=e}get style(){return this._style}set styleName(e){this._styleName=e}get styleName(){return this._styleName}get dynamicProperty0(){return this._dynamicProperty0}set dynamicProperty0(e){var t;this._dynamicProperty0=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty0",e))}get dynamicProperty1(){return this._dynamicProperty1}set dynamicProperty1(e){var t;this._dynamicProperty1=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty1",e))}get dynamicProperty2(){return this._dynamicProperty2}set dynamicProperty2(e){var t;this._dynamicProperty2=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty2",e))}get dynamicProperty3(){return this._dynamicProperty3}set dynamicProperty3(e){var t;this._dynamicProperty3=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty3",e))}get dynamicProperty4(){return this._dynamicProperty4}set dynamicProperty4(e){var t;this._dynamicProperty4=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty4",e))}get dynamicProperty5(){return this._dynamicProperty5}set dynamicProperty5(e){var t;this._dynamicProperty5=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty5",e))}get dynamicProperty6(){return this._dynamicProperty6}set dynamicProperty6(e){var t;this._dynamicProperty6=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty6",e))}get dynamicProperty7(){return this._dynamicProperty7}set dynamicProperty7(e){var t;this._dynamicProperty7=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty7",e))}get dynamicProperty8(){return this._dynamicProperty8}set dynamicProperty8(e){var t;this._dynamicProperty8=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty8",e))}get dynamicProperty9(){return this._dynamicProperty9}set dynamicProperty9(e){var t;this._dynamicProperty9=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicProperty9",e))}get referenceImageEnableFlags(){return this._referenceImageEnableFlags}set referenceImageEnableFlags(e){var t;this._referenceImageEnableFlags=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"referenceImageEnableFlags",e))}dynamicPropertyCount(){return exports.dynamicPropertyList.length}getDynamicProperty(e){if(e<0||e>=exports.dynamicPropertyList.length)return 0;return this[exports.dynamicPropertyList[e]]}setDynamicProperty(e,t){if(e<0||e>=exports.dynamicPropertyList.length)return;this[exports.dynamicPropertyList[e]]=t}get activePropertyCount(){return this._activePropertyCount}set activePropertyCount(e){var t;this._activePropertyCount=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"activePropertyCount",e))}get dynamicPropertyKey0(){return this._dynamicPropertyKey0}set dynamicPropertyKey0(e){var t;this._dynamicPropertyKey0=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey0",e))}get dynamicPropertyKey1(){return this._dynamicPropertyKey1}set dynamicPropertyKey1(e){var t;this._dynamicPropertyKey1=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey1",e))}get dynamicPropertyKey2(){return this._dynamicPropertyKey2}set dynamicPropertyKey2(e){var t;this._dynamicPropertyKey2=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey2",e))}get dynamicPropertyKey3(){return this._dynamicPropertyKey3}set dynamicPropertyKey3(e){var t;this._dynamicPropertyKey3=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey3",e))}get dynamicPropertyKey4(){return this._dynamicPropertyKey4}set dynamicPropertyKey4(e){var t;this._dynamicPropertyKey4=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey4",e))}get dynamicPropertyKey5(){return this._dynamicPropertyKey5}set dynamicPropertyKey5(e){var t;this._dynamicPropertyKey5=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey5",e))}get dynamicPropertyKey6(){return this._dynamicPropertyKey6}set dynamicPropertyKey6(e){var t;this._dynamicPropertyKey6=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey6",e))}get dynamicPropertyKey7(){return this._dynamicPropertyKey7}set dynamicPropertyKey7(e){var t;this._dynamicPropertyKey7=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey7",e))}get dynamicPropertyKey8(){return this._dynamicPropertyKey8}set dynamicPropertyKey8(e){var t;this._dynamicPropertyKey8=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey8",e))}get dynamicPropertyKey9(){return this._dynamicPropertyKey9}set dynamicPropertyKey9(e){var t;this._dynamicPropertyKey9=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"dynamicPropertyKey9",e))}getPropertyKey(e){if(e<0||e>=exports.dynamicPropertyKeyList.length)return"";return this[exports.dynamicPropertyKeyList[e]]}setPropertyKey(e,t){if(e<0||e>=exports.dynamicPropertyKeyList.length)return;this[exports.dynamicPropertyKeyList[e]]=t}set animation(e){var t;this._animation=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"animation",e))}get animation(){return this._animation}set play(e){var t;this._play=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"play",e))}get play(){return this._play}get texture(){return this._texture}set texture(e){e!==this.mainObject&&e&&(this._texture=e)}get referenceTexture(){return this._referenceTexture}set referenceTexture(e){e!==this._referenceTexture&&(this._referenceTexture=e)}get resultMaterial(){return this._resultMaterial}set resultMaterial(e){void 0===e&&(e=this.defaultResultMaterial,this.uniformTexA=void 0,this.uniformTexB=void 0,this.uniformProgress=void 0),e!==this._resultMaterial&&(this._resultMaterial=e)}get defaultResultMaterial(){return this._defaultResultMaterial}set defaultResultMaterial(e){this._defaultResultMaterial=e}get uniformTexA(){return this._uniformTexA||"_TextureA"}set uniformTexA(e){this._uniformTexA=e}get uniformTexB(){return this._uniformTexB||"_TextureB"}set uniformTexB(e){this._uniformTexB=e}get uniformProgress(){return this._uniformProgress||"_Progress"}set uniformProgress(e){this._uniformProgress=e}get duration(){return this._duration}set duration(e){this._duration=e}get grabMaterial(){return this._grabMaterial}set grabMaterial(e){e!==this._grabMaterial&&(this._grabMaterial=e)}get errorTexture(){return this._errorTexture}set errorTexture(e){var t;e&&(this._errorTexture=e),this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"errorTexture",e))}get errorMaterial(){return this._errorMaterial}set errorMaterial(e){e!==this._errorMaterial&&(this._errorMaterial=e)}get graphName(){return this._graphName}set graphName(e){var t;this._graphName=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"graphName",e))}get mainObject(){return this._mainObject}set mainObject(e){this._mainObject=e}createRenderTexture(e,t,r){const s=new APJS.RenderTextureCreateDesc;return s.name=e,s.builtinType=APJS.BuiltInTextureType.NORAML,s.internalFormat=APJS.InternalFormat.RGBA8,s.dataType=APJS.DataType.U8norm,s.depth=1,s.attachment=APJS.RenderTextureAttachment.DEPTH24,s.filterMag=APJS.FilterMode.Linear,s.filterMin=APJS.FilterMode.Linear,s.filterMipmap=APJS.FilterMipmapMode.None,s.width=t,s.height=r,s.colorFormat=APJS.PixelFormat.RGBA8Unorm,APJS.TextureUtils.createRenderTexture(s)}setAlgorithmEnable(e){const t=["aiDraw_0","aiDraw_blit_0"];if(e)APJS.AlgorithmManager.enableGraphNodes(this.graphName,t,!0);else{if(!0===this.anyNetworkBusy)return;APJS.AlgorithmManager.enableGraphNodes(this.graphName,t,!1),APJS.AlgorithmManager.setInputTexture(4,null,null)}}initialize(){this.mainObject&&(this.networkEventReporter=new NetworkEventReporter(this),this.mainObject.filterMag=APJS.FilterMode.Nearest,this.mainObject.filterMin=APJS.FilterMode.Nearest,this.mainObject.filterMipmap=APJS.FilterMipmapMode.None,this._resultMesh||(this._resultMesh=this.createQuadMesh()),this.resultMaterial&&(this.resultMaterialInstance=this.resultMaterial.instantiate()),this.errorMaterial&&(this.errorMaterialInstance=this.errorMaterial.instantiate()),this.setAlgorithmEnable(!1),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.clearTexture()}))))}onStart(){this.isRunTime&&this.initialize()}doStopAlgorithm(){super.doStopAlgorithm()}initAlgo(){this.texture&&(this.setAlgorithmEnable(!0),this.executeCallback(CallbackType.Begin),this.executeCallback(CallbackType.Stay),this.resultMaterialInstance&&(this.resultMaterialInstance.setTex(this.uniformTexA,this.texture),this.resultMaterialInstance.setTex(this.uniformTexB,this.texture),this.resultMaterialInstance.setFloat(this.uniformProgress,0)),this.captureRT=this.createRenderTexture("rendercache",this.texture.getWidth(),this.texture.getHeight()),this.flipCaptureRT=this.createRenderTexture("flipRendercache",this.texture.getWidth(),this.texture.getHeight()),this.referenceTexture&&(this.referenceCaptureRT=this.createRenderTexture("referenceRendercache",this.referenceTexture.getWidth(),this.referenceTexture.getHeight())))}clearTexture(){this.cmdBufferHelper&&(this.cmdBufferHelper.setRenderTexture(this.mainObject),this.cmdBufferHelper.clearRenderTexture(!0,!0,new APJS.Color(0,0,0,0),1))}blendIfSuceess(e){var t;const r=(null===(t=this.scene)||void 0===t?void 0:t.assetManager.getAllCustomAssetsProperty()).get(this.uuid);this.duration=r.get("duration"),this.isAlgoResultSuccess()&&this.blendTimer*this.blendSpeed<this.duration&&this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.executeCallback(CallbackType.Stay),this.blendStart(e)})))}algoShouldStart(){return!(!this.play&&!super.algoShouldStart())}doStartAlgorithm(){return!0!==this.anyNetworkBusy&&(this.networkBusy=!0,this._algoInited||(this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.initAlgo()}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.executeCallback(CallbackType.Stay),this.blitImage()}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.executeCallback(CallbackType.Stay),this.submitToAlgo()}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.executeCallback(CallbackType.Stay),this.setAlgoDirty()}))),this._algoInited=!0),super.doStartAlgorithm())}checkAndSetAlgoResult(e){return this._hasAlgoResult?(this.endAlgo(!0),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.executeCallback(CallbackType.Stay),this.blendStart(e)})))):this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.executeCallback(CallbackType.Stay),this.checkoutForResult(e)}))),super.checkAndSetAlgoResult(e)}doSetResult(e){this.blendIfSuceess(e),super.doSetResult(e)}onEnd(e){this.blendIfSuceess(e)}endAlgo(e){this.networkBusy=!1,this.setAlgorithmEnable(!1),super.endAlgo(e)}canTriggerStart(){return!(this.algoState()===JSAssetServerAlgoScriptBase_1.algoStateMap.during||!super.canTriggerStart())}onUpdate(e){var t,r,s,i,a;if(this.isRunTime){if(!this.texture){if(this.getMgrInstanceFunc){const e=this.getMgrInstanceFunc(),t=null==e?void 0:e.getListenedComponents();for(const e of t)if(e.isInstanceOf("Camera")){this.texture=e.renderTexture;break}}if(!this.texture)return}null===(t=this.resultMaterialInstance)||void 0===t||t.setMat4("u_MVP",this.identityMat),null===(r=this.resultMaterialInstance)||void 0===r||r.setMat4("u_Model",this.identityMat),null===(s=this.resultMaterialInstance)||void 0===s||s.setMat4("u_View",this.identityMat),null===(i=this.resultMaterialInstance)||void 0===i||i.setMat4("u_Projection",this.identityMat);const n=(null===(a=this.scene)||void 0===a?void 0:a.assetManager.getAllCustomAssetsProperty()).get(this.uuid);this.play=n.get("play"),super.onUpdate(e)}}onEvent(e){if(e.type!==APJS.AppEventType.COMPAT_BEF||e.args.length<2)return;const t=e.args[0],r=e.args[1];if(t===APJS.BEFEventType.BET_RECORD_VIDEO&&1===r&&void 0!==this.scene.getSettings){if(!0!==this.scene.getSettings().get("auto_reset_effect"))return;this.doStopAlgorithm()}}blitImage(){var e;this.cmdBufferHelper&&this.flipCaptureRT&&this.grabMaterial&&(this.cmdBufferHelper.blitWithMaterial(this.texture,this.flipCaptureRT,this.grabMaterial,0,!1),this.cmdBufferHelper.blit(this.texture,this.captureRT),this.referenceCaptureRT&&this.referenceTexture&&this.cmdBufferHelper.blitWithMaterial(this.referenceTexture,this.referenceCaptureRT,this.grabMaterial,0,!1),null===(e=this.resultMaterialInstance)||void 0===e||e.setTex(this.uniformTexA,this.captureRT))}submitToAlgo(){var e;this.flipCaptureRT||(console.error("no rt"),this.processError()),inputConfig.dirty=!0,APJS.AlgorithmManager.setInputTexture(4,this.flipCaptureRT,inputConfig),this.referenceCaptureRT&&APJS.AlgorithmManager.setInputTexture(5,this.referenceCaptureRT,inputConfig);const t=(null===(e=this.scene)||void 0===e?void 0:e.assetManager.getAllCustomAssetsProperty()).get(this.uuid),r=t.get("algoConfig"),s=t.get("prompt"),i=t.get("activePropertyCount"),a=JSON.parse(r);a.custom_prompt=s?s.toString():"";for(let e=0;e<i&&!(e>=exports.dynamicPropertyKeyList.length||e>=exports.dynamicPropertyList.length);e++){const t=this.getPropertyKey(e),r=this.getDynamicProperty(e);a[t]=r}const n=t.get("referenceImageEnableFlags"),o=JSON.parse(n);for(let e=0;e<o.length;e++){const t=o[e];t&&(a[t]=this.referenceCaptureRT?1:0)}const u=a?JSON.stringify(a):"",h=APJS.AlgorithmManager.getGraphNode(this.graphName,nodeName);h.setString("req_json",u),h.setString("req_service_name",this.style),h.setString("req_region",this.region),JSAssetServerAlgoScriptBase_1.JSAssetServerAlgoScriptBase.instanceCount++,h.setInt("requestId",JSAssetServerAlgoScriptBase_1.JSAssetServerAlgoScriptBase.instanceCount),this.requestId=JSAssetServerAlgoScriptBase_1.JSAssetServerAlgoScriptBase.instanceCount,this._hasAlgoResult=!1,this.requestSent=!0,this.responseReceived=!1,this.uuid&&this.networkEventReporter&&this.networkEventReporter.reportRequestSubmit(this.uuid)}setAlgoDirty(){inputConfig.dirty=!1,APJS.AlgorithmManager.setInputTexture(4,this.flipCaptureRT,inputConfig),this.referenceCaptureRT&&APJS.AlgorithmManager.setInputTexture(5,this.referenceCaptureRT,inputConfig)}onDestroy(){this.requestSent&&!this.responseReceived&&this.uuid&&this.networkEventReporter&&this.networkEventReporter.reportAlgClientTimeout(this.uuid,"client_drop_out"),this.resetProperty()}resetProperty(){this.networkBusy=!1,this.setAlgorithmEnable(!1),this.cmdBufferHelper&&(this._waitFrame=0,this.blendTimer=0,this.requestTimer=0,this._hasAlgoResult=!1,this._algoInited=!1,this.requestSent=!1,this.responseReceived=!1,this.timeoutEventSent=!1,super.resetProperty(),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.clearTexture()}))))}processError(){this.endAlgo(!1),this.executeCallback(CallbackType.Fail),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.errorTexture&&this.errorMaterialInstance&&(this._errorMesh||(this._errorMesh=this.createQuadMesh(-.4,.4,.5,.61)),this.errorMaterialInstance.setTex("u_AlbedoTexture",this.errorTexture),this.refreshTexture(this.errorMaterialInstance,this._errorMesh),this._algoResult.success=!1)})))}checkoutForResult(e){var t,r,s,i,a,n;if(this.requestTimer=this.requestTimer+e,this.requestTimer>this.maxTimeout&&this.algoState()===JSAssetServerAlgoScriptBase_1.algoStateMap.during)return this.uuid&&this.networkEventReporter&&!this.timeoutEventSent&&(this.networkEventReporter.reportAlgClientTimeout(this.uuid,"algo_fail"),this.timeoutEventSent=!0),this.processError(),void(this.responseReceived=!0);const o=APJS.AlgorithmManager.getResult().getScriptInfo(this.graphName,nodeName);if(!o)return;if(!o.outputMap)return;const u=o.outputMap,h=u.get("requestId"),l=u.get("gan_image"),c=u.get("status_code"),p=u.get("error"),y=u.get("success"),m=u.get("message"),d=u.get("log_id");if(h===this.requestId){if(m&&this.setServerMsg(m),p)return console.error("AIDraw","Text2X: Request Error "+p),this.processError(),this.uuid&&this.networkEventReporter&&this.networkEventReporter.reportResponseFailure(this.uuid,u),void(this.responseReceived=!0);if(!1===y)return console.error("AIDraw","Text2X: Request Timeoutlogid"+d),this.processError(),this.uuid&&this.networkEventReporter&&this.networkEventReporter.reportResponseFailure(this.uuid,u),void(this.responseReceived=!0);if(c>0)return console.error("AIDraw","Text2X: Request Status Code "+c),this.processError(),this.uuid&&this.networkEventReporter&&this.networkEventReporter.reportResponseFailure(this.uuid,u),void(this.responseReceived=!0);if(this.texture&&l){this.responseReceived=!0;const e=l.width,o=l.height;this.uuid&&this.networkEventReporter&&this.networkEventReporter.reportResponseSuccess(this.uuid,d);const u=new APJS.Texture2DCreateDesc;u.filterMin=APJS.FilterMode.Linear,u.filterMag=APJS.FilterMode.Linear,u.width=e,u.height=o,u.image=l,this._algoTexture=APJS.TextureUtils.createTexture2D(u),this._flipYAlgoTexture=this.createRenderTexture("flipYAlgoTexture",this._algoTexture.getWidth(),this._algoTexture.getHeight()),null===(t=this.cmdBufferHelper)||void 0===t||t.clearAll(),null===(r=this.cmdBufferHelper)||void 0===r||r.blitWithMaterial(this._algoTexture,this._flipYAlgoTexture,this.grabMaterial,0,!1),this.scene.commitCommandBuffer(this.cmdBufferHelper),null===(s=this.resultMaterialInstance)||void 0===s||s.setTex(this.uniformTexB,this._flipYAlgoTexture);const h=(null===(i=this.scene)||void 0===i?void 0:i.assetManager.getAllCustomAssetsProperty()).get(this.uuid);this.animation=h.get("animation"),this.animation?null===(a=this.resultMaterialInstance)||void 0===a||a.setFloat(this.uniformProgress,0):null===(n=this.resultMaterialInstance)||void 0===n||n.setFloat(this.uniformProgress,1),this.refreshTexture(this.resultMaterialInstance,this._resultMesh),this._hasAlgoResult=!0,this.blendTimer=0,this.executeCallback(CallbackType.Succeed)}}}blendStart(e){var t,r,s,i;const a=(null===(t=this.scene)||void 0===t?void 0:t.assetManager.getAllCustomAssetsProperty()).get(this.uuid);this.animation=a.get("animation"),this.animation&&(this.blendTimer=this.blendTimer+e,this.duration=a.get("duration"),0===this.duration?null===(r=this.resultMaterialInstance)||void 0===r||r.setFloat(this.uniformProgress,1):this.blendTimer*this.blendSpeed<this.duration?null===(s=this.resultMaterialInstance)||void 0===s||s.setFloat(this.uniformProgress,this.blendTimer*this.blendSpeed/this.duration):null===(i=this.resultMaterialInstance)||void 0===i||i.setFloat(this.uniformProgress,1),this.refreshTexture(this.resultMaterialInstance,this._resultMesh))}refreshTexture(e,t){var r,s;this.clearTexture(),null===(r=this.cmdBufferHelper)||void 0===r||r.setRenderTexture(this.mainObject),null===(s=this.cmdBufferHelper)||void 0===s||s.drawMesh(t,this.identityMat,e,0,0,new APJS.MaterialPropertyBlock,!1)}createQuadMesh(e=-1,t=1,r=-1,s=1){const i=new APJS.Mesh,a=new APJS.VertexAttribDesc;a.semantic=APJS.VertexAttribType.POSITION;const n=new APJS.VertexAttribDesc;n.semantic=APJS.VertexAttribType.TEXCOORD0;const o=new APJS.Vector;o.pushBack(a),o.pushBack(n),i.vertexAttribs=o;const u=[t,s,0,1,1,t,r,0,1,0,e,r,0,0,0,e,s,0,0,1],h=new APJS.FloatVector;for(let e=0;e<u.length;e++)h.pushBack(u[e]);i.vertices=h;const l=new APJS.SubMesh;l.primitive=APJS.Primitive.TRIANGLES;const c=[3,2,1,1,0,3],p=new APJS.UInt16Vector;for(let e=0;e<c.length;e++)p.pushBack(c[e]);return l.indices16=p,l.mesh=i,i.addSubMesh(l),i}}exports.JSAssetAIDrawTextureScript=JSAssetAIDrawTextureScript;