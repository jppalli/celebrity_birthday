"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,n){void 0===n&&(n=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,n,i)}:function(e,t,s,n){void 0===n&&(n=s),e[n]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.regJSAsset=exports.instance=exports.initInstance=exports.JSAssetRuntimeManager=void 0;const JSAssetScriptBase_1=require("./JSAssetScriptBase"),JSAssetProvider=__importStar(require("./JSAssetProvider")),APJS=require('amazingpro.js');class EventHandler{constructor(){this._callbacks={},this._callbackActive={}}_addCallback(e,t,s,n=!1){e&&"string"==typeof e&&t&&(this._callbacks[e]||(this._callbacks[e]=[]),this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].push({callback:t,scope:s||this,once:n}))}on(e,t,s){return this._addCallback(e,t,s,!1),this}off(e,t,s){if(e)this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());else for(const e in this._callbackActive)this._callbacks[e]&&this._callbacks[e]===this._callbackActive[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());if(e)if(t){const n=this._callbacks[e];if(!n)return this;let i=n.length;for(let e=0;e<i;e++)n[e].callback===t&&(s&&n[e].scope!==s||(n[e--]=n[--i]));n.length=i}else this._callbacks[e]&&(this._callbacks[e]=[]);else this._callbacks={};return this}fire(e,t,s,n,i,r,a,o,c){if(!e||!this._callbacks[e])return this;let d;this._callbackActive[e]?(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),d=this._callbacks[e].slice()):this._callbackActive[e]=this._callbacks[e];for(let l=0;(d||this._callbackActive[e])&&l<(d||this._callbackActive[e]).length;l++){const h=(d||this._callbackActive[e])[l];if(h.callback.call(h.scope,t,s,n,i,r,a,o,c),h.once){const t=this._callbacks[e].indexOf(h);-1!==t&&(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].splice(t,1))}}return d||(this._callbackActive[e]=void 0),this}once(e,t,s){return this._addCallback(e,t,s,!0),this}hasEvent(e){return this._callbacks[e]&&0!==this._callbacks[e].length||!1}}function utf8ByteToUnicodeStr(e){let t="";for(let s=0;s<e.length;){const n=e[s];let i=0;n>>>7==0?(t+=String.fromCharCode(e[s]),s+=1):252==(252&n)?(i=(3&e[s])<<30,i|=(63&e[s+1])<<24,i|=(63&e[s+2])<<18,i|=(63&e[s+3])<<12,i|=(63&e[s+4])<<6,i|=63&e[s+5],t+=String.fromCharCode(i),s+=6):248==(248&n)?(i=(7&e[s])<<24,i|=(63&e[s+1])<<18,i|=(63&e[s+2])<<12,i|=(63&e[s+3])<<6,i|=63&e[s+4],t+=String.fromCharCode(i),s+=5):240==(240&n)?(i=(15&e[s])<<18,i|=(63&e[s+1])<<12,i|=(63&e[s+2])<<6,i|=63&e[s+3],t+=String.fromCharCode(i),s+=4):224==(224&n)?(i=(31&e[s])<<12,i|=(63&e[s+1])<<6,i|=63&e[s+2],t+=String.fromCharCode(i),s+=3):192==(192&n)?(i=(63&e[s])<<6,i|=63&e[s+1],t+=String.fromCharCode(i),s+=2):(t+=String.fromCharCode(e[s]),s+=1)}return t}function ab2str(e){return utf8ByteToUnicodeStr(new Uint8Array(e))}exports.default=EventHandler;class JSAssetRuntimeManager extends EventHandler{registerSingleInsUpdateFn(e,t){const s=JSAssetRuntimeManager.instance;s&&(s._singleInstanceUpdaetFn.has(t)||s._singleInstanceUpdaetFn.set(t,e))}static get instance(){return this._instance}static get systemScript(){return this._instance._systemScript}getDefaultCmdBufferHelper(){return this._cmdBufHelper||(this._cmdBufHelper=new APJS.CommandBuffer),this._cmdBufHelper}getDefaultScreenMesh(){return this._screenMesh||(this._screenMesh=JSAssetScriptBase_1.MeshUtil.createQuadMesh()),this._screenMesh}static regJSAsset(e,t,s,n,i=!1){const r={extName:t,engineType:s,projectDir:n,tickInEditor:i,constructor:e};JSAssetRuntimeManager._mapExtNameToAssetConfig.has(t.toLowerCase())||JSAssetRuntimeManager._mapExtNameToAssetConfig.set(t.toLowerCase(),r)}static addNativeListener(e,t,s,n){var i,r;const a=JSAssetRuntimeManager.getObjectEvent(e,t);!(null===(i=JSAssetRuntimeManager.instance)||void 0===i?void 0:i.hasEvent(a))&&this.systemScript&&this.systemScript.addScriptListener(e,t,"_onObjectEvent",e),null===(r=JSAssetRuntimeManager.instance)||void 0===r||r.on(a,s,n)}static removeNativeListener(e,t,s,n){var i,r;const a=JSAssetRuntimeManager.getObjectEvent(e,t);(null===(i=JSAssetRuntimeManager.instance)||void 0===i?void 0:i.hasEvent(a))&&this.systemScript&&this.systemScript.removeScriptListener(e,t,"_onObjectEvent",e),null===(r=JSAssetRuntimeManager.instance)||void 0===r||r.off(a,s,n)}getFirstEffectNodeLargerOrEqualOrder(e){let t,s,n=Number.MIN_VALUE,i=Number.MAX_VALUE;for(const r of this._listenedComponents)r instanceof APJS.EffectNode&&(r.renderOrder>=e&&r.renderOrder<i&&(i=r.renderOrder,t=r),n<r.renderOrder&&(n=r.renderOrder,s=r));return void 0!==t?t:s}addListener(e,t){const s=this.getFirstEffectNodeLargerOrEqualOrder(t),n=this._renderOrderToInfo.get(t),i=null==n?void 0:n.updateFunction;return!!(n&&s&&i)&&(JSAssetRuntimeManager.addNativeListener(s,APJS.EffectNodeEvent.BEFORE_RENDER,i,this),n.effectNodeComponent=s,this._renderOrderToInfo.set(t,n),!0)}removeListener(e){var t;if(0===e)return!0;const s=this._renderOrderToInfo.get(e),n=null==s?void 0:s.effectNodeComponent,i=null===(t=this._renderOrderToInfo.get(e))||void 0===t?void 0:t.updateFunction;return!(!s||!n||void 0===i)&&(JSAssetRuntimeManager.removeNativeListener(n,APJS.EffectNodeEvent.BEFORE_RENDER,i,this),s.effectNodeComponent=void 0,this._renderOrderToInfo.set(e,s),!0)}constructor(){super(),this._scene=void 0,this._originAssetUUIDS=new Set,this._nativeObjMap=void 0,this._cmdBufHelper=void 0,this._deltaTime=0,this._curRenderTime=0,this._epsilon=30,this._screenMesh=void 0,this._singleInstanceUpdaetFn=new Map,this._currentFrame=0,this._scene=void 0,this._resEntryMap=new Map,this._assets=new Array,this._assetMap=new Map,this._renderOrderToInfo=new Map,this._renderOrders=new Map,this._renderOrderSet=new Set([]),this._listenedCompTypeSet=new Set([]),this._listenedComponents=new Array}static initInstance(e,t){if(void 0===this._instance){if(!e)throw new Error;if(this._instance=new JSAssetRuntimeManager,!((e=APJS.transferToAPJSObj(e))instanceof APJS.Scene))throw new Error("JSAssetRuntimeManager:initInstance, transfer to APJS.Scene failed!");this._instance.init(e,t)}else console.warn("Engine already initialized")}static getObjectEvent(e,t){return void 0===t?"":e.handle.toString()+":"+t.toString()}_onObjectEvent(e,t,s){var n;const i=JSAssetRuntimeManager.getObjectEvent(e,s);null===(n=JSAssetRuntimeManager.instance)||void 0===n||n.fire(i,t,s)}initSystemScript(e){let t=e.script;if(t=APJS.transferToAPJSObj(t),!(t instanceof APJS.JSScript))throw new Error("JSAssetRuntimeManager:initSystemScript, transfer to APJS.JSScript failed!");if(!(t instanceof APJS.JSScript))throw new Error("Incorrect/ missing system script is not passed in amg.Engine.init(). Please pass this as second argument");this._systemScript=t;this._systemScript.ref._onObjectEvent=this._onObjectEvent}getConfigFromFilePath(e){if(!fs.accessSync(e,0))return void console.log("No customAssets.json found");const t=fs.readFileSync(e),s=JSON.parse(ab2str(t));if(null!==s)return s;console.error("customAssets.json parse failed")}registerRenderChain(e,t){var s;void 0!==e&&t&&(this._renderOrderToInfo.has(e)?null===(s=this._renderOrderToInfo.get(e))||void 0===s||s.assets.push(t):this._renderOrderToInfo.set(e,{assets:[t],updateFunction:()=>{const t=this._renderOrderToInfo.get(e);t&&t.lastRenderTime!==this._currentFrame&&(t.lastRenderTime=this._currentFrame,this.render(e,this._deltaTime))},effectNodeComponent:void 0,lastRenderTime:0})),this._listenedCompTypeSet.add("EffectNode"),this._renderOrderSet.add(e)}addListenerOnStart(){if((0,JSAssetScriptBase_1.IsRenderChainEventSupported)())for(const e of this._renderOrderSet)if(0!==e){this.addListener(this._scene,e)||console.error("Custom-asset of renderOrder: "+e+" failed to be added")}}initJSAssetInstances(e,t){var s,n;for(const i of e){const e=this._resEntryMap.get(i);if(e.path.endsWith(".jsasset")||this._assetMap.has(i))continue;console.log("initializing JSAsset with uuid",i);const r=this.createJSAsset(e);if(r){r.mainObject=t.get(i),r.mainObject instanceof APJS.Texture&&APJS.TextureUtils.hasTextureProvider(r.mainObject,APJS.ScreenTextureProvider)&&(r.mainObject.getControl().needInitData=!0),this._assets.push(r),this._assetMap.set(i,r);const a=this._renderOrders.get(e.uuid);void 0!==a&&this.registerRenderChain(a,r);const o=e.properties;if(o)for(const e in o){const t=o[e];if("string"==typeof t&&t.startsWith("custom://")){const n=t.substring(t.lastIndexOf("/")+1,t.length),i=null===(s=this._assetMap.get(n))||void 0===s?void 0:s.mainObject;i&&(r[e]=i)}else if("string"==typeof t&&t.startsWith("share://")){const s=null===(n=this._scene)||void 0===n?void 0:n.assetManager.SyncLoad(t);r[e]=s}}}}}restoreInstantiatedObjects(e){if(0===e.size())return;const t=e.getVectorKeys();for(let s=0;s<t.size();s++){const n=t.get(s).toString(),i=e.get(n);if(this._assetMap.has(n))continue;const r=n.substring(0,n.lastIndexOf("-"));if(!this._assetMap.has(r)){console.error("JSAssetSystem restoreInstantiatedObjects original_id not exist:",r);continue}const a=this._assetMap.get(r).instantiate();void 0!==a&&(a.mainObject=APJS.transferToAPJSObj(i),this.setupInstantiatedJSAsset(a,n,r))}}setupInstantiatedJSAsset(e,t,s){var n,i;const r=Object.assign({},this._resEntryMap.get(s));r.uuid=t,this._resEntryMap.set(t,r),null===(i=null===(n=this._scene)||void 0===n?void 0:n.assetManager.getAllCustomAssetsProperty())||void 0===i||i.set(t,r.properties),e.uuid=t,this._assets.push(e),this._assetMap.set(t,e);const a=this._renderOrders.get(s);void 0!==a&&(this._renderOrders.set(r.uuid,a),this.registerRenderChain(a,e))}init(e,t){var s,n;this._scene=e,this.initSystemScript(t);const i=e.assetManager.rootDir+"customAssets.json";this._assetsConfig=this.getConfigFromFilePath(i),this._nativeObjMap=e.assetManager.getAllScriptCustomAssets();for(const e of this._assetsConfig)this._resEntryMap.set(e.uuid,e),this._renderOrders.set(e.uuid,null!==(n=null===(s=e.properties)||void 0===s?void 0:s.captureOrder)&&void 0!==n?n:0),this._originAssetUUIDS.add(e.uuid);const r=this.analyzeAssetsDependency();this.initJSAssetInstances(r,this._nativeObjMap),this.restoreInstantiatedObjects(this._nativeObjMap)}onInit(){var e,t,s,n,i,r;if(this._assets.forEach((e=>{e.init(this.registerSingleInsUpdateFn)})),this._listenedCompTypeSet.size>0)for(const t of this._listenedCompTypeSet)null===(e=this._systemScript)||void 0===e||e.handleComponentName(t);else null===(t=this._systemScript)||void 0===t||t.handleNoComponent();null===(s=this._systemScript)||void 0===s||s.addEventType(APJS.AppEventType.COMPAT_BEF),null===(n=this._systemScript)||void 0===n||n.addEventType(APJS.EventType.RCVALUE_CHANGE),null===(i=this._systemScript)||void 0===i||i.addEventType(APJS.EventType.TOUCH),APJS.EventType.DUAL_INSTANCE&&(null===(r=this._systemScript)||void 0===r||r.addEventType(APJS.EventType.DUAL_INSTANCE))}onStart(){this.addListenerOnStart();for(const e of this._renderOrderToInfo){const t=e[1].assets;for(const e of t)e.onStart()}}onUpdate(e){this._currentFrame%=Number.MAX_SAFE_INTEGER,this._currentFrame++,this._deltaTime=e,this.render(0,e)}render(e,t){var s,n;if(this._scene){null===(s=this._cmdBufHelper)||void 0===s||s.clearAll(),this._singleInstanceUpdaetFn.forEach(((e,s)=>{s.call(e,t)}));const i=null===(n=this._renderOrderToInfo.get(e))||void 0===n?void 0:n.assets;if(i)for(const e of i)null==e||e.onUpdate(t);this._cmdBufHelper&&this._scene.commitCommandBuffer(this._cmdBufHelper)}}onLateUpdate(e){for(const t of this._renderOrderToInfo){const s=t[1].assets;for(const t of s)t.onLateUpdate(e)}}onRelease(){for(const e of this._renderOrderToInfo){const t=e[1].assets;for(const e of t)e.onRelease()}}onDestroy(){if((0,JSAssetScriptBase_1.IsRenderChainEventSupported)())for(const e of this._renderOrderSet){this.removeListener(e)||console.error("Custom-asset of renderOrder: "+e+" failed to be removed")}for(const e of this._renderOrderToInfo){const t=e[1].assets;for(const e of t)e.onDestroy()}this._listenedComponents=[]}onEvent(e){for(const t of this._assets)t.onEvent(e)}onComponentAdded(e){this._listenedComponents.push(e)}onComponentRemoved(e){let t=-1;for(let s=0;s<this._listenedComponents.length;s++)if(this._listenedComponents[s].handle===e.handle){t=s;break}-1!==t&&this._listenedComponents.splice(t,1)}addListenCompType(e){this._listenedCompTypeSet.add(e)}getListenedComponents(e){return this._listenedComponents}getAsset(e){var t,s;const n=APJS.isAPJSType(e)?e:APJS.transferToAPJSObj(e);if(n&&APJS.isDynamicAsset(n))return n.getControl();const i=e&&e instanceof APJS.AObject?e.getNative():e,r=null===(t=this._nativeObjMap)||void 0===t?void 0:t.getVectorKeys();if(r)for(let e=0;e<r.size();++e){const t=r.get(e),n=null===(s=this._nativeObjMap)||void 0===s?void 0:s.get(t),a=n&&n instanceof APJS.AObject?n.getNative():n;if(i&&a&&a.eq(i))return this._assetMap.get(t)}}instantiateAsset(e){var t,s,n;if(void 0===e||void 0===e.uuid)return;const i=e.instantiate();if(void 0===i)return;const r=e.uuid+"-"+e.instantiatedObjectsNum.toString();let a;return(null===(t=e.mainObject)||void 0===t?void 0:t.isInstanceOf("Texture2D"))?a=APJS.TextureUtils.createTexture2D():(null===(s=e.mainObject)||void 0===s?void 0:s.isInstanceOf("TextureDelegate"))&&(a=APJS.TextureUtils.createTextureDelegate()),a&&(null===(n=this._nativeObjMap)||void 0===n||n.set(r,a),i.mainObject=a),this.setupInstantiatedJSAsset(i,r,e.uuid),a}removeAsset(e){var t,s,n;if(void 0===e||void 0===e.uuid||!1===e.canBeRemovedDynamically)return console.error("removeAsset: script or uuid undefined or canBeRemovedDynamically is false"),!1;const i=e.uuid;!1===this._originAssetUUIDS.has(i)&&(null===(t=this._nativeObjMap)||void 0===t||t.remove(i),null===(n=null===(s=this._scene)||void 0===s?void 0:s.assetManager.getAllCustomAssetsProperty())||void 0===n||n.remove(i)),this._resEntryMap.delete(i),this._assetMap.delete(i),this._assets=this._assets.filter((e=>e.uuid!==i));const r=this._renderOrders.get(i);if(void 0===r)return console.error("removeAsset: not found renderorder"),!1;{const e=this._renderOrderToInfo.get(r);if(void 0===e)return console.error("removeAsset: not found assetInfo"),!1;e.assets=e.assets.filter((e=>e.uuid!==i)),this._renderOrders.delete(i)}return!0}restoreToOriginalAssets(){var e,t;this.removeInstantiatedAssets();for(const s of this._assetsConfig)this._resEntryMap.set(s.uuid,s),this._renderOrders.set(s.uuid,null!==(t=null===(e=s.properties)||void 0===e?void 0:e.captureOrder)&&void 0!==t?t:0);const s=this.analyzeAssetsDependency(),n=new Array;for(const e of s)this._assetMap.has(e)||n.push(e);this.initJSAssetInstances(s,this._nativeObjMap);for(const e of n){const t=this._assetMap.get(e);t&&t.onStart()}}removeInstantiatedAssets(){for(const e of this._assetMap.keys())if(!this._originAssetUUIDS.has(e)){const t=this._assetMap.get(e);t&&this.removeAsset(t)}}getAssetByUUID(e){return this._assetMap.get(e)}getAllJSAssets(){return this._assets}createJSAsset(e){if("string"==typeof(null==e?void 0:e.path)){const t=e.path.substring(e.path.lastIndexOf(".")).toLowerCase(),s=JSAssetProvider.JSAssetExtNameToCtrMap.get(t.toLowerCase());if(!s)return console.error(`JSAsset doesn't support asset extName: [${t}]`),null;const n=new s;return n.scene=this._scene,n.loadFromConfig(e),n.isRunTime=!0,n.getMgrInstanceFunc=instance,n}return null}analyzeAssetsDependency(){let e=new Array;const t=new Map,s=new Map,n="custom://";let i=0;for(const e of this._assetsConfig)i+=1,s.set(e.uuid,0);for(const e of this._assetsConfig){const i=e.uuid;if(e.properties)for(const r in e.properties){const a=e.properties[r];if("string"==typeof a&&a.startsWith(n)){const e=a.substr(9);console.log(`custom assets: [${i}] depends on [${e}]`),s.set(e,s.get(e)+1),t.has(i)||t.set(i,new Array),t.get(i).push(e)}}}const r=new Array;for(const e of s.keys())0===s.get(e)&&r.push(e);for(;r.length>0;){const n=r.shift();if(e.push(n),t.has(n))for(const e of t.get(n))s.set(e,s.get(e)-1),0===s.get(e)&&r.push(e)}if(e.length===i)e.reverse();else{console.error("Found circular dependency in custom assets"),e=new Array;for(const t of this._assetsConfig)e.push(t.uuid)}if((0,JSAssetScriptBase_1.IsRenderChainEventSupported)())for(const s of e){const e=t.get(s);null==e||e.forEach((e=>{var t,n;this._renderOrders.set(s,Math.max(null!==(t=this._renderOrders.get(s))&&void 0!==t?t:0,null!==(n=this._renderOrders.get(e))&&void 0!==n?n:0))}))}return e}}exports.JSAssetRuntimeManager=JSAssetRuntimeManager,JSAssetRuntimeManager._instance=void 0,JSAssetRuntimeManager._mapExtNameToAssetConfig=new Map;let managerIns=null;function initInstance(e,t){JSAssetRuntimeManager.initInstance(e,t),managerIns=JSAssetRuntimeManager.instance,managerIns.onInit()}function instance(){return managerIns}function regJSAsset(e,t,s,n=!1){return i=>{JSAssetRuntimeManager.regJSAsset(i,e,t,s,n)}}exports.initInstance=initInstance,exports.instance=instance,exports.regJSAsset=regJSAsset;