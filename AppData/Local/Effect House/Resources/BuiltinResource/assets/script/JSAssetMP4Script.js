"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,s){void 0===s&&(s=i);var o=Object.getOwnPropertyDescriptor(e,i);o&&!("get"in o?!e.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,s,o)}:function(t,e,i,s){void 0===s&&(s=i),t[s]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetMP4Script=exports.MP4Event=void 0;const JSAssetScriptBase_1=require("./JSAssetScriptBase"),APJS=require('amazingpro.js');var MP4Event;!function(t){t.MP4_PLAY_BEGIN="MP4_PLAY_BEGIN",t.MP4_PLAY_END="MP4_PLAY_END",t.MP4_PAUSE="MP4_PAUSE",t.MP4_RESUME="MP4_RESUME",t.MP4_KEY_SEC="MP4_KEY_SEC",t.MP4_STOP="MP4_STOP"}(MP4Event=exports.MP4Event||(exports.MP4Event={}));class JSAssetMP4Script extends JSAssetScriptBase_1.JSAssetScriptBase{constructor(){if(super(),this._isPlaying=!0,this._isSeekMode=!1,this._time=0,this._curLoopIndex=0,this._loopCount=-1,this._cacheOnStartProperties={},this._eventCb=new Map,this._initilized=!1,this._handleVEEdit=!1,this._isVeEdit=!1,this._hasTriggerEnd=!1,this._hasTriggerBegin=!1,this.loopCount=-1,this._handleVEEdit=!0,this._handleVEEdit){const t=APJS.AmazingManager.getSingleton("BuiltinObject");if(t){const e=t.getUserStringValue("effect_ab_license");this._isVeEdit="ve_edit"===e||"ve_edit_temp"===e,console.log("[VEEdit] effectABLicence:"+e+" isEditorEnv:"+this.isEditorEnv())}}this.canBeRemovedDynamically=!0}get duration(){return this.controller&&this.controller.videoInfo()?this.controller.videoInfo().duration:-1}get time(){return this._time}get loopCount(){return this._loopCount}set loopCount(t){var e;this._loopCount=t,this.reset(),this.isRunTime&&(null===(e=this.scene)||void 0===e||e.assetManager.setCustomAssetsProperty(this.uuid,"loopCount",t))}get videoAsset(){return this._videoAsset}set videoAsset(t){var e;t&&t instanceof APJS.VideoAsset&&(this._videoAsset=t,this.reset(),this.isRunTime?null===(e=this.scene)||void 0===e||e.assetManager.setCustomAssetsProperty(this.uuid,"videoAsset",t):t.controller&&(this.controller=t.controller))}get controller(){return this._controller}set controller(t){t&&t instanceof APJS.VideoController&&(this._controller=t,this.reset())}init(){var t;this.videoAsset&&!0!==this._initilized&&(this.videoAsset.initController(),this.controller=null===(t=this.videoAsset)||void 0===t?void 0:t.controller,this._initilized=!0)}reset(){this._curLoopIndex=0,this._time=0,this._isPlaying=!0}onStart(){this.isRunTime&&this.init(),this.reset(),this._cacheOnStart(),this.controller&&(this.controller.scene=this.scene)}_cacheOnStart(){this._cacheOnStartProperties.loopCount=this._loopCount}_resetOnStart(){this._loopCount=this._cacheOnStartProperties.loopCount}playFromStart(){this.reset(),this._isPlaying=!0}pause(){this._isPlaying=!1,this.onPauseEvent()}resume(){this._isPlaying=!0,this.onResumeEvent()}stop(){this.reset(),this._isPlaying=!1,this.seekFrameAndApplyTexture(0),this.onStopEvent()}openSeekMode(){this._isSeekMode=!0}closeSeekMode(){this._isSeekMode=!1}seekTime(t){this._time=Math.max(0,1e6*t),0===this.loopCount?this._time=0:this.loopCount>0&&this._time>=this.duration*this.loopCount&&(this._time=this.duration),this._time>this.duration&&(this._time=this._time%this.duration),this.seekFrameAndApplyTexture(this._time)}onPlayBeginEvent(){if(0===this._time&&0===this._curLoopIndex&&this._eventCb.has(MP4Event.MP4_PLAY_BEGIN)){Array.from(this._eventCb.get(MP4Event.MP4_PLAY_BEGIN).values()).forEach((t=>t()))}}onPauseEvent(){if(this._eventCb.has(MP4Event.MP4_PAUSE)){Array.from(this._eventCb.get(MP4Event.MP4_PAUSE).values()).forEach((t=>t()))}}onResumeEvent(){if(this._eventCb.has(MP4Event.MP4_RESUME)){Array.from(this._eventCb.get(MP4Event.MP4_RESUME).values()).forEach((t=>t()))}}onPlayEndEvent(){if(this._eventCb.has(MP4Event.MP4_PLAY_END)){Array.from(this._eventCb.get(MP4Event.MP4_PLAY_END).values()).forEach((t=>t()))}}onKeySecondEvent(t,e){if(this._eventCb.has(MP4Event.MP4_KEY_SEC)){Array.from(this._eventCb.get(MP4Event.MP4_KEY_SEC).values()).forEach((i=>i(t,e)))}}onStopEvent(){if(this._eventCb.has(MP4Event.MP4_STOP)){Array.from(this._eventCb.get(MP4Event.MP4_STOP).values()).forEach((t=>t()))}}registerEventCB(t,e,i){this._eventCb.has(t)||this._eventCb.set(t,new Map),this._eventCb.get(t).set(e,i.bind(e))}unregisterEventCB(t,e){var i;null===(i=this._eventCb.get(t))||void 0===i||i.delete(e)}loopCompleted(){return-1!==this.loopCount&&this._curLoopIndex>=this.loopCount}loopAndSeek(t){this._time+=1e6*t,this._time>this.duration&&(this._time=0,this._curLoopIndex+=1,this.loopCompleted())?this.onPlayEndEvent():this.seekFrameAndApplyTexture(this._time)}seekFrameAndApplyTexture(t){const e=this.controller.seekFrame(this._time);if(null==e)return;const i=this.mainObject.getControl();i&&(i.internalTexture=e)}getPts(){const t=APJS.AmazingManager.getSingleton("Input");let e=0;return t&&(e=t.getFrameTimestamp()),e}loopAndSeekEdit(t){this._time=1e6*t,this._time<=0&&(this._time=0),this.loopCount>0&&this._time>=this.duration*this.loopCount&&(this._time=this.duration,this._hasTriggerEnd||(this._hasTriggerEnd=!0,this.onPlayEndEvent())),this._time>this.duration&&(this._time=this._time%this.duration),this.seekFrameAndApplyTexture(this._time)}onUpdateEdit(t){var e;if(0===this.loopCount&&this.loopAndSeekEdit(0),!this.controller||!this._isPlaying)return;const i=this._time;if(this._hasTriggerBegin||(this._hasTriggerBegin=!0,this.onPlayBeginEvent()),this.isRunTime){const t=(null===(e=this.scene)||void 0===e?void 0:e.assetManager.getAllCustomAssetsProperty()).get(this.uuid).get("loopCount");t!==this.loopCount&&(this.loopCount=t,this.reset())}this.loopAndSeekEdit(this.getPts()),this.onKeySecondEvent(i/1e6,this._time/1e6)}onUpdate(t){var e;if(this._isVeEdit&&this._handleVEEdit)return void this.onUpdateEdit(t);if(this._isSeekMode)return;if(0===this.loopCount&&this.loopAndSeek(0),!this.controller||this.loopCompleted()||!this._isPlaying)return;const i=this._time;if(this.onPlayBeginEvent(),this.isRunTime){const t=(null===(e=this.scene)||void 0===e?void 0:e.assetManager.getAllCustomAssetsProperty()).get(this.uuid).get("loopCount");t!==this.loopCount&&(this.loopCount=t,this.reset())}this.loopAndSeek(t),this.onKeySecondEvent(i/1e6,this._time/1e6)}onEvent(t){this._handleReset(t)}_handleReset(t){if(t.type!==APJS.AppEventType.COMPAT_BEF||t.args.length<2)return;const e=t.args[0],i=t.args[1];if(e===APJS.BEFEventType.BET_RECORD_VIDEO&&1===i&&void 0!==this.scene.getSettings){if(!0!==this.scene.getSettings().get("auto_reset_effect"))return void console.log("reset:","auto_reset is closed.");console.log("reset:","auto_reset is opened."),this.reset(),this._resetOnStart()}}instantiate(){const t=new JSAssetMP4Script;if(Object.assign(t,this),t._instantiatedObjectsNum=0,t.mainObject=void 0,void 0!==this._videoAsset){const e=new APJS.VideoAsset;e.getNative().assetMgr=this._videoAsset.getNative().assetMgr,e.loadConfig=this._videoAsset.loadConfig,e.processMaterials=this._videoAsset.processMaterials,e.settings=this._videoAsset.settings,t._videoAsset=e,t._controller=e.controller}return t.onStart(),this._instantiatedObjectsNum=this._instantiatedObjectsNum+1,t}}exports.JSAssetMP4Script=JSAssetMP4Script;