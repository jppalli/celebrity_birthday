"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var n=Object.getOwnPropertyDescriptor(t,s);n&&!("get"in n?!t.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,n)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetAnimSequenceScript=exports.PlayMode=void 0;const JSAssetScriptBase_1=require("./JSAssetScriptBase"),APJS=require('amazingpro.js');var PlayMode;!function(e){e[e.Forward=0]="Forward",e[e.PingPong=1]="PingPong",e[e.Randomize=2]="Randomize",e[e.Shuffle=3]="Shuffle"}(PlayMode=exports.PlayMode||(exports.PlayMode={}));class JSAssetAnimSequenceScript extends JSAssetScriptBase_1.JSAssetScriptBase{set editTimeShouldPlay(e){this._editTimeShouldPlay=e}constructor(){super(),this._reverse=!1,this._playMode=0,this._loopCount=-1,this._fps=12,this._duration=0,this._frameCount=0,this._isPlaying=!1,this._curLoopIndex=0,this._epsilon=1e-6,this._localTime=0,this._isInited=!1,this._frameIndex=0,this._startIndex=0,this._endIndex=-1,this._frameIndexArray=new Array,this._curAtlasIndex=-1,this._prevAtlasIndex=-1,this._atlasesArray=new Array,this._currAtlasOffset=0,this._nativeFrameIndexArray=new APJS.UInt32Vector,this._playingFrameCount=0,this._playingDuration=0,this._editTimeShouldPlay=!0,this._prevFrameArrayIndex=-1,this._cacheOnStart={},this._isEnding=!1,this._ptsStart=-1,this._handleVEEdit=!1,this._isVeEdit=!1,this._frameDebug=0,this._nodeEndPts=0,this.fps=12,this.loopCount=-1,this._handleVEEdit=!0;const e=APJS.AmazingManager.getSingleton("BuiltinObject");if(this._handleVEEdit&&e){const t=e.getUserStringValue("effect_ab_license");this._isVeEdit="ve_edit"===t||"ve_edit_temp"===t,console.log("[VEEdit] effectABLicence:"+t+" isEditorEnv:"+this.isEditorEnv())}this.canBeRemovedDynamically=!0}get reverse(){return this._reverse}set reverse(e){var t;this._reverse=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"reverse",e))}get playMode(){return this._playMode}set playMode(e){var t;this._playMode=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"playMode",e))}get loopCount(){return this._loopCount}set loopCount(e){var t;this._loopCount=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"loopCount",e))}get textureSequence(){return this._seq}set textureSequence(e){var t;e&&e instanceof APJS.TextureSequence&&(this._seq=e,this.frameCount=e.getFrameCount(),this.reset(),this.isRunTime?null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"textureSequence",e):console.error("[AnimSequence]: Invalid TextureSequence!"))}get fps(){return this._fps}set fps(e){var t;if(e>0&&this.fps!==e){if(this._fps=e,this._frameCount){const e=this._frameCount/this._fps;this.duration=e}this._playingFrameCount&&(this._playingDuration=this._playingFrameCount/this.fps),this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"fps",e))}}get duration(){return this._duration}set duration(e){var t;if(e>0&&this.duration!==e){if(this._duration=e,this._frameCount){const e=Math.round(this._frameCount/this._duration);this.fps=e}this._playingFrameCount&&(this._playingDuration=this._playingFrameCount/this.fps),this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"duration",e))}}get frameCount(){return this._frameCount}set frameCount(e){this._frameCount=e,this._fps&&(this._duration=this._frameCount/this._fps)}get frameIndex(){return this._frameIndex}resetAnim(){this.reset()}playFromTo(e,t,s){this._fps&&(this.reset(),e=(e=e>=0?e:0)<this._frameCount?e:this._frameCount-1,t=(t=t>=0?t:0)<this._frameCount?t:this._frameCount-1,this._playingFrameCount=Math.max(e,t)-Math.min(e,t)+1,this._playingDuration=this._playingFrameCount/this._fps,this._startIndex=e,this._endIndex=t,this._generateNextTwoLoop())}play(){this._isPlaying=!0}pause(){this._isPlaying=!1,this._doPause()}stop(){var e;this.resetToStart(),this._isPlaying=!1,this._seek(0);const t=this._atlasesArray[0];if(t){const s=null===(e=this.scene)||void 0===e?void 0:e.assetManager;if(s){const e=t.getOrLoadTexture(s);this._copyImage(e,this.mainObject)}}}resume(){this._isPlaying=!0,this._doResume()}init(){this.reset()}reset(){const e=this.textureSequence;if(e){if(this._atlasesArray=new Array,e.atlases){if(0===e.atlases.size())return void(this._isPlaying=!1);for(let t=0;t<e.atlases.size();t++)this._atlasesArray.push(e.atlases.get(t))}this._startIndex=0,this._endIndex=this._frameCount-1,this._localTime=0,this._isInited=!1,this._frameIndex=0,this._frameIndexArray=new Array,this._prevAtlasIndex=-1,this._currAtlasOffset=0,this._curLoopIndex=0,this._isPlaying=!0,this._playingFrameCount=this._frameCount,this._playingDuration=this._duration,this._generateNextTwoLoop()}else this._isPlaying=!1}_playFromBegining(){this._localTime=0,this._isInited=!1,this._frameIndex=0,this._frameIndexArray=new Array,this._prevAtlasIndex=-1,this._currAtlasOffset=0,this._curLoopIndex=0,this._generateNextTwoLoop()}onStart(){var e;const t=this._isPlaying,s=this._startIndex,i=this._endIndex,n=this._playingFrameCount,a=this._playingDuration;if(this.reset(),this._isPlaying=t,this._startIndex=s,this._endIndex=i,this._playingFrameCount=n,this._playingDuration=a,this._atlasesArray.length>0){const t=this._atlasesArray[0],s=null===(e=this.scene)||void 0===e?void 0:e.assetManager;if(s){const e=t.getOrLoadTexture(s);this._copyImage(e,this.mainObject)}}this._cacheOnStartStatus()}_cacheOnStartStatus(){this._cacheOnStart.isPlaying=this._isPlaying,this._cacheOnStart.startIndex=this._startIndex,this._cacheOnStart.endIndex=this._endIndex,this._cacheOnStart.playingFrameCount=this._playingFrameCount,this._cacheOnStart.playingDuration=this._playingDuration}resetToStart(){this._localTime=0,this._isInited=!1,this._frameIndex=0,this._prevAtlasIndex=-1,this._currAtlasOffset=0,this._curLoopIndex=0,this._isPlaying=this._cacheOnStart.isPlaying,this._startIndex=this._cacheOnStart.startIndex,this._endIndex=this._cacheOnStart.endIndex,this._playingFrameCount=this._cacheOnStart.playingFrameCount,this._playingDuration=this._cacheOnStart.playingDuration,this._generateNextTwoLoop()}getPts(){const e=APJS.AmazingManager.getSingleton("Input");let t=0;return e&&(t=e.getFrameTimestamp()),t}onUpdate(e){var t,s;if(this.isRunTime){const e=(null===(t=this.scene)||void 0===t?void 0:t.assetManager.getAllCustomAssetsProperty()).get(this.uuid);this.duration=e.get("duration"),this.fps=e.get("fps"),this.reverse=e.get("reverse");const s=e.get("playMode"),i=e.get("loopCount");s===this.playMode&&i===this.loopCount||(this.playMode=s,this.loopCount=i,this._playFromBegining())}else if(!this._editTimeShouldPlay)return;if(this._isInited||(this._isInited=!0,e=0),this.mainObject&&this._seq&&this._isPlaying&&0!==this.loopCount&&this.scene&&(this._handleVEEdit&&this._isVeEdit?this._updateLocaltimeAndIndexEditor(e):this._updateLocaltimeAndIndex(e),this._seek(this._frameIndex),this._curAtlasIndex!==this._prevAtlasIndex)){const e=this._atlasesArray[this._curAtlasIndex];if(e){const t=null===(s=this.scene)||void 0===s?void 0:s.assetManager;if(t){const s=e.getOrLoadTexture(t);0===this._currAtlasOffset&&(this._copyImage(s,this.mainObject),e.clearTexture())}else console.error("Wrong AnimSeq assetMgr!")}}}clearTextures(){var e;for(let t=0;t<this._atlasesArray.length;t++)null===(e=this._atlasesArray[t])||void 0===e||e.clearTexture()}onEvent(e){this._handleReset(e)}_handleReset(e){if(e.type!==APJS.AppEventType.COMPAT_BEF||e.args.length<2)return;const t=e.args[0],s=e.args[1];if(t===APJS.BEFEventType.BET_RECORD_VIDEO&&1===s&&void 0!==this.scene.getSettings){if(!0!==this.scene.getSettings().get("auto_reset_effect"))return void console.log("reset:","auto_reset is closed.");console.log("reset:","auto_reset is opened."),this._recordReset()}}_recordReset(){var e;this.resetToStart(),this._seek(0);const t=this._atlasesArray[this._curAtlasIndex];if(t&&this._seq){const s=null===(e=this.scene)||void 0===e?void 0:e.assetManager;if(s){const e=t.getOrLoadTexture(s);0===this._currAtlasOffset&&(this._copyImage(e,this.mainObject),this.isEditorEnv()||t.clearTexture())}}}_updateLocaltimeAndIndexEditor(e){if(console.log("[VEEdit] dt:"+e+" pts:"+this.getPts()),this._frameDebug++,this._isPlaying&&Math.abs(this._duration)>this._epsilon&&this._fps>0){-1===this._ptsStart&&(this._ptsStart=this._localTime),this._localTime=this.getPts(),this._localTime<.01&&(console.log("[VEEdit] _doAnimBegin:"),this._doAnimBegin());let e=!1;const t=Math.floor(this._localTime/this._playingDuration);if(t>this._curLoopIndex&&(this._curLoopIndex++,(t<this.loopCount||this.loopCount<0)&&(this._generateNextTwoLoop(),console.log("[VEEdit] _generateNextTwoLoop:"),e=!0)),this.loopCount>0&&this._localTime>this._duration*this.loopCount){const e=this.reverse?0:this._playingFrameCount-1;return this._frameIndex=this._frameIndexArray[e],this._nodeEndPts=this._duration*this.loopCount,this._isEnding||(this._isEnding=!0,this._doAnimEnd(),console.log("[VEEdit] _doAnimEnd:"+this._nodeEndPts+" "+this._frameIndex+" "+e)),void console.log("[VEEdit] at end:"+this._frameIndex)}let s=0;const i=this._fmod(this._localTime,this._playingDuration);if(s=Math.floor(this._playingFrameCount*(i/this._playingDuration)),this.reverse&&(s=this._playingFrameCount-s-1),(s>=this._playingFrameCount||s<0)&&(s=s<0?0:this._playingFrameCount-1),this._frameIndex=this._frameIndexArray[s],e&&this._doLoopBegin(),s>this._prevFrameArrayIndex){if(s-this._prevFrameArrayIndex>1)for(let e=this._prevFrameArrayIndex+1;e<s;e++)this._doKeyFrame(this._frameIndexArray[e]);this._doKeyFrame(this._frameIndexArray[s])}else if(s<this._prevFrameArrayIndex){if(s>0)for(let e=0;e<s;e++)this._doKeyFrame(this._frameIndexArray[e]);this._doKeyFrame(this._frameIndexArray[s])}this._prevFrameArrayIndex=s;Math.floor((this._localTime+.01)/this._duration)>t&&(this._doLoopEnd(),console.log("[VEEdit] _doLoopEnd:"))}console.log("[VEEdit] :"+this._frameIndex)}_updateLocaltimeAndIndex(e){if(this._isPlaying&&Math.abs(this._duration)>this._epsilon&&this._fps>0){0===this._localTime&&this._doAnimBegin(),this._localTime+=e;let t=!1;const s=Math.floor(this._localTime/this._playingDuration);if(s>this._curLoopIndex&&(this._curLoopIndex++,(s<this.loopCount||this.loopCount<0)&&(this._generateNextTwoLoop(),t=!0)),this.loopCount>0&&this._curLoopIndex>=this.loopCount){this._isPlaying=!1;const e=this.reverse?0:this._playingFrameCount-1;return this._frameIndex=this._frameIndexArray[e],void this._doAnimEnd()}let i=0;const n=this._fmod(this._localTime,this._playingDuration);if(i=Math.floor(this._playingFrameCount*(n/this._playingDuration)),this.reverse&&(i=this._playingFrameCount-i-1),(i>=this._playingFrameCount||i<0)&&(i=i<0?0:this._playingFrameCount-1),this._frameIndex=this._frameIndexArray[i],t&&this._doLoopBegin(),i>this._prevFrameArrayIndex){if(i-this._prevFrameArrayIndex>1)for(let e=this._prevFrameArrayIndex+1;e<i;e++)this._doKeyFrame(this._frameIndexArray[e]);this._doKeyFrame(this._frameIndexArray[i])}else if(i<this._prevFrameArrayIndex){if(i>0)for(let e=0;e<i;e++)this._doKeyFrame(this._frameIndexArray[e]);this._doKeyFrame(this._frameIndexArray[i])}this._prevFrameArrayIndex=i;Math.floor((this._localTime+e)/this._duration)>s&&this._doLoopEnd()}}_generateNextTwoLoop(){var e;if(this._nativeFrameIndexArray.clear(),0===this._frameIndexArray.length||0===this._curLoopIndex||1===this._curLoopIndex&&0!==this.playMode?(this._frameIndexArray.splice(0,this._frameIndexArray.length),this._generateNextLoop(this._curLoopIndex),this._generateNextLoop(this._curLoopIndex+1)):(this._frameIndexArray.splice(0,this._playingFrameCount),this._generateNextLoop(this._curLoopIndex+1)),this.isRunTime){const t=APJS.AmazingUtil.arrayToUInt32Vector(this._frameIndexArray);null===(e=this.textureSequence)||void 0===e||e.updateLoop(t)}}_generateNextLoop(e){switch(this.playMode){case PlayMode.Forward:if(this._startIndex<=this._endIndex)for(let e=this._startIndex;e<=this._endIndex;e++)this._frameIndexArray.push(e);else for(let e=this._startIndex;e>=this._endIndex;e--)this._frameIndexArray.push(e);break;case PlayMode.PingPong:if(this._startIndex<=this._endIndex)if(e%2==0)for(let e=this._startIndex;e<=this._endIndex;e++)this._frameIndexArray.push(e);else for(let e=this._endIndex;e>=this._startIndex;e--)this._frameIndexArray.push(e);else if(e%2==0)for(let e=this._startIndex;e>=this._endIndex;e--)this._frameIndexArray.push(e);else for(let e=this._endIndex;e<=this._startIndex;e++)this._frameIndexArray.push(e);break;case PlayMode.Randomize:{const e=this._seq.getRandomIndexs(this._startIndex,this._endIndex);for(let t=0;t<e.size();t++)this._frameIndexArray.push(e.get(t));break}case PlayMode.Shuffle:{const e=this._seq.getShuffleIndexs(this._startIndex,this._endIndex);for(let t=0;t<e.size();t++)this._frameIndexArray.push(e.get(t));break}}}_fmod(e,t){return Number((e-Math.floor(e/t)*t).toPrecision(8))}_copyImage(e,t){e&&t&&e!==t&&APJS.TextureUtils.copyTextureImage(e,t)}_seek(e){var t;this._prevAtlasIndex=this._curAtlasIndex,this._frameIndex=e,this._curAtlasIndex=this._frameIndex,!this.isEditorEnv()&&this.scene&&(null===(t=this._seq)||void 0===t||t.preloadTex(this._curAtlasIndex,this.scene.assetManager))}onPropertyValueChanged(e,t){"playMode"!==e&&"loopCount"!==e&&"textureSequence"!==e||this.reset()}_doAnimBegin(){const e=new APJS.AnimSequenceEventInfo,t=this.mainObject;e.eventType=APJS.AnimSequenceEventType.ANIMSEQ_PLAY_BEGIN,e.frameIndex=this._frameIndex,e.eventName="AnimSeq play begin",e.animSeq=t;const s=APJS.EventManager.createEvent(e.eventType);s.args=[e],APJS.EventManager.getObjectEmitter(t).internalEmit(s)}_doAnimEnd(){const e=new APJS.AnimSequenceEventInfo,t=this.mainObject;e.eventType=APJS.AnimSequenceEventType.ANIMSEQ_PLAY_END,e.frameIndex=this._frameIndex,e.eventName="AnimSeq play end",e.animSeq=t;const s=APJS.EventManager.createEvent(e.eventType);s.args=[e],APJS.EventManager.getObjectEmitter(t).internalEmit(s)}_doLoopBegin(){const e=new APJS.AnimSequenceEventInfo,t=this.mainObject;e.eventType=APJS.AnimSequenceEventType.ANIMSEQ_LOOP_BEGIN,e.frameIndex=this._frameIndex,e.eventName="AnimSeq loop begin",e.animSeq=t;const s=APJS.EventManager.createEvent(e.eventType);s.args=[e],APJS.EventManager.getObjectEmitter(t).internalEmit(s)}_doLoopEnd(){const e=new APJS.AnimSequenceEventInfo,t=this.mainObject;e.eventType=APJS.AnimSequenceEventType.ANIMSEQ_LOOP_END,e.frameIndex=this._frameIndex,e.eventName="AnimSeq loop end",e.animSeq=t;const s=APJS.EventManager.createEvent(e.eventType);s.args=[e],APJS.EventManager.getObjectEmitter(t).internalEmit(s)}_doPause(){const e=new APJS.AnimSequenceEventInfo,t=this.mainObject;e.eventType=APJS.AnimSequenceEventType.ANIMSEQ_PAUSE,e.frameIndex=this._frameIndex,e.eventName="AnimSeq pause",e.animSeq=t;const s=APJS.EventManager.createEvent(e.eventType);s.args=[e],APJS.EventManager.getObjectEmitter(t).internalEmit(s)}_doResume(){const e=new APJS.AnimSequenceEventInfo,t=this.mainObject;e.eventType=APJS.AnimSequenceEventType.ANIMSEQ_RESUME,e.frameIndex=this._frameIndex,e.eventName="AnimSeq resume",e.animSeq=t;const s=APJS.EventManager.createEvent(APJS.AnimSequenceEventType.ANIMSEQ_RESUME);s.args=[e],APJS.EventManager.getObjectEmitter(t).internalEmit(s)}_doKeyFrame(e){const t=new APJS.AnimSequenceEventInfo,s=this.mainObject;t.eventType=APJS.AnimSequenceEventType.ANIMSEQ_KEY_FRAME,t.frameIndex=e,t.eventName="AnimSeq key frame",t.animSeq=s;const i=APJS.EventManager.createEvent(t.eventType);i.args=[t],APJS.EventManager.getObjectEmitter(s).internalEmit(i)}instantiate(){const e=new JSAssetAnimSequenceScript;if(Object.assign(e,this),e._instantiatedObjectsNum=0,e.mainObject=void 0,void 0!==this._seq){const t=new APJS.Vector;for(let e=0;e<this._seq.atlases.size();e++){const s=new APJS.ImageAtlas,i=new APJS.Vector;i.pushBack(new APJS.ImageFrame),s.frames=i,s.uri=this._seq.atlases.get(e).uri,t.pushBack(s)}const s=new APJS.TextureSequence;s.getNative().assetMgr=this._seq.getNative().assetMgr,s.lazyload=!0,s.cache=!1,s.name=this._seq.name,s.atlases=t,s.onLoadEnd(),e.textureSequence=s}return e.onStart(),this._instantiatedObjectsNum=this._instantiatedObjectsNum+1,e}onDestroy(){this._atlasesArray=new Array}}exports.JSAssetAnimSequenceScript=JSAssetAnimSequenceScript;