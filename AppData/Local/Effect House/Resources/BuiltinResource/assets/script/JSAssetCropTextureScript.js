"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var s=Object.getOwnPropertyDescriptor(t,r);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,s)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&__createBinding(t,e,r);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetCropTextureScript=void 0;const JSAssetScriptBase_1=require("./JSAssetScriptBase"),APJS=require('amazingpro.js'),inputConfig=new APJS.AlgorithmInputConfig;class JSAssetCropTextureScript extends JSAssetScriptBase_1.JSAssetScriptBase{constructor(){super(),this._graphName="",this._isFirstFrame=!0,this._faceIds=0,this._faceCenter=0,this._faceCrop=!1,this._cropZone=new APJS.Rect(-1,1,-1,1),this._rotation=0,this._flipRT=void 0,this._scale=new APJS.Vector2f(1,1),this._texture=void 0,this._useDefaultCameraInput=!0,this._cropTextureIndex=0,this._captureOrder=1e5,this.faceScale=new APJS.Vector2f(1,1),this.imageCenter=new APJS.Vector2f(.5,.5),this.cmdBuffer=new APJS.CommandBuffer,this.ratio=0}get cropTextureIndex(){return this._cropTextureIndex}set cropTextureIndex(e){this._cropTextureIndex=e}get graphName(){return this._graphName}set graphName(e){var t;this._graphName=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"graphName",e))}get scale(){return this._scale}set scale(e){this._scale=e}get faceIds(){return this._faceIds}set faceIds(e){this._faceIds=e}get faceCenter(){return this._faceCenter}set faceCenter(e){this._faceCenter=e}get faceCrop(){return this._faceCrop}set faceCrop(e){this._faceCrop=e}get cropZone(){return this._cropZone}set cropZone(e){this._cropZone=e}get rotation(){return this._rotation}set rotation(e){this._rotation=e}get uvTransformMat(){return this._uvTransformMat}set uvTransformMat(e){this._uvTransformMat=e}get flipMat(){return this._flipMat}set flipMat(e){this._flipMat=e}get flipRT(){return this._flipRT}set flipRT(e){this._flipRT=e}get texture(){return this._texture}set texture(e){e!==this._mainObject&&e&&(this._texture=e)}get useDefaultCameraInput(){return this._useDefaultCameraInput}set useDefaultCameraInput(e){void 0!==e&&(this._useDefaultCameraInput=e)}get captureOrder(){return this._captureOrder}set captureOrder(e){this._captureOrder=e}createRenderTexture(e,t,r){const i=new APJS.RenderTextureCreateDesc;return i.name=e,i.builtinType=APJS.BuiltInTextureType.NORAML,i.internalFormat=APJS.InternalFormat.RGBA8,i.dataType=APJS.DataType.U8norm,i.depth=1,i.attachment=APJS.RenderTextureAttachment.DEPTH24,i.filterMag=APJS.FilterMode.Linear,i.filterMin=APJS.FilterMode.Linear,i.filterMipmap=APJS.FilterMipmapMode.None,i.width=t,i.height=r,i.colorFormat=APJS.PixelFormat.RGBA8Unorm,APJS.TextureUtils.createRenderTexture(i)}dynamicSetAlgorithmEnable(e,t){t?APJS.AlgorithmManager.enableGraphNodes(this.graphName,e,!0):(APJS.AlgorithmManager.enableGraphNodes(this.graphName,e,!1),APJS.AlgorithmManager.setInputTexture(this.cropTextureIndex,null,null))}onStart(){var e,t,r;this.mainObject||(this.mainObject=this.createRenderTexture("CropTexture",360,360)),null===(e=this.cmdBuffer)||void 0===e||e.clearAll(),null===(t=this.cmdBuffer)||void 0===t||t.setRenderTexture(this.mainObject),null===(r=this.cmdBuffer)||void 0===r||r.clearRenderTexture(!0,!0,new APJS.Color(0,0,0,0),1),this.scene.commitCommandBuffer(this.cmdBuffer)}onUpdate(e){var t,r,i,s,a,n,o;if(this.isRunTime&&this.texture){const e=this.texture.getWidth(),h=this.texture.getHeight();if(!0===this._isFirstFrame&&(this.useDefaultCameraInput?this.dynamicSetAlgorithmEnable(["blit_0","face_0"],!0):(this.dynamicSetAlgorithmEnable(["blit_"+this.cropTextureIndex,"face_"+this.cropTextureIndex],!0),inputConfig.dirty=!0,inputConfig.scaleX=e,inputConfig.scaleY=h,this.flipRT||(this.flipRT=this.createRenderTexture("FlipRT",e,h))),this._isFirstFrame=!1),this.uvTransformMat){const u=APJS.AlgorithmManager.getResult(),c=new APJS.Vector2f(Math.max((this.cropZone.y-this.cropZone.x)/2,0),Math.max((this.cropZone.height-this.cropZone.width)/2,0));if(u&&this.faceCrop){let t;if(t=this.useDefaultCameraInput?APJS.AlgorithmManager.getGraphNode(this.graphName,"face_0").getInfo(0):APJS.AlgorithmManager.getGraphNode(this.graphName,"face_"+this.cropTextureIndex).getInfo(0),t){const r=t.getFaceCount();if(this.faceIds<r){const r=t.getFaceBaseInfo(this.faceIds);if(r){const t=r.pointsArray,i=t[86],s=t[87],a=t[196],n=t[197],o=(t[32],t[33]);this.faceScale.x=1.5*(s-o)*this.scale.x*h/e,this.faceScale.y=2*(s-o)*this.scale.y,this.imageCenter.x=(1-this.faceCenter)*i+this.faceCenter*a,this.imageCenter.y=(1-this.faceCenter)*s+this.faceCenter*n}else console.log("face base info is none")}else console.log("faceIds is bigger than faceCount")}else console.log("face key point is none")}else console.log("alg result is none");if(c.x=c.x*this.faceScale.x,c.y=c.y*this.faceScale.y,Math.abs(c.x)<1e-6||Math.abs(c.y)<1e-6)return null===(t=this.cmdBuffer)||void 0===t||t.clearAll(),null===(r=this.cmdBuffer)||void 0===r||r.setRenderTexture(this.mainObject),null===(i=this.cmdBuffer)||void 0===i||i.clearRenderTexture(!0,!0,new APJS.Color(0,0,0,0),1),void this.scene.commitCommandBuffer(this.cmdBuffer);const f=Math.floor(e*c.x)/Math.floor(h*c.y);Math.abs(f-this.ratio)>.01&&(this.mainObject.getControl().setWidth(Math.floor(e)),this.mainObject.getControl().setHeight(Math.floor(h*c.y/c.x)),this.ratio=f),this.uvTransformMat.setVec2("u_imageCenter",this.imageCenter);const l=new APJS.Vector2f((this.cropZone.x+this.cropZone.y)/4,(this.cropZone.width+this.cropZone.height)/4);this.uvTransformMat.setVec2("u_offset",l),this.uvTransformMat.setFloat("u_width",e),this.uvTransformMat.setFloat("u_height",h),this.uvTransformMat.setVec2("u_scale",c);const p=this.rotation/57.295779513082;this.uvTransformMat.setFloat("u_angle",p),this.uvTransformMat.setVec2("u_faceScale",this.faceScale),null===(s=this.cmdBuffer)||void 0===s||s.clearAll(),this.mainObject&&(null===(a=this.cmdBuffer)||void 0===a||a.setRenderTexture(this.mainObject),this.flipMat&&!this.useDefaultCameraInput&&this.faceCrop&&(null===(n=this.cmdBuffer)||void 0===n||n.blitWithMaterial(this.texture,this.flipRT,this.flipMat,0,!1)),null===(o=this.cmdBuffer)||void 0===o||o.blitWithMaterial(this.texture,this.mainObject,this.uvTransformMat,0,!1),this.scene.commitCommandBuffer(this.cmdBuffer),this.flipMat&&!this.useDefaultCameraInput&&this.faceCrop&&(inputConfig.dirty=!0,inputConfig.scaleX=e,inputConfig.scaleY=h,APJS.AlgorithmManager.setInputTexture(this.cropTextureIndex,this.flipRT,inputConfig)))}}}onDestroy(){this.uvTransformMat&&(this.uvTransformMat=void 0),this.flipMat&&(this.flipMat=void 0),this.flipRT&&(this.flipRT=void 0),this.cmdBuffer&&(this.cmdBuffer=void 0),this.useDefaultCameraInput?this.dynamicSetAlgorithmEnable(["blit_0","face_0"],!1):this.dynamicSetAlgorithmEnable(["blit_"+this.cropTextureIndex,"face_"+this.cropTextureIndex],!1)}}exports.JSAssetCropTextureScript=JSAssetCropTextureScript;