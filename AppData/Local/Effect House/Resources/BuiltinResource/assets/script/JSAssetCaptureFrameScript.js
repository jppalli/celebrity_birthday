"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetCaptureFrameScript=void 0;const JSAssetScriptBase_1=require("./JSAssetScriptBase"),APJS=require('amazingpro.js'),screenVs="\nprecision highp float;\n\nattribute vec3 inPosition;\nattribute vec2 inTexCoord;\n\nvarying vec2 v_TexCoord;\n\nuniform mat4 u_Model;\n\nvoid main() {\n  v_TexCoord = inTexCoord;\n  gl_Position = u_Model * vec4(inPosition, 1.0);\n}\n",screenFs="\nprecision highp float;\n\nvarying vec2 v_TexCoord;\n\nuniform sampler2D u_CameraTex;\n\nvoid main() {\n  gl_FragColor = texture2D(u_CameraTex, v_TexCoord);\n}\n",screenMetalVs="\n#include <metal_stdlib>\n#include <simd/simd.h>\n\nusing namespace metal;\n\nstruct buffer_t\n{\n    float4x4 u_Model;\n};\n\nstruct main0_out\n{\n    float2 v_TexCoord;\n    float4 gl_Position [[position]];\n};\n\nstruct main0_in\n{\n    float3 inPosition [[attribute(0)]];\n    float2 inTexCoord [[attribute(1)]];\n};\n\nvertex main0_out main0(main0_in in [[stage_in]], constant buffer_t& buffer)\n{\n    main0_out out = {};\n    out.v_TexCoord = in.inTexCoord;\n    out.gl_Position = buffer.u_Model * float4(in.inPosition, 1.0);\n    out.gl_Position.z = (out.gl_Position.z + out.gl_Position.w) * 0.5;       // Adjust clip-space for Metal\n    return out;\n}\n",screenMetalFs="\n#include <metal_stdlib>\n#include <simd/simd.h>\n\nusing namespace metal;\n\nstruct main0_out\n{\n    float4 gl_FragColor [[color(0)]];\n};\n\nstruct main0_in\n{\n    float2 v_TexCoord;\n};\n\nfragment main0_out main0(main0_in in [[stage_in]], texture2d<float> u_CameraTex [[texture(0)]], sampler u_CameraTexSmplr [[sampler(0)]])\n{\n    main0_out out = {};\n    out.gl_FragColor = u_CameraTex.sample(u_CameraTexSmplr, in.v_TexCoord);\n    return out;\n}\n";class JSAssetCaptureFrameScript extends JSAssetScriptBase_1.JSAssetScriptBase{constructor(){super(),this._captureOrder=2010,this._builtin=!0,this._minEffectSDKVersion="14.0.0",this._effectNodeStatus=0,this._effectNode=null}get captureOrder(){return this._captureOrder}set captureOrder(e){this._captureOrder=e}get builtin(){return this._builtin}set builtin(e){this._builtin=e}get minEffectSDKVersion(){return this._minEffectSDKVersion}set minEffectSDKVersion(e){this._minEffectSDKVersion=e}get effectNode(){return this._effectNode}set effectNode(e){if(this._effectNode=e,e&&e instanceof APJS.SceneObject){this._effectNodeStatus=2;const t=e.getComponent("EffectNode");this.captureOrder=t.renderOrder}null===e&&(this._effectNodeStatus=1,this.captureOrder=9001)}get effectNodeStatus(){return this._effectNodeStatus}set effectNodeStatus(e){this._effectNodeStatus=e}get mainObject(){return this._mainObject}set mainObject(e){this._mainObject=e}onStart(){var e;if(!this.mainObject)return;const t=this.mainObject.getControl();t.setDepth(1),t.filterMag=APJS.FilterMode.Linear,t.filterMin=APJS.FilterMode.Linear,t.filterMipmap=APJS.FilterMipmapMode.None,t.setAttachment(APJS.RenderTextureAttachment.NONE);const n=APJS.AmazingManager.getSingleton("BuiltinObject");t.setWidth(n.getInputTextureWidth()),t.setHeight(n.getInputTextureHeight());const i=JSAssetScriptBase_1.RenderingUtil.createShaders({gles2:{vs:screenVs,fs:screenFs},metal:{vs:screenMetalVs,fs:screenMetalFs}});this._sceneOutputRT=null===(e=this.scene)||void 0===e?void 0:e.getOutputRenderTexture(),this._screenMaterial=JSAssetScriptBase_1.RenderingUtil.createScreenMaterial(i),this._sceneOutputRT&&this._screenMaterial.setTex("u_CameraTex",this._sceneOutputRT)}onUpdate(e){var t;if(!(this.mainObject&&this.isRunTime&&this._screenMaterial&&this.cmdBufferHelper&&this.screenMesh))return;const n=null===(t=this.scene)||void 0===t?void 0:t.getOutputRenderTexture();this._sceneOutputRT&&!this._sceneOutputRT.equals(n)&&(this._sceneOutputRT=n,this._screenMaterial.setTex("u_CameraTex",n));const i=APJS.AmazingManager.getSingleton("BuiltinObject"),r=this.mainObject.getControl();r.setWidth(i.getInputTextureWidth()),r.setHeight(i.getInputTextureHeight()),this.cmdBufferHelper.setRenderTexture(this.mainObject),this.cmdBufferHelper.drawMesh(this.screenMesh,new APJS.Matrix4x4f,this._screenMaterial,0,0,new APJS.MaterialPropertyBlock,!1)}}exports.JSAssetCaptureFrameScript=JSAssetCaptureFrameScript;