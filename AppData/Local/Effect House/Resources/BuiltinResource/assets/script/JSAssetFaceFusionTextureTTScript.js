"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,i)}:function(e,t,s,r){void 0===r&&(r=s),e[r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t};Object.defineProperty(exports,"__esModule",{value:!0}),exports.JSAssetFaceFusionTextureTTScript=void 0;const JSAssetServerAlgoScriptBase_1=require("./JSAssetServerAlgoScriptBase"),APJS=require('amazingpro.js'),nodeName="nh_script_0",inputConfig=new APJS.AlgorithmInputConfig,face295MeshIndexData=[98,92,93,92,98,97,0,204,190,204,0,205,190,204,231,122,137,136,137,122,123,2,205,1,205,2,3,0,1,205,1,0,193,118,132,117,132,118,133,2,1,232,142,126,127,126,142,141,205,3,206,3,2,243,279,161,286,161,279,248,206,3,4,4,3,243,131,116,117,116,131,178,206,4,5,5,4,246,119,133,118,133,119,134,206,5,207,5,6,207,6,5,250,117,132,131,6,7,207,7,6,250,132,147,146,147,132,133,207,7,208,7,8,208,8,7,251,134,119,120,208,8,9,9,8,277,245,249,250,249,245,244,208,9,10,10,9,286,128,275,129,275,128,127,209,10,11,10,209,208,11,10,286,279,247,248,247,279,249,209,11,12,12,11,287,269,265,270,265,269,264,209,12,210,12,13,210,13,12,287,245,241,244,241,245,242,210,13,14,14,13,288,36,43,41,43,36,35,211,14,15,14,211,210,15,14,288,36,41,40,212,15,16,15,212,211,16,15,289,213,17,18,17,213,212,17,212,16,17,16,289,214,18,19,18,214,213,18,17,290,36,42,35,42,36,37,214,19,20,19,18,290,244,240,44,240,244,241,20,19,291,264,260,261,260,264,45,214,20,215,20,21,215,21,20,291,43,35,259,21,22,215,22,21,292,35,42,239,215,22,216,22,23,216,23,22,292,64,234,65,234,64,235,23,24,216,24,23,278,86,254,255,254,86,87,216,24,25,25,24,271,67,233,46,233,67,66,216,25,217,25,26,217,26,25,270,253,89,68,89,253,88,217,26,27,27,26,270,64,50,63,50,64,49,217,27,218,27,28,218,28,27,266,72,86,85,86,72,71,28,29,218,29,28,263,253,68,194,218,29,219,29,30,219,30,29,263,46,233,193,30,31,219,31,30,252,83,75,74,75,83,82,31,32,219,32,31,194,114,74,75,74,114,113,55,59,54,59,55,56,256,82,83,82,256,257,60,236,61,236,60,237,33,34,191,34,33,192,179,145,130,145,179,160,249,279,251,34,35,239,35,34,259,139,124,140,124,139,123,273,117,247,117,273,118,135,121,136,121,135,120,118,273,119,37,36,38,37,247,44,247,37,273,247,116,248,116,247,117,274,272,122,272,274,39,37,38,273,38,36,39,276,124,272,124,276,125,38,39,274,39,36,40,129,267,130,267,129,275,39,40,276,285,267,269,267,285,268,40,41,275,261,265,264,265,261,262,42,238,239,238,42,237,42,37,44,61,236,62,41,43,45,43,258,257,258,43,259,256,83,84,42,44,240,7,250,251,41,45,267,45,43,260,270,25,271,51,62,63,62,51,52,232,1,193,90,193,0,193,90,97,62,52,61,46,47,67,47,46,193,193,97,47,53,61,52,61,53,60,47,48,66,48,47,97,56,58,59,58,56,57,48,49,65,49,48,98,50,49,99,98,48,97,95,101,100,101,95,96,50,51,63,51,50,99,92,97,91,81,77,76,77,81,78,52,51,100,93,99,98,99,93,94,54,59,60,53,52,101,94,100,99,100,94,95,102,55,54,55,102,191,53,54,60,54,53,101,191,102,196,56,55,191,191,34,239,191,238,57,238,191,239,57,56,191,57,238,58,58,237,59,237,58,238,59,237,60,62,235,63,235,62,236,49,64,65,63,235,64,246,243,242,243,246,4,48,65,66,234,243,233,243,234,242,65,234,66,47,66,67,233,66,234,243,2,232,31,252,194,84,73,85,73,84,74,194,103,32,103,194,110,68,69,194,69,68,89,74,84,83,110,194,69,69,70,110,70,69,88,78,80,79,80,78,81,70,71,111,71,70,87,71,72,112,99,49,98,70,111,110,72,73,112,73,72,85,101,52,100,115,76,77,76,115,114,73,74,113,100,51,99,102,101,96,101,102,54,81,76,82,114,75,76,76,75,82,115,77,192,115,192,196,34,192,259,77,78,192,79,258,192,258,79,80,78,79,192,192,258,259,80,257,258,257,80,81,257,81,82,84,255,256,255,84,85,255,85,86,86,71,87,266,263,28,263,266,262,263,254,253,254,263,262,87,70,88,254,87,88,88,69,89,88,253,254,30,263,252,90,0,190,92,189,201,189,92,190,195,102,96,102,195,196,90,91,97,91,90,190,188,201,189,201,188,200,199,108,109,108,199,203,92,91,190,201,199,95,199,201,197,93,92,201,182,203,202,203,182,181,73,113,112,94,93,201,106,203,105,203,106,107,105,110,111,110,105,104,95,94,201,112,106,111,106,112,107,71,112,111,96,95,199,105,111,106,191,196,33,32,103,180,107,113,108,113,107,112,180,103,104,104,103,110,180,104,105,32,180,220,105,203,181,105,181,180,182,202,183,197,203,199,203,197,202,202,198,184,198,202,197,114,108,113,108,114,109,107,108,203,114,115,109,195,96,199,33,196,192,109,115,195,280,286,161,286,280,287,178,131,146,273,38,274,148,163,147,163,148,164,273,120,119,120,273,274,134,149,148,149,134,135,288,287,280,287,288,13,137,152,151,152,137,138,121,120,274,274,122,121,138,123,139,123,138,137,121,122,136,123,272,124,272,123,122,39,276,272,125,140,124,140,125,141,138,153,152,153,138,154,276,275,126,275,276,40,141,156,140,156,141,157,125,126,141,126,125,276,126,275,127,143,128,144,128,143,127,41,267,275,292,175,285,175,292,284,128,129,144,285,175,268,285,269,271,129,130,145,45,269,267,269,45,264,162,147,163,147,162,146,131,132,146,134,120,135,147,133,148,134,148,133,164,281,280,281,164,165,150,135,136,135,150,149,151,136,137,136,151,150,281,167,282,167,281,166,152,168,167,168,152,153,138,139,154,154,139,155,139,140,155,142,127,143,155,140,156,290,282,283,282,290,289,141,142,157,157,142,158,142,143,158,144,129,145,155,170,169,170,155,171,143,144,159,158,143,159,144,145,160,284,174,175,174,284,173,146,162,161,280,162,163,162,280,161,149,164,148,164,149,150,164,150,165,151,165,150,165,151,166,167,151,152,151,167,166,281,282,288,154,168,153,168,154,169,169,154,155,289,290,17,155,156,171,171,156,172,156,157,172,172,283,171,283,172,284,157,158,172,159,144,160,158,159,173,173,159,174,159,160,174,160,175,174,175,160,179,178,146,161,286,287,11,288,280,281,163,164,280,288,282,289,165,166,281,288,289,15,167,168,282,169,283,282,283,169,170,168,169,282,284,290,283,290,284,291,170,171,283,172,158,173,290,291,19,172,173,284,292,291,284,291,292,21,251,279,277,248,116,178,161,248,178,268,175,179,130,268,179,268,130,267,285,271,278,220,180,221,180,181,221,197,201,200,221,181,222,181,182,222,223,182,183,182,223,222,200,198,197,198,200,186,224,183,184,183,224,223,184,183,202,200,187,186,187,200,188,224,184,225,184,185,225,185,184,198,225,185,226,185,186,227,186,185,198,226,185,227,186,187,228,186,228,227,187,188,229,228,187,229,188,189,230,189,190,231,230,189,231,109,195,199,195,115,196,219,32,220,229,188,230,232,193,233,243,232,233,235,242,234,242,235,241,42,240,237,237,240,236,235,236,241,236,240,241,250,5,246,244,44,249,250,246,245,242,245,246,249,44,247,251,250,249,8,251,277,253,194,252,253,252,263,262,255,254,255,262,261,260,43,257,256,255,261,260,257,256,260,256,261,27,270,266,266,270,265,265,262,266,270,271,269,271,24,278,286,9,277,23,292,278,277,279,286,278,292,285];class JSAssetFaceFusionTextureTTScript extends JSAssetServerAlgoScriptBase_1.JSAssetServerAlgoScriptBase{constructor(){super(),this._fusionTexture=void 0,this._morphTime=1.5,this._startMorph=!1,this._keepReal=!1,this._skinMaskTexture=void 0,this.preStartMorph=!1,this.preFusionTexture=void 0,this._graphName="",this.serviceName="faceswap_v2",this.algoConfig={need_crop:!1,template_need_crop:!1},this.region="auto",this._finalOutRT=void 0,this._maskTexture=void 0,this._errorTexture=void 0,this.faceErrorTexure=void 0,this.reqErrorTexure=void 0,this._transparentTexture=void 0,this.fusionBlendTime=3,this._addSkinMat=void 0,this.sColor=0,this.curSkinLutTexture=void 0,this._skinLut0Texture=void 0,this._skinLut1Texture=void 0,this._skinLut2Texture=void 0,this._skinLut3Texture=void 0,this._flipMat=void 0,this._grabMat=void 0,this._ratioBlitMat=void 0,this._resultMat=void 0,this._transitionMat=void 0,this._sprite2DMaterial=void 0,this.logicState="",this.waitFrame=0,this.blendTimer=0,this.progress=0,this.cmdBuffer=new APJS.CommandBuffer,this.ratioCMDBuffer=new APJS.CommandBuffer,this.transparentCMDBuffer=new APJS.CommandBuffer,this.fusionCMDBuffer=new APJS.CommandBuffer,this.maskCMDBuffer=new APJS.CommandBuffer,this.captureCMDBuffer=new APJS.CommandBuffer,this.captureRT=void 0,this.flipCaptureRT=void 0,this.fusionRT=void 0,this.maskRT=void 0,this.resultMeshRenderer=void 0,this.resultMesh=void 0,this.errorSpriteRenderer=void 0,this.oldMaterial=void 0,this.requestID=0,this.requestTimer=0,this.maxTimeout=5,this.hasAlgoResult=!1,this.errorWaitTimer=0,this.maxErrorWaitTime=3,this.camera=void 0,this.maskCamera=void 0,this.width=720,this.height=1280,this._instanceId=0,this._extName=void 0,this._grabing=!1,this._algoSubmitted=!1,this._algoInited=!1,this.identityMat=new APJS.Matrix4x4f,this.scaleMat=new APJS.Matrix4x4f,this.algorithmType="FaceFusionTT",this._extName=".fsjsatt"}get keepReal(){return this._keepReal}set keepReal(e){var t;this._keepReal=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"keepReal",e))}get skinMaskTexture(){return this._skinMaskTexture}set skinMaskTexture(e){var t;e&&(this._skinMaskTexture=e),this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"skinMaskTexture",e))}get skinLut0Texture(){return this._skinLut0Texture}set skinLut0Texture(e){this._skinLut0Texture=e}get skinLut1Texture(){return this._skinLut1Texture}set skinLut1Texture(e){this._skinLut1Texture=e}get skinLut2Texture(){return this._skinLut2Texture}set skinLut2Texture(e){this._skinLut2Texture=e}get skinLut3Texture(){return this._skinLut3Texture}set skinLut3Texture(e){this._skinLut3Texture=e}get addSkinMat(){return this._addSkinMat}set addSkinMat(e){this._addSkinMat=e}get flipMat(){return this._flipMat}set flipMat(e){this._flipMat=e}get grabMat(){return this._grabMat}set grabMat(e){this._grabMat=e}get ratioBlitMat(){return this._ratioBlitMat}set ratioBlitMat(e){this._ratioBlitMat=e}get uniformTexA(){return this._uniformTexA||"_TextureA"}set uniformTexA(e){this._uniformTexA=e}get uniformTexB(){return this._uniformTexB||"_TextureB"}set uniformTexB(e){this._uniformTexB=e}get uniformProgress(){return void 0===this._transitionMat?"progress":this._uniformProgress||"_Progress"}set uniformProgress(e){this._uniformProgress=e}get resultMatV2(){return this._resultMat}set resultMatV2(e){this._resultMat=e}get transitionMat(){return this._transitionMat}set transitionMat(e){this._transitionMat=e}get sprite2DMaterial(){return this._sprite2DMaterial}set sprite2DMaterial(e){this._sprite2DMaterial=e}get sourceTexture(){return this._sourceTexture}set sourceTexture(e){this._sourceTexture=e}get graphName(){return this._graphName}set graphName(e){var t;this._graphName=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"graphName",e))}get morphTime(){return this._morphTime}set morphTime(e){var t;this._morphTime=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"morphTime",e))}get startMorph(){return this._startMorph}set startMorph(e){var t;this._startMorph=e,this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"startMorph",e))}get fusionTexture(){return this._fusionTexture}set fusionTexture(e){var t;e!==this.mainObject&&(e&&(this._fusionTexture=e),this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"fusionTexture",e)))}get errorTexture(){return this._errorTexture}set errorTexture(e){var t;e&&(this._errorTexture=e),this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"errorTexture",e))}get maskTexture(){return this._maskTexture}set maskTexture(e){var t;e&&(this._maskTexture=e),this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"maskTexture",e))}get transparentTexture(){return this._transparentTexture}set transparentTexture(e){var t;e&&(this._transparentTexture=e),this.isRunTime&&(null===(t=this.scene)||void 0===t||t.assetManager.setCustomAssetsProperty(this.uuid,"transparentTexture",e))}onStart(){var e,t;if(this.isRunTime){if(console.log("wsr",this._instanceId+": ts start,"+this.serviceName),this._instanceId=JSAssetServerAlgoScriptBase_1.JSAssetServerAlgoScriptBase.instanceCount++,this.requestID=1e3*this._instanceId,this.addDynamicEntity(),this._finalOutRT||(this._finalOutRT=this.sourceTexture),!this.mainObject)throw new Error("Invalid mainObject");const s=this.mainObject,r=s.getControl();r.pecentX=1,r.pecentY=1,this.camera.renderTexture=this.mainObject,this.captureRT=this.createScreenRenderTexture("rendercache"),this.flipCaptureRT=this.createScreenRenderTexture("flipRendercache"),this.cmdBuffer.clearAll();const i=null===(e=this.grabMat)||void 0===e?void 0:e.instantiate();this.cmdBuffer.blitWithMaterial(this._finalOutRT,this.flipCaptureRT,i,0,!1),this.cmdBuffer.blit(this._finalOutRT,this.captureRT),this.transparentCMDBuffer.clearAll();const a=null===(t=this.flipMat)||void 0===t?void 0:t.instantiate();this.transparentCMDBuffer.blitWithMaterial(this.transparentTexture,s,a,0,!1),this.dynamicSetAlgorithmEnable(!1),this.dynamicSetNavifitEnable(!1)}}algoShouldStart(){var e;const t=(null===(e=this.scene)||void 0===e?void 0:e.assetManager.getAllCustomAssetsProperty()).get(this.uuid);return this.startMorph=t.get("startMorph"),this.scene.commitCommandBuffer(this.transparentCMDBuffer),!0===this.startMorph||super.algoShouldStart()?!!this.networkBusy||!0!==this.anyNetworkBusy&&(this.networkBusy=!0,console.log("wsr",this._instanceId+": start morph"),this.dynamicSetAlgorithmEnable(!0),this.keepReal&&this.dynamicSetNavifitEnable(!0),!0):(this.dynamicSetAlgorithmEnable(!1),this.dynamicSetNavifitEnable(!1),this.startMorph||this.scene.commitCommandBuffer(this.transparentCMDBuffer),!1)}keepRealFunc(){if(this.keepReal){if(this.sColor=this.getNaviFitResult(),this.sColor)switch(this.sColor){case 0:this.curSkinLutTexture=this.skinLut0Texture;break;case 1:this.curSkinLutTexture=this.skinLut1Texture;break;case 2:this.curSkinLutTexture=this.skinLut2Texture;break;case 3:this.curSkinLutTexture=this.skinLut3Texture}this.dynamicSetNavifitEnable(!1)}this._grabing=!0}triggerStartAlgorithm(){this.canTriggerStart()&&(this.errorSpriteRenderer.enabled=!1,APJS.AlgorithmManager.setInputTexture(1,null,null),APJS.AlgorithmManager.setInputTexture(2,null,null),APJS.AlgorithmManager.setInputTexture(3,null,null),super.triggerStartAlgorithm())}endAlgo(e){this.networkBusy=!1,this.dynamicSetAlgorithmEnable(!1),this.dynamicSetNavifitEnable(!1),super.endAlgo(e)}requestOrFaceError(){this.errorSpriteRenderer.instancedMaterial.setTex("_MainTex",this.errorTexture),this.errorSpriteRenderer.enabled=!0,this.resultMeshRenderer.enabled=!1,this.endAlgo(!1)}startBlend(){var e;if(void 0!==this.transitionMat&&void 0!==this.oldMaterial){this.captureCMDBuffer.clearAll(),this._finalAlgoTexture=this.createRenderTexture("finalAlgoTexture",this._algoTex.getWidth(),this._algoTex.getHeight());const t=null===(e=this.flipMat)||void 0===e?void 0:e.instantiate();t.setFloat("useCapture",1);const s=this.oldMaterial.getTex("maskTexture");void 0!==s&&t.setTex("maskTexture",s);const r=this.oldMaterial.getTex("fusionTexture");void 0!==r&&t.setTex("fusionTexture",r),this.captureCMDBuffer.blitWithMaterial(this._algoTex,this._finalAlgoTexture,t,0,!1),this.scene.commitCommandBuffer(this.captureCMDBuffer);const i=this.resultMeshRenderer.instancedMaterial;i.setTex(this.uniformTexB,this._finalAlgoTexture),i.setFloat(this.uniformProgress,0)}this.hasAlgoResult=!0,console.log("wsr",this._instanceId+": has algo,start blend"),this.resultMeshRenderer.enabled=!0,this.blendTimer=0}doStartAlgorithm(){return this._algoInited||(this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.keepRealFunc()}))),this._algoInited=!0),!!this._algoSubmitted&&(APJS.AlgorithmManager.setInputTexture(1,null,null),APJS.AlgorithmManager.setInputTexture(2,null,null),APJS.AlgorithmManager.setInputTexture(3,null,null),super.doStartAlgorithm())}checkAndSetAlgoResult(e){return this.hasAlgoResult?this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.blendStart(e)}))):this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.checkForResult(e)}))),super.checkAndSetAlgoResult(e)}onUpdate(e){var t;if(this.mainObject&&this.scene)if(this.isRunTime){if(!this.serviceName||!this.fusionTexture)return void this.scene.commitCommandBuffer(this.transparentCMDBuffer);super.onUpdate(e)}else{if(this.fusionTexture&&this.preFusionTexture!==this.fusionTexture&&this.ratioBlitMat)if(this.fusionTexture instanceof APJS.Texture){const e=null===(t=this.ratioBlitMat)||void 0===t?void 0:t.instantiate(),s=this.fusionTexture.getWidth()/this.fusionTexture.getHeight()*16/9;e.setFloat("ratio",s),this.ratioCMDBuffer.clearAll(),this.ratioCMDBuffer.blitWithMaterial(this.fusionTexture,this.mainObject,e,0,!1),this.preFusionTexture=this.fusionTexture}else console.error("wsr","fusionTexture is not texture");this.scene.commitCommandBuffer(this.ratioCMDBuffer)}}canDuplicate(){return!1}addDynamicEntity(){var e;const t=400+2*this._instanceId,s=this.scene.createSceneObject("cameraDynamic"),r=s.addComponent("Transform");this.camera=s.addComponent("Camera"),r.setWorldPosition(new APJS.Vector3f(0,0,10)),this.camera.clearColor=new APJS.Color(0,0,0,0),this.camera.alwaysClear=!0,this.camera.clearType=APJS.CameraClearType.ColorDepth,this.camera.cameraType=APJS.CameraType.Perspective;const i=new APJS.LayerSet(1024,0);i.set(t,!0),this.camera.renderLayer=i,s.layer=t,APJS.EventManager.getObjectEmitter(this.camera).on(APJS.CameraEvent.AFTER_RENDER,this.realBlit,this),APJS.EventManager.getObjectEmitter(this.camera).on(APJS.CameraEvent.BEFORE_RENDER,this.setIdentityMat,this);const a=this.scene.createSceneObject("faceFusionDynamic");a.layer=t,a.addComponent("Transform"),this.resultMeshRenderer=a.addComponent("MeshRenderer"),this.setResultMeshAndMaterial(),this.resultMeshRenderer&&(this.resultMeshRenderer.enabled=!1);const n=this.scene.createSceneObject("errorDynamic");n.layer=t,n.addComponent("Transform");const o=n.getComponent("Transform");this.errorSpriteRenderer=n.addComponent("Sprite2DRenderer"),o.localPosition=new APJS.Vector3f(0,0,0);const h=null===(e=this.sprite2DMaterial)||void 0===e?void 0:e.instantiate();this.errorSpriteRenderer.stretchMode=APJS.StretchMode.fit,this.errorSpriteRenderer.instancedMaterial=h,h.setTex("_MainTex",this.errorTexture),this.errorSpriteRenderer&&(this.errorSpriteRenderer.enabled=!1)}getNaviFitResult(){const e=APJS.AlgorithmManager.getGraphNode(this.graphName,"navi_fit_0").getInfo(0);if(e&&e.data){const t=e.data.get("scolor");return null!=t?(console.log("wsr",this._instanceId+":sColor->"+t),t):void console.log("wsr","no scolor")}}realBlit(e){var t,s,r;if(e.type===APJS.CameraEvent.AFTER_RENDER&&this._grabing){let e;console.log("wsr",this._instanceId+": realBlit"),this.scene.commitCommandBuffer(this.cmdBuffer),this.fusionCMDBuffer.clearAll(),this.keepReal&&this.skinMaskTexture&&this.curSkinLutTexture&&this.addSkinMat?(console.log("wsr",this._instanceId+": use add color skin"),e=null===(t=this.addSkinMat)||void 0===t?void 0:t.instantiate(),null==e||e.setTex("skin_filter",this.curSkinLutTexture),null==e||e.setTex("skin_mask",this.skinMaskTexture)):(console.log("wsr",this._instanceId+": no add skin"),e=null===(s=this.flipMat)||void 0===s?void 0:s.instantiate()),this.fusionRT=this.createRenderTexture("rendercache",Math.max(this.fusionTexture.getWidth(),576),Math.max(this.fusionTexture.getWidth(),576)/this.fusionTexture.getWidth()*this.fusionTexture.getHeight()),this.fusionCMDBuffer.blitWithMaterial(this.fusionTexture,this.fusionRT,e,0,!1),this.scene.commitCommandBuffer(this.fusionCMDBuffer),this.maskCMDBuffer.clearAll();const i=null===(r=this.flipMat)||void 0===r?void 0:r.instantiate();this.maskRT=this.createRenderTexture("maskRT",512,512),this.maskCMDBuffer.blitWithMaterial(this.maskTexture,this.maskRT,i,0,!1),this.scene.commitCommandBuffer(this.maskCMDBuffer);this.resultMeshRenderer.instancedMaterial.setTex("grabFrameTexture",this.captureRT),this._grabing=!1,this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.showGrab()})))}}setIdentityMat(e){var t,s,r,i,a;if(e.type===APJS.CameraEvent.BEFORE_RENDER&&void 0!==this.transitionMat){const e=((null===(t=this.sourceTexture)||void 0===t?void 0:t.getWidth())||0)/((null===(s=this.sourceTexture)||void 0===s?void 0:s.getHeight())||1),n=((null===(r=this.fusionTexture)||void 0===r?void 0:r.getWidth())||0)/((null===(i=this.fusionTexture)||void 0===i?void 0:i.getHeight())||1);if(0!==e&&0!==n){const t=1,s=e/n;this.scaleMat.set(1,1,t+(s-t)*this.progress)}const o=null===(a=this.resultMeshRenderer)||void 0===a?void 0:a.instancedMaterial;o.setMat4("u_MVP",this.scaleMat),o.setMat4("u_Model",this.scaleMat),o.setMat4("u_View",this.identityMat),o.setMat4("u_Projection",this.identityMat)}}showGrab(){console.log("wsr",this._instanceId+": showGrab");const e=this.maskRT,t=this.fusionRT,s=this.resultMeshRenderer.instancedMaterial;s.setTex("fusionTexture",t);const r=t.getWidth()/t.getHeight()*16/9;s.setFloat("ratio",r),inputConfig.dirty=!0,APJS.AlgorithmManager.setInputTexture(1,t,inputConfig),APJS.AlgorithmManager.setInputTexture(2,this.flipCaptureRT,inputConfig),APJS.AlgorithmManager.setInputTexture(3,e,inputConfig),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.setAlgoDirty()})))}setAlgoDirty(){console.log("wsr",this._instanceId+": setAlgoDirty");const e=this.maskRT,t=this.fusionRT;inputConfig.dirty=!1,APJS.AlgorithmManager.setInputTexture(1,t,inputConfig),APJS.AlgorithmManager.setInputTexture(2,this.flipCaptureRT,inputConfig),APJS.AlgorithmManager.setInputTexture(3,e,inputConfig),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{console.log("waitFrame")}))),this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.setAlgoParam()})))}setAlgoParam(){console.log("wsr",this._instanceId+": setAlgoParam");const e=APJS.AlgorithmManager.getGraphNode(this.graphName,"face_1").getInfo(0),t=APJS.AlgorithmManager.getGraphNode(this.graphName,"face_2").getInfo(0);e?console.log("wsr",this._instanceId+": fusionFaceAlgo faceCOunt:"+e.getFaceCount()):console.log("wsr",this._instanceId+": fusionFaceAlgo null"),t?console.log("wsr",this._instanceId+": normalFaceAlgo faceCOunt:"+t.getFaceCount()):console.log("wsr",this._instanceId+": normalFaceAlgo null"),e&&t&&(console.log("wsr",this._instanceId+": fusionFaceAlgo faceCOunt:"+e.getFaceCount()),console.log("wsr",this._instanceId+": normalFaceAlgo faceCOunt:"+t.getFaceCount()),e.getFaceCount()>0&&t.getFaceCount()>0)?this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.setFusionData()}))):this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.requestOrFaceError()})))}setFusionData(){console.log("wsr",this._instanceId+": set setFusionData");const e=APJS.AlgorithmManager.getGraphNode(this.graphName,"face_1").getInfo(0),t=APJS.AlgorithmManager.getGraphNode(this.graphName,"face_2").getInfo(0).getFaceBaseInfo(0),s=e.getFaceBaseInfo(0);if(t&&s){const e=s.pointsArray;for(let t=0;t<106;++t)e[2*t]=720*e[2*t],e[2*t+1]=1280-1280*e[2*t+1];const r={};this.computeFaceRectf(r,e),this.adaptTemplateImageResolution(e,r);for(let t=0;t<106;++t)e[2*t]=e[2*t]/720,e[2*t+1]=(1280-e[2*t+1])/1280;const i=APJS.AlgorithmManager.convertFace106To295(t.pointsArray),a=APJS.AlgorithmManager.convertFace106To295(e);this.setVertAndUVList(i,a),this.resultMeshRenderer.enabled=!0,this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.submitToAlgo()})))}else this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.requestOrFaceError()})))}submitToAlgo(){console.log("wsr",this._instanceId+": submitToAlgo");const e=JSON.stringify(this.algoConfig),t=this.serviceName,s=this.region;console.log("wsr",this._instanceId+": submit algo,key:"+this._instanceId);const r=APJS.AlgorithmManager.getGraphNode(this.graphName,nodeName);r.setString("req_json",e),r.setString("req_service_name",t),r.setString("req_region",s),r.setString("req_key",this._instanceId.toString()),this.requestID++,r.setInt("requestId",this.requestID),this.hasAlgoResult=!1,this._algoSubmitted=!0}checkForResult(e){if(this.requestTimer=this.requestTimer+e,this.requestTimer>this.maxTimeout&&!1===this.hasAlgoResult)return void this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.requestOrFaceError()})));const t=APJS.AlgorithmManager.getResult().getScriptInfo(this.graphName,nodeName);if(!t)return void console.log("wsr",this._instanceId+": scriptInfo null");if(!t.outputMap)return void console.log("wsr",this._instanceId+": scriptInfo outputMap null");const s=t.outputMap,r=s.get("gan_image"),i=s.get("mask_image"),a=s.get("status_code"),n=s.get("error"),o=s.get("success"),h=s.get("message"),u=s.get("log_id"),l=s.get("key");if(!1!==o){if(h&&this.setServerMsg(h),n)console.error("wsr",this._instanceId+": Text2X: Request Error "+n);else if(a>0)console.log("wsr",this._instanceId+": Text2X: Request Status Code "+a);else if(r){if(l!==this._instanceId.toString())return;const e=this.resultMeshRenderer.instancedMaterial;if(this._algoTex=e.getTex("algoTexture"),!this._algoTex){const t=new APJS.Texture2DCreateDesc;t.filterMin=APJS.FilterMode.Linear,t.filterMag=APJS.FilterMode.Linear,this._algoTex=APJS.TextureUtils.createTexture2D(t),e.setTex("algoTexture",this._algoTex)}APJS.TextureUtils.refreshTextureWithImage(this._algoTex,r),console.log("wsr",this._instanceId+": maskImage:"+(i?"yes:"+i.width+","+i.height+","+i.alphaPremul:"no"));let t=e.getTex("maskTexture");if(!t){const s=new APJS.Texture2DCreateDesc;s.filterMin=APJS.FilterMode.Linear,s.filterMag=APJS.FilterMode.Linear,t=APJS.TextureUtils.createTexture2D(s),e.setTex("maskTexture",t)}if(APJS.TextureUtils.refreshTextureWithImage(t,i),e.setFloat("progress",0),void 0!==this.transitionMat){this.oldMaterial=this.resultMeshRenderer.instancedMaterial;const e=this.transitionMat.instantiate();this.resultMeshRenderer.mesh=this.createQuadMesh(),this.resultMeshRenderer.instancedMaterial=e,e.setTex(this.uniformTexA,this.captureRT)}this._frameTaskQueue.push(new JSAssetServerAlgoScriptBase_1.FrameTask((()=>{this.startBlend()})))}}else console.error("wsr",this._instanceId+": Text2X: Request Timeoutlogid"+u)}blendStart(e){if(this.morphTime<=.01)return this.progress=1,this.resultMeshRenderer.instancedMaterial.setFloat(this.uniformProgress,this.progress),void this.endAlgo(!0);this.blendTimer=this.blendTimer+e,this.progress=this.blendTimer/this.morphTime,this.progress<1?this.resultMeshRenderer.instancedMaterial.setFloat(this.uniformProgress,this.progress):(this.progress=1,this.resultMeshRenderer.instancedMaterial.setFloat(this.uniformProgress,this.progress),this.endAlgo(!0))}onRelease(){const e=this.scene.findSceneObject("cameraDynamic");e&&this.scene.removeSceneObject(e);const t=this.scene.findSceneObject("faceFusionDynamic");t&&this.scene.removeSceneObject(t);const s=this.scene.findSceneObject("errorDynamic");s&&this.scene.removeSceneObject(s)}onDestroy(){APJS.EventManager.getObjectEmitter(this.camera).off(APJS.CameraEvent.AFTER_RENDER,this.realBlit,this),APJS.EventManager.getObjectEmitter(this.camera).off(APJS.CameraEvent.BEFORE_RENDER,this.setIdentityMat,this),this.resetProperty();Object.keys(this).forEach((e=>{this[e]=null}))}resetProperty(){this.logicState="",this.waitFrame=0,this.blendTimer=0,this.requestTimer=0,this.hasAlgoResult=!1,this.errorWaitTimer=0,this._grabing=!1,this._algoSubmitted=!1,this._algoInited=!1,this.resultMeshRenderer.instancedMaterial.setFloat("progress",0),this.resultMeshRenderer.enabled=!1,this.dynamicSetAlgorithmEnable(!1),super.resetProperty()}dynamicSetAlgorithmEnable(e){const t=["blit_1","blit_2","blit_3","face_1","face_2","bingo_crop","smash_crop","nh_script_0"];if(e)console.log("wsr",this._instanceId+": open algo"),APJS.AlgorithmManager.enableGraphNodes(this.graphName,t,!0);else{if(!0===this.anyNetworkBusy)return void console.log("wsr",this._instanceId+": close algo: skipped");console.log("wsr",this._instanceId+": close algo"),APJS.AlgorithmManager.enableGraphNodes(this.graphName,t,!1),APJS.AlgorithmManager.setInputTexture(1,null,null),APJS.AlgorithmManager.setInputTexture(2,null,null),APJS.AlgorithmManager.setInputTexture(3,null,null)}}dynamicSetNavifitEnable(e){const t=["expression_detect_0","navi_fit_0"];e?APJS.AlgorithmManager.enableGraphNodes(this.graphName,t,!0):APJS.AlgorithmManager.enableGraphNodes(this.graphName,t,!1)}setResultMeshAndMaterial(){var e;this.resultMesh||(this.resultMesh=this.createFusionMesh());const t=null===(e=this.resultMatV2)||void 0===e?void 0:e.instantiate();this.resultMeshRenderer.mesh=this.resultMesh,this.resultMeshRenderer.instancedMaterial=t,this.resultMeshRenderer.instancedMaterial.setFloat("progress",0)}createRenderTexture(e,t,s){const r=new APJS.RenderTextureCreateDesc;return r.name=e,r.builtinType=APJS.BuiltInTextureType.NORAML,r.internalFormat=APJS.InternalFormat.RGBA8,r.dataType=APJS.DataType.U8norm,r.depth=1,r.attachment=APJS.RenderTextureAttachment.DEPTH24,r.filterMag=APJS.FilterMode.Linear,r.filterMin=APJS.FilterMode.Linear,r.filterMipmap=APJS.FilterMipmapMode.None,r.width=t,r.height=s,r.colorFormat=APJS.PixelFormat.RGBA8Unorm,APJS.TextureUtils.createRenderTexture(r)}createScreenRenderTexture(e){const t=new APJS.ScreenTextureCreateDesc;return t.name=e,t.builtinType=APJS.BuiltInTextureType.NORAML,t.internalFormat=APJS.InternalFormat.RGBA8,t.dataType=APJS.DataType.U8norm,t.depth=1,t.attachment=APJS.RenderTextureAttachment.DEPTH24,t.filterMag=APJS.FilterMode.Linear,t.filterMin=APJS.FilterMode.Linear,t.filterMipmap=APJS.FilterMipmapMode.None,t.pecentX=1,t.pecentY=1,t.colorFormat=APJS.PixelFormat.RGBA8Unorm,APJS.TextureUtils.createScreenTexture(t)}computeFaceRectf(e,t){e.left=1e8,e.right=-1e8,e.bottom=-1e8,e.top=1e8;for(let s=0;s<106;++s)e.left=Math.min(e.left,t[2*s]),e.right=Math.max(e.right,t[2*s]),e.bottom=Math.max(e.bottom,t[2*s+1]),e.top=Math.min(e.top,t[2*s+1])}scaleVertex2DfPtr(e,t,s,r){for(let i=0;i<t;++i)e[2*i]=e[2*i]*s,e[2*i+1]=e[2*i+1]*r}translateVertex2DfPtr(e,t,s,r){for(let i=0;i<t;++i)e[2*i]=e[2*i]+s,e[2*i+1]=e[2*i+1]+r}adaptTemplateImageResolution(e,t){const s=this.height/this.width,r=720,i=1280;let a=1,n=this.width,o=this.height,h=!1;if(1.7777777777777777>s?(a=this.width/r,o=i*a,h=!0):(a=this.height/i,n=r*a,h=!1),this.scaleVertex2DfPtr(e,106,a,a),h){const r=o-this.height,a=1.7778/s;let n=((t.top+t.bottom)/2/i*a-.5)/(a-1);n=Math.max(Math.min(n,1),0),this.translateVertex2DfPtr(e,106,0,-r*n)}else{const i=n-this.width,a=.5625*s;let o=((t.left+t.right)/2/r*a-.5)/(a-1);o=Math.max(Math.min(o,1),0),this.translateVertex2DfPtr(e,106,-i*o,0)}}getVertexsWithFaceInfo(e,t,s,r){const i=720*r/s;for(let s=0;s<295;++s)e.push({x:720*t[2*s],y:t[2*s+1]*i+.5*(1280-i),z:0})}getDistance(e,t){const s=(e.x-t.x)*(e.x-t.x),r=(e.y-t.y)*(e.y-t.y),i=(e.z-t.z)*(e.z-t.z);return Math.sqrt(s+r+i)}getBorderScaleValue(e){const t=this.width*this.width+this.height*this.height;let s=t;const r=e[33],i={x:(e[33].x+e[36].x)/2,y:(e[33].y+e[36].y)/2,z:(e[33].z+e[36].z)/2};for(let t=0;t<33;t+=2){let r=this.getDistance(e[t],i);r*=r,r<s&&(s=r)}for(let t=180;t<191;++t){let i=this.getDistance(e[t],r);i*=i,i<s&&(s=i)}return-1*Math.sqrt(t/s)+1}extendBorderPoints(e,t){const s=[],r=e[33],i=(e[33].x+e[36].x)/2,a=(e[33].y+e[36].y)/2,n=(e[33].z+e[36].z)/2;for(let r=0;r<33;r+=2){const o={x:e[r].x*(1-t)+i*t,y:e[r].y*(1-t)+a*t,z:e[r].z*(1-t)+n*t};s.push(o)}for(let i=180;i<191;++i){const a={x:e[i].x*(1-t)+r.x*t,y:e[i].y*(1-t)+r.y*t,z:e[i].z*(1-t)+r.z*t};s.push(a)}for(let t=0;t<s.length;++t)e[204+t]=s[t]}normalizeVertexs(e){for(let t=0;t<e.length;++t)e[t].x=e[t].x/this.width*2-1,e[t].y=(this.height-e[t].y)/this.height*2-1,e[t].z=0}setVertAndUVList(e,t){const s=e,r=t,i=[],a=[];this.getVertexsWithFaceInfo(i,s,this.width,this.height),this.getVertexsWithFaceInfo(a,r,this.fusionTexture.getWidth(),this.fusionTexture.getHeight());const n=this.getBorderScaleValue(i),o=this.getBorderScaleValue(a),h=Math.min(n,o);this.extendBorderPoints(i,h),this.extendBorderPoints(a,h),this.normalizeVertexs(i),this.normalizeVertexs(a);const u=new Float32Array(10*i.length);for(let e=0;e<i.length;++e){const t=10*e;u[t+0]=i[e].x,u[t+1]=-1*i[e].y,u[t+2]=i[e].z,u[t+3]=(i[e].x+1)/2,u[t+4]=(i[e].y+1)/2,u[t+5]=a[e].x,u[t+6]=-1*a[e].y,u[t+7]=a[e].z,u[t+8]=(a[e].x+1)/2,u[t+9]=(a[e].y+1)/2}const l=new APJS.FloatVector;APJS.AmazingUtil.arrayBufferToPrimitiveVector(u.buffer,l),this.resultMeshRenderer.mesh.vertices=l}createFusionMesh(){const e=new APJS.Mesh,t=new APJS.SubMesh;t.primitive=APJS.Primitive.TRIANGLES;const s=new APJS.VertexAttribDesc;s.semantic=APJS.VertexAttribType.POSITION;const r=new APJS.VertexAttribDesc;r.semantic=APJS.VertexAttribType.TEXCOORD0;const i=new APJS.VertexAttribDesc;i.semantic=APJS.VertexAttribType.NORMAL;const a=new APJS.VertexAttribDesc;a.semantic=APJS.VertexAttribType.TEXCOORD1;const n=new APJS.Vector;n.pushBack(s),n.pushBack(r),n.pushBack(i),n.pushBack(a),e.vertexAttribs=n;const o=new APJS.UInt16Vector;return APJS.AmazingUtil.arrayBufferToPrimitiveVector(new Uint16Array(face295MeshIndexData).buffer,o),t.indices16=o,t.mesh=e,e.addSubMesh(t),e}createQuadMesh(e=-1,t=1,s=-1,r=1){const i=new APJS.Mesh,a=new APJS.VertexAttribDesc;a.semantic=APJS.VertexAttribType.POSITION;const n=new APJS.VertexAttribDesc;n.semantic=APJS.VertexAttribType.TEXCOORD0;const o=new APJS.Vector;o.pushBack(a),o.pushBack(n),i.vertexAttribs=o;const h=[t,r,0,1,1,t,s,0,1,0,e,s,0,0,0,e,r,0,0,1],u=new APJS.FloatVector;for(let e=0;e<h.length;e++)u.pushBack(h[e]);i.vertices=u;const l=new APJS.SubMesh;l.primitive=APJS.Primitive.TRIANGLES;const c=[3,2,1,1,0,3],g=new APJS.UInt16Vector;for(let e=0;e<c.length;e++)g.pushBack(c[e]);return l.indices16=g,l.mesh=i,i.addSubMesh(l),i}}exports.JSAssetFaceFusionTextureTTScript=JSAssetFaceFusionTextureTTScript;