/* eslint-disable */
var posejs;(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{ACTION_DEEP_SQUAT:()=>J,ACTION_FLY:()=>X,ACTION_HAND_CLAMP:()=>it,ACTION_HIGH_KNEE_LIFT:()=>Q,ACTION_KEYS:()=>gt,ACTION_LEFT_FOOT_UP:()=>rt,ACTION_LEFT_LEG_TO_HIP:()=>ot,ACTION_LEFT_PUNCH:()=>tt,ACTION_LIBRARY:()=>lt,ACTION_LIBRARY_IDS:()=>dt,ACTION_RIGHT_FOOT_UP:()=>at,ACTION_RIGHT_LEG_TO_HIP:()=>nt,ACTION_RIGHT_PUNCH:()=>et,ACTION_SWING_ARM:()=>st,ACTION_TURN_AROUND:()=>Z,BODY_IDS:()=>s,BODY_KEYS:()=>i,Body:()=>Lt,BodyManager:()=>yt,BodyPoint:()=>ct,Bone:()=>ft,DEBUG_MODE:()=>r,DISTANCE_DEFAULT_THRESHOLD:()=>l,DOUBLE_TOLERANCE:()=>g,FrameContext:()=>pt,FrameManager:()=>ut,Interval:()=>L,Limb:()=>Pt,Line2d:()=>y,MachineEnum:()=>St,MathUtils:()=>S,MedianBodyPoint:()=>mt,POSE_ARM_AKIMBO:()=>E,POSE_ARM_HORIZONTAL:()=>A,POSE_DEEP_SQUAT_END:()=>b,POSE_DEEP_SQUAT_START:()=>N,POSE_DEFAULT_THRESHOLD:()=>h,POSE_FACE_BACK:()=>B,POSE_FACE_FONT:()=>x,POSE_FOOT_PARALLEL:()=>W,POSE_HANDS_ABOVE_HEAD:()=>K,POSE_HAND_FAR:()=>D,POSE_HAND_NEAR:()=>v,POSE_KEYS:()=>$,POSE_LEFT_FOOT_OFF_FLOOR:()=>z,POSE_LEFT_HAND_ABOVE_HEAD:()=>Y,POSE_LEFT_HAND_CLOSE_ANKLE:()=>M,POSE_LEFT_HAND_CLOSE_SHOULDER:()=>C,POSE_LEFT_LEG_UP_TO_HIP:()=>O,POSE_LEFT_PUNCH_END:()=>R,POSE_LEFT_PUNCH_START:()=>T,POSE_LIBRARY:()=>q,POSE_LIBRARY_IDS:()=>G,POSE_RIGHT_FOOT_OFF_FLOOR:()=>V,POSE_RIGHT_HAND_ABOVE_HEAD:()=>j,POSE_RIGHT_HAND_CLOSE_ANKLE:()=>U,POSE_RIGHT_HAND_CLOSE_SHOULDER:()=>H,POSE_RIGHT_LEG_UP_TO_HIP:()=>k,POSE_RIGHT_PUNCH_END:()=>w,POSE_RIGHT_PUNCH_START:()=>I,POSE_SURRENDER:()=>F,PoseManager:()=>Rt,StateMachine:()=>Et,UP_VEC:()=>a,VERSION:()=>_,Vector2d:()=>P,actionJumpCreator:()=>_t,backToFront:()=>n,isMatchAction:()=>Tt,isMatchPose:()=>At,isTracking:()=>f,printError:()=>m,printLog:()=>u,printWarn:()=>c});const i={PT_KEYS:{Nose:"Nose",Neck:"Neck",RightShoulder:"RightShoulder",RightElbow:"RightElbow",RightWrist:"RightWrist",LeftShoulder:"LeftShoulder",LeftElbow:"LeftElbow",LeftWrist:"LeftWrist",RightHip:"RightHip",RightKnee:"RightKnee",RightAnkle:"RightAnkle",LeftHip:"LeftHip",LeftKnee:"LeftKnee",LeftAnkle:"LeftAnkle",RightEye:"RightEye",LeftEye:"LeftEye",RightEar:"RightEar",LeftEar:"LeftEar"},BONE_KEYS:{Spine:"Spine",LeftUpArm:"LeftUpArm",RightUpArm:"RightUpArm",LeftForeArm:"LeftForeArm",RightForeArm:"RightForeArm",LeftUpperLeg:"LeftUpperLeg",RightUpperLeg:"RightUpperLeg",LeftLowLeg:"LeftLowLeg",RightLowLeg:"RightLowLeg"},LIMB_KEYS:{LeftArm:"LeftArm",RightArm:"RightArm",LeftLeg:"LeftLeg",RightLeg:"RightLeg"},BONE_KEYS_ARR:["Spine","LeftUpArm","RightUpArm","LeftForeArm","RightForeArm","LeftUpperLeg","RightUpperLeg","LeftLowLeg","RightLowLeg"],PT_BACK_KEYS_ARR:["Nose","Neck","RightShoulder","RightElbow","RightWrist","LeftShoulder","LeftElbow","LeftWrist","RightHip","RightKnee","RightAnkle","LeftHip","LeftKnee","LeftAnkle","RightEye","LeftEye","RightEar","LeftEar"]},s={PT_NUM_IDS_FRONT:{Nose:0,Neck:1,LeftShoulder:2,LeftElbow:3,LeftWrist:4,RightShoulder:5,RightElbow:6,RightWrist:7,LeftHip:8,LeftKnee:9,LeftAnkle:10,RightHip:11,RightKnee:12,RightAnkle:13,LeftEye:14,RightEye:15,LeftEar:16,RightEar:17},PT_NUM_IDS_BACK:{Nose:0,Neck:1,RightShoulder:2,RightElbow:3,RightWrist:4,LeftShoulder:5,LeftElbow:6,LeftWrist:7,RightHip:8,RightKnee:9,RightAnkle:10,LeftHip:11,LeftKnee:12,LeftAnkle:13,RightEye:14,LeftEye:15,RightEar:16,LeftEar:17},MAIN_POINTS_IDS:["Neck","LeftHip","RightHip","LeftShoulder","RightShoulder"],BONE_9KEY_IDS:{Spine:0,LeftUpArm:1,RightUpArm:2,LeftForeArm:3,RightForeArm:4,LeftUpperLeg:5,RightUpperLeg:6,LeftLowLeg:7,RightLowLeg:8}},o={0:0,1:1,2:5,3:6,4:7,5:2,6:3,7:4,8:11,9:12,10:13,11:8,12:9,13:10,14:15,15:14,16:17,17:16};function n(t){return o[t]}const r=!1,a={x:0,y:1},h=20,_="0.0.2",l=.1,g=1e-4,d=!1,p=!1;function u(...t){r&&console.log("[Body Action Detection]",...t)}function c(...t){d&&console.warn("[Body Action Detection]",...t)}function m(...t){p&&console.error("[Body Action Detection]",...t)}function f(t,e){if(Array.isArray(t)){for(let i of t)if(!i.isTracking())return m(`tracking!!!!!! ${e||""} ${i.name} not tracking! in isTracking`),!1;return!0}return t&&t.isTracking?t.isTracking():(t&&t.name&&m(`${e||""} ${t.name} not tracking! in isTracking`),t||m(`${e||""} item is null! cant tracking! in isTracking`),!1)}class P{get x(){return this._data[0]}get y(){return this._data[1]}set x(t){this._data[0]=t}set y(t){this._data[1]=t}constructor(t,e){this._data=[],void 0===t?this._data=[0,0]:Array.isArray(t)?this.resetFromArray(t):"number"==typeof t?(this._data[0]=t,this._data[1]=e):t&&void 0!==t.x&&(this.data[0]=t.x,this._data[1]=t.y)}get data(){return this._data}add(t){const e=this._paramToVector(t);for(let t=0;t<this._data.length;t++)this._data[t]+=e._data[t];return this}sub(t){const e=this._paramToVector(t);for(let t=0;t<this._data.length;t++)this._data[t]-=e._data[t];return this}cross(t){return this.x*t.y-this.y*t.x}multi(t){for(let e=0;e<this._data.length;e++)this._data[e]*=t;return this}div(t){for(let e=0;e<this._data.length;e++)this._data[e]/=t;return this}dot(t){const e=this._paramToVector(t);let i=0;for(let t=0;t<this._data.length;t++)i+=this._data[t]*e._data[t];return i}distanceTo(t){return this._paramToVector(t).clone().sub(this).getLength()}isParallelTo(t,e=g){const i=this.clone(),s=new P(t);return i.normalize(),s.normalize(),Math.abs(i.cross(s))<e}isPerpendicularTo(t,e=g){const i=this._paramToVector(t),s=this.clone(),o=new P(i);s.normalize(),o.normalize();const n=s.dot(o);return Math.abs(n)<e}getLength(){return Math.sqrt(this.getSqLength())}getSqLength(){let t=0;for(const e of this._data)t+=e*e;return t}normalize(){const t=this.getLength();return t>0&&this.div(t),this}resetFromArray(t){return this._data.splice(0),t&&this._data.push(...t),this}copy(t){const e=this._paramToVector(t);return this.resetFromArray(e._data),this}clone(){return new P(this._data)}asString(){let t="";for(let e=0;e<this._data.length;e++)t+=`${this._data[e]} `;return t}toXY(){return{x:this.x,y:this.y}}_paramToVector(t){let e;return t instanceof P?e=t:(e=new P,e._data.push(t.x,t.y)),e}}class L{constructor(t,e,i=!1){if(this.min=t,this.max=e,i)this.min=Math.min(t,e),this.max=Math.max(t,e);else if(t>e)throw new Error(`invalid interval[ ${t}, ${e}]`)}getLength(){return this.max-this.min}getMid(){return(this.max+this.min)/2}containsPoint(t,e=g){return t+e>=this.min&&t-e<=this.max}intersect(t){const e=Math.max(this.min,t.min),i=Math.min(this.max,t.max);if(!(e>i))return new L(e,i)}clone(){return new L(this.min,this.max)}}class y{constructor(t,e){this._range=new L(0,0),this._dir=new P(1,0),this._origin=new P(0,0),t&&e&&this.resetByTwoPoint(t,e)}getRange(){return this._range.clone()}getLength(){return this._range.getLength()}getDirection(){return this._dir.clone()}getStartParam(){return this._range.min}getStartPt(){return this.getPtAt(this.getStartParam())}getEndParam(){return this._range.max}getEndPt(){return this.getPtAt(this.getEndParam())}getPtAt(t){return this._dir.clone().multi(t).add(this._origin)}getMidPt(){return this.getPtAt(this._range.getMid())}getParamAt(t){return new P(t).sub(this._origin).dot(this._dir)}getNormalizedParamAt(t){return this.getParamAt(t)/this.getLength()}clone(){const t=new y;return t._origin.copy(this._origin),t._dir.copy(this._dir),t._range.min=this._range.min,t._range.max=this._range.max,t}isParallelTo(t,e=g){return this._dir.isParallelTo(t._dir,e)}isPerpendicularTo(t,e=g){return this._dir.isPerpendicularTo(t._dir,e)}extend(t,e){e?this._range.max+=t:this._range.min-=t}extendDouble(t){this._range.max+=t,this._range.min-=t}resetByTwoPoint(t,e){this._origin.x=t.x,this._origin.y=t.y;const i=e.x-t.x,s=e.y-t.y;this._dir.x=i,this._dir.y=s;const o=this._dir.getLength();this._dir.normalize(),this._range.min=0,this._range.max=o}asString(){const t=this.getStartPt(),e=this.getEndPt();return t.asString()+"->"+e.asString()}}const S={calculateVectorAngle(t,e){const i=t.x,s=t.y,o=e.x,n=e.y,r=i*o+s*n,a=Math.sqrt(i*i+s*s),h=Math.sqrt(o*o+n*n);if(0===a||0===h)return 0;const _=Math.acos(r/(a*h))*(180/Math.PI);return i*n-s*o<0?360-_:_},getAngleDifference(t,e){let i=Math.abs(t-e);return i>180&&(i=360-i),i},ptToLineSignedDistance(t,e,i){const s=e.getDirection();[s.x,s.y]=[s.y,-s.x];const o=t.clone(),n=e.getPtAt(0),r=o.clone().sub(n).dot(s);return void 0!==i&&(o.sub(s.clone().multi(r)),i.copy(o)),r},line2dAndLine2dIntersect(t,e){if(t.isParallelTo(e,.05)){const i=this.ptToLineSignedDistance(e.getStartPt(),t);return Math.abs(i)<h}if(t.isPerpendicularTo(e,.05)){const i=new P;this.ptToLineSignedDistance(e.getStartPt(),t,i);const s=t.getParamAt(i);return t.getRange().containsPoint(s)}const i=e.getStartPt(),s=e.getEndPt(),o=new P,n=new P,r=this.ptToLineSignedDistance(i,t,o),a=this.ptToLineSignedDistance(s,t,n);if(r>0&&a<0||r<0&&a>0){const i=t.getParamAt(o),s=t.getParamAt(n),r=e.getRange(),a=new L(i,s,!0);return!!r.intersect(a)}return!1}},E={pose:{RightUpArm:313,RightForeArm:289,LeftUpArm:53,LeftForeArm:75},type:"pose",name:"akimbo"},A={pose:{LeftUpArm:348,RightUpArm:352,LeftForeArm:5,RightForeArm:0},threshold:20,type:"pose",name:"pose_arm_horizontal"},T={pose:{LeftUpArm:76},judge(t,e=1){const s=t.getItem(i.BONE_KEYS.Spine),o=t.getItem(i.LIMB_KEYS.LeftArm),n=t.getItem(i.PT_KEYS.LeftWrist);if(!f([s,o,n],"pose_left_punch_start"))return!1;const r=s.getLength(),a=o.getLength(),h=s.getNormalizedParamAt(n),{t:_,ivl:l,ptIvl:g}=this.judge_threshold;return l.containsPoint(a/r,_*e)&&g.containsPoint(h,_*e)},judge_threshold:{t:.1,ivl:new L(.4,1.2),ptIvl:new L(-.8,.5)},type:"pose",name:"pose_left_punch_start"},R={pose:{LeftUpArm:76},judge(t,e=1){const s=t.getItem(i.BONE_KEYS.Spine),o=t.getItem(i.LIMB_KEYS.LeftArm),n=t.getItem(i.PT_KEYS.LeftWrist);if(!f([s,o,n],"pose_left_punch_start"))return!1;const r=s.getLength(),a=o.getLength(),{t:h,ivl:_,ptIvl:l}=this.judge_threshold,g=s.getNormalizedParamAt(n);return _.containsPoint(a/r,h*e)&&l.containsPoint(g,h*e)},judge_threshold:{t:.1,ivl:new L(0,.2),ptIvl:new L(.7,2)},type:"pose",name:"pose_left_punch_end"},I={judge(t,e=1){const s=t.getItem(i.BONE_KEYS.Spine),o=t.getItem(i.LIMB_KEYS.RightArm),n=t.getItem(i.PT_KEYS.RightWrist);if(!f([s,o,n],"pose_right_punch_start"))return!1;const r=s.getLength(),a=o.getLength(),{t:h,ivl:_,ptIvl:l}=this.judge_threshold,g=s.getNormalizedParamAt(n);return _.containsPoint(a/r,h*e)&&l.containsPoint(g,h*e)},judge_threshold:{t:.1,ivl:new L(.4,1.2),ptIvl:new L(-.8,.5)},type:"pose",name:"pose_right_punch_start"},w={judge(t,e=1){const s=t.getItem(i.BONE_KEYS.Spine),o=t.getItem(i.LIMB_KEYS.RightArm),n=t.getItem(i.PT_KEYS.RightWrist);if(!f([s,o,n],"pose_right_punch_end"))return!1;const r=s.getLength(),a=o.getLength(),{t:h,ivl:_,ptIvl:l}=this.judge_threshold,g=s.getNormalizedParamAt(n);return _.containsPoint(a/r,h*e)&&l.containsPoint(g,h*e)},judge_threshold:{t:.1,ivl:new L(0,.2),ptIvl:new L(.7,2)},type:"pose",name:"pose_right_punch_end"},B={judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftShoulder),o=t.getItem(i.PT_KEYS.RightShoulder),n=t.getItem(i.BONE_KEYS.Spine);if(!f([s,o,n],"POSE_FACE_FONT"))return c("POSE_FACE_FONT not tracking!"),!1;const r=S.ptToLineSignedDistance(s,n),a=S.ptToLineSignedDistance(o,n),h=1*n.getLength()/6*e;return r<0&&a>0&&Math.abs(r)>h&&Math.abs(a)>h},type:"pose",name:"pose_face_back"},x={judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftShoulder),o=t.getItem(i.PT_KEYS.RightShoulder),n=t.getItem(i.BONE_KEYS.Spine);if(!f([s,o,n],"POSE_FACE_FONT"))return c("POSE_FACE_FONT not tracking!"),!1;const r=S.ptToLineSignedDistance(s,n),a=S.ptToLineSignedDistance(o,n),h=1*n.getLength()/6*e;return r>0&&a<0&&Math.abs(r)>h&&Math.abs(a)>h},judge_threshold:{t:.1},type:"pose",name:"pose_face_font"},b={pose:{RightLowLeg:278,LeftLowLeg:67},judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftAnkle),o=t.getItem(i.PT_KEYS.RightAnkle),n=t.getItem(i.PT_KEYS.LeftShoulder),r=t.getItem(i.PT_KEYS.RightShoulder);if(!f([s,o,n,r],"pose_deep_squat_end"))return!1;const a=new y(s,o),h=a.getNormalizedParamAt(n),_=a.getNormalizedParamAt(r),{t:l,ankleIvl:g}=this.judge_thresholds;return g.containsPoint(h,l*e)&&g.containsPoint(_,l*e)},judge_thresholds:{t:.1,ankleIvl:new L(0,1)},threshold:15,type:"pose",name:"pose_deep_squat_end"},N={pose:{LeftLowLeg:0,RightLowLeg:0},judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftAnkle),o=t.getItem(i.PT_KEYS.RightAnkle),n=t.getItem(i.PT_KEYS.LeftShoulder),r=t.getItem(i.PT_KEYS.RightShoulder);if(!f([s,o,n,r],"POSE_DEEP_SQUAT_START"))return!1;const a=new y(s,o),h=a.getNormalizedParamAt(n),_=a.getNormalizedParamAt(r),{t:l,ankleIvl:g}=this.judge_thresholds;return g.containsPoint(h,l*e)&&g.containsPoint(_,l*e)},judge_thresholds:{t:.1,ankleIvl:new L(0,1)},threshold:15,type:"pose",name:"pose_deep_squat_start"},O={pose:{RightLowLeg:0},judge(t,e=1){const s=t.getItem(i.LIMB_KEYS.RightLeg);if(!f([s,t.getItem(i.LIMB_KEYS.LeftLeg)],"pose_left_leg_up_to_hip"))return!1;const o=t.getItem(i.PT_KEYS.LeftKnee),n=t.getItem(i.PT_KEYS.LeftAnkle),r=s.getNormalizedParamAt(o),a=s.getNormalizedParamAt(n),{kneeIvl:h,ankleIvl:_,t:l}=this.judge_thresholds,g=h.containsPoint(r,l*e),d=_.containsPoint(a,l*e);return g&&d},threshold:40,judge_thresholds:{t:.1,kneeIvl:new L(-1,.2),ankleIvl:new L(-1,.7)},type:"pose",name:"pose_left_leg_up_to_hip"},k={pose:{LeftLowLeg:0},judge(t,e=1){const s=t.getItem(i.LIMB_KEYS.RightLeg),o=t.getItem(i.LIMB_KEYS.LeftLeg);if(!f([s,o],"pose_right_leg_up_to_hip"))return!1;const n=t.getItem(i.PT_KEYS.RightKnee),r=t.getItem(i.PT_KEYS.RightAnkle),a=o.getNormalizedParamAt(n),h=o.getNormalizedParamAt(r),{kneeIvl:_,ankleIvl:l,t:g}=this.judge_thresholds,d=_.containsPoint(a,g*e),p=l.containsPoint(h,g*e);return d&&p},threshold:40,judge_thresholds:{t:.1,kneeIvl:new L(-1,.2),ankleIvl:new L(-1,.7)},type:"pose",name:"pose_right_leg_up_to_hip"},F={pose:{RightUpArm:350,RightForeArm:106,LeftUpArm:8,LeftForeArm:253},type:"pose",name:"pose_surrender"},K={judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftWrist),o=t.getItem(i.PT_KEYS.RightWrist),n=t.getItem(i.PT_KEYS.Nose),r=t.getItem(i.BONE_KEYS.Spine);if(!f([s,o,n,r],"pose_hands_above_head"))return!1;const a=r.getNormalizedParamAt(s),h=r.getNormalizedParamAt(o),_=r.getNormalizedParamAt(n),l=new L(0,_),g=!l.containsPoint(a,this.judge_threshold.t*e),d=!l.containsPoint(h,this.judge_threshold.t*e);return g&&d},judge_threshold:{t:.1},type:"pose",name:"pose_hands_above_head"},Y={judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftWrist),o=t.getItem(i.PT_KEYS.Nose),n=t.getItem(i.BONE_KEYS.Spine);if(!f([s,o,n],"pose_left_hand_above_head"))return!1;const r=n.getNormalizedParamAt(s),a=n.getNormalizedParamAt(o);return!new L(0,a).containsPoint(r,this.judge_threshold.t*e)},judge_threshold:{t:.1},type:"pose",name:"pose_left_hand_above_head"},j={judge(t,e=1){const s=t.getItem(i.PT_KEYS.RightWrist),o=t.getItem(i.PT_KEYS.Nose),n=t.getItem(i.BONE_KEYS.Spine);if(!f([s,o,n],"pose_hands_above_head"))return!1;const r=n.getNormalizedParamAt(s),a=n.getNormalizedParamAt(o);return!new L(0,a).containsPoint(r,this.judge_threshold.t*e)},judge_threshold:{t:.1},type:"pose",name:"pose_right_hand_above_head"},v={judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftWrist),o=t.getItem(i.PT_KEYS.RightWrist),n=t.getItem(i.PT_KEYS.LeftShoulder),r=t.getItem(i.PT_KEYS.RightShoulder);if(!f([s,o],"pose_hand_far"))return c("tracking!!!!!!pose_hand_far not tracking!"),!1;const a=new y(n,r),h=a.getNormalizedParamAt(s),_=a.getNormalizedParamAt(o),l=Math.abs(h-_),{t:g,ivl:d}=this.judge_threshold;return d.containsPoint(l,g*e)},judge_threshold:{t:.1,ivl:new L(0,.5)},type:"pose",name:"pose_hand_near"},D={judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftWrist),o=t.getItem(i.PT_KEYS.RightWrist),n=t.getItem(i.PT_KEYS.LeftShoulder),r=t.getItem(i.PT_KEYS.RightShoulder),a=t.getItem(i.BONE_KEYS.Spine);if(!f([s,o],"pose_hand_far"))return c("tracking!!!!!!pose_hand_far not tracking!"),!1;const h=new y(n,r),_=h.getNormalizedParamAt(s),l=h.getNormalizedParamAt(o),g=Math.abs(_-l),{t:d,ivl:p,disIvl:u}=this.judge_threshold,m=a.getNormalizedParamAt(n),P=a.getNormalizedParamAt(s);return p.containsPoint(g,d*e)&&u.containsPoint(Math.abs(P-m),d*e)},judge_threshold:{t:.1,ivl:new L(.8,5),disIvl:new L(0,.1)},type:"pose",name:"pose_hand_far"},M={judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftWrist),o=t.getItem(i.PT_KEYS.LeftAnkle),n=t.getItem(i.PT_KEYS.Spine);if(!f([s,o,n],"pose_left_hand_close_ankle"))return!1;const r=n.getNormalizedParamAt(s),a=n.getNormalizedParamAt(o);return Math.abs(r-a)<this.judge_threshold.t*e},judge_threshold:{t:.1},type:"pose",name:"pose_left_hand_close_ankle"},C={judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftWrist),o=t.getItem(i.PT_KEYS.LeftShoulder),n=t.getItem(i.PT_KEYS.Spine);if(!f([s,o,n],"pose_left_hand_close_shoulder"))return!1;const r=n.getNormalizedParamAt(s),a=n.getNormalizedParamAt(o);return Math.abs(r-a)<this.judge_threshold.t*e},judge_threshold:{t:.1},type:"pose",name:"pose_left_hand_close_shoulder"},U={judge(t,e=1){const s=t.getItem(i.PT_KEYS.RightWrist),o=t.getItem(i.PT_KEYS.RightAnkle),n=t.getItem(i.PT_KEYS.Spine);if(!f([s,o,n],"pose_right_hand_close_ankle"))return!1;const r=n.getNormalizedParamAt(s),a=n.getNormalizedParamAt(o);return Math.abs(r-a)<this.judge_threshold.t*e},judge_threshold:{t:.1},type:"pose",name:"pose_right_hand_close_ankle"},H={judge(t,e=1){const s=t.getItem(i.PT_KEYS.RightWrist),o=t.getItem(i.PT_KEYS.RightShoulder),n=t.getItem(i.PT_KEYS.Spine);if(!f([s,o,n],"pose_right_hand_close_shoulder"))return!1;const r=n.getNormalizedParamAt(s),a=n.getNormalizedParamAt(o);return Math.abs(r-a)<this.judge_threshold.t*e},judge_threshold:{t:.1},type:"pose",name:"pose_right_hand_close_shoulder"},z={pose:{RightUpperLeg:270,RightLowLeg:0},judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftAnkle),o=t.getItem(i.LIMB_KEYS.RightLeg);if(!f([s,o],"pose_left_foot_off_floor"))return!1;const n=o.getNormalizedParamAt(s),{t:r,ivl:a}=this.judge_threshold;return a.containsPoint(n,r*e)},judge_threshold:{t:.1,ivl:new L(0,.65)},type:"pose",name:"pose_left_foot_off_floor"},V={pose:{LeftUpperLeg:90,LeftLowLeg:0},judge(t,e=1){const s=t.getItem(i.PT_KEYS.RightAnkle),o=t.getItem(i.LIMB_KEYS.LeftLeg);if(!f([s,o],"pose_right_foot_off_floor"))return!1;const n=o.getNormalizedParamAt(s),{t:r,ivl:a}=this.judge_threshold;return a.containsPoint(n,r*e)},judge_threshold:{t:.1,ivl:new L(0,.65)},type:"pose",name:"pose_right_foot_off_floor"},W={pose:{RightUpperLeg:270,RightLowLeg:0,LeftUpperLeg:90,LeftLowLeg:0},judge(t,e=1){const s=t.getItem(i.PT_KEYS.LeftAnkle),o=t.getItem(i.PT_KEYS.RightAnkle),n=t.getItem(i.BONE_KEYS.Spine);if(!f([s,o,n],"pose_foot_parallel"))return!1;const r=n.getNormalizedParamAt(s),a=n.getNormalizedParamAt(o),{t:h,ivl:_}=this.judge_threshold,l=Math.abs(r-a);return _.containsPoint(l,h*e)},judge_threshold:{t:.1,ivl:new L(0,.1)},type:"pose",name:"pose_foot_parallel"},q={pose_arm_akimbo:E,pose_arm_horizontal:A,pose_surrender:F,pose_hands_above_head:K,pose_left_hand_above_head:Y,pose_right_hand_above_head:j,pose_left_leg_up_to_hip:O,pose_right_leg_up_to_hip:k,pose_right_foot_off_floor:V,pose_left_foot_off_floor:z},G=["pose_arm_akimbo","pose_arm_horizontal","pose_surrender","pose_hands_above_head","pose_left_hand_above_head","pose_right_hand_above_head","pose_left_leg_up_to_hip","pose_right_leg_up_to_hip","pose_left_foot_off_floor","pose_right_foot_off_floor"],$={pose_arm_akimbo:"pose_arm_akimbo",pose_arm_horizontal:"pose_arm_horizontal",pose_surrender:"pose_surrender",pose_hands_above_head:"pose_hands_above_head",pose_left_hand_above_head:"pose_left_hand_above_head",pose_right_hand_above_head:"pose_right_hand_above_head",pose_left_leg_up_to_hip:"pose_left_leg_up_to_hip",pose_right_leg_up_to_hip:"pose_right_leg_up_to_hip",pose_left_foot_off_floor:"pose_left_foot_off_floor",pose_right_foot_off_floor:"pose_right_foot_off_floor"},Q={key_poses:{pose_left_leg_up_to_hip:O,pose_right_leg_up_to_hip:k},pose_order:[["pose_left_leg_up_to_hip","pose_right_leg_up_to_hip"],["pose_right_leg_up_to_hip","pose_left_leg_up_to_hip"]],type:"action",name:"action_high_knee_lift",pose_limit_time:5e3},X={key_poses:{fly_top:{pose:{LeftUpArm:45,LeftForeArm:3,RightUpArm:318,RightForeArm:359},type:"pose",name:"pose_fly_top",threshold:20},fly_hortizontal:{pose:{LeftUpArm:348,LeftForeArm:5,RightUpArm:352,RightForeArm:0},threshold:30,type:"pose",name:"pose_arm_horizontal"},fly_bot:{pose:{LeftUpArm:318,LeftForeArm:5,RightUpArm:28,RightForeArm:20},threshold:20,type:"pose",name:"pose_fly_bot"}},pose_order:["fly_top","fly_hortizontal","fly_bot"],type:"action",name:"action_fly",pose_limit_time:3e3},J={key_poses:{pose_deep_squat_start:N,pose_deep_squat_end:b},pose_order:["pose_deep_squat_start","pose_deep_squat_end"],type:"action",name:"action_deep_squat",pose_limit_time:5e3},Z={key_poses:{pose_face_font:x,pose_face_back:B},pose_order:["pose_face_font","pose_face_back"],type:"action",name:"action_turn_around",pose_limit_time:3e3},tt={key_poses:{pose_left_punch_start:T,pose_left_punch_end:R},pose_order:["pose_left_punch_start","pose_left_punch_end"],type:"action",name:"action_left_punch",pose_limit_time:3e3},et={key_poses:{pose_right_punch_start:I,pose_right_punch_end:w},pose_order:["pose_right_punch_start","pose_right_punch_end"],type:"action",name:"action_right_punch",pose_limit_time:3e3},it={key_poses:{pose_hand_near:v,pose_hand_far:D},pose_order:["pose_hand_far","pose_hand_near"],type:"action",name:"action_hand_clamp",pose_limit_time:3e3},st={key_poses:{pose_left_hand_close_ankle:M,pose_left_hand_close_shoulder:C,pose_right_hand_close_ankle:U,pose_right_hand_close_shoulder:H},pose_order:[["pose_left_hand_close_shoulder","pose_left_hand_close_ankle","pose_right_hand_close_shoulder","pose_right_hand_close_ankle"],["pose_right_hand_close_shoulder","pose_right_hand_close_ankle","pose_left_hand_close_shoulder","pose_left_hand_close_ankle"]],type:"action",name:"action_swing_arm",pose_limit_time:3e3},ot={key_poses:{pose_left_leg_up_to_hip:O,pose_foot_parallel:W},pose_order:["pose_foot_parallel","pose_left_leg_up_to_hip"],type:"action",name:"action_left_leg_to_hip",pose_limit_time:5e3},nt={key_poses:{pose_right_leg_up_to_hip:k,pose_foot_parallel:W},pose_order:["pose_foot_parallel","pose_right_leg_up_to_hip"],type:"action",name:"action_right_leg_to_hip",pose_limit_time:5e3},rt={key_poses:{pose_left_foot_up:z,pose_foot_parallel:W},pose_order:["pose_foot_parallel","pose_left_foot_up"],type:"action",name:"action_left_foot_up",pose_limit_time:5e3},at={key_poses:{pose_right_foot_up:V,pose_foot_parallel:W},pose_order:["pose_foot_parallel","pose_right_foot_up"],type:"action",name:"action_right_foot_up",pose_limit_time:5e3};function ht(t){this.name=t,this.judge_threshold={t:.01,timeIvl:new L(.1,.5),disIvl:new L(.3,2)},this.type="pose"}ht.prototype.judge=function(t,e=1,s={}){const o=t.getItem(i.PT_KEYS.RightAnkle),n=t.getItem(i.PT_KEYS.LeftAnkle),r=t.getItem(i.BONE_KEYS.Spine),a=t.getItem("Hip");if(!f([o,n,a,r],"pose_jump_start"))return!1;if(!s.deltaTime)return!1;if(1===s.step){s.step=0;const o=t.context.mgr,n=o.seekFrame(s.startFrameFid),a=o.seekFrame(s.endFrameFid);let h=10;if(n&&a){const e=t.mgr.getTempBody();e.bodyId=t.bodyId,e.update(n);const s=e.getScreenPointByName(i.PT_KEYS.RightAnkle),o=t.mgr.getTempBody();o.bodyId=t.bodyId,o.update(a);const r=o.getScreenPointByName(i.PT_KEYS.RightAnkle);h=s.y-r.y}return!W.judge(t,e)||h<10?(s.clear&&s.clear(),!1):(u("_roundTimes spine length=",r.getLength()),u("spine ratio=",s.totalDis/r.getLength()),u("jump-------------------------------"),u("jump dis = ",s.totalDis),u("jump time = ",s.totalTime),u("jump frame = ",s.totalFrame),u("jump-------------------------------"),s.clear&&s.clear(),!0)}const{deltaTime:h,preY:_}=s,l=a.y;if(_){const e=_-l;e>0?(s.doStart||(s.startFrameFid=t.context.fid-1,s.doStart=!0,s.doEnd=!1),s.totalTime+=h,s.totalDis+=e,s.totalFrame+=1,s.doEnd=!1,s.preY=l):(s.doEnd=!0,s.endFrameFid=t.context.fid-1,s.preY=0)}else s.preY=l;const{t:g,timeIvl:d,disIvl:p}=this.judge_threshold;if(s.doEnd&&s.totalTime>0){if(u("stateName judge=",this.name),d.containsPoint(s.totalTime,g*e)&&p.containsPoint(s.totalDis/r.getLength(),g*e))return s.step=1,!0;s.clear&&s.clear()}return!1};const _t=function(){return{key_poses:{pose_jump_step_1:new ht("pose_jump_step_1"),pose_jump_step_2:new ht("pose_jump_step_2")},pose_order:["pose_jump_step_1","pose_jump_step_2"],type:"action",name:"action_jump",context:{deltaTime:0,preY:0,totalTime:0,totalDis:0,startFrameFid:0,endFrameFid:0,totalFrame:0,doEnd:!1,doStart:!1,step:0,stateMachine:void 0,clear(){this.deltaTime=0,this.preY=0,this.totalTime=0,this.totalDis=0,this.doEnd=!1,this.doStart=!1,this.step=0,this.totalFrame=0,this.startFrameFid=0,this.endFrameFid=0}},pose_limit_time:5e3}},lt={action_arms_parallel_up_and_down:X,action_high_knee_lift:Q,action_left_punch:tt,action_right_punch:et,action_deep_squat:J,action_turn_around:Z,action_hand_clamp:it,action_swing_arm:st,action_left_leg_to_hip:ot,action_right_leg_to_hip:nt,action_left_foot_up:rt,action_right_foot_up:at,action_jump_creator:_t},gt={action_arms_parallel_up_and_down:"action_arms_parallel_up_and_down",action_high_knee_lift:"action_high_knee_lift",action_left_punch:"action_left_punch",action_right_punch:"action_right_punch",action_deep_squat:"action_deep_squat",action_turn_around:"action_turn_around",action_hand_clamp:"action_hand_clamp",action_swing_arm:"action_swing_arm",action_left_leg_to_hip:"action_left_leg_to_hip",action_right_leg_to_hip:"action_right_leg_to_hip",action_left_foot_up:"action_left_foot_up",action_right_foot_up:"action_right_foot_up",action_jump_creator:"action_jump_creator"},dt=["action_arms_parallel_up_and_down","action_high_knee_lift","action_left_punch","action_right_punch","action_deep_squat","action_turn_around","action_hand_clamp","action_swing_arm","action_left_leg_to_hip","action_right_leg_to_hip","action_left_foot_up","action_right_foot_up","action_jump_creator"];class pt{constructor(){this.fid=0,this.width=0,this.height=0,this.deltaTime=0,this.cameraToward=0,this.algorithmResult=null,this.mgr=null,this.cumulativeTime=0}setFid(t){this.fid=t}setMgr(t){this.mgr=t}setSize(t,e){this.width=t,this.height=e}setDeltaTime(t){this.deltaTime=t}setCumulativeTime(t){this.cumulativeTime=t}setCameraToward(t){this.cameraToward=t}setAlgorithmResult(t){this._transferAglorithmResult(t)}getBodyAlgoData(t){return this.algorithmResult?this.algorithmResult.bodys[t]:null}getPointData(t,e){const i=this.getBodyAlgoData(t);return i?i.points[e]:null}reset(){this.fid=0,this.width=0,this.height=0,this.deltaTime=0,this.cameraToward=0,this.cumulativeTime=0,this.algorithmResult=null}dump(){return{fid:this.fid,width:this.width,height:this.height,deltaTime:this.deltaTime,cameraToward:this.cameraToward,cumulativeTime:this.cumulativeTime,algorithmResult:this.algorithmResult}}_transferAglorithmResult(t){if(!t)return this.algorithmResult=null,!1;const e=t.getSkeletonCount();if(0===e)return this.algorithmResult=null,!1;this.algorithmResult={bodys:[]};for(let s=0;s<e;s++){const e=t.getSkeletonInfo(s),o=e.keyPointsXY,n=e.keyPointsDetected,r=[];i.PT_BACK_KEYS_ARR.forEach(((t,e)=>{const i=o[2*e],s=o[2*e+1];r[e]={xy:[i,s],isValid:n[e]>0}}));const a=e.rect,h={id:s,points:r,rect:{x:a.x,y:a.y,width:a.width,height:a.height}};this.algorithmResult.bodys[s]=h}return!0}}class ut{constructor(t){this._frames=[],this._workingFrames=[],this._maxFrames=t.maxFrames||30;for(let t=0;t<this._maxFrames;t++){const t=new pt;t.setMgr(this),this._frames.push(t)}this.currentFid=0,this.currentFrameContext=this._getOrCreateFrameContext(),this.cumulativeTime=0}get frameContext(){return this.currentFrameContext}get maxFrameNum(){return this._maxFrames}seekFrame(t){return this._workingFrames.find((e=>e.fid===t))}tick(t){if(t!==this.currentFid){if(0===this._frames.length){const t=this._workingFrames.splice(0,1)[0];t.reset(),this._frames.push(t)}return this.currentFid=t,this.currentFrameContext=this._getOrCreateFrameContext(),this.currentFrameContext.setFid(t),this._workingFrames.push(this.currentFrameContext),this.currentFrameContext||m("frame context is null!"),!0}return!1}_getOrCreateFrameContext(){const t=this._frames.pop();return void 0===t?null:t}}ut.getInstance=function(t){return ut._instance||(ut._instance=new ut(t)),ut._instance};class ct extends P{constructor(t,e){super(),this.name=t,this.body=e,this.lp=new P,this.sp=new P}clear(){this.name="",this.body=null,this.lp=null,this.sp=null}get anchor(){return s.PT_NUM_IDS_BACK[this.name]}get x(){return this.sp.x}get y(){return this.sp.y}set x(t){throw new Error("not support set x!")}set y(t){throw new Error("not support set y!")}getLocalPosition(){return this.lp}updatePoint(){const{width:t,height:e}=this.body.context,i=this.body.currentPts[this.anchor];this.lp.x=i.x,this.lp.y=i.y,this.sp.x=i.x*t-t/2,this.sp.y=i.y*e-e/2,this._data[0]=this.sp.x,this._data[1]=this.sp.y}isTracking(){const t=this.body.currentPtsValid[this.anchor];return t||(c(`${this.name} is not tracking!`),c(`${this.name} valid number=`,this.anchor)),t}}class mt extends P{constructor(t,e,i){super(),this.name=t,this.bodyPoints=i||[],this.body=e,this.lp=new P,this.sp=new P}clear(){this.name="",this.bodyPoints=null,this.body=null,this.lp=null,this.sp=null}get x(){return this.sp.x}get y(){return this.sp.y}set x(t){throw new Error("not support set x!")}set y(t){throw new Error("not support set y!")}getLocalPosition(){return this.lp}updatePoint(){this.lp.resetFromArray([0,0]);for(let t=0;t<this.bodyPoints.length;t++){let e=this.bodyPoints[t].getLocalPosition();e&&this.lp.add(e)}this.lp.multi(1/this.bodyPoints.length);const{width:t,height:e}=this.body.context;this.sp.x=this.lp.x*t-t/2,this.sp.y=this.lp.y*e-e/2,this._data[0]=this.sp.x,this._data[1]=this.sp.y}isTracking(){for(let t=0;t<this.bodyPoints.length;t++)if(!f(this.bodyPoints[t],"MedianBodyPoint"))return!1;return!0}}class ft extends y{constructor(t,e,i,s,o){super(),this.name=t,this.body=e,this.start=i,this.end=s,this.parent=o,this.angle=0}updatePoints(t,e){this.resetByTwoPoint(t,e);const i=new P(this.end.x-this.start.x,this.end.y-this.start.y).normalize();let s=a;this.parent&&(s={x:this.start.x-this.parent.x,y:this.start.y-this.parent.y}),s=new P(s.x,s.y).normalize();let o=S.calculateVectorAngle(s,i);o=parseInt(`${o}`),this.angle=o}getRotation(){return this.angle}isTracking(){return f([this.start,this.end],"Bone")}}class Pt extends y{constructor(t,e,i,s,o){super(),this.name=t,this.body=e,this.start=i,this.end=s,this.joint=o,this.angle=0}updatePoints(t,e){this.resetByTwoPoint(t,e);const i=new P(this.end.x-this.start.x,this.end.y-this.start.y).normalize(),s=a;let o=S.calculateVectorAngle(s,i);o=parseInt(`${o}`),this.angle=o}getRotation(){return this.angle}isTracking(){return f([this.start,this.end,this.joint],"Limb")}}class Lt{constructor(t){this.bodyId=t,this.BodyPoints={},this.Bones={Spine:null,RightUpArm:null,LeftUpArm:null,RightForeArm:null,LeftForeArm:null,RightUpperLeg:null,LeftUpperLeg:null,RightLowLeg:null,LeftLowLeg:null},this.Limbs={LeftArm:null,RightArm:null,LeftLeg:null,RightLeg:null},this.currentPose={},this.context=null,this.contextDirty=!1,this.currentPoseAngles=[],this.currentPts=[],this.currentPtsValid=[],this.currentRect=null,this.mgr=null}get bodyContext(){return this.context&&this.context.getBodyAlgoData(this.bodyId)}init(){this._initBodyPoint(),this._initBone(),this._initLimb()}update(t){this.bindContext(t)&&this.contextDirty&&(this.context&&this.bodyContext?this._updateBody():this._resetBody(),this.contextDirty=!1)}bindContext(t){return this.context!==t&&(this.context=t,this.contextDirty=!0,!0)}isFront(){return!this.context||0===this.context.cameraToward}isValid(){return!!this.bodyContext}getItem(t){let e;return this.BodyPoints[t]?e=this.BodyPoints[t]:this.Bones[t]?e=this.Bones[t]:this.Limbs[t]&&(e=this.Limbs[t]),!e&&m(`body Item ${t} is not exist!`),e}getSize(){const t=this.BodyPoints[i.PT_KEYS.Neck].getLocalPosition(),e=this.BodyPoints.Hip.getLocalPosition();return t.distanceTo(e)}isTracking(){const{MAIN_POINTS_IDS:t}=s;for(let e=0;e<t.length;e++)if(!f(this.BodyPoints[t[e]],t[e]))return!1;return!0}_initBodyPoint(){Object.values(i.PT_KEYS).forEach((t=>{this.BodyPoints[t]=new ct(t,this)})),this.BodyPoints.Hip=new mt("Hip",this,[this.BodyPoints.LeftHip,this.BodyPoints.RightHip])}_initBone(){this.Bones.Spine=new ft("Spine",this,this.BodyPoints.Hip,this.BodyPoints.Neck),this.Bones.LeftUpArm=new ft("LeftUpArm",this,this.BodyPoints.LeftShoulder,this.BodyPoints.LeftElbow,this.BodyPoints.Neck),this.Bones.RightUpArm=new ft("RightUpArm",this,this.BodyPoints.RightShoulder,this.BodyPoints.RightElbow,this.BodyPoints.Neck),this.Bones.LeftForeArm=new ft("LeftForeArm",this,this.BodyPoints.LeftElbow,this.BodyPoints.LeftWrist,this.BodyPoints.LeftShoulder),this.Bones.RightForeArm=new ft("RightForeArm",this,this.BodyPoints.RightElbow,this.BodyPoints.RightWrist,this.BodyPoints.RightShoulder),this.Bones.LeftUpperLeg=new ft("LeftUpperLeg",this,this.BodyPoints.LeftHip,this.BodyPoints.LeftKnee,this.BodyPoints.Hip),this.Bones.RightUpperLeg=new ft("RightUpperLeg",this,this.BodyPoints.RightHip,this.BodyPoints.RightKnee,this.BodyPoints.Hip),this.Bones.LeftLowLeg=new ft("LeftLowLeg",this,this.BodyPoints.LeftKnee,this.BodyPoints.LeftAnkle,this.BodyPoints.LeftHip),this.Bones.RightLowLeg=new ft("RightLowLeg",this,this.BodyPoints.RightKnee,this.BodyPoints.RightAnkle,this.BodyPoints.RightHip)}_initLimb(){this.Limbs.LeftArm=new Pt("LeftArm",this,this.BodyPoints.LeftShoulder,this.BodyPoints.LeftWrist,this.BodyPoints.LeftElbow),this.Limbs.RightArm=new Pt("RightArm",this,this.BodyPoints.RightShoulder,this.BodyPoints.RightWrist,this.BodyPoints.RightElbow),this.Limbs.LeftLeg=new Pt("LeftLeg",this,this.BodyPoints.LeftHip,this.BodyPoints.LeftAnkle,this.BodyPoints.LeftKnee),this.Limbs.RightLeg=new Pt("RightLeg",this,this.BodyPoints.RightHip,this.BodyPoints.RightAnkle,this.BodyPoints.RightKnee)}_updateBody(){this._updatePoint(),Object.values(this.BodyPoints).forEach((t=>{t&&t.updatePoint()})),Object.values(this.Bones).forEach((t=>{t&&t.updatePoints(this.BodyPoints[t.start.name],this.BodyPoints[t.end.name])})),Object.values(this.Limbs).forEach((t=>{t&&t.updatePoints(this.BodyPoints[t.start.name],this.BodyPoints[t.end.name])})),this._updatePose(),this.currentRect=this.bodyContext.rect}_resetBody(){this.currentPose={},this.currentPoseAngles=[],this.currentPts=[],this.currentPtsValid=[],this.currentRect=null}_updatePose(){const t={};return Object.values(i.BONE_KEYS).forEach((e=>{const i=this.Bones[e];i?t[e]=i.getRotation():m("Bone!!!!",e,"is null")})),this.printPose(),this.currentPose=t,this.currentPoseAngles=i.BONE_KEYS_ARR.map((e=>parseInt(t[e]))),t}printPose(){u(JSON.stringify(this.currentPose,null,2))}getPointAnchor(t){return"Hip"===t?18:s.PT_NUM_IDS_BACK[t]}getNormalizedPointByAnchor(t){return!!this.getPointValidByAnchor(t)&&this.currentPts[t]}getScreenPointByAnchor(t){const e=this.currentPts[t];return!!this.getPointValidByAnchor(t)&&this.localToScreen(e)}getPointValidByAnchor(t){return this.currentPtsValid[t]}getPointValidByName(t){const e=this.getPointAnchor(t);return this.getPointValidByAnchor(e)}getNormalizedPointByName(t){const e=this.getPointAnchor(t);return this.getNormalizedPointByAnchor(e)}getScreenPointByName(t){const e=this.getPointAnchor(t);return this.getScreenPointByAnchor(e)}_updatePoint(){const{PT_NUM_IDS_FRONT:t,PT_NUM_IDS_BACK:e}=s;this.currentPts=[];const i=this.isFront()?t:e;Object.entries(i).forEach((([t,i])=>{const s=this.bodyContext.points[e[t]];this.currentPts[i]=new P(s.xy).toXY(),this.currentPtsValid[i]=s.isValid}));const o=this.currentPts[e.LeftHip],n=this.currentPts[e.RightHip],r=new y(o,n);this.currentPts.push(r.getMidPt().toXY());const a=this.currentPtsValid[e.LeftHip],h=this.currentPtsValid[e.RightHip];this.currentPtsValid.push(a&&h)}toNormalizedPts(){return this.currentPts}toPtsIsDetected(){return this.currentPtsValid}toPoseAngle(){return this.currentPoseAngles}toCameraAngle(t){return this.isValid()?this.isFront()?t:360-t:t}toBoneIsDetected(){return i.BONE_KEYS_ARR.map((t=>this.Bones[t].isTracking()))}toRect(){return this.currentRect}localToScreen(t){if(!this.isValid())return c(this.bodyId,"body is not valid!"),!1;if(!t)return c("localToScreen p is null!"),!1;const{width:e,height:i}=this.context,s=new P;return s.x=t.x*e-e/2,s.y=t.y*i-i/2,s}}class yt{constructor(){this.body0=new Lt(0),this.body0.init(),this.body1=new Lt(1),this.body1.init(),this.tempBody=new Lt,this.tempBody.init(),this.body0.mgr=this,this.body1.mgr=this,this.tempBody.mgr=this}update(){const t=ut.getInstance().frameContext;this.body0.update(t),this.body1.update(t)}getBody(t){return 0===t?this.body0:1===t?this.body1:null}getTempBody(){return this.tempBody}}yt.getInstance=function(){return yt.instance||(yt.instance=new yt),yt.instance};const St={idle:0,running:1};class Et{constructor(){this.name="",this.states=[],this.statesMap=new Map,this._currentStateIndex=0,this._mode=St.idle,this._recordIndex=-1,this._roundTimes=0,this.userData={}}get currentState(){return this.states[this._currentStateIndex]||(m("current state is not defined"),null)}get nextState(){let t=this._currentStateIndex+1;t=t>=this.states.length?0:t;const e=this.states[t];return u("nextStateIndex=",t),e||(m("next state is not defined"),null)}get beforeState(){let t=this._currentStateIndex-1;t=t<0?this.states.length-1:t;return this.states[t]||(m("before state is not defined"),null)}get roundTimes(){return this._roundTimes}isRunning(){return this._mode===St.running}reset(){u("reset state machine"),this._mode!==St.idle&&this.currentState&&this.currentState.onExit&&this.currentState.onExit(),this.name="",this._currentStateIndex=0,this._mode=St.idle,this._roundTimes=0,this.userData={}}clear(){u("clear state machine"),this.reset(),this.name="",this.states=[],this.statesMap.clear(),this._recordIndex=-1}hasState(t){return this.statesMap.has(t)}addState(t){this.statesMap.has(t.name)?c(`${t.name} has been added!`):(this.states.push(t),this.statesMap.set(t.name,t),this._recordIndex=this.states.length-1)}setState(t){if(this._mode===St.idle){const e=this.statesMap.get(t);return e?(this._currentStateIndex=this.states.indexOf(e),this._mode=St.running,e.onEnter&&e.onEnter(),void u("start state:",t)):void m(`${t} is invalid!`)}let e=this.currentState,i=this.nextState;if(t===i.name)return e&&e.onExit&&e.onExit(),this._currentStateIndex=this.states.indexOf(i),this._recordIndex===this._currentStateIndex&&(this._roundTimes++,u("this._roundTimes++=",this._roundTimes,"index=",this._recordIndex,"stateName=",t,"nextState=",this.nextState.name),u("record number:",this._roundTimes)),i&&i.onEnter&&i.onEnter(),void u("go next state:",t)}}function At(t,e,i,s,o){if(!t.isValid())return m("body is null"),!1;let n=0,r=0,a=t.Bones,h=e.pose;if(h&&!t.isFront()){const t={};Object.entries(h).forEach((([e,i])=>{t[e]=360-i})),h=t}i=e.threshold||i,i*=s;for(let t in h){if(!f(a[t],"isMatchPose bone"))return!1;r+=S.getAngleDifference(h[t],a[t].getRotation()),n++}const _=!(n>0)||r/n<=i;let l=_;return _&&e.judge&&(l=e.judge(t,s,o||{})),!!l}function Tt(t,e,i,s,o){if(!t.isValid())return m("body is null"),!1;const{pose_order:n,type:r,name:a,key_poses:_,pose_limit_time:l,context:g}=e;if("action"!==r)return m(`${a} is not a action type`),!1;if(g&&(g.deltaTime=t.context.deltaTime,g.stateMachine=i),u("action checking!"),a!==i.name){i.isRunning()&&i.reset(),i.name=a;for(let t of n){if(Array.isArray(t)){for(let e of t){const t=_[e];i.addState({name:e,pose:t,onEnter:()=>{null!==i.userData.st&&(clearTimeout(i.userData.st),i.userData.st=null),i.userData.st=setTimeout((()=>{u("do reset"),i.reset(),i.userData.st=null}),o||l)},onExit:()=>{null!==i.userData.st&&(u("clearTimeout"),clearTimeout(i.userData.st),i.userData.st=null)}})}break}const e=_[t];i.addState({name:t,pose:e,onEnter:()=>{i.userData.st=setTimeout((()=>{u("do reset"),i.reset()}),o||l)},onExit:()=>{i.userData.st&&(u("clearTimeout"),clearTimeout(i.userData.st),i.userData.st=null)}})}u("stateMachine init!")}let d=n;if(!i.isRunning()&&"string"==typeof n[0]){const e=n[0];return!!At(t,_[e],h,s,g)&&(i.setState(e),!0)}if(!i.isRunning()&&Array.isArray(n[0])){for(let e of n){const o=e[0];if(At(t,_[o],h,s,g))return u("mathch first pose=",o),i.setState(o),!0}return!1}Array.isArray(n[0])&&(d=n[0]);for(let e of d){u("poseName=",e);const o=_[e];if(u("stateMachine.nextState.name=",i.nextState.name),e===i.nextState.name&&At(t,o,h,s,g))return u("mathch pose=",e),i.setState(e),!0}return i.isRunning()}class Rt{constructor(t){this.activePoses={},this.ativeActions={},this.options={maxFrames:20,defaultWidth:720,defaultHeight:1280},Object.assign(this.options,t),this.frameMgr=ut.getInstance(this.options),this.bodyMgr=yt.getInstance()}get fid(){return this.frameMgr.currentFid}get frameContext(){return this.frameMgr.frameContext}getBody(t){return this.bodyMgr.getBody(t)}tick(t){return this.frameMgr.tick(t)}update(){this.bodyMgr.update()}setSize(t,e){t&&e?this.frameContext.setSize(t,e):this.frameContext.setSize(this.options.defaultWidth,this.options.defaultHeight)}setDeltaTime(t){this.frameMgr.cumulativeTime+=t,this.frameContext.setDeltaTime(t),this.frameContext.setCumulativeTime(this.frameMgr.cumulativeTime)}setCameraToward(t){this.frameContext.setCameraToward(t)}setAlgorithmResult(t){this.frameContext.setAlgorithmResult(t)}}Rt.getInstance=function(){return Rt._instance||(Rt._instance=new Rt),Rt._instance},posejs=e})();

const APJS = require('./amazingpro');
const {BaseNode} = require('./Graph/Lib/Utils/BaseNode');

const {
  printWarn,
  PoseManager
} = posejs;

class CGPoseBaseNode extends BaseNode {
  constructor() {
    super();
    this.sys = null;
  }

  getBody(bodyID) {
    return this.sys && this.sys.poseManager && this.sys.poseManager.getBody(bodyID);
  }

  beforeStart(sys) {
    this.sys = sys;
    if (!sys.poseManager) {
      sys.poseManager = PoseManager.getInstance();
    }
  }

  updatePose(dt, algoResult) {
    if (!this.sys.poseManager) {
      return;
    }
    const poseManager = this.sys.poseManager;
    // tick (set fid)
    const doTick = poseManager.tick(this.sys.frameCntNoReset);
    if (!doTick) {
      return;
    }

    // set size
    const scene = this.sys.APJScene.getNative();
    if (scene) {
      const tex = scene.getOutputRenderTexture();
      if (tex) {
        poseManager.setSize(tex.width, tex.height);
      } else {
        poseManager.setSize();
        printWarn('scene output texture is null');
      }
    }

    // set deltaTime
    poseManager.setDeltaTime(dt);

    // set cameraToward
    const camFacing = APJS.Platform.getCameraToward();
    poseManager.setCameraToward(camFacing);

    // set algo result
    poseManager.setAlgorithmResult(algoResult);

    // update
    poseManager.update();
  }

}

exports.posejs = posejs;
exports.CGPoseBaseNode = CGPoseBaseNode;